<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: mutation_domlistener.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/mangalam.css">
</head>

<body>


<div id="main">

    <h1 class="page-title">Source: mutation_domlistener.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module mutation_domlistener
 * @desc Facility to listen to changes to a DOM tree.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013, 2014 Mangalam Research Center for Buddhist Languages
 */

define(/** @lends module:mutation_domlistener */
    function (require, exports, module) {
'use strict';

var oop = require("./oop");
var domlistener = require("./domlistener");

// Location depends on platform. :-/
var MutationObserver = window.MutationObserver ||
        window.WebKitMutationObserver;

/**
 * @classdesc A DOM listener based on MutationObserver.
 *
 * @extends module:domlistener~Listener
 *
 * @constructor
 * @param {Node} root The root of the DOM tree about which the
 * listener should listen to changes.
 */

function Listener(root) {
    domlistener.Listener.call(this, root);
    this._observer = new MutationObserver(this._onMutation.bind(this));
}

oop.inherit(Listener, domlistener.Listener);

Listener.prototype.startListening = function() {
    this._observer.observe(this._root, {
        subtree: true,
        childList: true,
        attributes: true,
        // Reminder: following option can't be true if 'attributes' false.
        attributeOldValue: true,
        characterData: true,
        // Reminder: following option can't be true if 'characterData' false.
        characterDataOldValue: true
    });
};

Listener.prototype.stopListening = function () {
    this._observer.disconnect();
};

Listener.prototype.processImmediately = function () {
    var records = this._observer.takeRecords();
    while(records.length > 0) {
        while(records.length > 0) {
            this._processMutations(records);
            records = this._observer.takeRecords();
        }
        this._processTriggers();
        records = this._observer.takeRecords();
    }
};

Listener.prototype.clearPending = function () {
    // This is a noop for this implementation.
};

/**
 * Mutation handler.
 * @private
 *
 * @param mutations The mutation to process.
 * @param observer The observer object which saw this mutation.
 */
Listener.prototype._onMutation = function (mutations, observer) {
    this._processMutations(mutations);
    this._processTriggers();
};

/**
 * Act on the mutations.
 * @private
 *
 * @param {Array} mutations An array of mutations to process.
 */
Listener.prototype._processMutations = function (mutations) {
    for(var mut_ix = 0, mut_ix_limit = mutations.length;
        mut_ix &lt; mut_ix_limit; ++mut_ix) {
        var mut = mutations[mut_ix];

        var target = mut.target;

        // Hoisting is the pits
        var pair_ix, pair_ix_limit, pair, sel, pairs;

        var added_other = [];
        var removed_other = [];
        var node_ix, node;
        if (mut.type === "childList") {
            for(node_ix = 0; !!(node = mut.addedNodes[node_ix]); node_ix++)
                if (node.nodeType !== Node.TEXT_NODE)
                    added_other.push(node);

            for(node_ix = 0; !!(node = mut.removedNodes[node_ix]); node_ix++)
                if (node.nodeType !== Node.TEXT_NODE)
                    removed_other.push(node);

            this._fireAddRemHandlers("added-element", mut, added_other,
                                     target);
            this._fireAddRemHandlers("removed-element", mut, removed_other,
                                     target);
            this._fireIncExcHandlers("included-element", mut, added_other,
                                     target);
            this._fireIncExcHandlers("excluded-element", mut, removed_other,
                                     target);

            // children-changed
            pairs = this._event_handlers["children-changed"];

            var prev = mut.previousSibling;
            var next = mut.nextSibling;
            // Go over all the elements for which we have handlers
            for (pair_ix = 0, pair_ix_limit = pairs.length;
                 pair_ix &lt; pair_ix_limit; ++pair_ix) {
                pair = pairs[pair_ix];
                sel = pair[0];

                if (target.matches(sel))
                    this._callHandler(pair[1], mut.addedNodes, mut.removedNodes,
                                      prev, next, target);
            }
        }
        else if (mut.type === "characterData") {
            //
            // text-changed
            //
            pairs = this._event_handlers["text-changed"];

            // Go over all the elements for which we have
            // handlers
            var parent = target.parentNode;
            for (pair_ix = 0, pair_ix_limit = pairs.length;
                 pair_ix &lt; pair_ix_limit; ++pair_ix) {
                pair = pairs[pair_ix];
                sel = pair[0];

                // Check whether any of the nodes contains an
                // element we care about.
                if (parent.matches(sel))
                        this._callHandler(pair[1], target, mut.oldValue);
            }
        }
        else if (mut.type === "attributes") {
            //
            // attribute-changed
            //
            pairs = this._event_handlers["attribute-changed"];
            // Go over all the elements for which we have
            // handlers
            for (pair_ix = 0, pair_ix_limit = pairs.length;
                 pair_ix &lt; pair_ix_limit; ++pair_ix) {
                pair = pairs[pair_ix];
                sel = pair[0];

                // Check whether any of the nodes contains an
                // element we care about.
                if (target.matches(sel))
                    this._callHandler(pair[1], target,
                                      mut.attributeNamespace,
                                      mut.attributeName, mut.oldValue);
            }

        }
    }
};

/**
 * Fires the &lt;code>added-element&lt;/code> and
 * &lt;code>removed-element&lt;/code> handlers.
 *
 * @private
 *
 * @param {string} name The name of the event.
 * @param mutation The mutation object.
 * @param {Array.&lt;Node>} nodes The nodes for which to fire the event.
 * @param {Node} target The parent of the nodes added or removed.
 */
Listener.prototype._fireAddRemHandlers = function (name, mutation, nodes,
                                                   target) {
    var pairs = this._event_handlers[name];

    // Go over all the elements for which we have handlers
    for (var pair_ix = 0, pair_ix_limit = pairs.length;
         pair_ix &lt; pair_ix_limit; ++pair_ix) {
        var pair = pairs[pair_ix];
        var sel = pair[0];

        // Check whether any of the nodes contains an element we
        // care about.
        for (var node_ix = 0, node_ix_limit = nodes.length;
             node_ix &lt; node_ix_limit; ++node_ix) {
            // These are the elements we are interested in.
            var node = nodes[node_ix];
            if (node.matches(sel)) {
                // mutation.previousSibling and nextSibling are
                // relative to the entire set of nodes, so adjust
                // for each individual node.
                var prev = (node_ix === 0) ? mutation.previousSibling:
                        nodes[node_ix - 1];
                var next = (node_ix === node_ix_limit - 1) ?
                        mutation.nextSibling: nodes[node_ix + 1];

                this._callHandler(pair[1], target, prev, next, node);
            }
        }
    }
};


/**
 * Fires the &lt;code>included-element&lt;/code> and
 * &lt;code>excluded-element&lt;/code> handlers.
 *
 * @private
 *
 * @param {string} name The name of the event.
 * @param mutation The mutation object.
 * @param {Array.&lt;Node>} nodes The nodes for which to fire the event.
 * @param {Node} target The parent of the nodes included or excluded.
 */
Listener.prototype._fireIncExcHandlers = function (name, mutation, nodes,
                                                   target) {
    var pairs = this._event_handlers[name];

    // Go over all the elements for which we have handlers
    for (var pair_ix = 0, pair_ix_limit = pairs.length;
         pair_ix &lt; pair_ix_limit; ++pair_ix) {
        var pair = pairs[pair_ix];
        var sel = pair[0];

        // Check whether any of the nodes contains an element we
        // care about.
        for (var node_ix = 0, node_ix_limit = nodes.length;
             node_ix &lt; node_ix_limit; ++node_ix) {
            // mutation.previousSibling and nextSibling are
            // relative to the entire set of nodes, so adjust
            // for each individual node.
            var prev = (node_ix === 0) ? mutation.previousSibling:
                    nodes[node_ix - 1];
            var next = (node_ix === node_ix_limit - 1) ?
                    mutation.nextSibling: nodes[node_ix + 1];

            var node = nodes[node_ix];
            // These are the elements we are interested in.
            if (node.matches(sel))
                this._callHandler(pair[1], node, target, prev, next, node);

            var targets = node.querySelectorAll(sel);

            for(var target_ix = 0, target_ix_limit = targets.length;
                target_ix &lt; target_ix_limit; ++target_ix)
                this._callHandler(pair[1], node, target, prev, next,
                                  targets[target_ix]);
        }
    }
};

exports.Listener = Listener;

});

//  LocalWords:  childList characterData DOM oop Mangalam MPL Dubeau
//  LocalWords:  previousSibling MutationObserver nextSibling
//  LocalWords:  domlistener
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-action.html">action</a></li><li><a href="module-browsers.html">browsers</a></li><li><a href="module-convert.html">convert</a></li><li><a href="module-decorator.html">decorator</a></li><li><a href="module-dloc.html">dloc</a></li><li><a href="module-domlistener.html">domlistener</a></li><li><a href="module-domutil.html">domutil</a></li><li><a href="module-exceptions.html">exceptions</a></li><li><a href="action_context_menu.html">gui/action_context_menu</a></li><li><a href="completion_menu.html">gui/completion_menu</a></li><li><a href="context_menu.html">gui/context_menu</a></li><li><a href="icon.html">gui/icon</a></li><li><a href="modal.html">gui/modal</a></li><li><a href="tooltip.html">gui/tooltip</a></li><li><a href="module-gui_updater.html">gui_updater</a></li><li><a href="module-guiroot.html">guiroot</a></li><li><a href="module-input_trigger.html">input_trigger</a></li><li><a href="module-input_trigger_factory.html">input_trigger_factory</a></li><li><a href="module-key.html">key</a></li><li><a href="module-key_constants.html">key_constants</a></li><li><a href="conditioned.html">lib/conditioned</a></li><li><a href="pubsub.html">lib/pubsub</a></li><li><a href="simple_event_emitter.html">lib/simple_event_emitter</a></li><li><a href="module-log.html">log</a></li><li><a href="module-mode.html">mode</a></li><li><a href="module-mode_validator.html">mode_validator</a></li><li><a href="generic.html">modes/generic/generic</a></li><li><a href="generic_decorator.html">modes/generic/generic_decorator</a></li><li><a href="generic_meta.html">modes/generic/generic_meta</a></li><li><a href="generic_tr.html">modes/generic/generic_tr</a></li><li><a href="tei_meta.html">modes/generic/metas/tei_meta</a></li><li><a href="test_decorator.html">modes/test/test_decorator</a></li><li><a href="test_mode.html">modes/test/test_mode</a></li><li><a href="test_mode_validator.html">modes/test/test_mode_validator</a></li><li><a href="module-mutation_domlistener.html">mutation_domlistener</a></li><li><a href="module-object_check.html">object_check</a></li><li><a href="module-onbeforeunload.html">onbeforeunload</a></li><li><a href="module-onerror.html">onerror</a></li><li><a href="module-oop.html">oop</a></li><li><a href="module-preferences.html">preferences</a></li><li><a href="module-refman.html">refman</a></li><li><a href="module-saver.html">saver</a></li><li><a href="module-transformation.html">transformation</a></li><li><a href="module-tree_updater.html">tree_updater</a></li><li><a href="module-undo.html">undo</a></li><li><a href="module-undo_recorder.html">undo_recorder</a></li><li><a href="module-updater_domlistener.html">updater_domlistener</a></li><li><a href="module-util.html">util</a></li><li><a href="module-validator.html">validator</a></li><li><a href="module-wed.html">wed</a></li><li><a href="module-wundo.html">wundo</a></li></ul><h3>Externals</h3><ul><li><a href="external-jQuery.html">jQuery</a></li></ul><h3>Classes</h3><ul><li><a href="module-action-Action.html">action~Action</a></li><li><a href="module-decorator-Decorator.html">decorator~Decorator</a></li><li><a href="module-dloc-DLoc.html">dloc~DLoc</a></li><li><a href="module-domlistener-Listener.html">domlistener~Listener</a></li><li><a href="module-exceptions-AbortTransformationException.html">exceptions~AbortTransformationException</a></li><li><a href="action_context_menu-ContextMenu.html">gui/action_context_menu~ContextMenu</a></li><li><a href="completion_menu-CompletionMenu.html">gui/completion_menu~CompletionMenu</a></li><li><a href="context_menu-ContextMenu.html">gui/context_menu~ContextMenu</a></li><li><a href="modal-Modal.html">gui/modal~Modal</a></li><li><a href="module-gui_updater-GUIUpdater.html">gui_updater~GUIUpdater</a></li><li><a href="module-input_trigger-InputTrigger.html">input_trigger~InputTrigger</a></li><li><a href="module-key-Key.html">key~Key</a></li><li><a href="conditioned-Conditioned.html">lib/conditioned~Conditioned</a></li><li><a href="simple_event_emitter-SimpleEventEmitter.html">lib/simple_event_emitter~SimpleEventEmitter</a></li><li><a href="module-log-Handled.html">log~Handled</a></li><li><a href="generic_decorator-GenericDecorator.html">modes/generic/generic_decorator~GenericDecorator</a></li><li><a href="generic_meta-Meta.html">modes/generic/generic_meta~Meta</a></li><li><a href="generic-Mode.html">modes/generic/generic~Mode</a></li><li><a href="tei_meta-TeiMeta.html">modes/generic/metas/tei_meta~TeiMeta</a></li><li><a href="test_decorator-TestDecorator.html">modes/test/test_decorator~TestDecorator</a></li><li><a href="test_mode-TestMode.html">modes/test/test_mode~TestMode</a></li><li><a href="module-mode-Mode.html">mode~Mode</a></li><li><a href="module-mutation_domlistener-Listener.html">mutation_domlistener~Listener</a></li><li><a href="module-refman-ReferenceManager.html">refman~ReferenceManager</a></li><li><a href="module-refman-SenseReferenceManager.html">refman~SenseReferenceManager</a></li><li><a href="module-saver-Saver.html">saver~Saver</a></li><li><a href="module-transformation-Transformation.html">transformation~Transformation</a></li><li><a href="module-tree_updater-TreeUpdater.html">tree_updater~TreeUpdater</a></li><li><a href="module-undo_recorder-UndoRecorder.html">undo_recorder~UndoRecorder</a></li><li><a href="module-undo-Undo.html">undo~Undo</a></li><li><a href="module-undo-UndoGroup.html">undo~UndoGroup</a></li><li><a href="module-undo-UndoList.html">undo~UndoList</a></li><li><a href="module-updater_domlistener-Listener.html">updater_domlistener~Listener</a></li><li><a href="module-validator-EventIndexException.html">validator~EventIndexException</a></li><li><a href="module-validator-Validator.html">validator~Validator</a></li><li><a href="module-wed-Editor.html">wed~Editor</a></li><li><a href="module-wundo-MarkerUndo.html">wundo~MarkerUndo</a></li><li><a href="module-wundo-TextUndoGroup.html">wundo~TextUndoGroup</a></li><li><a href="module-wundo-UndoGroup.html">wundo~UndoGroup</a></li></ul><h3>Events</h3><ul><li><a href="module-action-Action.html#event:disabled">action~Action#disabled</a></li><li><a href="module-action-Action.html#event:enabled">action~Action#enabled</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:beforeDeleteNode">gui_updater~GUIUpdater#beforeDeleteNode</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:changed">gui_updater~GUIUpdater#changed</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:deleteNode">gui_updater~GUIUpdater#deleteNode</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:insertNodeAt">gui_updater~GUIUpdater#insertNodeAt</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:setAttributeNS">gui_updater~GUIUpdater#setAttributeNS</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:setTextNodeValue">gui_updater~GUIUpdater#setTextNodeValue</a></li><li><a href="pubsub.html#event:WED">lib/pubsub#WED</a></li><li><a href="pubsub.html#event:WED_MODE">lib/pubsub#WED_MODE</a></li><li><a href="pubsub.html#event:WED_MODE_READY">lib/pubsub#WED_MODE_READY</a></li><li><a href="pubsub.html#event:WED_MODES_GENERIC_META_READY">lib/pubsub#WED_MODES_GENERIC_META_READY</a></li><li><a href="module-transformation-Transformation.html#event:disabled">transformation~Transformation#disabled</a></li><li><a href="module-transformation-Transformation.html#event:enabled">transformation~Transformation#enabled</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:beforeDeleteNode">tree_updater~TreeUpdater#beforeDeleteNode</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:changed">tree_updater~TreeUpdater#changed</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:deleteNode">tree_updater~TreeUpdater#deleteNode</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:insertNodeAt">tree_updater~TreeUpdater#insertNodeAt</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:setAttributeNS">tree_updater~TreeUpdater#setAttributeNS</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:setTextNodeValue">tree_updater~TreeUpdater#setTextNodeValue</a></li><li><a href="module-validator-Validator.html#event:error">validator~Validator#error</a></li><li><a href="module-validator-Validator.html#event:reset-errors">validator~Validator#reset-errors</a></li><li><a href="module-validator-Validator.html#event:state-update">validator~Validator#state-update</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Fri Oct 24 2014 16:24:40 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
