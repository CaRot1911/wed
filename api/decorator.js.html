<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: decorator.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/wed.css">
</head>

<body>


<div id="main">

    <h1 class="page-title">Source: decorator.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source"><code> /**
  * @module decorator
  * @desc Basic decoration facilities.
  * @author Louis-Dominique Dubeau
  * @license MPL 2.0
  * @copyright 2013 Mangalam Research Center for Buddhist Languages
  */
define(/** @lends module:decorator */ function (require, exports, module) {
'use strict';

var util = require("./util");
var $ = require("jquery");
var domutil = require("./domutil");
var jqutil = require("./jqutil");
var transformation = require("./transformation");

/**
 * @classdesc A decorator is responsible for adding decorations to a
 * tree of DOM elements. Decorations are GUI elements.
 *
 * @constructor
 * @param {module:domlistener~Listener} domlistener The listener that
 * the decorator must use to know when the DOM tree has changed and
 * must be redecorated.
 * @param {module:wed~Editor} editor The editor instance for which
 * this decorator was created.
 * @param {module:gui_updater~GUIUpdater} gui_updater The updater to
 * use to modify the GUI tree. All modifications to the GUI must go
 * through this updater.
*/
function Decorator(domlistener, editor, gui_updater) {
    this._domlistener = domlistener;
    this._editor = editor;
    this._gui_updater = gui_updater;
}

exports.Decorator = Decorator;

/**
 * Request that the decorator add its event handlers to its listener.
 */
Decorator.prototype.addHandlers = function () {
    this._domlistener.addHandler(
        "added-element",
        "._real, ._phantom, ._phantom_wrap",
        this.contentEditableHandler.bind(this));
};

/**
 * Start listening to changes to the DOM tree.
 *
 * @param {jQuery} $root The DOM root that this decorator listens
 * to. This must be the same root as the root that the this
 * decorator's domlistener listens on and the same root as the root
 * which the GUI updater updates.
 */
Decorator.prototype.startListening = function ($root) {
    var $contents = $root.contents();
    $contents.detach();
    this._domlistener.startListening();
    this._gui_updater.insertAt($root.get(0), 0, $contents.toArray());
};

/**
 * This function adds a separator between each child element of the
 * element passed as &lt;code>el&lt;/code>. The function only considers
 * "._real" elements.
 *
 * @param {Node} el The element to decorate.
 * @param {String|jQuery} sep A separator.
 */
Decorator.prototype.listDecorator = function (el, sep) {
    // We expect to work with a homogeneous list. That is, all
    // children the same element.
    var name_map = {};
    $(el).children('._real').each(function () {
        name_map[util.getOriginalName(this)] = 1;
    });

    var tags = Object.keys(name_map);
    if (tags.length > 1)
        throw new Error("calling listDecorator on a non-homogeneous list.");

    if (tags.length === 0)
        return; // Nothing to work with

    // First drop all children that are separators
    var me = this;
    $(el).children('[data-wed--separator-for]').each(function () {
        me._gui_updater.removeNode(this);
    });

    var tag_name = tags[0];

    // If sep is a string, create an appropriate div.
    if (typeof sep === "string")
        sep = $('&lt;div class="_text">' + sep + "&lt;/div>");

    $(sep).addClass('_phantom');
    $(sep).attr('data-wed--separator-for', tag_name);

    var first = true;
    $(el).children('._real').each(function () {
        if (!first)
            me._gui_updater.insertBefore(this.parentNode, sep.clone().get(0),
                                         this);
        else
            first = false;
    });
};

/**
 * An event handler for additions or removals of list
 * elements. Redecorates the list. The parameters after
 * &lt;code>sep&lt;/code> are the same as those for
 * &lt;code>added-element&lt;/code> and &lt;code>removed-element&lt;/code> events
 * in {@link module:domlistener domlistener}.
 *
 * @param {String|jQuery} sep Separator between the elements of the
 * list.
 */
Decorator.prototype.addRemListElementHandler = function (
    sep, $root, $parent, $previous_sibling, $next_sibling, $element) {
    this.listDecorator($parent, sep);
};

/**
 * An event handler for inclusions of lists. The parameters after
 * &lt;code>sep&lt;/code> are the same as those for
 * &lt;code>included-element&lt;/code> events in {@link module:domlistener
 * domlistener}.
 *
 * @param {String|jQuery} sep Separator between the elements of the
 * list.
 */
Decorator.prototype.includeListHandler = function (
    sep, $root, $tree, $parent, $previous_sibling, $next_sibling, $element) {
    this.listDecorator($element, sep);
};


/**
 * Generic handler for setting &lt;code>contenteditable&lt;/code> on nodes
 * included into the tree. The parameters are the same as those for
 * &lt;code>included-element&lt;/code> events in {@link module:domlistener
 * domlistener}.
 */
Decorator.prototype.contentEditableHandler = function (
    $root, $parent, $previous_sibling, $next_sibling, $element) {
    $element.findAndSelf('._phantom').attr("contenteditable", "false");
    $element.findAndSelf('._phantom_wrap').attr("contenteditable", "false");
    $element.findAndSelf('._real').attr("contenteditable", "true");
    // All element that may get a selection must be focusable to work
    // around bug: https://bugzilla.mozilla.org/show_bug.cgi?id=921444
    $element.findAndSelf('*').attr("tabindex", "-1");
};

/**
 * Add a start label at the start of an element and end label at the
 * end.
 *
 * @param {jQuery} $root The root of the decorated tree.
 * @param {Node} el The element to decorate.
 * @param {Function} pre_context_handler An event handler to run when
 * the user invokes a context menu on the start label
 * @param {Function} post_context_handler An event handler to run when
 * the user invokes a context menu on the end label.
 */
Decorator.prototype.elementDecorator = function (
    $root, el, pre_context_handler, post_context_handler) {
    var $el = $(el);
    el = $el.get(0);
    var orig_name = util.getOriginalName(el);
    // _[name]_label is used locally to make the function idempotent.
    var cls = "_" + orig_name + "_label";
    var me = this;
    $(el).children("." + util.escapeCSSClass(cls)).each(function () {
        // We don't call remove node because removing these nodes
        // should not result in text getting merged.
        me._gui_updater.deleteNode(this);
    });
    var $pre = $('&lt;span class="_gui _phantom _start_button ' + cls +
                 ' _button">&lt;span class="_phantom">&nbsp;' + orig_name +
                 ' >&nbsp;&lt;/span>&lt;/span>');
    this._gui_updater.insertNodeAt(el, 0, $pre.get(0));
    var $post = $('&lt;span class="_gui _phantom _end_button ' + cls +
                  ' _button">&lt;span class="_phantom">&nbsp;&lt; ' +
                  orig_name + '&nbsp;&lt;/span>&lt;/span>');
    this._gui_updater.insertBefore(el, $post.get(0), null);

    // Setup a handler so that clicking one label highlights it and
    // the other label.
    var data = {'$root': $root, '$pre': $pre, '$post': $post};
    $pre.on("wed-click click", data,
            this._elementButtonClickHandler.bind(this));
    $post.on("wed-click click", data,
             this._elementButtonClickHandler.bind(this));
    $pre.on("wed-unclick", data, this._elementButtonUnclickHandler.bind(this));
    $post.on("wed-unclick", data, this._elementButtonUnclickHandler.bind(this));

    if (pre_context_handler !== undefined)
        $pre.on('wed-context-menu', pre_context_handler);
    else
        $pre.on('wed-context-menu', false);

    if (post_context_handler !== undefined)
        $post.on('wed-context-menu', post_context_handler);
    else
        $post.on('wed-context-menu', false);
};

/**
 * Event handler for clicks on start and end labels placed by {@link
 * module:decorator~Decorator#elementDecorator elementDecorator}.
 *
 * @private
 * @param {Event} ev DOM event.
 */
Decorator.prototype._elementButtonClickHandler = function (ev) {
    var data = ev.data;
    data.$pre.addClass("_button_clicked");
    data.$post.addClass("_button_clicked");
};

/**
 * Event handler for "unclicks" on start and end labels placed by
 * {@link module:decorator~Decorator#elementDecorator
 * elementDecorator}. ("Unclicks" are generated by wed.)
 *
 * @private
 * @param {Event} ev DOM event.
 */
Decorator.prototype._elementButtonUnclickHandler = function (ev) {
    var data = ev.data;
    data.$pre.removeClass("_button_clicked");
    data.$post.removeClass("_button_clicked");
};

/**
 * Context menu handler for the labels of elements decorated by {@link
 * module:decorator~Decorator#elementDecorator elementDecorator}.
 *
 * @private
 * @param {Boolean} at_start Whether or not this event is for the
 * start label.
 * @param {Event} wed_ev The DOM event that wed generated to trigger
 * this handler.
 * @param {Event} ev The DOM event that wed received.
 * @returns {Boolean} To be interpreted the same way as for all DOM
 * event handlers.
 */
Decorator.prototype._contextMenuHandler = function (
    at_start, wed_ev, ev) {
    var node = $(wed_ev.currentTarget).parents('._real').first().get(0);
    var menu_items = [];
    var editor = this._editor;
    var mode = editor.mode;
    if (node.parentNode !== editor.gui_root) {
        // We first gather the transformations that pertain to the
        // node to which the label belongs.

        var orig = util.getOriginalName(node);
        var trs = mode.getContextualActions(
            ["unwrap", "delete-element"], orig, node, 0);
        if (trs !== undefined) {
            trs.forEach(function (tr) {
                var data = {node: node, element_name: orig };
                var icon = tr.getIcon();
                var $a = $("&lt;a tabindex='-1' href='#'>" +
                           (icon ? icon + " ": "") +
                           tr.getDescriptionFor(data) + "&lt;/a>");
                $a.click(data, tr.bound_handler);
                menu_items.push($("&lt;li>").append($a).get(0));
            }.bind(this));
        }

        // Then we check what could be done before the node (if the
        // user clicked on an start element label) or after the node
        // (if the user clicked on an end element label).
        var parent = node.parentNode;
        var index = Array.prototype.indexOf.call(parent.childNodes, node);

        // If we're on the end label, we want the events *after* the node.
        if (!at_start)
            index++;

        var tree_caret = editor.toDataCaret(parent, index);
        editor.validator.possibleAt(
            tree_caret[0], tree_caret[1]).forEach(function (ev) {
                if (ev.params[0] !== "enterStartTag")
                    return;

                var unresolved = editor.resolver.unresolveName(
                    ev.params[1], ev.params[2]);

                var trs = mode.getContextualActions(
                    "insert", unresolved, tree_caret[0], tree_caret[1]);
                if (trs === undefined)
                    return;

                for(var tr_ix = 0, tr; (tr = trs[tr_ix]) !== undefined;
                    ++tr_ix) {
                    var data = {element_name: unresolved,
                               move_caret_to: tree_caret};
                    var icon = tr.getIcon();
                    var $a = $("&lt;a tabindex='-1' href='#'>" +
                               (icon ? icon + " ": "") +
                               tr.getDescriptionFor(data) +
                               (at_start ? " before this element":
                                " after this element") +
                               "&lt;/a>");
                    $a.click(data, tr.bound_handler);
                    menu_items.push($("&lt;li>&lt;/li>").append($a).get(0));
                }
            }.bind(this));

        // There's no menu to display, so let the event bubble up.
        if (menu_items === 0)
            return true;

        editor.displayContextMenu(ev.clientX, ev.clientY, menu_items);
        return false;
    }

    return true;
};


});

//  LocalWords:  sep el focusable lt enterStartTag unclick nbsp li
//  LocalWords:  tabindex listDecorator contenteditable href jQuery
//  LocalWords:  gui jqutil domlistener domutil util validator jquery
//  LocalWords:  Mangalam MPL Dubeau
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="findandself.html">findandself</a></li><li><a href="module-action.html">action</a></li><li><a href="module-decorator.html">decorator</a></li><li><a href="module-domlistener.html">domlistener</a></li><li><a href="module-domutil.html">domutil</a></li><li><a href="module-exceptions.html">exceptions</a></li><li><a href="context_menu.html">gui/context_menu</a></li><li><a href="modal.html">gui/modal</a></li><li><a href="module-gui_updater.html">gui_updater</a></li><li><a href="module-input_trigger.html">input_trigger</a></li><li><a href="module-input_trigger_factory.html">input_trigger_factory</a></li><li><a href="module-jqutil.html">jqutil</a></li><li><a href="module-key.html">key</a></li><li><a href="module-key_constants.html">key_constants</a></li><li><a href="conditioned.html">lib/conditioned</a></li><li><a href="simple_event_emitter.html">lib/simple_event_emitter</a></li><li><a href="module-log.html">log</a></li><li><a href="module-mode.html">mode</a></li><li><a href="generic.html">modes/generic/generic</a></li><li><a href="generic_decorator.html">modes/generic/generic_decorator</a></li><li><a href="generic_meta.html">modes/generic/generic_meta</a></li><li><a href="generic_tr.html">modes/generic/generic_tr</a></li><li><a href="tei_meta.html">modes/generic/metas/tei_meta</a></li><li><a href="test_decorator.html">modes/test/test_decorator</a></li><li><a href="test_mode.html">modes/test/test_mode</a></li><li><a href="module-mutation_domlistener.html">mutation_domlistener</a></li><li><a href="module-onbeforeunload.html">onbeforeunload</a></li><li><a href="module-onerror.html">onerror</a></li><li><a href="module-oop.html">oop</a></li><li><a href="module-refman.html">refman</a></li><li><a href="module-saver.html">saver</a></li><li><a href="module-transformation.html">transformation</a></li><li><a href="module-tree_updater.html">tree_updater</a></li><li><a href="module-undo.html">undo</a></li><li><a href="module-undo_recorder.html">undo_recorder</a></li><li><a href="module-updater_domlistener.html">updater_domlistener</a></li><li><a href="module-util.html">util</a></li><li><a href="module-validator.html">validator</a></li><li><a href="module-wed.html">wed</a></li><li><a href="module-wundo.html">wundo</a></li></ul><h3>Classes</h3><ul><li><a href="module-action-Action.html">Action</a></li><li><a href="module-decorator-Decorator.html">Decorator</a></li><li><a href="module-domlistener-Listener.html">Listener</a></li><li><a href="module-exceptions-AbortTransformationException.html">AbortTransformationException</a></li><li><a href="context_menu-ContextMenu.html">ContextMenu</a></li><li><a href="modal-Modal.html">Modal</a></li><li><a href="module-gui_updater-GUIUpdater.html">GUIUpdater</a></li><li><a href="module-input_trigger-InputTrigger.html">InputTrigger</a></li><li><a href="module-key-Key.html">Key</a></li><li><a href="conditioned-Conditioned.html">Conditioned</a></li><li><a href="simple_event_emitter-SimpleEventEmitter.html">SimpleEventEmitter</a></li><li><a href="module-log-Handled.html">Handled</a></li><li><a href="generic_decorator-GenericDecorator.html">GenericDecorator</a></li><li><a href="generic_meta-Meta.html">Meta</a></li><li><a href="generic_tr-Registry.html">Registry</a></li><li><a href="generic-Mode.html">Mode</a></li><li><a href="tei_meta-TeiMeta.html">TeiMeta</a></li><li><a href="test_decorator-TestDecorator.html">TestDecorator</a></li><li><a href="test_mode-TestMode.html">TestMode</a></li><li><a href="module-mode-Mode.html">Mode</a></li><li><a href="module-mutation_domlistener-Listener.html">Listener</a></li><li><a href="module-refman-ReferenceManager.html">ReferenceManager</a></li><li><a href="module-refman-SenseReferenceManager.html">SenseReferenceManager</a></li><li><a href="module-saver-Saver.html">Saver</a></li><li><a href="module-transformation-Transformation.html">Transformation</a></li><li><a href="module-transformation-TransformationRegistry.html">TransformationRegistry</a></li><li><a href="module-tree_updater-TreeUpdater.html">TreeUpdater</a></li><li><a href="module-undo_recorder-UndoRecorder.html">UndoRecorder</a></li><li><a href="module-undo-Undo.html">Undo</a></li><li><a href="module-undo-UndoGroup.html">UndoGroup</a></li><li><a href="module-undo-UndoList.html">UndoList</a></li><li><a href="module-updater_domlistener-Listener.html">Listener</a></li><li><a href="module-validator-EventIndexException.html">EventIndexException</a></li><li><a href="module-validator-Validator.html">Validator</a></li><li><a href="module-wed-Editor.html">Editor</a></li><li><a href="module-wundo-MarkerUndo.html">MarkerUndo</a></li><li><a href="module-wundo-TextUndoGroup.html">TextUndoGroup</a></li><li><a href="module-wundo-UndoGroup.html">UndoGroup</a></li></ul><h3>Events</h3><ul><li><a href="module-action-Action.html#event:disabled">disabled</a></li><li><a href="module-action-Action.html#event:enabled">enabled</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:deleteNode">deleteNode</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:insertNodeAt">insertNodeAt</a></li><li><a href="module-gui_updater-GUIUpdater.html#event:setTextNodeValue">setTextNodeValue</a></li><li><a href="module-transformation-Transformation.html#event:disabled">disabled</a></li><li><a href="module-transformation-Transformation.html#event:enabled">enabled</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:deleteNode">deleteNode</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:insertNodeAt">insertNodeAt</a></li><li><a href="module-tree_updater-TreeUpdater.html#event:setTextNodeValue">setTextNodeValue</a></li><li><a href="module-validator-Validator.html#event:error">error</a></li><li><a href="module-validator-Validator.html#event:reset-errors">reset-errors</a></li><li><a href="module-validator-Validator.html#event:state-update">state-update</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Wed Nov 13 2013 14:29:37 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
