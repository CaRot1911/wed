/**
 * @module log
 * @desc Logging facilities
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module oop
 * @desc Object-oriented programming utilities.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module lib/simple_event_emitter
 * @desc A mixin class for objects that can emit events.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module saver
 * @desc Data saving functionality.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module name_resolver
 * @desc Implements a name resolver for handling namespace changes in XML.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module util
 * @desc A mock implementation of Node's util package. This module
 * implements only what is actually used in salve.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module oop
 * @desc OOP utilities
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module hashstructs
 * @desc {@link module:hashstructs~HashSet HashSet} and {@link
 * module:hashstructs~HashMap HashMap} implementations.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module set
 * @desc Naive set implementation.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module patterns
 * @desc Classes that model RNG patterns.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module formats
 * @desc This module contains data and utilities to work with the
 * schema format that salve uses natively.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module validate
 * @desc RNG-based validator.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module util
 * @desc Various utilities for wed.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module domutil
 * @desc Utilities that manipulate or query the DOM tree.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module dloc
 * @desc Model for DOM locations.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module validator
 * @desc This module is responsible for validating the document being
 * edited in wed.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * A jQuery plugin. Works like <code>find</code>, except that if
 * the starting context node matches, it is added to the set of
 * results.
 * @function external:jQuery.findandself
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module domlistener
 * @desc Abstract base class for classes that raise events when a DOM
 * tree is modified.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module mutation_domlistener
 * @desc Facility to listen to changes to a DOM tree.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module updater_domlistener
 * @desc Facility to listen to changes to a DOM tree.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module refman
 * @desc Basic reference manager functions.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module action
 * @desc Editing actions.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module transformation
 * @desc Transformation framework.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module undo
 * @desc Basic undo/redo framework.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module wundo
 * @desc Wed-specific undo functionality.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module jqutil
 * @desc Utilities for use with jQuery.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module tree_updater
 * @desc Facility for updating a DOM tree and issue synchronous events
 * on changes.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module gui_updater
 * @desc Listens to changes on a tree and updates the GUI tree in
 * response to changes.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module undo_recorder
 * @desc Listens to changes on a tree and records undo operations
 * corresponding to these changes.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module key
 * @desc Module implementing an class that describes keyboard keys.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module key_constants
 * @desc Keys that wed uses, as constants.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module lib/conditioned
 * @desc A mixin class for objects that have conditions.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module gui/modal
 * @desc Modal dialog boxes.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module gui/context_menu
 * @desc Context menus.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module exceptions
 * @desc Exceptions for wed.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module onerror
 * @desc The onerror handler for wed.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module object_check
 * @desc Checks whether an object conforms to a template.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module onbeforeunload
 * @desc The onbeforeunload handler for wed.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module wed
 * @desc The main module for wed.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module mode
 * @desc The base class for modes.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
  * @module decorator
  * @desc Basic decoration facilities.
  * @author Louis-Dominique Dubeau
  * @license MPL 2.0
  * @copyright 2013 Mangalam Research Center for Buddhist Languages
  */

/**
 * @module modes/generic/generic_decorator
 * @desc Decorator for the generic mode.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module modes/generic/generic_tr
 * @desc Transformation registry for the generic mode.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module modes/generic/generic
 * @desc The main module for the generic mode.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

/**
 * @module modes/generic/generic_meta
 * @desc Meta-information regarding the schema.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright 2013 Mangalam Research Center for Buddhist Languages
 */

define("wed/log",["require","exports","module","log4javascript"],function(e,t,n){function a(){u.show()}function f(e){this.original=e}function l(e){return e instanceof f?e:(o.fatal("Unhandled exception",e),new f(e))}function c(e){throw l(e)}function h(e){return function(){try{return e.apply(this,arguments)}catch(t){c(t)}return undefined}}function p(e,t){var n=new i.AjaxAppender(e);n.setThreshold(i.Level.ALL);var r=new i.XmlLayout;n.setLayout(r),t&&Object.keys(t).forEach(function(e){n.addHeader(e,t[e])}),s.addAppender(n),o.info("Ajax appender initialized")}var r=n.config(),i=e("log4javascript");i.setShowStackTraces(!0);var s=i.getLogger("wed");s.setLevel(i.Level.ALL);var o=i.getLogger("wed.common");o.setLevel(i.Level.ALL);var u=new i.PopUpAppender(!0);u.setThreshold(i.Level.ERROR),u.setFocusPopUp(r&&r.focus_popup),u.setInitiallyMinimized(!0),u.setNewestMessageAtTop(!0),o.addAppender(u),t.trace=o.trace.bind(o),t.debug=o.debug.bind(o),t.info=o.info.bind(o),t.warn=o.warn.bind(o),t.error=o.error.bind(o),t.fatal=o.fatal.bind(o),t.showPopup=a,t.unhandled=l,t.handle=c,t.wrap=h,t.addURL=p}),define("wed/oop",["require","exports","module"],function(e,t,n){function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e}function i(e,t){var n=t.prototype!==undefined?t.prototype:t;for(var r in n)e.prototype[r]=n[r]}t.inherit=r,t.implement=i}),define("wed/lib/simple_event_emitter",["require","exports","module"],function(e,t,n){function r(){this._event_listeners={},this._simple_event_emitter_trace=!1}r.prototype.addEventListener=function(e,t){var n=this._event_listeners[e];n===undefined&&(n=this._event_listeners[e]=[]),n.push(t)},r.prototype.addOneTimeEventListener=function(e,t){var n=function(r){return this.removeEventListener(e,n),t(r)}.bind(this);return this.addEventListener(e,n),n},r.prototype.removeEventListener=function(e,t){var n=this._event_listeners[e];if(n===undefined)return;var r=n.lastIndexOf(t);r!==-1&&n.splice(r,1)},r.prototype.removeAllListeners=function(e){this._event_listeners[e]=[]},r.prototype._emit=function(e,t){this._simple_event_emitter_trace&&console.log("simple_event_emitter emitting:",e,"with:",t);var n,r,i=this._event_listeners["*"];if(i&&i.length>0){i=i.slice();for(n=0;n<i.length;++n){r=i[n](e,t);if(r===!1)return}}i=this._event_listeners[e];if(i&&i.length>0){i=i.slice();for(n=0;n<i.length;++n){r=i[n](t);if(r===!1)return}}},t.SimpleEventEmitter=r}),define("wed/saver",["require","exports","module","jquery","./log","./oop","./lib/simple_event_emitter","jquery.bootstrap-growl"],function(e,t,n){function u(e,t,n,r,i){o.call(this),this._url=e,this._headers=t,this._version=n,this._data_updater=r,this._data_tree=i,this._initialized=!1,this._failed=undefined,this._post({command:"check",version:n},function(e){this._initialized=!0,this._failed=!1}.bind(this),"json").fail(this._failure_wrapper(function(){throw new Error(e+" is not responding; saving is not possible.")}.bind(this)))}function a(e){var t=e.messages;if(!t||!t.length)return undefined;var n={};for(var r=0,i;(i=t[r])!==undefined;++r){var s=i.type;if(n[s]!==undefined)throw new Error("same type of message appearing more than once in one transaction");n[s]=i}return n}var r=e("jquery"),i=e("./log"),s=e("./oop"),o=e("./lib/simple_event_emitter").SimpleEventEmitter;e("jquery.bootstrap-growl"),s.implement(u,o),u.prototype._failure_wrapper=function(e){return function(){try{return e.apply(undefined,arguments)}catch(t){throw this._failed=!0,t}}.bind(this)},u.prototype.save=function(){function e(e){try{var t=a(e);if(!t)throw new Error("The server accepted the save request but did not return any information regarding whether the save was successful or not.");if(t.save_fatal_error)throw new Error("The server was not able to save the data due to a fatal error. Please contact technical support before trying to edit again.");if(t.save_transient_error){this._emit("failed",t.save_transient_error);return}if(!t.save_successful)throw new Error("Unexpected response from the server while saving. Please contact technical support before trying to edit again.");this._emit("saved")}catch(n){throw this._failed=!0,n}}if(!this._initialized)return;this._post({command:"save",version:this._version,data:this._data_tree.innerHTML},this._failure_wrapper(e.bind(this)),"json").fail(this._failure_wrapper(function(){throw new Error(this._url+" is not responding; save did not work.")}.bind(this)))},u.prototype.recover=function(e){function t(t){var n=a(t);if(!n){e(!1);return}if(n.save_fatal_error){e(!1);return}if(!n.save_successful){e(!1);return}e(!0)}if(!this._initialized||this._failed){e(undefined);return}this._post({command:"recover",version:this._version,data:this._data_tree.innerHTML},t,"json").fail(e.bind(undefined,!1))},u.prototype._post=function(e,t,n){return r.ajax({type:"POST",url:this._url,data:e,success:t,dataType:n,headers:this._headers})},t.Saver=u}),define("salve/name_resolver",["require","exports","module","./validate"],function(e,t,n){function s(){this._context_stack=[],this.enterContext(),this.definePrefix("xml",i)}var r=e("./validate"),i="http://www.w3.org/XML/1998/namespace";s.prototype.clone=function(){var e=new s;return e._context_stack=this._context_stack.slice(),e},s.prototype.definePrefix=function(e,t){this._context_stack[0].forward[e]=t;var n=this._context_stack[0].backwards[t];n===undefined&&(n=this._context_stack[0].backwards[t]=[]),e===""?n.unshift(""):n.push(e)},s.prototype.enterContext=function(){this._context_stack.unshift(Object.create(null)),this._context_stack[0].forward=Object.create(null),this._context_stack[0].backwards=Object.create(null)},s.prototype.leaveContext=function(){if(!(this._context_stack.length>1))throw new Error("trying to leave the default context");this._context_stack.shift()},s.prototype.resolveName=function(e,t){t===undefined&&(t=!1);var n=e.split(":");if(n.length==1){if(t)return new r.EName("",e);n=["",e]}if(n.length>2)throw new Error("invalid name passed to resolveName");var i;for(var s=0,o;i===undefined&&(o=this._context_stack[s])!==undefined;++s)i=o.forward[n[0]];return i===undefined?n[0]===""?new r.EName("",n[1]):undefined:new r.EName(i,n[1])},s.prototype.unresolveName=function(e,t){if(e==="")return t;var n;for(var r=0,i;n===undefined&&(i=this._context_stack[r])!==undefined;++r)n=i.backwards[e];if(n===undefined)return undefined;var s=n[0];return s!==""?s+":"+t:t},s.prototype.prefixFromURI=function(e){var t;for(var n=0,r;t===undefined&&(r=this._context_stack[n])!==undefined;++n)t=r.backwards[e];if(t===undefined)return undefined;var i=t[0];return i},t.NameResolver=s,t.XML1_NAMESPACE=i}),define("salve/util",["require","exports","module"],function(e,t,n){return{inspect:function(e){return e}}}),define("salve/oop",["require","exports","module"],function(e,t,n){function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e}function i(e,t){for(var n in t.prototype)e.prototype[n]=t.prototype[n]}t.inherit=r,t.implement=i}),define("salve/hashstructs",["require","exports","module","./oop"],function(e,t,n){function i(e,t){this.hash_f=e,this.backing=Object.create(null),this._size=0;if(t!==undefined)if(t instanceof i){var n=this.backing,r=t.backing,s=Object.keys(r);for(var o=0,u;(u=s[o++])!==undefined;)n[u]=r[u];this._size=s.length}else if(t instanceof Array)for(var a=0;a<t.length;++a)this.add(t[a]);else this.add(t)}function s(){i.apply(this,arguments)}function o(e,t){if(t instanceof Array)throw new Error("cannot initialize a map with an array");i.apply(this,arguments)}var r=e("./oop").inherit;i.prototype.hash_f=undefined,i.prototype.backing=undefined,i.prototype._size=0,i.prototype._store=function(e,t){if(e===undefined||e===null)throw new Error("undefined or null hash");this.backing[e]===undefined&&(this.backing[e]=t,this._size++)},i.prototype.union=function(e){if(e===null||e===undefined)return;if(!(e instanceof this.constructor))throw new Error("union invalid class object; my class "+this.constructor.name+" other class "+e.constructor.name);var t=e.backing,n=Object.keys(t);for(var r=0,i;(i=n[r++])!==undefined;)this._store(i,t[i])},i.prototype.forEach=function(e){var t=this.backing,n=Object.keys(t);for(var r=0,i;(i=n[r++])!==undefined;)e(t[i])},i.prototype.size=function(){return this._size},i.prototype.filter=function(e){var t=new this.constructor;t.hash_f===undefined&&(t.hash_f=this.hash_f);var n=this.backing,r=Object.keys(n);for(var i=0,s;(s=r[i++])!==undefined;){var o=n[s],u=o instanceof Array?o:[o];e.apply(undefined,u)&&t._store(s,o)}return t},i.prototype.has=function(e){var t=this.hash_f(e);return this.backing[t]},i.prototype.toString=function(){return this.toArray().join(", ")},i.prototype.toArray=function(){var e=[],t=this.backing,n=Object.keys(t);for(var r=0,i;(i=n[r++])!==undefined;)e.push(t[i]);return e},r(s,i),s.prototype.add=function(e){this._store(this.hash_f(e),e)},r(o,i),o.prototype.add=function(e,t){this._store(this.hash_f(e),[e,t])},o.prototype.forEach=function(e){var t=this.backing,n=Object.keys(t);for(var r=0,i;(i=n[r++])!==undefined;)e(t[i][0],t[i][1])},o.prototype.has=function(e){var t=this.hash_f(e),n=this.backing[t];if(n!==undefined)return n[1]},o.prototype.keys=function(){return Object.keys(this.backing)},t.HashSet=s,t.HashMap=o}),define("salve/set",["require","exports","module"],function(e,t,n){function r(e){if(e!==undefined)if(e instanceof r)this.b=e.b.concat([]);else if(e instanceof Array){this.b=[];for(var t=0;t<e.length;++t)this.add(e[t])}else this.b=[e];else this.b=[]}r.prototype.b=undefined,r.prototype.add=function(e){var t=this.b.indexOf(e);t<0&&this.b.push(e)},r.prototype.union=function(e){if(e===null||e===undefined)return;if(!(e instanceof r))throw new Error("union with non-Set");var t=e.b.length;for(var n=0;n<t;++n)this.add(e.b[n])},r.prototype.filter=function(e){var t=new this.constructor;return t.b=this.b.filter(e),t},r.prototype.map=function(e){var t=new this.constructor;for(var n=0;n<this.b.length;++n){var r=e(this.b[n]);r!==undefined&&t.add(r)}return t},r.prototype.forEach=function(e){this.b.forEach(e)},r.prototype.toString=function(){return this.b.join(", ")},r.prototype.size=function(){return this.b.length},r.prototype.has=function(e){return this.b.indexOf(e)>=0},r.prototype.toArray=function(){return this.b.slice()},t.Set=r}),define("salve/patterns",["require","exports","module","./name_resolver","./util","./hashstructs","./oop","./set"],function(e,t,n){function w(e,t){e.prototype.newWalker=function(){return new t(this)}}function E(e){function t(){return t.prototype.__singleton_instance!==undefined?t.prototype.__singleton_instance:(e.apply(this,arguments),t.prototype.__singleton_instance=this,this)}return t}function x(e,t){this.ns=e,this.name=t}function T(e){return e.hash()}function N(e){this.id=this.__newID(),this.xml_path=e}function C(e){N.call(this,e),this.pat=undefined}function k(e){N.call(this,e),this.pat_a=undefined,this.pat_b=undefined}function L(e){this.msg=e}function A(e,t){L.call(this,e),this.name=t}function O(){A.apply(this,arguments)}function M(){A.apply(this,arguments)}function _(){A.apply(this,arguments)}function D(e,t){L.call(this,""),this.names_a=e,this.names_b=t}function P(){var e=arguments[0]instanceof Array?arguments[0]:Array.prototype.slice.call(arguments),t=e.join(),n=P.__cache[t];if(n!==undefined)return n;this.id=this.__newID(),this.params=e,this.key=t,P.__cache[t]=this}function H(e){var t=function(e){return e},n=new c(t);e.forEach(function(e){var r=e;e instanceof P&&(r=e.params);var i=n;for(var s=0;s<r.length;++s)if(s==r.length-1)i.add(r[s],!1);else{var o=i.has(r[s]);o===undefined&&(o=new c(t),i.add(r[s],o)),i=o}});var r=function(){var e="",t="    ";return function(n,i){var s="",o=n.keys();return o.sort(),o.forEach(function(i){var o=n.has(i);o!==!1?(s+=e+i+":\n",e+=t,s+=r(n.has(i)),e=e.slice(t.length)):s+=e+i+"\n"}),s}}();return r(n)}function B(){this.id=this.__newID(),this.possible_cached=undefined,this.suppressed_attributes=!1}function j(){throw new Error("not meant to be called")}function F(){throw new Error("not meant to be called")}function q(e){B.call(this),this.possible_cached=new S}function $(e){B.call(this),this.possible_cached=new S($._text_event)}function J(e,t){N.call(this,e),this.name=t,this.resolves_to=undefined}function K(e){B.call(this),this.el=e,this.subwalker=e!==undefined?e.resolves_to.newWalker():undefined}function Q(e,t){C.call(this,e);if(t!==undefined){if(t.length!==1)throw new Error("OneOrMore needs exactly one pattern.");this.pat=t[0]}}function G(e){B.call(this),this.seen_once=!1,this.el=e,this.current_iteration=undefined,this.next_iteration=undefined}function Y(e,t){k.call(this,e);if(t!==undefined){if(t.length!=2)throw new Error("ChoiceWalker does not work with Choices that have not exactly 2 elements");this.pat_a=t[0],this.pat_b=t[1]}}function Z(e){B.call(this),this.el=e,this.chosen=!1,this.walker_a=this.walker_b=undefined,this.instantiated_walkers=!1,this.done=!1}function et(e,t){k.call(this,e);if(t!==undefined){if(t.length!=2)throw new Error("GroupWalkers walk only groups of two elements!");this.pat_a=t[0],this.pat_b=t[1]}}function tt(e){B.call(this),this.el=e,this.hit_a=!1,this.ended_a=!1,this.hit_b=!1,this.walker_a=this.walker_b=undefined}function nt(e,t,n){C.call(this,e),this.name=t;if(n!==undefined){if(n.length!==1)throw new Error("Attribute needs exactly one pattern.");this.pat=n[0]}}function rt(e){B.call(this),this.el=e,this.seen_name=!1,this.seen_value=!1,e!==undefined?(this.attr_name_event=new P("attributeName",e.name.ns,e.name.name),this.attr_value_event=new P("attributeValue","*")):this.attr_name_event=this.attr_value_event=undefined}function it(e,t,n){C.call(this,e),this.name=t;if(n!==undefined){if(n.length!==1)throw new Error("Element requires exactly one pattern.");this.pat=n[0]}this.attr_pat=undefined,this.attr_pat_valid=!1}function st(e){B.call(this),this.el=e,this.seen_name=!1,this.ended_start_tag=!1,this.closed=!1,this.walker=undefined,this.captured_attr_events=[],e!==undefined?(this.start_tag_event=new P("enterStartTag",e.name.ns,e.name.name),this.end_tag_event=new P("endTag",this.el.name.ns,this.el.name.name)):this.start_tag_event=this.end_tag_event=undefined}function ot(e){B.call(this),this.el=e,this.possible_cached=new S}function ut(e,t,n){C.call(this,e),this.name=t;if(n!==undefined){if(n.length!==1)throw new Error("Define needs exactly one pattern.");this.pat=n[0]}this.attr_pat=undefined,this.attr_pat_valid=!1}function at(e){B.call(this),this.el=e,this.subwalker=e!==undefined?e.pat.newWalker():undefined}function ft(e){this.references=e}function lt(e,t,n){this.xml_path=e,this.start=t,this.definitions=[],this.element_definitions={},this._namespaces=Object.create(null);var r=this;n.forEach(function(e){r.add(e)}),this._resolve(),this._prepare(this._namespaces)}function ct(e){B.call(this),this.el=e,this.subwalker=e!==undefined?e.start.newWalker():undefined,this._foreign_stack=[],this._swallow_attribute_value=!1,this._name_resolver=undefined}var r=e("./name_resolver"),i=e("./util"),s=e("./hashstructs"),o=e("./oop"),u=e("./set").Set,a=o.inherit,f=o.implement,l=s.HashSet,c=s.HashMap,h=!1;if(h){var p=function(e){console.log(e)},d=function(){p((new Error).stack)},v,m,g,y;(function(){var e="",t=" ",n=function(e){return e!==undefined?e.name!==undefined?" named "+e.name.toString():" with path "+e.xml_path:""};y=function(t,r,i){p(e+t+r+" on class "+i.constructor.name+" id "+i.id+(i.el!==undefined?n(i.el):n(i)))},v=function(n,r,s){e+=t,y("calling ",r,this);var o=n.apply(this,s);return y("called ",r,this),p(e+"return from the call: "+i.inspect(o)),e=e.slice(t.length),o},m=function(n,r,s){e+=t,y("calling ",r,this),p(e+i.inspect(s[0]));var o=n.apply(this,s);return y("called ",r,this),o!==!1&&p(e+"return from the call: "+i.inspect(o)),e=e.slice(t.length),o},g=function(n,r,i){e+=t,y("calling ",r,this);var s=n.apply(this,i);return y("called ",r,this),e=e.slice(t.length),s}})();var b=function(e,t,n){var r="___"+t;e[r]=e[t],e[t]=function(){return n.call(this,e[r],t,arguments)}}}var S=u;x.prototype.toString=function(){return"{"+this.ns+"}"+this.name},x.prototype.equal=function(e){return this.ns===e.ns&&this.name===e.name},a(N,Object),N.__id=0,N.prototype.__newID=function(){return N.__id++},N.prototype.hash=function(){return this.id},N.prototype._resolve=function(e){return new u},N.prototype._prepare=function(e){},N.prototype.newWalker=function(){throw new Error("must define newWalker method")},N.prototype.clone=function(){return this._clone(new c(T))},N.prototype._clone=function(e){var t=e.has(this);return t!==undefined?t:(t=new this.constructor,e.add(this,t),this._copyInto(t,e),t)},N.prototype._copyInto=function(e,t){e.xml_path=this.xml_path},N.prototype._keepAttrs=function(){return undefined},N.prototype._cleanAttrs=function(){return undefined},N.prototype._elementDefinitions=function(e){},a(C,N),C.prototype._resolve=function(e){return new u(this.pat._resolve(e))},C.prototype._copyInto=function(e,t){N.prototype._copyInto.call(this,e,t),e.pat=this.pat._clone(t)},C.prototype._prepare=function(e){this.pat._prepare(e)},C.prototype._keepAttrs=function(){var e=[],t=this.pat._keepAttrs();return t!==undefined?(this.pat=t,this):undefined},C.prototype._cleanAttrs=function(){var e=!1,t=this.pat._cleanAttrs();return t!==undefined?t[0]instanceof I?undefined:(this.pat=t[0],e=t[1],[this,e]):undefined},C.prototype._elementDefinitions=function(e){this.pat._elementDefinitions(e)},a(k,N),k.prototype._resolve=function(e){var t=this.pat_a._resolve(e);return t.union(this.pat_b._resolve(e)),t},k.prototype._copyInto=function(e,t){N.prototype._copyInto.call(this,e,t),e.pat_a=this.pat_a._clone(t),e.pat_b=this.pat_b._clone(t)},k.prototype._prepare=function(e){this.pat_a._prepare(e),this.pat_b._prepare(e)},k.prototype._keepAttrs=function(){var e=[],t=this.pat_a._keepAttrs();return t!==undefined&&e.push(t),t=this.pat_b._keepAttrs(),t!==undefined&&e.push(t),e.length>0?(this.pats=e,this):undefined},k.prototype._cleanAttrsFromPat=function(){var e=!1,t=[],n=this.pat_a._cleanAttrs();return n!==undefined&&(t.push(n[0]),e=n[1]),n=this.pat_b._cleanAttrs(),n!==undefined&&(t.push(n[0]),e=e||n[1]),t.length===0?undefined:[t,e]},k.prototype._cleanAttrs=function(){var e=this._cleanAttrsFromPat();if(e===undefined)return undefined;var t=e[0];return t.length==1&&t[0]instanceof I?undefined:(this.pat_a=t[0],this.pat_b=t[1],[this,e[1]])},k.prototype._elementDefinitions=function(e){this.pat_a._elementDefinitions(e),this.pat_b._elementDefinitions(e)},L.prototype.toString=function(){return this.msg},L.prototype.getNames=function(){return[]},L.prototype.toStringWithNames=function(e){return this.msg},a(A,L),A.prototype.toString=function(){return this.toStringWithNames([this.name])},A.prototype.getNames=function(){return[this.name]},A.prototype.toStringWithNames=function(e){return this.msg+": "+e[0]},a(O,A),a(M,A),a(_,A),a(D,L),D.prototype.toString=function(){return this.toStringWithNames(this.names_a.concat(this.names_b))},D.prototype.getNames=function(){return this.names_a.concat(this.names_b)},D.prototype.toStringWithNames=function(e){var t=e.slice(0,this.names_a.length),n=e.slice(this.names_a.length);return"must choose either "+t.join(", ")+" or "+n.join(", ")},P.__cache={},P.__id=0,P.prototype.__newID=function(){return P.__id++},P.prototype.hash=function(){return this.id},P.prototype.matchingEvents=function(){return this.params[0]==="attributeValue"?[this,new P("attributeValue","*")]:[this]},P.prototype.isAttributeEvent=function(){return this.params[0]=="attributeName"||this.params[0]=="attributeValue"},P.prototype.toString=function(){return"Event: "+this.params.join(", ")},B.__id=0,B.prototype.__newID=function(){return B.__id++},B.prototype.hash=function(){return this.id},B.prototype.possible=function(){return new S(this._possible())},B.prototype._possible=function(){throw new Error("must be implemented by derived classes")},B.prototype.fireEvent=function(e){throw new Error("must be implemented by derived classes")},B.prototype.canEnd=function(){return!0},B.prototype.end=function(){return!1},B.prototype.clone=function(){return this._clone(new c(T))},B.prototype._clone=function(e){var t=e.has(this);return t!==undefined?t:(t=new this.constructor,e.add(this,t),this._copyInto(t,e),t)},B.prototype._copyInto=function(e,t){e.possible_cached=this.possible_cached,e.suppressed_attributes=this.suppressed_attributes},B.prototype._suppressAttributes=function(){throw new Error("must be implemented by derived classes")},j.prototype._possible=function(e){return this.subwalker.possible()},j.prototype.fireEvent=function(e){return this.subwalker.fireEvent(e)},j.prototype._suppressAttributes=function(){this.suppressed_attributes||(this.suppressed_attributes=!0,this.subwalker._suppressAttributes())},j.prototype.canEnd=function(){return this.subwalker.canEnd()},j.prototype.end=function(){return this.subwalker.end()},F.prototype._suppressAttributes=function(){this.suppressed_attributes=!0},F.prototype.canEnd=function(){return!0},F.prototype.end=function(){return!1};var I=E(N);a(I,N),I.prototype._keepAttrs=function(){return this},I.prototype._cleanAttrs=function(){return[this,!1]},w(I,q),a(q,B),f(q,F),q.prototype.possible=function(){return new S},q.prototype._possible=function(){return this.possible_cached},q.prototype.fireEvent=function(){return undefined};var R=E(N);a(R,N),w(R,$);var U=E(N);a(U,N),w(U,$);var z=E(N);a(z,N),w(z,$);var W=E(N);a(W,N),w(W,$);var X=E(N);a(X,N);var V=E(N);a(V,N),w(V,$),a($,B),f($,F),$._text_event=new P("text"),$.prototype._possible=function(){return this.possible_cached},$.prototype.fireEvent=function(e){return e.params.length===1&&e.params[0]=="text"?!1:undefined},a(J,N),J.prototype._prepare=function(){return},J.prototype._copyInto=function(e,t){N.prototype._copyInto.call(this,e,t),e.name=this.name,e.resolves_to=this.resolves_to},J.prototype._resolve=function(e){return this.resolves_to=e[this.name],this.resolves_to===undefined?new u(this):new u},J.prototype.newWalker=function(){return this.resolves_to.pat.newWalker()},a(K,B),f(K,j),K.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.subwalker=this.subwalker._clone(t)},a(Q,C),w(Q,G),Q.prototype._cleanAttrs=function(){return[this.pat,!0]},a(G,B),G.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.seen_once=this.seen_once,e.el=this.el,e.current_iteration=this.current_iteration!==undefined?this.current_iteration._clone(t):undefined,e.next_iteration=this.next_iteration!==undefined?this.next_iteration._clone(t):undefined},G.prototype._possible=function(){if(this.possible_cached!==undefined)return this.possible_cached;this.current_iteration===undefined&&(this.current_iteration=this.el.pat.newWalker()),this.possible_cached=this.current_iteration._possible();if(this.current_iteration.canEnd()){this.possible_cached=new S(this.possible_cached),this.next_iteration===undefined&&(this.next_iteration=this.el.pat.newWalker());var e=this.next_iteration._possible();this.possible_cached.union(e)}return this.possible_cached},G.prototype.fireEvent=function(e){this.possible_cached=undefined,this.current_iteration===undefined&&(this.current_iteration=this.el.pat.newWalker());var t=this.current_iteration.fireEvent(e);t===!1&&(this.seen_once=!0);if(t!==undefined)return t;if(this.seen_once&&this.current_iteration.canEnd()){t=this.current_iteration.end();if(t)throw new Error("internal error; canEnd() returns true but end() fails");this.next_iteration===undefined&&(this.next_iteration=this.el.pat.newWalker());var n=this.next_iteration.fireEvent(e);return n===!1&&(this.current_iteration=this.next_iteration,this.next_iteration=undefined),n}return undefined},G.prototype._suppressAttributes=function(){},G.prototype.canEnd=function(){return this.seen_once&&this.current_iteration.canEnd()},G.prototype.end=function(){return this.current_iteration===undefined&&(this.current_iteration=this.el.pat.newWalker()),this.next_iteration=undefined,this.current_iteration.end()},a(Y,k),w(Y,Z),Y.prototype._cleanAttrs=function(){var e=this._cleanAttrsFromPat();if(e===undefined)return undefined;var t=e[0];return t.length===1?t[0]instanceof I?undefined:[new Y(this.xml_path+" %CLEAN ATTRS%",[t[0],new I]),!0]:(this.pat_a=t[0],this.pat_b=t[1],[this,e[1]])},a(Z,B),Z.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.chosen=this.chosen,e.walker_a=this.walker_a!==undefined?this.walker_a._clone(t):undefined,e.walker_b=this.walker_b!==undefined?this.walker_b._clone(t):undefined,e.instantiated_walkers=this.instantiated_walkers,e.done=this.done},Z.prototype._instantiateWalkers=function(){this.instantiated_walkers||(this.instantiated_walkers=!0,this.walker_a=this.el.pat_a.newWalker(),this.walker_b=this.el.pat_b.newWalker())},Z.prototype._possible=function(){this._instantiateWalkers();if(this.possible_cached!==undefined)return this.possible_cached;this.possible_cached=this.walker_a!==undefined?this.walker_a._possible():undefined;if(this.walker_b!==undefined){this.possible_cached=new S(this.possible_cached);var e=this.walker_b._possible();this.possible_cached.union(e)}else this.possible_cached===undefined&&(this.possible_cached=new S);return this.possible_cached},Z.prototype.fireEvent=function(e){if(this.done)return undefined;this._instantiateWalkers(),this.possible_cached=undefined;var t=this.walker_a!==undefined?this.walker_a.fireEvent(e):undefined,n=this.walker_b!==undefined?this.walker_b.fireEvent(e):undefined;return t!==undefined?(this.chosen=!0,n===undefined?(this.walker_b=undefined,t):t):n!==undefined?(this.chosen=!0,this.walker_a=undefined,n):undefined},Z.prototype._suppressAttributes=function(){this._instantiateWalkers(),this.suppressed_attributes||(this.possible_cached=undefined,this.suppressed_attributes=!0,this.walker_a!==undefined&&this.walker_a._suppressAttributes(),this.walker_b!==undefined&&this.walker_b._suppressAttributes())},Z.prototype.canEnd=function(){this._instantiateWalkers();var e=this.walker_a!==undefined?this.walker_a.canEnd():!0,t=this.walker_b!==undefined?this.walker_b.canEnd():!0;return this.chosen?e&&t:e||t},Z.prototype.end=function(){this.done=!0,this._instantiateWalkers();if(this.canEnd())return!1;var e=this.walker_a!==undefined?this.walker_a.end():!1,t=this.walker_b!==undefined?this.walker_b.end():!1;if(!e&&!t)return!1;if(e&&!t)return e;if(!e&&t)return t;var n=[],r=[],i=!1;this.walker_a.possible().forEach(function(e){e.params[0]==="enterStartTag"?n.push(new x(e.params[1],e.params[2])):i=!0});if(!i){this.walker_b.possible().forEach(function(e){e.params[0]==="enterStartTag"?r.push(new x(e.params[1],e.params[2])):i=!0});if(!i)return[new D(n,r)]}return e||t},a(et,k),w(et,tt),et.prototype._cleanAttrs=function(){var e=this._cleanAttrsFromPat();if(e===undefined)return undefined;var t=e[0];return t.length===1?t[0]instanceof I?undefined:[t[0],!0]:(this.pat_a=t[0],this.pat_b=t[1],[this,e[1]])},a(tt,B),tt.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.hit_a=this.hit_a,e.ended_a=this.ended_a,e.hit_b=this.hit_b,e.walker_a=this.walker_a!==undefined?this.walker_a._clone(t):undefined,e.walker_b=this.walker_b!==undefined?this.walker_b._clone(t):undefined},tt.prototype._instantiateWalkers=function(){this.walker_a===undefined&&(this.walker_a=this.el.pat_a.newWalker(),this.walker_b=this.el.pat_b.newWalker())},tt.prototype._possible=function(){this._instantiateWalkers();if(this.possible_cached!==undefined)return this.possible_cached;this.possible_cached=this.ended_a?undefined:this.walker_a._possible();if(this.suppressed_attributes){if(this.ended_a||this.walker_a.canEnd())this.possible_cached=new S(this.possible_cached),this.possible_cached.union(this.walker_b._possible())}else{var e=this.walker_b._possible();(!this.ended_a||this.hit_b)&&!this.walker_a.canEnd()&&(e=e.filter(function(e){return e.isAttributeEvent()})),this.possible_cached=new S(this.possible_cached),this.possible_cached.union(e)}return this.possible_cached},tt.prototype.fireEvent=function(e){this._instantiateWalkers(),this.possible_cached=undefined;if(!this.ended_a){var t=this.walker_a.fireEvent(e);if(t!==undefined)return this.hit_a=!0,t;if(!e.isAttributeEvent()&&!this.walker_a.canEnd())return undefined}var n=this.walker_b.fireEvent(e);n!==undefined&&(this.hit_b=!0);if(!e.isAttributeEvent()&&n!==undefined&&!this.ended_a){var r=this.walker_a.end();this.ended_a=!0,n?r&&(n=n.concat(r)):n=r}return n},tt.prototype._suppressAttributes=function(){this._instantiateWalkers(),this.suppressed_attributes||(this.possible_cached=undefined,this.suppressed_attributes=!0,this.walker_a._suppressAttributes(),this.walker_b._suppressAttributes())},tt.prototype.canEnd=function(){return this._instantiateWalkers(),this.walker_a.canEnd()&&this.walker_b.canEnd()},tt.prototype.end=function(){this._instantiateWalkers();var e;if(!this.ended_a){e=this.walker_a.end();if(e)return e}return e=this.walker_b.end(),e?e:!1},a(nt,C),w(nt,rt),nt.prototype._copyInto=function(e,t){N.prototype._copyInto.call(this,e,t),e.name=this.name},nt.prototype._prepare=function(e){this.name.ns!==""&&(e[this.name.ns]=1)},nt.prototype._keepAttrs=function(){return this},nt.prototype._cleanAttrs=function(){return[this,!1]},a(rt,B),rt.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.seen_name=this.seen_name,e.seen_value=this.seen_value,e.attr_name_event=this.attr_name_event,e.attr_value_event=this.attr_value_event},rt.prototype._possible=function(){return this.suppressed_attributes?new S:this.seen_name?this.seen_value?new S:new S(this.attr_value_event):new S(this.attr_name_event)},rt.prototype.possible=rt.prototype._possible,rt.prototype.fireEvent=function(e){if(this.suppressed_attributes)return undefined;if(this.seen_name){if(!this.seen_value&&e.params[0]=="attributeValue")return this.seen_value=!0,!1}else if(e.params[0]=="attributeName"&&e.params[1]==this.el.name.ns&&e.params[2]==this.el.name.name)return this.seen_name=!0,!1;return undefined},rt.prototype._suppressAttributes=function(){this.suppressed_attributes=!0},rt.prototype.canEnd=function(){return this.suppressed_attributes||this.seen_value},rt.prototype.end=function(){return this.suppressed_attributes?!1:this.seen_name?this.seen_value?!1:[new M("attribute value missing",this.el.name)]:[new O("attribute missing",this.el.name)]},a(it,C),it.prototype._copyInto=function(e,t){C.prototype._copyInto.call(this,e,t),e.name=this.name,e.attr_pat=this.attr_pat,e.attr_pat_valid=this.attr_pat_valid},it.prototype._prepare=function(e){e[this.name.ns]=1;if(!this.attr_pat_valid){this.pat._prepare(e);var t=this.pat.clone()._keepAttrs();if(t!==undefined){var n=this,r=[undefined,!0];while(r&&r[1])r=t._cleanAttrs(),t=r&&r[0];n.attr_pat=t}this.attr_pat_valid=!0}},it.prototype.newWalker=function(){return this.pat instanceof X?new ot(this):new st(this)},it.prototype._keepAttrs=function(){return undefined},it.prototype._elementDefinitions=function(e){var t=this.name.toString();e[t]===undefined?e[t]=[this]:e[t].push(this)},a(st,B),st._leaveStartTag_event=new P("leaveStartTag"),st.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.seen_name=this.seen_name,e.ended_start_tag=this.ended_start_tag,e.closed=this.closed,e.walker=this.walker!==undefined?this.walker._clone(t):undefined,e.captured_attr_events=this.captured_attr_events.concat([]),e.start_tag_event=this.start_tag_event,e.end_tag_event=this.end_tag_event},st.prototype._possible=function(){if(!this.seen_name)return new S(this.start_tag_event);if(!this.ended_start_tag){if(this.el.attr_pat!==undefined){var e=this.walker._possible(),t=new S,n;return e.forEach(function(e){e.params[0]==="attributeValue"&&(n=e),e.isAttributeEvent()&&t.add(e)}),n&&(t=new S(n)),this.walker.canEnd()&&t.add(st._leaveStartTag_event),t}return new S(st._leaveStartTag_event)}if(!this.closed){var r=new S(this.walker._possible());return this.walker.canEnd()&&r.add(this.end_tag_event),r}return new S},st.prototype.possible=st.prototype._possible,st.prototype.fireEvent=function(e){var t;if(!this.ended_start_tag){if(!this.seen_name){if(e.params[0]=="enterStartTag"&&e.params[1]==this.el.name.ns&&e.params[2]==this.el.name.name)return this.el.attr_pat!==undefined&&(this.walker=this.el.attr_pat.newWalker()),this.seen_name=!0,!1}else if(e.params[0]=="leaveStartTag"){this.ended_start_tag=!0,this.walker!==undefined&&(t=this.walker.end()),this.walker=this.el.pat.newWalker();var n=this;return this.captured_attr_events.forEach(function(e){n.walker.fireEvent(e)}),this.walker._suppressAttributes(),t||!1}return e.isAttributeEvent()&&this.captured_attr_events.push(e),this.walker!==undefined?this.walker.fireEvent(e):undefined}if(!this.closed){t=this.walker.fireEvent(e);if(t===undefined)if(e.params[0]=="endTag"){if(e.params[1]==this.el.name.ns&&e.params[2]==this.el.name.name)return this.closed=!0,this.walker.end()}else if(e.params[0]=="leaveStartTag")return[new L("unexpected leaveStartTag event; it is likely that fireEvent is incorrectly called")];return t}return undefined},st.prototype._suppressAttributes=function(){return},st.prototype.canEnd=function(){return this.closed},st.prototype.end=function(e){var t=[];if(!this.seen_name)t.push(new _("tag required",this.el.name));else if(!this.ended_start_tag||!this.closed){if(this.walker!==undefined){var n=this.walker.end();n&&(t=n)}t.push(this.ended_start_tag?new _("tag not closed",this.el.name):new _("start tag not terminated",this.el.name))}return t.length>0?t:!1},a(ot,B),ot.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el},ot.prototype._possible=function(){return this.possible_cached},ot.prototype.fireEvent=function(e){return undefined},a(ut,C),w(ut,at),ut.prototype._copyInto=function(e,t){C.prototype._copyInto.call(this,e,t),e.name=this.name,e.attr_pat=this.attr_pat,e.attr_pat_valid=this.attr_pat_valid},ut.prototype._prepare=function(e){if(!this.attr_pat_valid){this.pat._prepare(e);var t=this.pat.clone()._keepAttrs();this.attr_pat=t,this.attr_pat_valid=!0}},a(at,B),f(at,j),at.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.subwalker=this.subwalker._clone(t)},a(ft,Error),ft.prototype.toString=function(){return"Cannot resolve the following references: "+this.references.toString()},lt.prototype.definitions=undefined,lt.prototype.start=undefined,lt.prototype._resolve=function(){var e=new u;for(var t in this.definitions)e.union(this.definitions[t]._resolve(this.definitions));e.union(this.start._resolve(this.definitions));if(e.size()>0)throw new ft(e)},lt.prototype.add=function(e){this.definitions[e.name]=e,e.name=="start"&&(this.start=e)},lt.prototype._prepare=function(e){this.start._prepare(e);for(var t in this.definitions)this.definitions[t]._prepare(e)},lt.prototype._elementDefinitions=function(e){for(var t in this.definitions)this.definitions[t]._elementDefinitions(e)},lt.prototype.whollyContextIndependent=function(){var e=this.element_definitions;this._elementDefinitions(e);for(var t in e)if(e[t].length>1)return!1;return!0},lt.prototype.getNamespaces=function(){return Object.keys(this._namespaces)},w(lt,ct),a(ct,B),f(ct,j),ct.prototype.subwalker=undefined,ct.prototype._copyInto=function(e,t){B.prototype._copyInto.call(this,e,t),e.el=this.el,e.subwalker=this.subwalker._clone(t),e._foreign_stack=this._foreign_stack.concat([]),e._swallow_attribute_value=this.swallow_attribute_value,this._name_resolver&&(e._name_resolver=this._name_resolver.clone())},ct.prototype.useNameResolver=function(){if(this._name_resolver)throw new Error("called useNameResolver twice on the same walker");this._name_resolver=new r.NameResolver},ct.prototype.resolveName=function(e,t){if(!this._name_resolver)throw new Error("resolveName needs a name resolver");return this._name_resolver.resolveName(e,t)},ct.prototype.unresolveName=function(e,t){if(!this._name_resolver)throw new Error("unresolveName needs a name resolver");return this._name_resolver.unresolveName(e,t)},ct.prototype.fireEvent=function(e){if(this._foreign_stack.length>0){switch(e.params[0]){case"enterStartTag":this._foreign_stack.unshift(e.params.slice(1));break;case"endTag":this._foreign_stack.shift()}return!1}if(this.swallow_attribute_value)return this.swallow_attribute_value=!1,e.params[0]==="attributeValue"?!1:[new L("attribute value required")];if(e.params[0]==="enterContext"||e.params[0]==="leaveContext"||e.params[0]==="definePrefix"){if(!this._name_resolver)throw new Error("event "+e.params[0]+" needs a name resolver");switch(e.params[0]){case"enterContext":this._name_resolver.enterContext();break;case"leaveContext":this._name_resolver.leaveContext();break;case"definePrefix":this._name_resolver.definePrefix(e.params[1],e.params[2])}return!1}var t=this.subwalker.fireEvent(e);if(t===undefined)switch(e.params[0]){case"enterStartTag":t=[new _("tag not allowed here",new x(e.params[1],e.params[2]))],this._foreign_stack=[e.params.slice(1)];break;case"endTag":t=[new _("unexpected end tag",new x(e.params[1],e.params[2]))];break;case"attributeName":t=[new O("attribute not allowed here",new x(e.params[1],e.params[2]))],this.swallow_attribute_value=!0;break;case"attributeValue":t=[new L("unexpected attributeValue event; it is likely that fireEvent is incorrectly called")];break;case"text":t=[new L("text not allowed here")];break;case"leaveStartTag":default:throw new Error("unexpected event type in GrammarWalker's fireEvent: "+e.params[0])}return t},ct.prototype._suppressAttributes=function(){throw new Error("_suppressAttributes cannot be called on a GrammarWalker")},t.Event=P,t.eventsToTreeString=H,t.EName=x,t.ReferenceError=ft,t.ValidationError=L,t.AttributeNameError=O,t.AttributeValueError=M,t.ElementNameError=_,t.ChoiceError=D;var ht={};ht.GrammarWalker=ct,ht.Walker=B,ht.Text=V,t.__test=function(){return ht},t.__protected={Empty:I,Data:R,List:U,Param:z,Value:W,NotAllowed:X,Text:V,Ref:J,OneOrMore:Q,Choice:Y,Group:et,Attribute:nt,Element:it,Define:ut,Grammar:lt,EName:x}}),define("salve/formats",["require","exports","module","./util","./oop","./patterns"],function(e,t,n){function f(e){for(var t=0,n;(n=e[t])!==undefined;t++)n instanceof Array?f(n):typeof n=="object"&&(e[t]=c(n))}function l(e,t){var n=Object.create(e.prototype),r=e.apply(n,t);return r!==undefined?r:n}function c(e){var t=e.type;if(t===undefined)throw new Error("object without type: "+e);var n=u[t];if(n===undefined)throw new Error("undefined type: "+t);var r=e.args;return r!==undefined&&f(r),l(n,r)}function h(e){this.options=e}function p(){h.apply(this,arguments)}function d(e){var t=JSON.parse(e);if(typeof t=="object"&&!t.v)return c(t);var n=t.v,r=t.o;if(n===1)return(new p(r)).walkObject(t.d,r);throw new Error("unknown version: "+n)}var r=e("./util"),i=e("./oop").inherit,s=e("./patterns"),o=s.__protected,u={0:Array,Empty:o.Empty,1:o.Empty,Data:o.Data,2:o.Data,List:o.List,3:o.List,Param:o.Param,4:o.Param,Value:o.Value,5:o.Value,NotAllowed:o.NotAllowed,6:o.NotAllowed,Text:o.Text,7:o.Text,Ref:o.Ref,8:o.Ref,OneOrMore:o.OneOrMore,9:o.OneOrMore,Choice:o.Choice,10:o.Choice,Group:o.Group,11:o.Group,Attribute:o.Attribute,12:o.Attribute,Element:o.Element,13:o.Element,Define:o.Define,14:o.Define,Grammar:o.Grammar,15:o.Grammar,EName:o.EName,16:o.EName},a=1;h.prototype.walkObject=function(e){if(e.length<1)throw new Error("array too small to contain object");var t=e[0];if(t===undefined)throw new Error("object without type: "+r.inspec(e));var n=u[t];if(n===undefined)throw new Error("undefined type: "+t);if(n===Array)throw new Error("trying to build array with _constructObjectV1");var i=this.options&a&&n!==o.EName,s;return e.length>1?(s=e.slice(1),i&&s.unshift(""),s.unshift(0),s=this._processArrayForCtor(s)):i?s=[""]:s=[],this._processObject(e,n,s)},h.prototype._processObject=function(e,t,n){return undefined},h.prototype._processArrayForCtor=function(e){return this._walkArray(e).slice(1)},h.prototype._processArray=function(e){return this._walkArray(e).slice(1)},h.prototype._walkArray=function(e){if(e[0]!==0)throw new Error("array type not 0, but "+e[0]+" for array "+e);var t=[0];for(var n=1,r;(r=e[n])!==undefined;n++)r instanceof Array?r[0]!==0?t.push(this.walkObject(r)):t.push(this._processArray(r)):t.push(r);return t},i(p,h),p.prototype._processObject=function(e,t,n){return l(t,n)},t.constructTree=d,t.__protected={V1JSONWalker:h,name_to_constructor:u,OPTION_NO_PATHS:a}}),define("salve/validate",["require","exports","module","./patterns","./formats"],function(e,t,n){var r=e("./patterns"),i=e("./formats");t.version="0.15.1";for(var s in r)t[s]=r[s];t.constructTree=i.constructTree}),define("wed/util",["require","exports","module"],function(e,t,n){function r(e,t){return Math.sqrt(e*e+t*t)}function i(e,t,n,i,s,o){var u=t-i,a=e-n,f=t-o,l=e-s,c=u<0,h=f>0,p=a<0,d=l>0,v=p?a:d?l:0,m=c?u:h?f:0;return r(v,m)}function s(e){return e.replace(/:/g,"\\:")}function o(e){return e.className.split(" ",1)[0]}function u(e){return e==="*"?"._real":"."+s(e)+"._real"}function a(e){return e.slice(9).replace(/---/,":").replace(/---(-+)/g,"--$1")}function f(e){return"data-wed-"+e.replace(/--(-+)/g,"---$1").replace(/:/,"---")}function c(){return"WED-ID-"+ ++l}function h(e){return e.altKey||e.ctrlKey||e.metaKey}var l=0;t.escapeCSSClass=s,t.getOriginalName=o,t.classFromOriginalName=u,t.decodeAttrName=a,t.encodeAttrName=f,t.newGenericID=c,t.anySpecialKeyHeld=h,t.distFromDeltas=r,t.distFromRect=i}),define("wed/domutil",["require","exports","module","jquery","rangy","./util"],function(e,t,n){function u(e){var t=i.getSelection(e);return t===undefined||t.rangeCount<1?undefined:t.getRangeAt(0)}function a(e,t,n,r){var s=i.createRange(e.ownerDocument),o=!1;return i.dom.comparePoints(e,t,n,r)<=0?(s.setStart(e,t),s.setEnd(n,r)):(s.setStart(n,r),s.setEnd(e,t),o=!0),{range:s,reversed:o}}function f(e){var t=e&&e.nodeType;switch(t){case Node.TEXT_NODE:e.parentNode.focus();break;case Node.ELEMENT_NODE:e.focus();break;default:throw new Error("tried to focus something other than a text node or an element.")}}function l(e,t,n){var i=e[0],s=e[1];n===undefined&&(n=!0);var u=!1;e:while(!u){var a=i.parentNode;switch(i.nodeType){case Node.TEXT_NODE:if(s>=i.nodeValue.length||a.childNodes[a.childNodes.length-1]===i&&r(a).css("white-space")==="normal"&&/^\s+$/.test(i.nodeValue.slice(s))){if(t!==undefined&&i===t)break e;s=o.call(a.childNodes,i)+1,i=a}else s++,u=!0;break;case Node.ELEMENT_NODE:if(s>=i.childNodes.length){if(a===null||a===i.ownerDocument||t!==undefined&&i===t)break e;s=o.call(a.childNodes,i)+1,i=a,u=!0}else i=i.childNodes[s],s=0,i.childNodes.length>0&&i.childNodes[s].nodeType===Node.TEXT_NODE||(u=!0)}}return u?n&&i.nodeType===Node.TEXT_NODE?[i.parentNode,o.call(i.parentNode.childNodes,i)]:[i,s]:null}function c(e,t,n){var i=e[0],s=e[1];n===undefined&&(n=!0);var u=!1;e:while(!u){s--;var a=i.parentNode;switch(i.nodeType){case Node.TEXT_NODE:if(s<0||r(i.parentNode).css("white-space")==="normal"&&a.childNodes[0]===i&&/^\s+$/.test(i.nodeValue.slice(0,s))){if(t!==undefined&&i===t)break e;s=o.call(a.childNodes,i),i=a}else u=!0;break;case Node.ELEMENT_NODE:if(s<0||i.childNodes.length===0){if(a===null||a===i.ownerDocument||t!==undefined&&i===t)break e;s=o.call(a.childNodes,i),i=a,u=!0}else i=i.childNodes[s],i.nodeType===Node.ELEMENT_NODE?(s=i.childNodes.length,i.childNodes.length>0&&i.childNodes[s-1].nodeType===Node.TEXT_NODE||(u=!0)):s=i.nodeValue.length+1}}return u?n&&i.nodeType===Node.TEXT_NODE?[i.parentNode,o.call(i.parentNode.childNodes,i)]:[i,s]:null}function h(e,t){if(e===null||e===undefined)throw new Error("invalid root parameter");if(t===null||t===undefined)throw new Error("invalid node parameter");var n=r(t);if(n.closest("._gui, ._placeholder, ._phantom").length>0)throw new Error("cannot provide path to node because it is a gui, placeholder or phantom node");if(e===t)return"";if(n.closest(e).length===0||t===e)throw new Error("node is not a descendant of root");return p(e,t)}function p(e,t){var n=r(t),i=t.parentNode,s,u=0,a,f;if(!n.is("._real, ._phantom_wrap")&&t.nodeType!==Node.TEXT_NODE)throw new Error("only nodes of class ._real and ._phantom_wrap are supported by nodeToPath");s=o.call(i.childNodes,t);for(f=0;f<s;++f)(i.childNodes[f].nodeType===Node.TEXT_NODE||i.childNodes[f].nodeType===Node.ELEMENT_NODE&&r(i.childNodes[f]).is("._real, ._phantom_wrap"))&&u++;return a=""+u,i===e?a:p(e,i)+"/"+a}function d(e,t){if(!e)return null;if(t==="")return e;var n=t.split(/\//,1),i,s;n.length===0?i=t:(i=n[0],s=t.slice(i.length+1));var o,u,a,f=null,l=/^(\d+)$/.exec(i);if(!l)throw new Error("malformed path expression");o=l[1]>>0;for(a=0;!f&&a<e.childNodes.length;a++)u=e.childNodes[a],(u.nodeType===Node.TEXT_NODE||u.nodeType===Node.ELEMENT_NODE&&r(u).is("._real, ._phantom_wrap"))&&--o<0&&(f=u);return s?d(f,s):f}function v(e){return r("<span class='_placeholder' contenteditable='true'>"+(e?e:" ")+"</span>")}function m(e,t){var n=w(e,t,undefined,!1);return[n[0][0],n[1][0]]}function g(e,t,n){if(!n)throw new Error("must pass an actual node to insert");return y.apply(this,arguments)}function y(e,t,n,r){if(e.nodeType!==Node.TEXT_NODE)throw new Error("insertIntoText called on non-text");var i,s;r===undefined&&(r=!0),t<0?t=0:t>e.nodeValue.length&&(t=e.nodeValue.length);var u,a,f,l=n&&n.nodeType===Node.DOCUMENT_FRAGMENT_NODE,c=e.parentNode,h=o.call(c.childNodes,e);if(r&&(!n||l&&n.childNodes.length===0))i=s=[e,t];else{var p=document.createDocumentFragment();a=document.createTextNode(e.nodeValue.slice(0,t)),p.appendChild(a),n&&p.appendChild(n),f=document.createTextNode(e.nodeValue.slice(t));var d=f.nodeValue.length;p.appendChild(f),r&&p.normalize(),r&&t===0?i=[c,h]:i=[p.firstChild,t],r&&t===e.nodeValue.length?s=[c,h+p.childNodes.length]:s=[p.lastChild,p.lastChild.nodeValue.length-d],this.deleteNode(e);if(this.insertFragAt)this.insertFragAt(c,h,p);else while(p.firstChild)this.insertNodeAt(c,h++,p.firstChild)}return[i,s]}function S(e,t,n){if(n==="")return[undefined,undefined];var r;e:for(;;)switch(e.nodeType){case Node.ELEMENT_NODE:var i=e.childNodes[t];if(i&&i.nodeType===Node.TEXT_NODE){e=i,t=0;continue e}var s=e.childNodes[t-1];if(s&&s.nodeType===Node.TEXT_NODE){e=s,t=e.nodeValue.length;continue e}r=document.createTextNode(""),r.nodeValue=n,this.insertNodeAt(e,t,r),e=undefined;break e;case Node.TEXT_NODE:var o=e.nodeValue.slice(0,t),u=e.nodeValue.slice(t);this.setTextNodeValue(e,o+n+u),r=e;break e;default:throw new Error("unexpected node type: "+e.nodeType)}return[e,r]}function T(e,t,n){if(e.nodeType!==Node.TEXT_NODE)throw new Error("deleteText called on non-text");e.nodeValue=e.nodeValue.slice(0,t)+e.nodeValue.slice(t+n),e.nodeValue.length===0&&e.parentNode.removeChild(e)}function N(e,t){r(e).data("wed_mirror_node",t),r(t).data("wed_mirror_node",e);if(e.nodeType===Node.ELEMENT_NODE)for(var n=0;n<e.childNodes.length;++n){var i=e.childNodes[n],s=t.childNodes[n];N(i,s)}}function C(e){r(e).removeData("wed_mirror_node");if(e.nodeType===Node.ELEMENT_NODE)for(var t=0;t<e.childNodes.length;++t)C(e.childNodes[t])}function k(e){while(e&&e.childNodes&&e.childNodes.length)e=e.childNodes[0];return e}function L(e){e.parentNode.removeChild(e)}function A(e,t,n){e.insertBefore(n,e.childNodes[t])}function O(e){var t=e.nextSibling;if(e.nodeType===Node.TEXT_NODE&&t&&t.nodeType===Node.TEXT_NODE){var n=e.nodeValue.length;return e.nodeValue+=t.nodeValue,t.parent.removeChild(t),[e,n]}var r=e.parentNode;return[r,o.call(r.childNodes,e)+1]}function M(e,t){if(!D({startContainer:e[0],startOffset:e[1],endContainer:t[0],endOffset:t[1]}))throw new Error("range is not well-formed");var n=e[0],r=e[1],i=t[0],s=t[1],u,a=n===i,f,l;if(n.nodeType===Node.TEXT_NODE){u=n.parentNode;var c=o.call(u.childNodes,n),h=a?s:n.nodeValue.length;l=u.ownerDocument.createTextNode(n.nodeValue.slice(r,h)),this.deleteText(n,r,l.nodeValue.length),f=n.parentNode?[n,r]:[u,c];if(a)return[f,[l]];r=n.parentNode?c+1:c,n=u}var p;if(i.nodeType===Node.TEXT_NODE){u=i.parentNode;var d=o.call(u.childNodes,i);p=u.ownerDocument.createTextNode(i.nodeValue.slice(0,s)),this.deleteText(i,0,s),s=d,i=u}if(n!==i)throw new Error("internal error in cut: containers unequal");if(n.nodeType!==Node.ELEMENT_NODE)throw new Error("internal error in cut: not an element");var v=[];s--;while(s>=r)v.unshift(i.childNodes[s]),this.deleteNode(i.childNodes[s]),s--;return l&&v.unshift(l),p&&v.push(p),this.mergeTextNodes(i.childNodes[s]),[f,v]}function _(e){var t;switch(e.startContainer.nodeType){case Node.TEXT_NODE:t=e.startContainer.parentNode;break;case Node.ELEMENT_NODE:t=e.startContainer;break;default:throw new Error("unexpected node type: "+e.startContainer.nodeType)}var n;switch(e.endContainer.nodeType){case Node.TEXT_NODE:n=e.endContainer.parentNode;break;case Node.ELEMENT_NODE:n=e.endContainer;break;default:throw new Error("unexpected node type: "+e.endContainer.nodeType)}return[t,n]}function D(e){var t=_(e);return t[0]===t[1]}function P(e,t){H(e,u(t))}function H(e,t){t?console.log(e,t.startContainer,t.startOffset,t.endContainer,t.endOffset):console.log(e,"no range")}function B(e,t,n){var i=r(e).offset();return t-=i.left,n-=i.top,t>=0&&n>=0&&t<e.clientWidth&&n<e.clientHeight}var r=e("jquery"),i=e("rangy"),s=e("./util"),o=Array.prototype.indexOf,b={insertNodeAt:A,insertFragAt:A,deleteNode:L},w=y.bind(b),E=g.bind(b),x=S.bind({insertNodeAt:A,setTextNodeValue:function(e,t){e.nodeValue=t}});t.getSelectionRange=u,t.nextCaretPosition=l,t.prevCaretPosition=c,t.makePlaceholder=v,t.nodeToPath=h,t.pathToNode=d,t.splitTextNode=m,t.insertIntoText=E,t.insertText=x,t.deleteText=T,t.linkTrees=N,t.unlinkTree=C,t.firstDescendantOrSelf=k,t.isWellFormedRange=D,t.genericCutFunction=M,t.genericInsertIntoText=g,t.genericInsertText=S,t.deleteNode=L,t.mergeTextNodes=O,t.rangeFromPoints=a,t.focusNode=f,t.dumpCurrentSelection=P,t.dumpRange=H,t.pointInContents=B}),define("wed/dloc",["require","exports","module","jquery","rangy","./domutil","./oop"],function(e,t,n){function u(){throw new Error("use makeDLoc to create DLoc objects")}function a(e,t,n){this.root=e,this.node=t,this.offset=n}function f(e,t,n){t instanceof Array&&(n=t[1],t=t[0]);if(!t)return undefined;var i;if(t instanceof r){i=t,t=t[0];if(!t)return undefined}else i=r(t);var s;e instanceof r?(s=e,e=e[0]):s=r(e);if(i.closest(e).length===0)throw new Error("node not in root");if(!s.data("wed-dloc-root"))throw new Error("root has not been marked as a root: "+e);return new a(e,t,n)}function l(e){r(e).data("wed-dloc-root",!0)}function c(e){e=e instanceof r?e[0]:e;while(e){if(r(e).data("wed-dloc-root"))return e;e=e.parentNode}return undefined}function h(e){var t=c(e);if(!t)throw new Error("no root found");return t}var r=e("jquery"),i=e("rangy"),s=e("./domutil"),o=e("./oop");u.prototype.clone=function(){return new a(this.root,this.node,this.offset)},u.prototype.make=function(e,t){return f(this.root,e,t)},u.prototype.toArray=function(){return[this.node,this.offset]},u.prototype.makeRange=function(e){if(!e){var t=i.createRange(this.node.ownerDocument);return t.setStart(this.node,this.offset),t}return s.rangeFromPoints(this.node,this.offset,e.node,e.offset)},o.inherit(a,u),t.markRoot=l,t.makeDLoc=f,t.DLoc=u,t.findRoot=c,t.getRoot=h}),define("wed/validator",["require","exports","module","./lib/simple_event_emitter","salve/validate","jquery","./util","./oop","./dloc"],function(e,t,n){function g(e,t){r.call(this),this.schema=e,this.root=t,this._timeout=200,this._max_timespan=100,this._timeout_id=undefined,this._initialized=!1,this._errors=[],this._tree=undefined,this._bound_wrapper=this._workWrapper.bind(this),this._events=[],this._validation_walker=undefined,this._working_state=undefined,this._part_done=0,this._validation_stage=c,this._previous_child=null,this._validation_stack=[new b(0,1)],this._cur_el=this.root,s(this._cur_el).data("wed_event_index_after_start",this._events.length),this._setWorkingState(p)}function y(){Error.call(this,"undefined event_index; _validateUpTo should have taken care of that")}function b(e,t){this.part_done=e,this.portion=t}var r=e("./lib/simple_event_emitter").SimpleEventEmitter,i=e("salve/validate"),s=e("jquery"),o=e("./util"),u=e("./oop"),a=e("./dloc"),f=Array.prototype.indexOf,l=1,c=2,h=3,p=1,d=2,v=3,m=4;t.INCOMPLETE=p,t.WORKING=d,t.INVALID=v,t.VALID=m,u.implement(g,r),g.prototype.start=function(){this._timeout_id!==undefined&&this.stop(),this._initialized?(this._setWorkingState(d,this._part_done),this._workWrapper()):this.initialize(function(){this._setWorkingState(d,this._part_done),this._workWrapper()}.bind(this))},g.prototype.initialize=function(t){s.get(e.toUrl(this.schema),function(e){this._tree=i.constructTree(e),this._validation_walker=this._tree.newWalker(),this._validation_walker.useNameResolver(),this._initialized=!0,t()}.bind(this),"text").fail(function(e,t,n){throw new Error(t+" "+n)})},g.prototype.getSchemaNamespaces=function(){if(!this._initialized)throw new Error("calling getSchemaNamespaces on uninitialized validator");return this._tree.getNamespaces()},g.prototype.getDocumentNamespaces=function(){function n(t){var r=t.attributes.length;for(var i=0;i<r;++i){var s=t.attributes[i];if(s.name.lastIndexOf("data-wed-xmlns---",0)===0){var o=s.name.slice(17),u=e[o];u||(u=e[o]=[]),u.push(s.value)}}t=t.firstChild;while(t)t.nodeType===Node.ELEMENT_NODE&&n(t),t=t.nextSibling}var e={},t=s(this.root).find("[data-wed-xmlns]");return t.length&&(e[""]=[t.attr("data-wed-xmlns")]),n(this.root),e},g.prototype._workWrapper=function(){this._restarting=!1,this._work()&&(this._timeout_id=window.setTimeout(this._bound_wrapper,this._timeout))},g.prototype._work=function(){if(!this._initialized)return!0;var e=new Date;for(;;){if(this._max_timespan>0&&new Date-e>=this._max_timespan)return!0;var t=this._cycle();if(!t)return!1}return!0},g.prototype._cycle=function(){var e,t,n,r,u,a=this._validation_walker,p=this._validation_stack[0].portion;e:for(;;){var g=s(this._cur_el);switch(this._validation_stage){case l:this._validation_stack.unshift(new b(this._part_done,p));if(!g.hasClass("_phantom_wrap")&&!g.is("._real._text, ._placeholder, ._wed_caret")){this._fireAndProcessEvent(a,new i.Event("enterContext"),this._cur_el,0);var y=this._cur_el.attributes.length;for(n=0;n<y;++n)r=this._cur_el.attributes[n],r.name==="data-wed-xmlns"?this._fireAndProcessEvent(a,new i.Event("definePrefix","",r.value),this._cur_el,0):r.name.lastIndexOf("data-wed-xmlns---",0)===0&&this._fireAndProcessEvent(a,new i.Event("definePrefix",r.name.slice(17),r.value),this._cur_el,0);u=this._cur_el.className.split(" ",1)[0],t=a.resolveName(u);var w=this._cur_el.parentNode?f.call(this._cur_el.parentNode.childNodes,this._cur_el):undefined;this._fireAndProcessEvent(a,new i.Event("enterStartTag",t.ns,t.name),this._cur_el.parentNode,w);for(n=0;n<y;++n){r=this._cur_el.attributes[n];if(r.name.lastIndexOf("data-wed-",0)!==0||r.name==="data-wed-xmlns"||r.name.lastIndexOf("data-wed-xmlns",0)===0)continue;var E=o.decodeAttrName(r.name);t=a.resolveName(E,!0),this._fireAndProcessEvent(a,new i.Event("attributeName",t.ns,t.name),this._cur_el,0),this._fireAndProcessEvent(a,new i.Event("attributeValue",r.value),this._cur_el,0)}this._fireAndProcessEvent(a,new i.Event("leaveStartTag"),this._cur_el,0)}return this._validation_stage=c,g.data("wed_event_index_after_start",this._events.length),!0;case c:var S=this._previous_child===null?this._cur_el.firstChild:this._previous_child.nextSibling;while(S!==null){switch(S.nodeType){case Node.TEXT_NODE:e=this._fireTextEventIfNeeded(S,a),e&&this._processEventResult(e,S,f.call(S.parentNode.childNodes,S));break;case Node.ELEMENT_NODE:if(!s(S).hasClass("_phantom")){p/=g.children().length,this._cur_el=S,this._validation_stage=l,this._previous_child=null;continue e}break;default:throw new Error("unexpected node type: "+S.nodeType)}S=S.nextSibling}S===null&&(this._validation_stage=h);break;case h:if(this._cur_el===this.root)return e=a.end(),e&&this._processEventResult(e,this._cur_el,this._cur_el.childNodes.length),this._part_done=1,this._setWorkingState(this._errors.length>0?v:m),s(this._cur_el).data("wed_event_index_after",this._events.length),this.stop(),!1;var x=this._cur_el;return!g.hasClass("_phantom_wrap")&&!g.is("._real._text, ._placeholder, ._wed_caret")&&(u=this._cur_el.className.split(" ",1)[0],t=a.resolveName(u),this._fireAndProcessEvent(a,new i.Event("endTag",t.ns,t.name),this._cur_el,this._cur_el.childNodes.length),this._fireAndProcessEvent(a,new i.Event("leaveContext"),this._cur_el,this._cur_el.childNodes.length)),this._previous_child=this._cur_el,this._cur_el=this._cur_el.parentNode,this._cur_el!==this.root&&(this._validation_stack.shift(),this._part_done=this._validation_stack[0].part_done+=p,p=this._validation_stack[0].portion),this._setWorkingState(d,this._part_done),s(x).data("wed_event_index_after",this._events.length),this._validation_stage=c,!0;default:throw new Error("unexpected state")}}},g.prototype.stop=function(){this._timeout_id!==undefined&&window.clearTimeout(this._timeout_id),this._timeout_id=undefined,this._working_state===d&&this._setWorkingState(p)},g.prototype.restartAt=function(e){this._working_state===d&&this.stop(),this._initialized&&!this._restarting&&(this._restarting=!0,this._resetTo(e)),this.start()},g.prototype._resetTo=function(e){s(this.root).findAndSelf("*").removeData(["wed_event_index_after","wed_event_index_after_start"]),this._validation_stage=c,this._previous_child=null,this._validation_walker=this._tree.newWalker(),this._validation_walker.useNameResolver(),this._events=[],this._cur_el=this.root,this._part_done=0,this._errors=[],this._emit("reset-errors",{at:0})},g.prototype._setWorkingState=function(e){if(this._working_state!==e||e===d)this._working_state=e,this._emit("state-update")},g.prototype.getWorkingState=function(){return{state:this._working_state,part_done:this._part_done}},g.prototype._processEventResult=function(e,t,n){for(var r=0,i;(i=e[r])!==undefined;++r)this._errors.push(i),this._emit("error",{error:i,node:t,index:n})},g.prototype._fireAndProcessEvent=function(e,t,n,r){this._events.push(t);var i=e.fireEvent(t);i&&this._processEventResult(i,n,r)},g.prototype._fireTextEventIfNeeded=function(e,t,n){if(s.trim(e.nodeValue).length>0||t.possible().filter(function(e){return e[0]==="text"}).length>0){var r=new i.Event("text");return n||this._events.push(r),t.fireEvent(r)}return!1},g.prototype._validateUpTo=function(e,t){var n=s(e),r=n,i="wed_event_index_after";if(e===this.root&&t<=0){if(t===0)return}else{var o;switch(e.nodeType){case Node.TEXT_NODE:o=s(e).prev("._real, ._phantom_wrap"),o.length>0?r=o:(r=s(e.parentNode),i="wed_event_index_after_start");break;case Node.ELEMENT_NODE:var u=e.childNodes[t];o=u===undefined?s(e).children("._real, ._phantom_wrap").last():s(u).prev("._real, ._phantom_wrap"),o.length>0?r=o:i="wed_event_index_after_start";break;default:throw new Error("unexpected node type: "+e.nodeType)}}while(r.data(i)===undefined)this._cycle()},u.inherit(y,Error),g.prototype._getWalkerAt=function(e,t){this._validateUpTo(e,t);var n,r;if(e===this.root&&t<=0){n=this._tree.newWalker(),n.useNameResolver();if(t===0)return n;o=s(e).data("wed_event_index_after");if(o===undefined)throw new y;for(r=0;r<this._events.length;++r)n.fireEvent(this._events[r]);return n}var i,o;switch(e.nodeType){case Node.TEXT_NODE:i=s(e).prev("._real, ._phantom_wrap"),o=i.length>0?i.data("wed_event_index_after"):s(e.parentNode).data("wed_event_index_after_start");if(o===undefined)throw new y;n=this._tree.newWalker(),n.useNameResolver();for(r=0;r<o;++r)n.fireEvent(this._events[r]);(t>0||i.nextUntil(e).filter(function(e){return this.nodeType===Node.TEXT_NODE||s(this).hasClass("_text")}).length>0)&&this._fireTextEventIfNeeded(e,n,!0);break;case Node.ELEMENT_NODE:var u=e.childNodes[t];i=u===undefined?s(e).children("._real, ._phantom_wrap").last():s(u).prev("._real, ._phantom_wrap"),o=i.length>0?i.data("wed_event_index_after"):s(e).data("wed_event_index_after_start");if(o===undefined)throw new y;n=this._tree.newWalker(),n.useNameResolver();for(r=0;r<o;++r)n.fireEvent(this._events[r]);(u===undefined?i.nextAll():i.nextUntil(u)).filter(function(e){return this.nodeType===Node.TEXT_NODE||s(this).hasClass("_text")}).length>0&&this._fireTextEventIfNeeded(e,n,!0);break;default:throw new Error("unexpected node type: "+e.nodeType)}return n},g.prototype.possibleAt=function(e,t){e instanceof a.DLoc&&(t=e.offset,e=e.node);var n=this._getWalkerAt(e,t);return n.possible()},g.prototype.possibleWhere=function(e,t){var n=[];for(var r=0;r<e.childNodes.length;++r){var i=this.possibleAt(e,r);i.has(t)&&n.push(r)}return n},g.prototype.speculativelyValidate=function(e,t,n){e instanceof a.DLoc&&(n=t,t=e.offset,e=e.node);if(!this._initialized)throw new Error("uninitialized Validator");var r=s(n).clone(),i=s("<div>");i.append(r);var o=new g(this.schema,i.get(0));return o._validation_walker=this._getWalkerAt(e,t).clone(),o._tree=this._tree,o._initialized=!0,o._validateUpTo(i.get(0),1),o._errors.length?o._errors:!1},t.Validator=g}),function(e){typeof define=="function"&&define.amd?define("wed/jquery.findandself",["jquery"],e):e(jQuery)}(function(e){e.fn.findAndSelf=function(e){var t=this.find(e);return this.is(e)&&(t=t.add(this)),t}}),define("wed/domlistener",["require","exports","module","jquery","./jquery.findandself"],function(e,t,n){function i(e){this._$root=r(e),this._event_handlers={"included-element":[],"excluded-element":[],"added-element":[],"removed-element":[],"children-changed":[],"text-changed":[]},this._trigger_handlers={},this._triggers_to_fire={}}function s(){throw new Error("derived classes must override this method")}var r=e("jquery");e("./jquery.findandself"),i.prototype.startListening=s,i.prototype.addHandler=function(e,t,n){e instanceof Array||(e=[e]);for(var r=0,i;(i=e[r])!==undefined;r++)if(i!=="trigger"){var s=this._event_handlers[i];if(s===undefined)throw new Error("invalid event_type: "+i);s.push([t,n])}else{var o=this._trigger_handlers[t];o===undefined&&(o=this._trigger_handlers[t]=[]),o.push(n)}},i.prototype.stopListening=s,i.prototype.processImmediately=s,i.prototype.trigger=function(e){this._triggers_to_fire[e]=1},i.prototype._processTriggers=function(){var e=Object.keys(this._triggers_to_fire);while(e.length>0){this._triggers_to_fire={};var t=this._trigger_handlers;for(var n=0,r;(r=e[n])!==undefined;++n){var i=t[r];if(i!==undefined)for(var s=0,o;(o=i[s])!==undefined;++s)this._callHandler(o)}e=Object.keys(this._triggers_to_fire)}},i.prototype._callHandler=function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);t.unshift(this._$root),e.apply(undefined,t)},i.prototype._dumpMutation=function(e){console.log(e.type+":",e.target,e.addedNodes,e.removedNodes,e.previousSibling,e.nextSibling,e.attributeName,e.attributeNamespace,e.oldValue)},t.Listener=i}),define("wed/mutation_domlistener",["require","exports","module","./oop","./domlistener","jquery","./jquery.findandself"],function(e,t,n){function u(e){i.Listener.call(this,e),this._observer=new o(this._onMutation.bind(this))}var r=e("./oop"),i=e("./domlistener"),s=e("jquery");e("./jquery.findandself");var o=window.MutationObserver||window.WebKitMutationObserver;r.inherit(u,i.Listener),u.prototype.startListening=function(){this._observer.observe(this._$root.get(0),{subtree:!0,childList:!0,attributes:!1,attributeOldValue:!1,characterData:!0,characterDataOldValue:!0})},u.prototype.stopListening=function(){this._observer.disconnect()},u.prototype.processImmediately=function(){var e=this._observer.takeRecords();while(e.length>0){while(e.length>0)this._processMutations(e),e=this._observer.takeRecords();this._processTriggers(),e=this._observer.takeRecords()}},u.prototype._onMutation=function(e,t){this._processMutations(e),this._processTriggers()},u.prototype._processMutations=function(e){for(var t=0,n=e.length;t<n;++t){var r=e[t],i=s(r.target),o,u,a,f,l,c=[],h=[],p,d;if(r.type==="childList"){for(p=0;!!(d=r.addedNodes[p]);p++)d.nodeType!==Node.TEXT_NODE&&c.push(d);for(p=0;!!(d=r.removedNodes[p]);p++)d.nodeType!==Node.TEXT_NODE&&h.push(d);this._fireAddRemHandlers("added-element",r,c,i),this._fireAddRemHandlers("removed-element",r,h,i),this._fireIncExcHandlers("included-element",r,c,i),this._fireIncExcHandlers("excluded-element",r,h,i),l=this._event_handlers["children-changed"];for(o=0,u=l.length;o<u;++o)a=l[o],f=a[0],i.is(f)&&this._callHandler(a[1],s(r.addedNodes),s(r.removedNodes),s(r.previousSibling),s(r.nextSibling),i)}else if(r.type==="characterData"){l=this._event_handlers["text-changed"];var v=i.parent();for(o=0,u=l.length;o<u;++o)a=l[o],f=a[0],v.is(f)&&this._callHandler(a[1],i,r.oldValue)}}},u.prototype._fireAddRemHandlers=function(e,t,n,r){var i=this._event_handlers[e];for(var o=0,u=i.length;o<u;++o){var a=i[o],f=a[0];for(var l=0,c=n.length;l<c;++l){var h=s(n[l]);if(h.is(f)){var p=l===0?s(t.previousSibling):s(n[l-1]),d=l===c-1?s(t.nextSibling):s(n[l+1]);this._callHandler(a[1],r,p,d,h)}}}},u.prototype._fireIncExcHandlers=function(e,t,n,r){var i=this._event_handlers[e];for(var o=0,u=i.length;o<u;++o){var a=i[o],f=a[0];for(var l=0,c=n.length;l<c;++l){var h=s(n[l]),p=h.findAndSelf(f),d=l===0?s(t.previousSibling):s(n[l-1]),v=l===c-1?s(t.nextSibling):s(n[l+1]);for(var m=0,g=p.length;m<g;++m)this._callHandler(a[1],h,r,d,v,s(p.get(m)))}}},t.Listener=u}),define("wed/updater_domlistener",["require","exports","module","./oop","./domlistener","jquery","./jquery.findandself"],function(e,t,n){function o(e,t){i.Listener.call(this,e),this._updater=t,this._stopped=!0,this._scheduled_process_triggers=0,this._updater.addEventListener("insertNodeAt",this._insertNodeAtHandler.bind(this)),this._updater.addEventListener("setTextNodeValue",this._setTextNodeValueHandler.bind(this)),this._updater.addEventListener("deleteNode",this._deleteNodeHandler.bind(this))}var r=e("./oop"),i=e("./domlistener"),s=e("jquery");e("./jquery.findandself"),r.inherit(o,i.Listener),o.prototype.startListening=function(){this._stopped=!1},o.prototype.stopListening=function(){this._stopped=!0},o.prototype.processImmediately=function(){},o.prototype._insertNodeAtHandler=function(e){if(this._stopped)return;var t=s(e.parent),n=s(e.node),r=this._childrenChangedCalls(t,n,s(),n.prev(),n.next()),i=[],o=[];e.node.nodeType===Node.ELEMENT_NODE&&(i=this._addRemCalls("added-element",n,t),o=this._incExcCalls("included-element",n,t));var u=r.concat(i,o);for(var a=0,f;(f=u[a])!==undefined;++a)this._callHandler.apply(this,f);this._scheduleProcessTriggers()},o.prototype._deleteNodeHandler=function(e){if(this._stopped)return;var t=s(e.node),n=t.parent(),r=this._childrenChangedCalls(n,s(),t,t.prev(),t.next()),i=[],o=[];e.node.nodeType===Node.ELEMENT_NODE&&(i=this._addRemCalls("removed-element",t,n),o=this._incExcCalls("excluded-element",t,n));var u=r.concat(i,o);for(var a=0,f;(f=u[a])!==undefined;++a)this._callHandler.apply(this,f);this._scheduleProcessTriggers()},o.prototype._childrenChangedCalls=function(e,t,n,r,i){var s=this._event_handlers["children-changed"],o=[];for(var u=0,a=s.length;u<a;++u){var f=s[u],l=f[0];e.is(l)&&o.push([f[1],t,n,r,i,e])}return o},o.prototype._setTextNodeValueHandler=function(e){if(this._stopped)return;var t=this._event_handlers["text-changed"],n=s(e.node),r=n.parent();for(var i=0,o=t.length;i<o;++i){var u=t[i],a=u[0];r.is(a)&&this._callHandler(u[1],n,e.old_value)}this._scheduleProcessTriggers()},o.prototype._scheduleProcessTriggers=function(){if(this._scheduled_process_triggers)return;this._scheduled_process_triggers=window.setTimeout(function(){this._scheduled_process_triggers=undefined,this._processTriggers()}.bind(this),0)},o.prototype._addRemCalls=function(e,t,n){var r=this._event_handlers[e],i=t.prev(),s=t.next(),o=[];for(var u=0,a=r.length;u<a;++u){var f=r[u],l=f[0];t.is(l)&&o.push([f[1],n,i,s,t])}return o},o.prototype._incExcCalls=function(e,t,n){var r=this._event_handlers[e],i=t.prev(),o=t.next(),u=[];for(var a=0,f=r.length;a<f;++a){var l=r[a],c=l[0],h=t.findAndSelf(c);for(var p=0,d=h.length;p<d;++p)u.push([l[1],t,n,i,o,s(h.get(p))])}return u},t.Listener=o}),define("wed/refman",["require","exports","module","./oop"],function(e,t,n){function i(e){this.name=e,this._id_to_label={},this._highest_number=0}function o(){i.call(this,"sense"),this._next_sense_label_ix=0}var r=e("./oop");i.prototype.allocateLabel=function(e){throw new Error("allocateLabel must be overriden in children.")},i.prototype.idToLabel=function(e){return this._id_to_label[e]},i.prototype.deallocateAll=function(){this._id_to_label={},this._deallocateAllLabels()},i.prototype._deallocateAllLabels=function(){throw new Error("_deallocateAllLabels must be overriden in children.")},i.prototype.nextNumber=function(){return++this._highest_number},t.ReferenceManager=i;var s="abcdefghijklmnopqrstuvwxyz";r.inherit(o,i),o.prototype.allocateLabel=function(e){if(this._next_sense_label_ix>=s.length)throw new Error("hit the hard limit of 26 sense labels in a single article");return this._id_to_label[e]=s[this._next_sense_label_ix++]},o.prototype._deallocateAllLabels=function(){this._next_sense_label_ix=0},t.___test_rm=new o}),define("wed/action",["require","exports","module","./lib/simple_event_emitter","./oop"],function(e,t,n){function s(e,t,n,i){r.call(this),this._editor=e,this._desc=t,this._abbreviated_desc=n,this._icon=i||"",this._enabled=!0,this.bound_handler=this.eventHandler.bind(this),this.bound_terminal_handler=this.terminalEventHandler.bind(this)}var r=e("./lib/simple_event_emitter").SimpleEventEmitter,i=e("./oop");i.implement(s,r),s.prototype.execute=function(e){throw new Error("the execute method must be overridden.")},s.prototype.eventHandler=function(e){this.execute(e.data),e.preventDefault()},s.prototype.terminalEventHandler=function(e){return this.eventHandler(e),e.preventDefault(),e.stopPropagation(),!1},s.prototype.getDescription=function(){return this._desc},s.prototype.getDescriptionFor=function(e){return this.getDescription()},s.prototype.getAbbreviatedDescription=function(){return this._abbreviated_desc},s.prototype.getIcon=function(){return this._icon},s.prototype.getLabelFor=function(e){var t=this.getDescriptionFor(e),n=this.getIcon();return n&&t?n+" "+t:n?n:t},s.prototype.toString=function(){return this.getDescription()},s.prototype.getEnabled=function(){return this._enabled},t.Action=s}),define("wed/transformation",["require","exports","module","jquery","./util","./refman","./domutil","./action","./oop"],function(e,t,n){function l(){this._tag_tr={insert:{},"delete-element":{},"delete-parent":{},"merge-with-next":{},"merge-with-previous":{},"swap-with-next":{},"swap-with-previous":{},wrap:{},append:{},prepend:{},unwrap:{}}}function c(e,t,n,r,i){switch(arguments.length){case 3:i=n,n=r=undefined;break;case 4:i=r,r=undefined}u.call(this,e,t,n,r),this.handler=i}function h(e,t,n,r,i,s){var o=p(r,i,s!==undefined);return s!==undefined&&o.append(s),e.insertAt(t,n,o.get(0)),o}function p(e,t){var n=r("<div class='"+e+" _real'>");if(t!==undefined){var s=Object.keys(t);for(var o=0,u;(u=s[o++])!==undefined;)n.attr(i.encodeAttrName(u),t[u])}return n}function d(e,t,n,r,i,s){var o=t.nodeValue,u=t.nodeValue.slice(n,r);e.deleteText(t,n,u.length);var a=p(i,s);return a.append(u),e.insertAt(t,n,a.get(0)),a}function v(e,t,n){var r=t.parentNode,i=f.call(r.childNodes,t);if(n===0)n=i;else if(n>=t.nodeValue.length)n=i+1;else{var s=t.nodeValue.slice(n);e.setTextNode(t,t.nodeValue.slice(0,n)),e.insertNodeAt(r,i+1,t.ownerDocument.createTextNode(s)),n=i+1}return t=r,[t,n]}function m(e,t,n,r,i,s,u){if(!o.isWellFormedRange({startContainer:t,startOffset:n,endContainer:r,endOffset:i}))throw new Error("malformed range");var a;if(t.nodeType===Node.TEXT_NODE){if(t===r)return d(e,t,n,i,s,u);a=v(e,t,n),t=a[0],n=a[1]}r.nodeType===Node.TEXT_NODE&&(a=v(e,r,i),r=a[0],i=a[1]);if(t!==r)throw new Error("start_container and end_container are not the same;probably due to an algorithmic mistake");var f=p(s,u);while(--i>=n){var l=r.childNodes[i];e.deleteNode(l),f.prepend(l)}return e.insertAt(t,n,f.get(0)),f}function g(e,t){var n=t.parentNode,r=Array.prototype.slice.call(t.childNodes),i=t.previousSibling,s=t.nextSibling;e.deleteNode(t);var o=s?f.call(n.childNodes,s):n.childNodes.length,u=t.lastChild;while(t.firstChild)e.insertNodeAt(n,o++,t.firstChild);return e.mergeTextNodes(u),e.mergeTextNodes(i),r}function y(e,t){var n=e.getDataCaret();if(r(n.node).closest(t).length===0)throw new Error("caret outside node");var i=e.data_updater.splitAt(t,n);e.setDataCaret(o.firstDescendantOrSelf(i[1]),0)}function b(e,t){var n=r(t),s=n.prev(),o=i.getOriginalName(t);if(s.is(i.classFromOriginalName(o))){var u=s.get(0).childNodes.length,a=s.get(0).lastChild.nodeType===Node.TEXT_NODE,f=a?s.get(0).lastChild.nodeValue.length:0,l=s.get(0),c=l.childNodes.length;for(var h=t.childNodes.length;h>=0;--h)e.data_updater.insertAt(l,c,t.childNodes[h]);a?e.setDataCaret(s.get(0).childNodes[u-1],f):e.setDataCaret(s.get(0),u),e.data_updater.removeNode(t)}}function w(e,t){var n=r(t),s=n.next(),o=i.getOriginalName(t);s.is(i.classFromOriginalName(o))&&b(e,s.get(0))}function E(e,t){var n=t.previousSibling,s=i.getOriginalName(t);if(r(n).is(i.classFromOriginalName(s))){var o=n.parentNode;e.data_updater.removeNode(t),e.data_updater.insertBefore(o,t,n),e.setDataCaret(o,f.call(o.childNodes,t))}}function S(e,t){var n=t.nextSibling;n&&E(e,n)}var r=e("jquery"),i=e("./util"),s=e("./refman").sense_refs,o=e("./domutil"),u=e("./action").Action,a=e("./oop"),f=Array.prototype.indexOf;l.prototype.addTagTransformations=function(e,t,n){n instanceof Array||(n=[n]),this._tag_tr[e][t]=n},l.prototype.getTagTransformations=function(e,t){e instanceof Array||(e=[e]);var n=[];for(var r=0;r<e.length;r++){var i=this._tag_tr[e[r]][t];i!==undefined&&(n=n.concat(i)),i=this._tag_tr[e[r]]["*"],i!==undefined&&(n=n.concat(i))}return n},a.inherit(c,u),c.prototype.getDescriptionFor=function(e){return this._desc.replace(/<element_name>/,e.element_name)},c.prototype.execute=function(e){e=e||{},this._editor.fireTransformation(this,e)},t.TransformationRegistry=l,t.Transformation=c,t.wrapTextInElement=d,t.wrapInElement=m,t.insertElement=h,t.makeElement=p,t.unwrap=g,t.splitNode=y,t.mergeWithPreviousHomogeneousSibling=b,t.mergeWithNextHomogeneousSibling=w,t.swapWithPreviousHomogeneousSibling=E,t.swapWithNextHomogeneousSibling=S}),define("wed/undo",["require","exports","module","./oop"],function(e,t,n){function i(){this._stack=[],this._list=[],this._index=-1,this._undoing_or_redoing=!1}function s(e){this._desc=e}function o(){s.apply(this,arguments),this._list=[]}var r=e("./oop");i.prototype.record=function(e){this._stack.length>0?this._stack[0].record(e):(this._list=this._list.splice(0,this._index+1),this._list.push(e),this._index++)},i.prototype.undo=function(){if(this._undoing_or_redoing)throw new Error("calling undo while undoing or redoing");this._undoing_or_redoing=!0;while(this._stack.length>0)this.endGroup();this._index>=0&&this._list[this._index--].undo(),this._undoing_or_redoing=!1},i.prototype.redo=function(){if(this._undoing_or_redoing)throw new Error("calling redo while undoing or redoing");this._undoing_or_redoing=!0,this._index<this._list.length-1&&this._list[++this._index].redo(),this._undoing_or_redoing=!1},i.prototype.undoingOrRedoing=function(){return this._undoing_or_redoing},i.prototype.canUndo=function(){return this._index>-1},i.prototype.canRedo=function(){return this._index<this._list.length-1},i.prototype.startGroup=function(e){this._stack.unshift(e)},i.prototype.endGroup=function(){if(this._stack.length===0)throw new Error("ending a non-existent group.");var e=this._stack.shift();e.end(),this.record(e)},i.prototype.endAllGroups=function(){while(this._stack.length>0)this.endGroup()},i.prototype.getGroup=function(){return this._stack[0]},i.prototype.toString=function(){var e=[];e.push("Start of list\n");for(var t=0,n;(n=this._list[t])!==undefined;++t)e.push(n.toString());e.push("End of list\n"),e.push("Unfinished groups:\n");for(t=this._stack.length-1;(n=this._stack[t])!==undefined;--t)e.push(n.toString());return e.push("End of unfinished groups\n"),e.join("")},t.UndoList=i,s.prototype.undo=function(){throw new Error("must override the undo method.")},s.prototype.redo=function(){throw new Error("must override the redo method.")},s.prototype.toString=function(){return this._desc+"\n"},t.Undo=s,r.inherit(o,s),o.prototype.undo=function(){for(var e=this._list.length-1;e>=0;--e)this._list[e].undo()},o.prototype.redo=function(){for(var e=0;e<this._list.length;++e)this._list[e].redo()},o.prototype.record=function(e){this._list.push(e)},o.prototype.end=function(){},o.prototype.toString=function(){var e=[];e.push("Start of ",this._desc,"\n");for(var t=0,n;(n=this._list[t])!==undefined;++t)e.push(n.toString().replace(/(^|\n)/g,"$1 ").slice(0,-1));return e.push("End of ",this._desc,"\n"),e.join("")},t.UndoGroup=o}),define("wed/wundo",["require","exports","module","jquery","./oop","./undo","./domutil"],function(e,t,n){function u(e,t){s.UndoGroup.call(this,e),this._editor=t,this._caret_as_path_before=this.getDataCaretAsPath()}function a(e,t,n,r){u.call(this,e,t),this._undo_list=n,this._limit=r}function f(e){s.Undo.call(this,"*** MARKER *** "+e)}var r=e("jquery"),i=e("./oop"),s=e("./undo"),o=e("./domutil");i.inherit(u,s.UndoGroup),u.prototype.undo=function(){this.setDataCaretAsPath(this._caret_as_path_after),s.UndoGroup.prototype.undo.apply(this,arguments),this.setDataCaretAsPath(this._caret_as_path_before)},u.prototype.redo=function(){this.setDataCaretAsPath(this._caret_as_path_before),s.UndoGroup.prototype.redo.apply(this,arguments),this.setDataCaretAsPath(this._caret_as_path_after)},u.prototype.getDataCaretAsPath=function(){var e=this._editor.getDataCaret(!0);return e?[this._editor.data_updater.nodeToPath(e.node),e.offset]:[undefined,undefined]},u.prototype.setDataCaretAsPath=function(e){if(!e[0]&&!e[1])return;this._editor.setDataCaret(this._editor.data_updater.pathToNode(e[0]),e[1])},u.prototype.recordCaretAfter=function(){this._caret_as_path_after=this.getDataCaretAsPath()},u.prototype.end=function(){this._caret_as_path_after||this.recordCaretAfter()},t.UndoGroup=u,i.inherit(a,u),a.prototype.record=function(){if(this._list.length>=this._limit)throw new Error("TextUndoGroup.record called beyond the limit");s.UndoGroup.prototype.record.apply(this,arguments),this._list.length===this._limit&&this._undo_list.endGroup()},t.TextUndoGroup=a,i.inherit(f,s.Undo),f.prototype.undo=function(){},f.prototype.redo=function(){},t.MarkerUndo=f}),define("wed/jqutil",["require","exports","module","jquery","./util","./log"],function(e,t,n){function o(){return this.nodeType===Node.TEXT_NODE}function f(e){if(/[\]['"()]/.test(e))throw new Error("selector is too complex");var t=e.split(a),n=[];for(var r=0;r<t.length;++r){var s=t[r];if(s.length)if(u.indexOf(s)>-1)n.push(s);else if(/[a-zA-Z]/.test(s[0])){s=s.trim();var o=s.split(/(.#)/);n.push(i.classFromOriginalName(o[0])),n=n.concat(o.slice(1))}else n.push(s)}return n.join("")}function l(e){if(/[,+~#.]/.test(e))throw new Error("selector is too complex for selectorToElements");var t=f(e),n=e.split(a),s=r(),o=!1;for(var u=n.length-1;u>-1;--u){var l=n[u].trim();if(l.length)if(o){if(l!==">")throw new Error("selector is not a sequence of > selectors");o=!1}else{var c=r("<div>");c.addClass(i.classFromOriginalName(l).replace(/\./g," ")),c.append(s),s=c,o=!0}}return s}var r=e("jquery"),i=e("./util"),s=e("./log"),u=",>+~ ",a=new RegExp("(["+u+"]+)");t.textFilter=o,t.toDataSelector=f,t.selectorToElements=l}),define("wed/tree_updater",["require","exports","module","jquery","./domutil","./oop","./lib/simple_event_emitter","./dloc"],function(e,t,n){function l(e){o.call(this),this._tree=e}var r=e("jquery"),i=e("./domutil"),s=e("./oop"),o=e("./lib/simple_event_emitter").SimpleEventEmitter,u=e("./dloc"),a=u.DLoc,f=u.makeDLoc;s.implement(l,o),l.prototype.insertAt=function(e,t,n){var r,i;e instanceof a?(r=e.node,i=e.offset,n=t):(r=e,i=t);if(n instanceof Array||n instanceof NodeList)for(var s=0;s<n.length;++s,++i)this.insertAt(r,i,n[s]);else if(typeof n=="string")this.insertText(r,i,n);else if(n.nodeType===Node.TEXT_NODE)switch(r.nodeType){case Node.TEXT_NODE:this.insertText(r,i,n.nodeValue);break;case Node.ELEMENT_NODE:this.insertNodeAt(r,i,n);break;default:throw new Error("unexpected node type: "+r.nodeType)}else{if(n.nodeType!==Node.ELEMENT_NODE)throw new Error("unexpected value for what: "+n);switch(r.nodeType){case Node.TEXT_NODE:this.insertIntoText(r,i,n);break;case Node.ELEMENT_NODE:this.insertNodeAt(r,i,n);break;default:throw new Error("unexpected node type: "+r.nodeType)}}},l.prototype.splitAt=function(e,t,n){var s;t instanceof a?(s=t.node,n=t.offset):s=t;if(s===e&&s.nodeType===Node.TEXT_NODE)throw new Error("splitAt called in a way that would result in two adjacent text nodes");if(r(s).closest(e).length===0)throw new Error("split location is not inside top");var o=r(e).clone().get(0),u=i.pathToNode(o,i.nodeToPath(e,s)),f=this._splitAt(o,u,n),l=e.parentNode,c=Array.prototype.indexOf.call(l.childNodes,e);return this.deleteNode(e),this.insertNodeAt(l,c,f[0]),this.insertNodeAt(l,c+1,f[1]),f},l.prototype._splitAt=function(e,t,n){var i=t===e,s=t.parentNode,o;switch(t.nodeType){case Node.TEXT_NODE:if(n===0)o=[null,t];else if(n===t.nodeValue.length)o=[t,null];else{var u=t.nodeValue.slice(n);t.nodeValue=t.nodeValue.slice(0,n),s&&s.insertBefore(s.ownerDocument.createTextNode(u),t.nextSibling),o=[t,t.nextSibling]}break;case Node.ELEMENT_NODE:n<0?n=0:n>t.childNodes.length&&(n=t.childNodes.length);var a=r(t),f=a.clone(),l=f.get(0);while(t.childNodes[n])t.removeChild(t.childNodes[n]);while(n--)l.removeChild(l.childNodes[0]);s&&s.insertBefore(l,t.nextSibling),o=[t,l];break;default:throw new Error("unexpected node type: "+t.nodeType)}return i?o:this._splitAt(e,s,Array.prototype.indexOf.call(s.childNodes,t)+1)},l.prototype.insertBefore=function(e,t,n){var r=n?Array.prototype.indexOf.call(e.childNodes,n):e.childNodes.length;if(r===-1)throw new Error("insertBefore called with a before_this value which is not a child of parent");this.insertAt(e,r,t)},l.prototype.insertText=function(e,t,n){var r;return e instanceof a?(n=t,r=e.node,t=e.offset):r=e,i.genericInsertText.call(this,r,t,n)},l.prototype.deleteText=function(e,t,n){var r;e instanceof a?(n=t,r=e.node,t=e.offset):r=e;if(r.nodeType!==Node.TEXT_NODE)throw new Error("deleteText called on non-text");this.setTextNode(r,r.nodeValue.slice(0,t)+r.nodeValue.slice(t+n))},l.prototype.insertIntoText=function(e,t,n){var r;e instanceof a?(n=t,t=e.offset,r=e.node):r=e;var s=i.genericInsertIntoText.call(this,r,t,n);return[f(this._tree,s[0]),f(this._tree,s[1])]},l.prototype.insertNodeAt=function(e,t,n){var r;e instanceof a?(n=t,t=e.offset,r=e.node):r=e;if(n.nodeType===Node.DOCUMENT_FRAGMENT_NODE)throw new Error("document fragments cannot be passed to insertNodeAt");r.insertBefore(n,r.childNodes[t]),this._emit("insertNodeAt",{parent:r,index:t,node:n})},l.prototype.setTextNode=function(e,t){if(e.nodeType!==Node.TEXT_NODE)throw new Error("setTextNode called on non-text");t!==""?this.setTextNodeValue(e,t):this.deleteNode(e)},l.prototype.setTextNodeValue=function(e,t){if(e.nodeType!==Node.TEXT_NODE)throw new Error("setTextNodeValue called on non-text");var n=e.nodeValue;e.nodeValue=t,this._emit("setTextNodeValue",{node:e,value:t,old_value:n})},l.prototype.removeNode=function(e){var t=e.previousSibling,n=e.nextSibling,r=e.parentNode,i=Array.prototype.indexOf.call(r.childNodes,e);return this.deleteNode(e),t?this.mergeTextNodes(t):f(this._tree,r,i)},l.prototype.removeNodes=function(e){if(!e.length)return undefined;var t=e[0].previousSibling,n=e[e.length-1].nextSibling,r=e[0].parentNode,i=Array.prototype.indexOf.call(r.childNodes,e[0]);for(var s=0;s<e.length;++s){if(s<e.length-1&&e[s].nextSibling!==e[s+1])throw new Error("nodes are not immediately contiguous in document order");this.deleteNode(e[s])}return t?this.mergeTextNodes(t):f(this._tree,r,i)},l.prototype.cut=function(e,t){var n=i.genericCutFunction.call(this,e.toArray(),t.toArray());return n[0]=f(this._tree,n[0]),n},l.prototype.mergeTextNodes=function(e){var t=e.nextSibling;if(e.nodeType===Node.TEXT_NODE&&t&&t.nodeType===Node.TEXT_NODE){var n=e.nodeValue.length;return this.setTextNodeValue(e,e.nodeValue+t.nodeValue),this.deleteNode(t),f(this._tree,e,n)}var r=e.parentNode;return f(this._tree,r,Array.prototype.indexOf.call(r.childNodes,e)+1)},l.prototype.deleteNode=function(e){this._emit("deleteNode",{node:e}),r(e).detach()},l.prototype.nodeToPath=function(e){return i.nodeToPath(this._tree,e)},l.prototype.pathToNode=function(e){return i.pathToNode(this._tree,e)},t.TreeUpdater=l}),define("wed/gui_updater",["require","exports","module","./domutil","jquery","./oop","./tree_updater","./dloc"],function(e,t,n){function l(e,t){o.call(this,e),this._gui_tree=e,this._tree_updater=t,this._tree_updater.addEventListener("insertNodeAt",this._insertNodeAtHandler.bind(this)),this._tree_updater.addEventListener("setTextNodeValue",this._setTextNodeValueHandler.bind(this)),this._tree_updater.addEventListener("deleteNode",this._deleteNodeHandler.bind(this))}var r=e("./domutil"),i=e("jquery"),s=e("./oop"),o=e("./tree_updater").TreeUpdater,u=e("./dloc"),a=u.makeDLoc,f=u.DLoc;s.inherit(l,o),l.prototype._insertNodeAtHandler=function(e){var t=this.fromDataLocation(e.parent,e.index),n=i(e.node).clone().get(0);r.linkTrees(e.node,n),this.insertNodeAt(t,n)},l.prototype._setTextNodeValueHandler=function(e){var t=this.fromDataLocation(e.node,0);this.setTextNodeValue(t.node,e.value)},l.prototype._deleteNodeHandler=function(e){var t=e.node,n;switch(t.nodeType){case Node.TEXT_NODE:var s=this.fromDataLocation(t,0);n=s.node;break;case Node.ELEMENT_NODE:n=i(t).data("wed_mirror_node")}this.deleteNode(n),r.unlinkTree(t),r.unlinkTree(n)},l.prototype.fromDataLocation=function(e,t){var n;e instanceof f?(n=e.node,t=e.offset):n=e;var i=r.pathToNode(this._gui_tree,this._tree_updater.nodeToPath(n));if(n.nodeType===Node.TEXT_NODE)return a(this._gui_tree,i,t);if(t===0)return a(this._gui_tree,i,0);if(t>=n.childNodes.length)return a(this._gui_tree,i,i.childNodes.length);var s=r.pathToNode(this._gui_tree,this._tree_updater.nodeToPath(n.childNodes[t]));return s===null?a(this._gui_tree,i,i.childNodes.length):a(this._gui_tree,s.parentNode,Array.prototype.indexOf.call(s.parentNode.childNodes,s))},t.GUIUpdater=l}),define("wed/undo_recorder",["require","exports","module","./domutil","jquery","./oop","./undo"],function(e,t,n){function u(e,t){this._editor=e,this._tree_updater=t,this._tree_updater.addEventListener("insertNodeAt",this._insertNodeAtHandler.bind(this)),this._tree_updater.addEventListener("setTextNodeValue",this._setTextNodeValueHandler.bind(this)),this._tree_updater.addEventListener("deleteNode",this._deleteNodeHandler.bind(this)),this._suppress=!1}function a(e,t,n,r){o.Undo.call(this,"InsertNodeAtUndo"),this._tree_updater=e,this._parent_path=e.nodeToPath(t),this._index=n,this._node=undefined}function f(e,t,n,r){o.Undo.call(this,"SetTextNodeValueUndo"),this._tree_updater=e,this._node_path=e.nodeToPath(t),this._new_value=n,this._old_value=r}function l(e,t){o.Undo.call(this,"DeleteNodeUndo"),this._tree_updater=e;var n=t.parentNode;this._parent_path=e.nodeToPath(n),this._index=Array.prototype.indexOf.call(n.childNodes,t),this._node=i(t).clone().get(0)}var r=e("./domutil"),i=e("jquery"),s=e("./oop"),o=e("./undo");u.prototype.suppressRecording=function(e){if(e===this._suppress)throw new Error("spurious call to suppressRecording");this._suppress=e},u.prototype._insertNodeAtHandler=function(e){if(this._suppress)return;this._editor.recordUndo(new a(this._tree_updater,e.parent,e.index,e.node))},u.prototype._setTextNodeValueHandler=function(e){if(this._suppress)return;this._editor.recordUndo(new f(this._tree_updater,e.node,e.value,e.old_value))},u.prototype._deleteNodeHandler=function(e){if(this._suppress)return;this._editor.recordUndo(new l(this._tree_updater,e.node))},s.inherit(a,o.Undo),a.prototype.undo=function(){if(this._node)throw new Error("undo called twice in a row");var e=this._tree_updater.pathToNode(this._parent_path);this._node=i(e.childNodes[this._index]).clone().get(0),this._tree_updater.deleteNode(e.childNodes[this._index])},a.prototype.redo=function(){if(!this._node)throw new Error("redo called twice in a row");var e=this._tree_updater.pathToNode(this._parent_path);this._tree_updater.insertNodeAt(e,this._index,this._node),this._node=undefined},a.prototype.toString=function(){function e(e){return e?i(e).clone().wrap("<div>").parent().html()||i(e).text():"undefined"}return[this._desc,"\n"," Parent path: ",this._parent_path,"\n"," Index: ",this._index,"\n"," Node: ",e(this._node),"\n"].join("")},s.inherit(f,o.Undo),f.prototype.undo=function(){var e=this._tree_updater.pathToNode(this._node_path);this._tree_updater.setTextNodeValue(e,this._old_value)},f.prototype.redo=function(){var e=this._tree_updater.pathToNode(this._node_path);this._tree_updater.setTextNodeValue(e,this._new_value)},f.prototype.toString=function(){return[this._desc,"\n"," Node path: ",this._node_path,"\n"," New value: ",this._new_value,"\n"," Old value: ",this._old_value,"\n"].join("")},s.inherit(l,o.Undo),l.prototype.undo=function(){if(!this._node)throw new Error("undo called twice in a row");var e=this._tree_updater.pathToNode(this._parent_path);this._tree_updater.insertNodeAt(e,this._index,this._node),this._node=undefined},l.prototype.redo=function(){if(this._node)throw new Error("redo called twice in a row");var e=this._tree_updater.pathToNode(this._parent_path);this._node=i(e.childNodes[this._index]).clone().get(0),this._tree_updater.deleteNode(e.childNodes[this._index])},l.prototype.toString=function(){function e(e){return e?i(e).clone().wrap("<div>").parent().html()||i(e).text():"undefined"}return[this._desc,"\n"," Parent path: ",this._parent_path,"\n"," Index: ",this._index,"\n"," Node: ",e(this._node),"\n"].join("")},t.UndoRecorder=u}),define("wed/key",["require","exports","module"],function(e,t,n){function i(e,t,n,s,o,u,a){t=!!t,o=!!o,u=!!u,a=!!a;var f=[e,n,s,o,u,a,t].join(","),l=i.__cache[f];return l!==undefined?l:(this.which=e,this.keyCode=n,this.charCode=s,this.ctrlKey=o,this.altKey=u,this.metaKey=a,this.keypress=t,this.hash_key=f,this._id=r++,i.__cache[f]=this,this)}function s(e){return o(e,!1,undefined,undefined,!0,!1,!1)}function o(e,t,n,r,s,o,u){if(typeof e=="string"){if(e.length!==1)throw new Error("when the first parameter is a string, a one-character string is required");e=e.charCodeAt(0)}else if(typeof e!="number")throw new Error("the first parameter must be a string or number");t===undefined?t=!0:t=!!t;if(n===undefined||n===null)n=e;if(r===undefined||r===null)r=t?e:0;return s=!!s,o=!!o,u=!!u,new i(e,t,n,r,s,o,u)}var r=0;i.__cache={},i.prototype.matchesEvent=function(e){return e.which===this.which&&e.keyCode===this.keyCode&&e.charCode===this.charCode&&e.ctrlKey===this.ctrlKey&&e.altKey===this.altKey&&e.metaKey===this.metaKey&&(this.keypress?e.type==="keypress":e.type==="keydown"||e.type==="keyup")},i.prototype.setEventToMatch=function(e){e.which=this.which,e.keyCode=this.keyCode,e.charCode=this.charCode,e.ctrlKey=this.ctrlKey,e.altKey=this.altKey,e.metaKey=this.metaKey,this.keypress?e.type="keypress":e.type="keydown"},i.prototype.hash=function(){return this._id},i.prototype.anyModifier=function(){return this.ctrlKey||this.altKey||this.metaKey},t.makeKey=o,t.makeCtrlKey=s,t.Key=i}),define("wed/key_constants",["require","exports","module","./key"],function(e,t,n){var r=e("./key");t.CTRL_S=r.makeCtrlKey("S"),t.CTRL_Z=r.makeCtrlKey("Z"),t.CTRL_Y=r.makeCtrlKey("Y"),t.CTRL_C=r.makeCtrlKey("C"),t.CTRL_X=r.makeCtrlKey("X"),t.CTRL_FORWARD_SLASH=r.makeCtrlKey(191),t.CTRL_PERIOD=r.makeCtrlKey(190),t.CTRL_BACKQUOTE=r.makeCtrlKey(192),t.CTRL_OPEN_BRACKET=r.makeCtrlKey(219),t.CTRL_CLOSE_BRACKET=r.makeCtrlKey(221),t.LEFT_ARROW=r.makeKey(37,!1),t.RIGHT_ARROW=r.makeKey(39,!1),t.BACKSPACE=r.makeKey(8,!1),t.DELETE=r.makeKey(46,!1),t.ENTER=r.makeKey(13,!1),t.SPACE=r.makeKey(32,!1),t.ESCAPE=r.makeKey(27,!1),t.EDITING_KEYS=[t.LEFT_ARROW,t.RIGHT_ARROW,t.BACKSPACE,t.DELETE,t.ENTER]}),define("wed/lib/conditioned",["require","exports","module"],function(e,t,n){function r(){this._conditions={}}r.prototype._setCondition=function(e,t){this._conditions[e]===undefined&&(this._conditions[e]=!0,this._emit(e,t))},r.prototype.getCondition=function(e){return this._conditions[e]},r.prototype.whenCondition=function(e,t){this._conditions[e]?t():this.addOneTimeEventListener(e,t)},t.Conditioned=r}),define("wed/gui/modal",["require","exports","module","jquery","../util","../log","bootstrap"],function(e,t,n){function o(){this._$dom=r('<div class="modal" style="position: absolute" tabindex="1">  <div class="modal-dialog">    <div class="modal-content">      <div class="modal-header">        <button type="button" class="close" data-dismiss="modal"          aria-hidden="true">&times;</button>        <h3>Untitled</h3>      </div>      <div class="modal-body">        <p>No body.</p>      </div>      <div class="modal-footer">      </div>    </div>  </div></div>'),this._$header=this._$dom.find(".modal-header"),this._$body=this._$dom.find(".modal-body"),this._$footer=this._$dom.find(".modal-footer"),this._$dom.on("click",".btn",s.wrap(function(e){return this._$clicked=r(e.currentTarget),!0}.bind(this))),this._$dom.on("shown.bs.modal.modal",s.wrap(this._handleShown.bind(this))),this._$clicked=undefined}var r=e("jquery"),i=e("../util"),s=e("../log");e("bootstrap"),o.prototype.getTopLevel=function(){return this._$dom},o.prototype.setTitle=function(e){this._$header.find("h3").remove();var t=r("<h3>");t.append(e),this._$header.append(t)},o.prototype.setBody=function(e){this._$body.empty(),this._$body.append(e)},o.prototype.setFooter=function(e){this._$footer.empty(),this._$footer.append(e)},o.prototype.addButton=function(e,t){var n=r('<a href="#" class="btn" data-dismiss="modal">'+e+"</a>");return n.addClass(t?"btn-primary":"btn-default"),this._$footer.append(n),n},o.prototype.addOkCancel=function(){return[this.addButton("Ok",!0),this.addButton("Cancel")]},o.prototype.addYesNo=function(){return[this.addButton("Yes",!0),this.addButton("No")]},o.prototype.getPrimary=function(){return this._$footer.find(".btn-primary")},o.prototype.modal=function(e){this._$clicked=undefined,e&&this._$dom.one("hidden.bs.modal.modal",s.wrap(e)),this._$dom.modal()},o.prototype.getClicked=function(){return this._$clicked},o.prototype.getClickedAsText=function(){return this._$clicked===undefined?undefined:this._$clicked.text()},o.prototype._handleShown=function(e){var t=this._$dom.parent().height();this._$body.css("max-height",t-this._$header.height()-this._$footer.height())},t.Modal=o}),define("wed/gui/context_menu",["require","exports","module","jquery","../util","../log","bootstrap"],function(e,t,n){function o(e,t,n,i,s,o){var u=r("<div class='dropdown wed-context-menu' style='visibility: hidden'>");u.append(r('<a href="#" data-toggle="dropdown"></a>'));var a=r("<ul tabindex='0' class='dropdown-menu' role='menu'>");u.append(a),t-=5,n-=5,u.css("top",n),u.css("left",t),a.css("max-height",i),a.append(r(s)),this._$backdrop=r('<div class="wed-context-menu-backdrop"/>'),this._$body=r("body",e),this._$body.prepend(u),this._$body.prepend(this._$backdrop);var f=a.outerWidth(),l=r(e.defaultView).width();u.css("left",Math.max(0,Math.min(t,l-f))),u.css("visibility",""),this._$backdrop.click("mousedown",this._backdrop_click_handler.bind(this)),a.on("click",this._contents_click_handler.bind(this)),a.on("mousedown",function(e){e.stopPropagation()}.bind(this)),a.on("contextmenu",!1),a.dropdown("toggle"),this._$dropdown=u,this._dismiss_callback=o,this._dismissed=!1}var r=e("jquery"),i=e("../util"),s=e("../log");e("bootstrap"),o.prototype._contents_click_handler=function(e){return this.dismiss(),e.stopPropagation(),e.preventDefault(),!1},o.prototype._backdrop_click_handler=function(){return this.dismiss(),!1},o.prototype.dismiss=function(){if(this._dismissed)return;this._$dropdown.remove(),this._$backdrop.remove(),this._dismiss_callback&&this._dismiss_callback(),this._dismissed=!0},t.ContextMenu=o}),define("wed/exceptions",["require","exports","module","./oop"],function(e,t,n){function i(){Error.apply(this,arguments)}var r=e("./oop");r.inherit(i,Error),t.AbortTransformationException=i}),define("wed/onerror",["require","exports","module","./log","jquery"],function(e,t,n){function f(){d=!1,v&&(m.clearTimeout(v),v=undefined),a.off(),a.remove()}function l(){return d}function c(e){g(e)}function g(e){function r(e,r,s){function g(){v&&t.clearTimeout(v);if(f===1)c.push(y(undefined,l[0]?l[0][1]:undefined));else for(var e=0,n;(n=l[e])!==undefined;++e)c.push(y(h[n[0]].name,n[1]));u("body").append(a),a.find(".modal-body").contents().replaceWith(c.join("")),a.on("hide.bs.modal.modal",function(){a.remove(),t.location.reload()}),a.modal()}function b(e){l.push([this,e]),l.length===f&&g()}if(d)return!1;d=!0;var f=h.length,l=[],c=[];v=t.setTimeout(g,p),m=t,o.error(e,r,s);try{n&&!i&&n.apply(undefined,arguments)}finally{for(var w=0,E;(E=h[w])!==undefined;++w){var S=E._saver;S.recover(b.bind(w))}return!1}}var t=e;while(t!==t.parent)t=t.parent;t!==e&&g(t);if(e.wed_installed_onerror===e.onerror)return;var n=e.onerror;e.onerror=r,e.wed_installed_onerror=r}function y(e,t){var n=["<p>",e||"Your editor"];n.push(" experienced a severe error.");switch(t){case!0:n.push(" However, it successfully saved the latest state of your data to the server. Please reload.");break;case!1:case undefined:n.push(" It was not able to save your data to the server before terminating.")}return n.push("</p>"),n.join("")}var r=n.config(),i=r&&r.suppress_old_onerror,s=r&&r.test,o=e("./log"),u=e("jquery"),a=u('<div class="modal wed-fatal-modal" style="position: absolute" tabindex="1">  <div class="modal-dialog">    <div class="modal-content">      <div class="modal-header">        <button type="button" class="close" data-dismiss="modal"aria-hidden="true">&times;</button>        <h3>Fatal Error</h3>      </div>      <div class="modal-body">      </div>      <div class="modal-footer">        <a href="#" class="btn btn-primary" data-dismiss="modal">Reload</a>      </div>    </div>  </div></div>');s&&(t.__test={$modal:a,reset:f,is_terminating:l}),g(window),t.register=c;var h=[],p=5e3,d=!1,v,m;t.editors=h}),define("wed/build-info",[],function(){return{desc:"v0.10.0-x-132-g16eeb61",date:"Sat Nov 23 2013 16:19:29 GMT-0500 (EST)"}}),define("wed/object_check",["require","exports","module"],function(e,t,n){function r(e,t){var n=e[t];if(n instanceof Array||typeof n!="object")return n;for(var i in n)if(r(n,i))return!0;return!1}function i(e,t){var n={missing:[],extra:[]};s(e,t,undefined,n);for(var r in n)n[r].length||delete n[r];return n}function s(e,t,n,i){var o,u;for(o in e)if(r(e,o)){u=n?[n,o].join("."):o;if(o in t){var a=t[o];!(a instanceof Array)&&typeof a=="object"&&s(e[o],a,u,i)}else i.missing.push(u)}for(o in t)o in e||(u=n?[n,o].join("."):o,i.extra.push(u))}t.check=i}),define("wed/onbeforeunload",["require","exports","module"],function(e,t,n){function s(e){e.onbeforeunload=function(){return"Do you really want to navigate away from this page?"}}var r=n.config(),i=r&&r.test;i||s(window)}),define("wed/wed",["require","exports","module","jquery","./log","./saver","rangy","./validator","./util","salve/name_resolver","./domutil","./mutation_domlistener","./updater_domlistener","./transformation","salve/validate","./oop","./undo","./wundo","./jqutil","./tree_updater","./gui_updater","./undo_recorder","./key_constants","./lib/simple_event_emitter","./lib/conditioned","./gui/modal","./gui/context_menu","./exceptions","./onerror","./key","./build-info","./dloc","./object_check","bootstrap","jquery.bootstrap-growl","./onbeforeunload"],function(e,t,n){function q(){T.call(this),N.call(this),this._mode_data={},this._development_mode=!1,this._text_undo_max_length=10,A.editors.push(this)}function R(e,t){var n=e.getDOMSelectionRange();if(!c.isWellFormedRange(n))throw new Error("malformed range");var r=e.toDataLocation(n.startContainer,n.startOffset),i=e.toDataLocation(n.endContainer,n.endOffset),s=e.data_updater.cut(r,i);e._$cut_buffer.empty(),e._$cut_buffer.append(s[1]),e.setDataCaret(s[0]),n=e.my_window.document.createRange();var o=e._$cut_buffer[0];n.setStart(o,0),n.setEnd(o,o.childNodes.length);var u=e.my_window.getSelection();u.removeAllRanges(),u.addRange(n)}function U(e,t){var n=t.$data,r=n.clone(),i=e.getDataCaret(),s=n.get(0),o,u;if(s.childNodes.length===1&&s.firstChild.nodeType===Node.TEXT_NODE)u=e.data_updater.insertText(i,s.firstChild.nodeValue),o=u[0]===u[1]?i.make(i.node,i.offset+s.firstChild.nodeValue.length):i.make(u[1],u[1].nodeValue.length);else{var a=document.createDocumentFragment();n.contents().each(function(){a.appendChild(this)});switch(i.node.nodeType){case Node.TEXT_NODE:var f=i.node.parentNode;u=e.data_updater.insertIntoText(i,a),o=u[1];break;case Node.ELEMENT_NODE:var l=i.node.childNodes[i.offset],c=l?l.nextSibling:null;e.data_updater.insertBefore(i.node,a,l),o=i.make(i.node,c?j.call(i.node.childNodes,c):i.node.childNodes.length);break;default:throw new Error("unexpected node type: "+i.node.nodeType)}}e.setDataCaret(o),e.$gui_root.trigger("wed-post-paste",[t.e,i,r])}function X(e){e.data.editor.destroy()}var r=e("jquery"),i=e("./log"),s=e("./saver"),o=e("rangy"),u=e("./validator"),a=u.Validator,f=e("./util"),l=e("salve/name_resolver"),c=e("./domutil"),h=e("./mutation_domlistener"),p=e("./updater_domlistener"),d=e("./transformation"),v=e("salve/validate"),m=e("./oop"),g=e("./undo"),y=e("./wundo"),b=e("./jqutil"),w=e("./tree_updater").TreeUpdater,E=e("./gui_updater").GUIUpdater,S=e("./undo_recorder").UndoRecorder,x=e("./key_constants"),T=e("./lib/simple_event_emitter").SimpleEventEmitter,N=e("./lib/conditioned").Conditioned,C=e("./gui/modal"),k=e("./gui/context_menu"),L=e("./exceptions"),A=e("./onerror"),O=e("./key"),M=e("./build-info"),_=L.AbortTransformationException,D=e("./dloc"),P=e("./object_check"),H=D.makeDLoc,B=D.DLoc;e("bootstrap"),e("jquery.bootstrap-growl"),e("./onbeforeunload");var j=Array.prototype.indexOf;t.version="0.10.0";var F=t.version,I=f.getOriginalName;m.implement(q,T),m.implement(q,N),q.prototype.init=i.wrap(function(t,o){this.max_label_level=undefined,this._current_label_level=undefined,this.widget=t,this.$widget=r(this.widget),this.$frame=this.$widget.closest("html"),this.my_window=this.$frame.get(0).ownerDocument.defaultView,A.register(this.my_window),o=r.extend(!0,{},n.config(),o),this.name=o.name,o.ajaxlog&&i.addURL(o.ajaxlog.url,o.ajaxlog.headers),this._save=o.save,this._first_validation_complete=!1,this._destroying=!1,this._destroyed=!1,this.options=o;var u=r('<div class="row"> <div class="wed-frame col-sm-push-2 col-lg-10 col-md-10 col-sm-10">  <div class="row">   <div class="progress">    <span></span>    <div id="validation-progress" class="progress-bar" style="width: 0%"/>   </div>  </div>  <div class="row">   <div class="wed-cut-buffer" contenteditable="true"></div>   <div class="wed-document-constrainer">    <div class="wed-caret-layer">     <input class="wed-comp-field" type="text"></input>    </div>    <div class="wed-document"><span class="root-here"/></div>   </div>   <div class="wed-location-bar"></div>  </div> </div> <div id="sidebar" class="col-sm-pull-10 col-lg-2 col-md-2 col-sm-2"/></div>');this.$gui_root=u.find(".wed-document"),this.gui_root=this.$gui_root.get(0),this.$sidebar=u.find("#sidebar"),this.$validation_progress=u.find("#validation-progress"),this.$validation_message=this.$validation_progress.prev("span"),this._$input_field=u.find(".wed-comp-field"),this._$cut_buffer=u.find(".wed-cut-buffer"),this._caret_layer=u.find(".wed-caret-layer").get(0),this._$caret_layer=r(this._caret_layer);var a=u.find(".root-here");t.firstChild?a.replaceWith(t.firstChild):a.remove(),this.$widget.append(u),this._$wed_location_bar=u.find(".wed-location-bar"),this.$data_root=this.$gui_root.clone(),this.data_root=this.$data_root.get(0),this.$data_root.css("display","none"),D.markRoot(this.gui_root),D.markRoot(this.data_root);var f=this.widget.ownerDocument.createDocumentFragment();f.appendChild(this.data_root),c.linkTrees(this.data_root,this.gui_root),this.data_updater=new w(this.data_root),this._gui_updater=new E(this.gui_root,this.data_updater),this._undo_recorder=new S(this,this.data_updater),this._save&&this._save.url?(this._saver=new s.Saver(this._save.url,this._save.headers,F,this.data_updater,this.data_root),this._saver.addEventListener("saved",this._onSaverSaved.bind(this)),this._saver.addEventListener("failed",this._onSaverFailed.bind(this))):i.error("wed cannot save data due to the absence of a save_url option"),this.$sidebar.append('<div id="sidebar-panel" class="panel-group wed-sidebar-panel"> <div class="panel">  <div class="panel-heading">   <div class="panel-title">    <a class="accordion-toggle" data-toggle="collapse" data-parent="#sidebar-panel" href="#sb-nav-collapse">Navigation</a>   </div>  </div> <div id="sb-nav-collapse" data-parent="#sidebar-panel"   class="panel-collapse collapse in">   <div id="sb-nav" class="panel-body">    <ul id="navlist" class="nav nav-list">     <li class="inactive">A list of navigation links will appear here</li>    </ul>   </div>  </div> </div> <div class="panel">  <div class="panel-heading">   <div class="panel-title">    <a class="accordion-toggle" data-toggle="collapse"data-parent="#sidebar-panel"href="#sb-errors-collapse">Errors</a>   </div>  </div>  <div id="sb-errors-collapse" data-parent="#sidebar-panel"class="panel-collapse collapse">   <div id="sb-errors" class="panel-body">    <ul id="sb-errorlist" class="nav nav-list wed-errorlist">     <li class="inactive"></li>    </ul>   </div>  </div> </div></div>'),this._current_dropdown=undefined,this._$fake_caret=r("<span class='_wed_caret' contenteditable='false'> </span>"),this._fake_caret=undefined,this._refreshing_caret=0,this._limitation_modal=new C.Modal,this._limitation_modal.setTitle("Cannot proceed"),this._limitation_modal.addButton("Reload",!0),this._paste_modal=this.makeModal(),this._paste_modal.setTitle("Invalid structure"),this._paste_modal.setBody("<p>The data you are trying to paste appears to be XML.         However, pasting it here will result in a structurally invalid         document. Do you want to paste it as text instead? (If you answer         negatively, the data won't be pasted at all.)<p>"),this._paste_modal.addYesNo(),this.straddling_modal=this.makeModal(),this.straddling_modal.setTitle("Invalid modification"),this.straddling_modal.setBody("<p>The text selected straddles disparate elements of the document.         You may be able to achieve what you want to do by selecting         smaller sections.<p>"),this.straddling_modal.addButton("Ok",!0),this.help_modal=this.makeModal(),this.help_modal.setTitle("Help"),this.help_modal.setBody("<ul>          <li>Clicking the right mouse button on the document contents brings up a contextual menu.</li>          <li>Clicking the right mouse button on the links in the navigation panel brings up a contextual menu.</li>          <li>F1: help</li>          <li>Ctrl-[: Decrease the label visibility level.</li>          <li>Ctrl-]: Increase the label visibility level.</li>          <li>Ctrl-S: Save</li>          <li>Ctrl-X: Cut</li>          <li>Ctrl-V: Paste</li>          <li>Ctrl-C: Copy</li>          <li>Ctrl-Z: Undo</li>          <li>Ctrl-Y: Redo</li>          <li>Ctrl-/: Bring up a contextual menu.</li>        </ul>        <p class='wed-build-info'>Build descriptor: "+M.desc+"<br/>        Build date: "+M.date+"</p>        "),this.help_modal.addButton("Close",!0),this.$navigation_list=this.$widget.find("#navlist"),this._raw_caret=undefined,this._sel_anchor=undefined,this._sel_focus=undefined,this._selection_stack=[];var l=e.toUrl("font-awesome/css/font-awesome.min.css");this.$frame.children("head").prepend('<link rel="stylesheet" href="'+l+'" type="text/css" />');var v=e.toUrl("bootstrap/../../css/bootstrap.min.css");this.$frame.children("head").prepend('<link rel="stylesheet" href="'+v+'" type="text/css" />'),this.validation_domlistener=new h.Listener(this.$data_root),this.gui_domlistener=new p.Listener(this.gui_root,this._gui_updater),r(this.my_window).on("unload.wed",{editor:this},X),r(this.my_window).on("popstate",function(e){document.location.hash===""&&this.$gui_root.scrollTop(0)}.bind(this)),this._last_done_shown=0,this.$error_list=this.$widget.find("#sb-errorlist"),this._validation_errors=[],this._undo=new g.UndoList,this.mode_path=o.mode.path,this.paste_tr=new d.Transformation(this,"Paste",U),this.cut_tr=new d.Transformation(this,"Cut",R),this.split_node_tr=new d.Transformation(this,"Split <element_name>",function(e,t){return d.splitNode(e,t.node)}),this.merge_with_previous_homogeneous_sibling_tr=new d.Transformation(this,"Merge <element_name> with previous",function(e,t){return d.mergeWithPreviousHomogeneousSibling(e,t.node)}),this.merge_with_next_homogeneous_sibling_tr=new d.Transformation(this,"Merge <element_name> with next",function(e,t){return d.mergeWithNextHomogeneousSibling(e,t.node)}),this.setMode(this.mode_path,o.mode.options)}),q.prototype.setMode=i.wrap(function(t,n){var r=function(e){e.Mode.optionResolver(n,function(t){this.onModeChange(new e.Mode(t))}.bind(this))}.bind(this);e([t],r,function(n){if(t.indexOf("/")!==-1)throw new Error("can't load mode "+t);var i="./modes/"+t+"/"+t;e([i],r,function(t){e([i+"_mode"],r)})})}),q.prototype.onModeChange=i.wrap(function(t){if(this._destroyed)return;this.mode=t,t.init(this);var n=t.getWedOptions();if(!this._processWedOptions(n))return;var r=this.mode.getStylesheets();for(var i=0,s;(s=r[i])!==undefined;++i)this.$frame.children("head").append('<link rel="stylesheet" href="'+e.toUrl(s)+'" type="text/css" />');this.$gui_root.css("overflow-y","auto"),this._resizeHandler(),this.$gui_root.attr("tabindex","-1"),this.$gui_root.focus(),this.resolver=t.getAbsoluteResolver(),this.validator=new a(this.options.schema,this.data_root),this.validator.addEventListener("state-update",this._onValidatorStateChange.bind(this)),this.validator.addEventListener("error",this._onValidatorError.bind(this)),this.validator.addEventListener("reset-errors",this._onResetErrors.bind(this)),this.validator.initialize(this._postInitialize.bind(this))}),q.prototype._processWedOptions=function(e){var t=function(){return this._limitation_modal.setBody("<p>The mode you are trying to use is passing incorrect options to wed. Contact the mode author with the following information: </p><ul><li>"+i.join("</li><li>")+"</li></ul>"),this._limitation_modal.modal(function(){window.location.reload()}),this.destroy(),!1}.bind(this),n={metadata:{name:!0,authors:!0,description:!0,license:!0,copyright:!0},label_levels:{max:!0,initial:!0}},r=P.check(n,e),i=[],s;r.missing&&r.missing.forEach(function(e){i.push("missing option: "+e)}),r.extra&&r.extra.forEach(function(e){i.push("extra option: "+e)});if(i.length)return t();this.max_label_level=e.label_levels.max,this.max_label_level<1&&i.push("label_levels.max must be >= 1"),this._current_label_level=this.max_label_level;var o=e.label_levels.initial;o>this.max_label_level&&i.push("label_levels.initial must be < label_levels.max"),o<1&&i.push("label_levels.initial must be >= 1");while(this._current_label_level>o)this.decreaseLabelVisiblityLevel();return i.length?t():!0},q.prototype._postInitialize=i.wrap(function(){if(this._destroyed)return;this.validation_domlistener.addHandler("children-changed","._real, ._phantom_wrap, .wed-document",function(e,t,n,r,i,s){if(t.is("._real, ._phantom_wrap")||t.filter(b.textFilter).length||n.is("._real, ._phantom_wrap")||n.filter(b.textFilter).length)this._last_done_shown=0,this.validator.restartAt(s.get(0))}.bind(this)),this.validation_domlistener.startListening(),this.decorator=this.mode.makeDecorator(this.gui_domlistener,this,this._gui_updater),this.decorator.addHandlers(),this.gui_domlistener.addHandler("children-changed","*",function(e,t,n,r,i,s){var o=t.add(n);if(this._refreshing_caret)return;this.gui_domlistener.trigger("refresh-caret")}.bind(this)),this.gui_domlistener.addHandler("text-changed","*",function(){if(this._refreshing_caret)return;this.gui_domlistener.trigger("refresh-caret")}.bind(this)),this.gui_domlistener.addHandler("included-element","._label",function(e,t,n,r,i,s){var o=s[0].classList,u=!1;for(var a=0;a<o.length&&!u;++a)o[a].lastIndexOf("_label_level_",0)===0&&(u=Number(o[a].slice(13)));if(!u)throw new Error("unable to get level");u>this._current_label_level?s.hide():s.show()}.bind(this)),this.gui_domlistener.addHandler("trigger","refresh-caret",function(){this._refreshFakeCaret()}.bind(this)),this._updating_placeholder=0,this.gui_domlistener.addHandler("children-changed","._real, ._phantom_wrap",function(e,t,n,i,s,o){if(this._updating_placeholder)return;this._updating_placeholder++;try{var u=o.contents().filter(function(){return b.textFilter.call(this)||r(this).is("._real, ._phantom._text, ._phantom_wrap")}),a;if(u.length===0||u.length===1&&u.is(n)){if(o.children("._placeholder").length!==0)return;var f=o.get(0),l=this.mode.nodesAroundEditableContents(f);a=this.mode.makePlaceholderFor(f).get(0),this._gui_updater.insertBefore(f,a,l[1])}else a=o.children("._placeholder").not("._transient")[0],a&&this._gui_updater.removeNode(a)}finally{this._updating_placeholder--}}.bind(this)),this.gui_domlistener.addHandler("included-element","._real, ._phantom_wrap",function(e,t,n,i,s,o){if(this._updating_placeholder)return;if(o.children("._placeholder").length!==0)return;this._updating_placeholder++;try{var u=o.contents().filter(function(){return b.textFilter.call(this)||r(this).is("._real, ._phantom._text, ._phantom_wrap")});if(u.length===0){var a=o.get(0),f=this.mode.nodesAroundEditableContents(a),l=this.mode.makePlaceholderFor(a).get(0);this._gui_updater.insertBefore(a,l,f[1])}}finally{this._updating_placeholder--}}.bind(this)),this.gui_domlistener.addHandler("excluded-element","*",function(e,t,n,i,s,o){o.is("._placeholder")&&o.addClass("_dying");if(!this._raw_caret)return;var u=this._raw_caret.node,a=r(u);if(a.closest(o).length>0){var f=n.get(0);i.length>0&&i.closest(e).length>0&&n.closest(e).length>0?this.setGUICaret(f,j.call(f.childNodes,i.get(0))+1):s.length>0&&s.closest(e).length>0&&n.closest(e).length>0?this.setGUICaret(f,j.call(f.childNodes,s.get(0))):n.closest(e).length>0?this.setGUICaret(f,f.childNodes.length):(this._setFakeCaretTo(),this._raw_caret=undefined)}}.bind(this)),this.decorator.startListening(this.$gui_root),this.$gui_root.on("dragenter",!1),this.$gui_root.on("dragover",!1),this.$gui_root.on("drop",!1),this.$gui_root.on("wed-global-keydown",this._globalKeydownHandler.bind(this)),this.$gui_root.on("wed-global-keypress",this._globalKeypressHandler.bind(this)),this.$gui_root.on("keydown",this._keydownHandler.bind(this)),this.$gui_root.on("keypress",this._keypressHandler.bind(this)),this.$gui_root.on("scroll",this._refreshFakeCaret.bind(this)),this._$input_field.on("keydown",this._keydownHandler.bind(this)),this._$input_field.on("keypress",this._keypressHandler.bind(this)),this._$input_field.on("compositionstart compositionupdate compositionend",this._compositionHandler.bind(this)),this._$input_field.on("input",this._inputHandler.bind(this)),this.$gui_root.on("mousedown",this._mousedownHandler.bind(this)),this.$gui_root.on("caretchange",this._caretChangeHandler.bind(this)),this.$gui_root.on("contextmenu",!1),this.$gui_root.on("paste",i.wrap(this._pasteHandler.bind(this))),this.$gui_root.on("cut",i.wrap(this._cutHandler.bind(this))),r(this.my_window).on("resize.wed",this._resizeHandler.bind(this)),this.$gui_root.on("focus",i.wrap(function(e){this._focusInputField(),e.preventDefault(),e.stopPropagation()}.bind(this))),this.$gui_root.on("click","a",function(e){return e.ctrlKey?window.location=e.currentTarget.href:this._caretChangeEmitter(),!1}.bind(this)),r("body",this.my_window.document).on("mouseup.wed",function(e){this.$gui_root.off("mousemove.wed mouseup"),this._$caret_layer.off("mousemove mouseup")}.bind(this)),this._$caret_layer.on("mousedown click contextmenu",this._caretLayerMouseHandler.bind(this)),this.$widget.removeClass("loading"),this.$widget.css("display","block");if(this.gui_root.childNodes.length===0){var e=Object.create(null);this.validator.getSchemaNamespaces().forEach(function(t){var n=this.resolver.prefixFromURI(t);n===""?e.xmlns=t:e["xmlns:"+n]=t}.bind(this));var t=this.validator.possibleAt(this.data_root,0).toArray();t.length===1&&t[0].params[0]==="enterStartTag"&&d.insertElement(this.data_updater,this.data_root,0,this.resolver.unresolveName(t[0].params[1],t[0].params[2]),e)}else{var n=this.validator.getDocumentNamespaces(),s=!1,o=this.resolver;Object.keys(n).forEach(function(e){var t=n[e];t.length>1&&(s=!0),o.definePrefix(e,t[0])});if(s){this._limitation_modal.setBody("The document you are trying to edit uses namespaces in a way not supported by this version of wed."),this._limitation_modal.modal(function(){var e=window.location.search;if(!e)window.location.reload();else{e=e.slice(1);var t=e.split("&");e="?";for(var n=0;n<t.length;++n){var r=t[n];r.lastIndexOf("file=",0)!==0&&(e+=r,n<t.length-1&&(e+="&"))}window.location.search=e}}),this.destroy();return}}this.validator.start(),this.gui_domlistener.processImmediately(),this._undo=new g.UndoList,this._setCondition("initialized",{editor:this})}),q.prototype.fireTransformation=function(e,t){this.dismissContextMenu();var n=this._undo.getGroup();n instanceof y.TextUndoGroup&&this._undo.endGroup(),this._undo.startGroup(new y.UndoGroup("Undo "+e.getDescriptionFor(t),this));try{try{var s=t.node;if(s!==undefined){var o=r(s);if(o.closest(this.$gui_root).length>0){var u=this.nodeToPath(s);t.node=this.data_updater.pathToNode(u)}else if(o.closest(this.$data_root).length===0)throw new Error("node is neither in the gui tree nor the data tree")}var a=t.move_caret_to;if(a)switch(a.root){case this.gui_root:this.setGUICaret(a);break;case this.data_root:this.setDataCaret(a);break;default:throw new Error("caret outside GUI and data trees")}if(this._raw_caret===undefined)throw new Error("transformation applied with undefined caret.");e.handler(this,t)}catch(f){throw f instanceof _||i.handle(f),f}finally{this._undo.endGroup()}}catch(f){this.undo();if(!(f instanceof _))throw f}},q.prototype.recordUndo=function(e){this._undo.record(e)},q.prototype.undo=function(){try{this._undo_recorder.suppressRecording(!0),this._undo.undo()}finally{this._undo_recorder.suppressRecording(!1)}},q.prototype.redo=function(){try{this._undo_recorder.suppressRecording(!0),this._undo.redo()}finally{this._undo_recorder.suppressRecording(!1)}},q.prototype.dumpUndo=function(){console.log(this._undo.toString())},q.prototype.undoMarker=function(e){this.recordUndo(new y.MarkerUndo(e))},q.prototype.undoingOrRedoing=function(){return this._undo.undoingOrRedoing()},q.prototype.resize=function(){this._resizeHandler()},q.prototype._resizeHandler=i.wrap(function(){function t(){e+=r(this).outerHeight(!0)}var e=0,n=this.$widget;while(n.length>0){var i=n.nextAll();i.each(t),n=n.parent()}var s=this.my_window.innerHeight-this.$gui_root.offset().top-e;this.$gui_root.css("max-height",s),this.$gui_root.css("min-height",s);var o=this.$gui_root.width(),u=this.$widget.find(".wed-frame"),a=u.outerHeight(!0);u.siblings().css("max-height",a).css("min-height",a).css("height",a);var f=this.$widget.find(".wed-sidebar-panel");f.css("max-height",a).css("min-height",a).css("height",a);var l=f.find(".panel"),c=l.children(".panel-heading"),h=0;c.each(function(){var e=r(this);h+=e.parent().outerHeight(!0)-e.parent().innerHeight(),h+=e.outerHeight(!0)});var p=a-h;l.each(function(){var e=r(this);e.css("max-height",p+e.children(".panel-heading").first().outerHeight(!0))});var d=l.find(".panel-body");d.css("height",p)}),q.prototype._contextMenuHandler=function(e){var t=r(e.target).closest("._placeholder");t.length>0&&this.setGUICaret(t.get(0).childNodes[0],0);var n=this._raw_caret;if(!n)return!0;var i=this.getDOMSelection(),s=this.getDOMSelectionRange(),o;if(s&&!s.collapsed){if(!c.isWellFormedRange(s))return!1;if(r(s.startContainer).closest(this.gui_root).length===0||r(s.endContainer).closest(this.gui_root).length===0)return!0;o=!1,s=s.cloneRange();var u=i.focusNode===s.startContainer&&i.focusOffset===s.startOffset;s.collapse(u),a=r(s.startContainer),f=s.startOffset}else a=r(n.node),f=n.offset,o=!0;var a,f;if(a.get(0).nodeType!==Node.ELEMENT_NODE){var l=a.parent().get(0);f=j.call(l.childNodes,a.get(0)),a=r(l)}var h=a.closest("._placeholder").get(0);h&&(f=j.call(h.parentNode.childNodes,h),a=r(h.parentNode));var p={};if(a.is("._phantom")){var d;while(a.is("._phantom"))d=a,a=a.parent();if(a.length&&a.closest(this.gui_root).length!==0){var v=d[0],m=this.mode.nodesAroundEditableContents(a[0]),g=a[0].childNodes;f=j.call(g,v);var y=m[0]&&j.call(g,m[0]),b=m[1]&&j.call(g,m[1]);y!==null&&f<=y&&(f=y+1),b!==null&&f>=b&&(f=b-1),p={move_caret_to:H(this.gui_root,a[0],f)}}else a=r()}var w=[],E;if(!a.hasClass("_phantom")&&a.parent("._gui").length===0){E=r(this.data_updater.pathToNode(this.nodeToPath(a.get(0))));var S=!o;this.validator.possibleAt(E.get(0),f).forEach(function(e){if(e.params[0]!=="enterStartTag")return;var t=this.resolver.unresolveName(e.params[1],e.params[2]),n=this.mode.getContextualActions(S?"wrap":"insert",t,E.get(0),f);if(n===undefined)return;for(var i=0,s;(s=n[i])!==undefined;++i){var o=r.extend({},p,{element_name:t}),u=s.getIcon(),a=r("<a tabindex='0' href='#'>"+(u?u+" ":"")+s.getDescriptionFor(o)+"</a>");a.click(o,s.bound_handler),w.push(r("<li></li>").append(a).get(0))}}.bind(this));if(E.get(0)!==this.data_root.childNodes[0]){var x=I(E.get(0)),T=this.mode.getContextualActions("delete-parent",x,E.get(0),0);T!==undefined&&T.forEach(function(e){var t=r.extend({},p,{node:E.get(0),element_name:x}),n=e.getIcon(),i=r("<a tabindex='0' href='#'>"+(n?n+" ":"")+e.getDescriptionFor(t)+"</a>");i.click(t,e.bound_handler),w.push(r("<li>").append(i).get(0))}.bind(this))}}var N=this.mode.getContextualMenuItems();N.forEach(function(e){var t=r("<a tabindex='0' href='#'>"+e[0]+"</a>");t.click(e[1],e[2]),w.push(r("<li>").append(t).get(0))});var C=a.parents().addBack().siblings("[data-wed--separator-for]").first(),k=a.get(0),L=C.siblings().filter(function(){return this===k||r(this).has(k).length>0}),A=C.attr("data-wed--separator-for");if(A!==undefined){var T=this.mode.getContextualActions(["merge-with-next","merge-with-previous","append","prepend"],A,L.get(0),0);T.forEach(function(e){var t={node:L.get(0),element_name:A},n=r("<a tabindex='0' href='#'>"+e.getDescriptionFor(t)+"</a>");n.click(t,e.bound_handler),w.push(r("<li></li>").append(n).get(0))}.bind(this))}if(w.length===0)return!0;var O;if(e.type==="mousedown"||e.type==="mouseup"||e.type==="click")O={left:e.clientX,top:e.clientY};else if(this._fake_caret){var M=this._positionFromGUIRoot(this._$fake_caret);this.scrollIntoView(M.left,M.top,M.left+this._$fake_caret.outerWidth(),M.top+this._$fake_caret.outerHeight()),O=this._$fake_caret.offset(),O.left-=r(this.my_window.document).scrollLeft(),O.top-=r(this.my_window.document).scrollTop(),O.top+=this._$fake_caret.height()/2}else{if(!s)throw new Error("no position for displaying the menu");O=s.getBoundingClientRect(),this.scrollIntoView(O.left,O.top,O.left+O.right/2,O.top+O.bottom/2),O=s.getBoundingClientRect(),O.left-=r(this.my_window.document).scrollLeft(),O.top-=r(this.my_window.document).scrollTop(),O.top+=O.height/2}return this.displayContextMenu(O.left,O.top,w),!1},q.prototype._cutHandler=function(e){if(this.getDataCaret()===undefined)return!1;var t=this.getDOMSelectionRange();return c.isWellFormedRange(t)?(this.fireTransformation(this.cut_tr,{e:e}),!0):(this.straddling_modal.modal(),!1)},q.prototype._pasteHandler=function(e){var t=this.getDataCaret();if(t===undefined)return!1;var n=e.originalEvent.clipboardData,i=j.call(n.types,"text/html")>-1,s=r("<div class='_real'>");if(i){s.append(n.getData("text/html")),s.find("._phantom_wrap").each(function(){var e=r(this);e.replaceWith(e.contents())}),s.children("span").each(function(){r(this).replaceWith(this.childNodes)}),s.find(":not(._real)").remove();if(s.contents().length===0)i=!1;else{var o=this.validator.speculativelyValidate(t,s.contents().toArray());if(o)return this._paste_modal.modal(function(){this._paste_modal.getClickedAsText()==="Yes"&&(s=r("<div class='_real'>"),s.append(document.createTextNode(n.getData("text/plain"))),this.fireTransformation(this.paste_tr,{node:t.node,$data:s,e:e}))}.bind(this)),!1}}return i||(s=r("<div class='_real'>"),s.append(n.getData("text/plain"))),this.fireTransformation(this.paste_tr,{node:t.node,$data:s,e:e}),!1},q.prototype.caretPositionRight=function(){return this.positionRight(this._raw_caret)},q.prototype.positionRight=function(e){if(e===undefined||e===null)return undefined;var t=r(e.node).closest("._gui").get(0);t!==undefined&&(e=e.make(t,t.childNodes.length));var n=r(e.node).closest("._placeholder").get(0);n!==undefined&&(e=e.make(n.parentNode,j.call(n.parentNode.childNodes,n)+1));for(;;){e=e.make(c.nextCaretPosition(e.toArray(),this.gui_root.childNodes[0],!1));if(!e)break;var i=r(e.node);t=i.closest("._gui").get(0);if(t!==undefined){e=e.make(t,0);break}var s=i.closest("._phantom").get(0);if(s){e=e.make(s,s.childNodes.length);continue}var n=i.closest("._placeholder").get(0);if(n&&e.offset>0){e=e.make(n,n.childNodes.length);continue}if(e.node.nodeType===Node.ELEMENT_NODE){var o=e.node.childNodes[e.offset],u=e.node.childNodes[e.offset-1],a=r(o),f=r(u);if(o!==undefined&&o.nodeType===Node.ELEMENT_NODE&&!a.is("._gui.__end_label")&&!f.is("._gui.__start_label")||f.is("._wed-validation-error, ._gui.__end_label"))continue}break}return e||undefined},q.prototype.caretPositionLeft=function(){return this.positionLeft(this._raw_caret)},q.prototype.positionLeft=function(e){if(e===undefined||e===null)return undefined;var t=r(e.node).closest("._gui").get(0);t!==undefined&&(e=e.make(t,0));var n=r(e.node).closest("._placeholder").get(0);n!==undefined&&(e=e.make(n.parentNode,j.call(n.parentNode.childNodes,n)));for(;;){e=e.make(c.prevCaretPosition(e.toArray(),this.gui_root.childNodes[0],!1));if(!e)break;var i=r(e.node);t=i.closest("._gui").get(0);if(t!==undefined){e=e.make(t,0);break}var s=i.closest("._placeholder");if(s.length>0){e=e.make(s.get(0).childNodes[0],0);break}var o=i.closest("._phantom").get(0);if(o!==undefined){e=e.make(o,0);continue}if(e.node.nodeType===Node.ELEMENT_NODE){var u=e.node.childNodes[e.offset-1],a=e.node.childNodes[e.offset],f=r(a),l=r(u);if(u!==undefined&&u.nodeType===Node.ELEMENT_NODE&&!l.is("._gui.__start_label")&&!f.is("._gui.__end_label")||f.is("._gui.__start_label, .wed-validation-error"))continue}break}return e||undefined},q.prototype.moveCaretRight=function(){var e=this.caretPositionRight();e&&this.setGUICaret(e)},q.prototype.moveCaretLeft=function(){var e=this.caretPositionLeft();e&&this.setGUICaret(e)},q.prototype.scrollIntoView=function(e,t,n,r){var i=this.$gui_root.scrollTop(),s=this.$gui_root.height(),o=i+s;if(t<i||r>o)i=t<i?t:r-s,this.$gui_root.scrollTop(i);var u=this.$gui_root.scrollLeft(),a=this.$gui_root.width(),f=u+a;if(e<u||n>f)u=e<u?e:n-a,this.$gui_root.scrollLeft(u);var l=this.my_window.document.body.scrollTop,c=this.my_window.document.body.scrollLeft,h=this.$gui_root.offset();h.top-=l,h.left-=c,e=e-u+h.left,n=n-u+h.left,t=t-i+h.top,r=r-i+h.top;var p=this.my_window.document.body.scrollHeight,d=this.my_window.document.body.scrollWidth,v=0;if(t<0||r>p)v=t<0?t:r;var m=0;if(e<0||n>d)m=e<0?e:n;this.my_window.scrollBy(m,v)},q.prototype.setGUICaret=function(e,t,n,r){var i;e instanceof B?(t=e.offset,i=e.node,n=arguments[1],r=arguments[2]):(i=e,e=H(this.gui_root,i,t)),this.clearDOMSelection(),this._setFakeCaretTo(e),this._focusInputField(),this._sel_anchor=e,this._sel_focus=this._sel_anchor,this._caretChangeEmitter(undefined,r)},q.prototype._focusInputField=function(){this._$input_field.blur(),this._$input_field.focus()},q.prototype._setFakeCaretTo=function(e){this._fake_caret=e,this._refreshFakeCaret()},q.prototype._refreshFakeCaret=function(){var e,t;this._fake_caret&&(e=this._fake_caret.node,t=this._fake_caret.offset,r(e).closest(this.$gui_root).length===0&&(this._fake_caret=undefined));if(!this._fake_caret){this._$fake_caret.detach(),this._$input_field.css("top",""),this._$input_field.css("left","");return}this._$fake_caret.parent()[0]||this._$caret_layer.append(this._$fake_caret);if(r(e).closest("._gui").length>0){this._$fake_caret.detach();return}var n=r("<span style='height: 100%; display: inline-block; font-size: inherit; width: 1px; max-width: 1px;'>&nbsp;</span>"),i=n.get(0),s=this.getDOMSelectionRange(),u;if(s){var a=s.startContainer.parentNode,f=s.endContainer.parentNode;u={stContParent:a,stContOffset:j.call(a.childNodes,s.startContainer),startOffset:s.startOffset,endContParent:f,endContOffset:j.call(f.childNodes,s.endContainer),endOffset:s.endOffset}}var l,h;try{this._refreshing_caret++;switch(e.nodeType){case Node.TEXT_NODE:var p=e.parentNode,d=e.previousSibling,v=e.nextSibling;c.insertIntoText(e,t,i);break;case Node.ELEMENT_NODE:e.insertBefore(i,e.childNodes[t]);break;default:throw new Error("unexpected node type: "+e.nodeType)}l=n.position(),h=n.height();if(e.nodeType===Node.TEXT_NODE){var m=d?d.nextSibling:p.firstChild;while(m!==v)p.removeChild(m),m=d?d.nextSibling:p.firstChild;p.insertBefore(e,v)}else n.remove()}finally{this._refreshing_caret--}if(u){var s=o.createRange(this.my_window.document);s.setStart(u.stContParent.childNodes[u.stContOffset],u.startOffset),s.setEnd(u.endContParent.childNodes[u.endContOffset],u.endOffset),this.getDOMSelection().setSingleRange(s)}this._$fake_caret.css("top",l.top),this._$fake_caret.css("left",l.left),this._$fake_caret.css("height",h),this._$fake_caret.css("max-height",h),this._$fake_caret.css("min-height",h),this._$input_field.css("top",l.top),this._$input_field.css("left",l.left)},q.prototype._keydownHandler=i.wrap(function(e){var t=this.getGUICaret();t&&this.$gui_root.trigger("wed-input-trigger-keydown",[e]);if(e.isImmediatePropagationStopped()||e.isPropagationStopped())return;this.$gui_root.trigger("wed-global-keydown",[e])}),q.prototype._globalKeydownHandler=i.wrap(function(e,t){function o(){return t.stopPropagation(),t.preventDefault(),!1}var n,s;if(t.which===17||t.which===16||t.which===18||t.which===0)return!0;if(t.which===112)return this.help_modal.modal(),o();if(this._development_mode){if(t.which===113){var u=this.getDataCaret();console.log("raw caret",this._raw_caret.node,this._raw_caret.offset),console.log("data caret",u.node,u.offset),console.log("fake caret",this._fake_caret.node,this._fake_caret.offset),console.log("data closest real",r(u.node).closest("._real")),console.log("gui closest real",r(this._raw_caret.node).closest("._real"));var n=this.getDOMSelectionRange();return n?console.log("DOM range",n.startContainer,n.startOffset,n.endContainer,n.endOffset):console.log("DOM range undefined"),console.log("input field location",this._$input_field.css("top"),this._$input_field.css("left")),console.log("document.activeElement",document.activeElement),o()}if(t.which==114)return this.dumpUndo(),o();if(t.which==115)return console.log("manual focus"),console.log("document.activeElement before",document.activeElement),console.log('document.querySelector(":focus") before',document.querySelector(":focus")),this._focusInputField(),console.log("document.activeElement after",document.activeElement),console.log('document.querySelector(":focus") after',document.querySelector(":focus")),o()}if(t.which>=33&&t.which<=40){var a,l;if(x.RIGHT_ARROW.matchesEvent(t)){if(t.shiftKey){this._sel_focus=this.positionRight(this._sel_focus);var h=this._sel_anchor.makeRange(this._sel_focus);this.setSelectionRange(h.range,h.reversed)}else this.moveCaretRight();return o()}if(x.LEFT_ARROW.matchesEvent(t)){if(t.shiftKey){this._sel_focus=this.positionLeft(this._sel_focus);var h=this._sel_anchor.makeRange(this._sel_focus);this.setSelectionRange(h.range,h.reversed)}else this.moveCaretLeft();return o()}return!0}if(x.CTRL_S.matchesEvent(t))return this._saver.save(),o();if(x.CTRL_Z.matchesEvent(t))return this.undo(),o();if(x.CTRL_Y.matchesEvent(t))return this.redo(),o();if(x.CTRL_C.matchesEvent(t))return!0;if(x.CTRL_X.matchesEvent(t))return!0;if(x.SPACE.matchesEvent(t))return s=this.getGUICaret(),s&&r(s.node).closest("._phantom").length===0&&this._handleKeyInsertingText(t),o();if(x.CTRL_BACKQUOTE.matchesEvent(t))return this._development_mode=!this._development_mode,r.bootstrapGrowl(this._development_mode?"Development mode on.":"Development mode off.",{ele:"body",type:"info",align:"center"}),this._development_mode&&i.showPopup(),o();if(x.CTRL_OPEN_BRACKET.matchesEvent(t))return this.decreaseLabelVisiblityLevel(),o();if(x.CTRL_CLOSE_BRACKET.matchesEvent(t))return this.increaseLabelVisibilityLevel(),o();if(x.CTRL_FORWARD_SLASH.matchesEvent(t)&&this._contextMenuHandler.call(this,t)===!1)return o();n=this.getDOMSelectionRange();if(n!==undefined){if(n.startContainer===n.endContainer){var p=n.startContainer.nodeType===Node.TEXT_NODE?!r(n.startContainer.parentNode).hasClass("_phantom")&&!r(n.startContainer.parentNode).hasClass("_phantom_wrap"):!0;if(!p)return o()}if(!n.collapsed)return o()}var d=this._raw_caret;if(d!==undefined){var m=r(d.node).closest("._placeholder");if(m.length>0){s=this.getDataCaret();if(!f.anySpecialKeyHeld(t)&&!this.validator.possibleAt(s).has(new v.Event("text")))return o();if(f.anySpecialKeyHeld(t)||x.BACKSPACE.matchesEvent(t)||x.DELETE.matchesEvent(t))return o()}if(r(d.node).hasClass("_phantom")||r(d.node).hasClass("_phantom_wrap"))return o()}var g;if(x.DELETE.matchesEvent(t)){if(!r(c.nextCaretPosition(this._raw_caret.toArray(),this.gui_root,!0)[0]).is("._phantom, ._phantom_wrap")){s=this.getDataCaret(),s.node.nodeType!==Node.TEXT_NODE&&(s=s.make(s.node.childNodes[s.offset],0));if(s.node.nodeType===Node.TEXT_NODE){var y=s.node.parentNode,b=j.call(y.childNodes,s.node);g=this._initiateTextUndo(),this.data_updater.deleteText(s,1),s.node.parentNode?this.setDataCaret(s,!0):this.setDataCaret(y,b,!0),g.recordCaretAfter()}}return o()}if(x.BACKSPACE.matchesEvent(t)){if(!r(c.prevCaretPosition(this._raw_caret.toArray(),this.gui_root,!0)[0]).is("._phantom, ._phantom_wrap")){s=this.getDataCaret(),s.node.nodeType!==Node.TEXT_NODE&&(s=s.make(s.node.childNodes[s.offset-1],s.node.childNodes[s.offset-1].length));if(s.node.nodeType===Node.TEXT_NODE){var y=s.node.parentNode,b=j.call(y.childNodes,s.node);if(s.offset===0)return o();g=this._initiateTextUndo(),this.data_updater.deleteText(s.node,s.offset-1,1),s.node.parentNode?this.setDataCaret(s.node,s.offset-1,!0):this.setDataCaret(y,b,!0),g.recordCaretAfter()}}return o()}return!0}),q.prototype._initiateTextUndo=function(){var e=this._undo.getGroup();if(e===undefined)e=new y.TextUndoGroup("text",this,this._undo,this._text_undo_max_length),this._undo.startGroup(e);else if(!(e instanceof y.TextUndoGroup))throw new Error("group not undefined and not a TextUndoGroup");return e},q.prototype._terminateTextUndo=function(){var e=this._undo.getGroup();e instanceof y.TextUndoGroup&&this._undo.endGroup()},q.prototype._keypressHandler=i.wrap(function(e){this.$gui_root.trigger("wed-input-trigger-keypress",[e]);if(e.isImmediatePropagationStopped()||e.isPropagationStopped())return;this.$gui_root.trigger("wed-global-keypress",[e])}),q.prototype.type=function(e){e instanceof O.Key&&(e=[e]);for(var t=0;t<e.length;++t){var n=e[t];typeof n=="string"&&(n=n===" "?x.SPACE:O.makeKey(n));var i=new r.Event("keydown");n.setEventToMatch(i),this._$input_field.trigger(i)}},q.prototype._globalKeypressHandler=i.wrap(function(e,t){return this._raw_caret===undefined?!0:t.which?t.ctrlKey||t.altKey||t.metaKey?!0:(this._handleKeyInsertingText(t),!1):!0}),q.prototype._handleKeyInsertingText=function(e){var t=String.fromCharCode(e.which);if(t==="")return!1;this._insertText(t),e.preventDefault(),e.stopPropagation()},q.prototype._insertText=function(e){if(e==="")return;var t=this._raw_caret,n=r(t.node),i=n.closest("._placeholder").get(0);i&&(this.setGUICaret(this.getGUICaret()),this._gui_updater.removeNode(i));var s=n.children("._placeholder").toArray(),o;for(o=0,i;(i=s[o])!==undefined;++o)this._gui_updater.removeNode(i);var u=this._initiateTextUndo();t=this.getDataCaret();var a=this.data_updater.insertText(t,e),f=a[0];if(f===undefined)this.setDataCaret(a[1],e.length,!0);else{var l;f===t.node?l=t.offset+e.length:t.node.childNodes[t.offset]===f?l=e.length:l=f.nodeValue.length,this.setDataCaret(f,l,!0)}u.recordCaretAfter()},q.prototype._compositionHandler=i.wrap(function(e){if(e.type==="compositionstart")this._composing=!0,this._composition_data={data:e.originalEvent.data,start_caret:this._raw_caret},this._$input_field.css("z-index",10);else if(e.type==="compositionupdate")this._composition_data.data=e.originalEvent.data;else{if(e.type!=="compositionend")throw new Error("unexpected event type: "+e.type);this._composing=!1,this._$input_field.css("z-index","")}}),q.prototype._inputHandler=i.wrap(function(e){if(this._composing)return;if(this._$input_field.val()==="")return;this._insertText(this._$input_field.val()),this._$input_field.val(""),this._focusInputField()}),q.prototype._findBoundaryAt=function(e,t){var n=this.elementAtPointUnderLayers(e,t);if(!n)return undefined;var r=this.my_window.document.createRange(),i=n.firstChild,s;e:while(i){if(i.nodeType===Node.TEXT_NODE)for(var o=0;o<i.nodeValue.length-1;++o){r.setStart(i,o),r.setEnd(i,o+1);var u=r.getBoundingClientRect(),a=f.distFromRect(e,t,u.left,u.top,u.right,u.bottom);if(!s||s.dist>a){s={dist:a,node:i,start:o};if(a===0)break e}}i=i.nextSibling}return s?{node:s.node,offset:s.start}:{node:n,offset:0}},q.prototype._pointToCharBoundary=function(e,t){var n=this._findBoundaryAt(e,t);if(n&&n.node.nodeType===Node.TEXT_NODE){var r=this.my_window.document.createRange();r.setStart(n.node,n.offset),r.setEnd(n.node,n.offset+1);var i=r.getBoundingClientRect();Math.abs(i.left-e)>=Math.abs(i.right-e)&&n.offset++}return n},q.prototype._mousemoveHandler=i.wrap(function(e){var t=this.elementAtPointUnderLayers(e.clientX,e.clientY),n=r(t);if(n.closest(this.gui_root).length===0)return;var i;if(n.is("[contenteditable='true']")){i=this._pointToCharBoundary(e.clientX,e.clientY);if(!i)return}else{var s;while(!n.is("[contenteditable='true']")){s=n,n=s.parent();if(n.closest(this.gui_root).length===0)return}t=n[0];var o=j.call(t.childNodes,s[0]),u=this.my_window.document.createRange();u.setStart(t,o),u.setEnd(t,o+1);var a=u.getBoundingClientRect();Math.abs(a.left-e.clientX)>=Math.abs(a.right-e.clientX)&&o++,i={node:t,offset:o}}this._sel_focus=i;if(!this._prev_sel_focus||this._sel_focus.offset!=this._prev_sel_focus.offset||this._sel_focus.node!=this._prev_sel_focus.node){var f=this._sel_anchor.makeRange(this._sel_focus);this.setDOMSelectionRange(f.range,f.reversed),this._prev_sel_focus=this._sel_focus}}),q.prototype.elementAtPointUnderLayers=function(e,t){var n=this._$caret_layer.css("display");this._$caret_layer.css("display","none");var r;try{r=this.my_window.document.elementFromPoint(e,t)}finally{this._$caret_layer.css("display",n)}return r},q.prototype._caretLayerMouseHandler=i.wrap(function(e){e.type==="mousedown"&&(this._$caret_layer.on("mousemove",this._caretLayerMouseHandler.bind(this)),this._$caret_layer.one("mouseup",this._caretLayerMouseHandler.bind(this)));var t=this.elementAtPointUnderLayers(e.clientX,e.clientY),n=r.Event(e.type,e);n.target=t,n.toElement=t;var i=this._$caret_layer.css("display");this._$caret_layer.css("display","none"),r(t).trigger(n),this._$caret_layer.css("display",i),e.type==="mouseup"&&this._$caret_layer.off("mousemove"),e.preventDefault(),e.stopPropagation()}),q.prototype._mousedownHandler=i.wrap(function(e){if(!c.pointInContents(this.gui_root,e.pageX,e.pageY))return!1;this.$gui_root.one("mouseup",this._caretChangeEmitter.bind(this));if(e.which===1){var t=this._pointToCharBoundary(e.clientX,e.clientY);this._sel_anchor=H(this.gui_root,t.node,t.offset),this._sel_focus=this._sel_anchor,this._prev_sel_focus=undefined,this.$gui_root.on("mousemove.wed",this._mousemoveHandler.bind(this))}this.$widget.find(".wed-validation-error.selected").removeClass("selected"),this.$error_list.find(".selected").removeClass("selected");var n=this.getDOMSelectionRange();if(!n||n.collapsed)this.my_window.setTimeout(this._seekCaret.bind(this,e),0);else if(e.which===3)return this._contextMenuHandler(e);return!0}),q.prototype.insertTransientPlaceholderAt=function(e){var t=r("<span class='_placeholder _transient' contenteditable='false'> </span>")[0];return this._gui_updater.insertNodeAt(e,t),t},q.prototype._seekCaret=i.wrap(function(e){var t=this._normalizeSelectionRange(),n=r(e.target),i=n.closest("._gui").length>0;if(n.closest("._placeholder").length>0){var s=o.createRange(this.my_window.document);s.setStart(e.target,0),this.getDOMSelection().setSingleRange(s),this._caretChangeEmitter()}else if(i){var s=o.createRange(this.my_window.document);s.setStart(e.target,0),this.getDOMSelection().setSingleRange(s),this._caretChangeEmitter()}else t&&r(t.startContainer).closest(this.gui_root).length!==0&&r(t.endContainer).closest(this.gui_root).length!==0&&this.setGUICaret(t.startContainer,t.startOffset);if(e.which===3){if(!i){if(!t){var u=this._pointToCharBoundary(e.clientX,e.clientY);this.setGUICaret(u.node,u.offset)}return n.data("wed-custom-context-menu")?(n.trigger("wed-context-menu",[e]),!1):this._contextMenuHandler(e)}this.setGUICaret(n[0],0),n.trigger("wed-context-menu",[e])}return!0}),q.prototype.getGUICaret=function(){return this._raw_caret===undefined?undefined:this._normalizeCaret(this._raw_caret)},q.prototype._normalizeCaret=function(e){if(!e)return e;var t=r(e.node).closest("._placeholder, ._gui").get(0);if(t!==undefined){var n=t.parentNode;return e.make(n,j.call(n.childNodes,t))}return e},q.prototype.fromDataLocation=function(e,t){var n=this._gui_updater.fromDataLocation(e,t),r=n.offset;e=n.node;if(e.nodeType===Node.ELEMENT_NODE){var i=this.mode.nodesAroundEditableContents(e),s=j.call(e.childNodes,i[0]);if(r<=s)r=s+1;else{var o=i[1]?j.call(e.childNodes,i[1]):e.childNodes.length;r>=o&&(r=o)}}return n.make(e,r)},q.prototype.toDataLocation=function(e,t,n){var i;e instanceof B?(n=t,t=e.offset,i=e.node):i=e;var s=r(i).parents("._phantom, ._gui").last()[0]||(r(i).is("._phantom, ._gui")?i:undefined);if(s){if(!n)return undefined;i=s.parentNode,t=j.call(i.childNodes,s)}var o=this._normalizeCaret(H(this.gui_root,i,t));i=o.node,t=o.offset;var u;if(i.nodeType===Node.TEXT_NODE)return u=this.data_updater.pathToNode(this.nodeToPath(i)),H(this.data_root,u,t);if(t>=i.childNodes.length)return u=this.data_updater.pathToNode(this.nodeToPath(i)),H(this.data_root,u,u.childNodes.length);var a=i.childNodes[t];if(a.nodeType!==Node.TEXT_NODE&&!r(a).is("._real")){var f=a.previousSibling,l;while(f)f.nodeType===Node.TEXT_NODE||r(f).is("._real")?(l=f,f=null):f=f.previousSibling;return l?(u=this.data_updater.pathToNode(this.nodeToPath(l)),H(this.data_root,u.parentNode,j.call(u.parentNode.childNodes,u)+1)):H(this.data_root,this.data_updater.pathToNode(this.nodeToPath(i)),0)}return u=this.data_updater.pathToNode(this.nodeToPath(a)),H(this.data_root,u.parentNode,j.call(u.parentNode.childNodes,u))},q.prototype.getDataCaret=function(e){var t=this.getGUICaret();return t===undefined?undefined:this.toDataLocation(t,e)},q.prototype.setDataCaret=function(e,t,n){e instanceof B?n=t:e=H(this.data_root,e,t),n=!!n;var r=this.fromDataLocation(e);this.setGUICaret(r,!1,n)},q.prototype.toDataNode=function(e){return this.data_updater.pathToNode(this.nodeToPath(e))},q.prototype._caretChangeEmitter=i.wrap(function(e,t){if(e&&!c.pointInContents(this.gui_root,e.pageX,e.pageY))return;t=!!t,e===undefined&&(e={which:undefined,type:undefined,target:undefined}),e.type==="mouseup"||e.type==="click"?window.setTimeout(this._caretChangeEmitterTimeout.bind(this,e,t),0):this._caretChangeEmitterTimeout(e,t)}),q.prototype._caretChangeEmitterTimeout=i.wrap(function(e,t){e.type==="mouseup"&&(this._sel_focus?this._setFakeCaretTo(this._sel_focus):this._sel_anchor&&this._setFakeCaretTo(this._sel_anchor));var n=this._sel_anchor&&this._sel_anchor.makeRange(this._sel_focus);if(e.type==="mouseup"&&(!n||n.range.collapsed)||e.type==="click"){var i;r(e.target).closest("._placeholder").length>0&&this.setGUICaret(e.target,0);var s=r(e.target).closest("._gui").get(0);if(s)this.setGUICaret(s,0);else{var o=r(e.target).parents("._phantom").last().get(0);o&&this.setGUICaret(o.parentNode,j.call(o.parentNode.childNodes,o))}}var u=this.getDOMSelection(),a,f;this._fake_caret?(a=this._fake_caret.node,f=this._fake_caret.offset):u.rangeCount>0&&r(u.focusNode).closest(this.gui_root).length!==0&&(a=u.focusNode,f=u.focusOffset);var l=u.rangeCount>0&&u.getRangeAt(0);l&&l.collapsed&&this.clearDOMSelection();if(a&&a.nodeType===Node.ELEMENT_NODE){var c=r(a).children("._placeholder"),h=c.get(0);if(h&&!c.is("._dying")){this.setGUICaret(h,0);return}}if(this._raw_caret===undefined||this._raw_caret.node!==a||this._raw_caret.offset!==f){var p=this._raw_caret;this._raw_caret=a?H(this.gui_root,a,f):undefined,this.$gui_root.trigger("caretchange",[this._raw_caret,p,t])}}),q.prototype._positionFromGUIRoot=function(e){var t=e.offset(),n=this.$gui_root.offset();return t.left=t.left-n.left+this.$gui_root.scrollLeft(),t.top=t.top-n.top+this.$gui_root.scrollTop(),t},q.prototype._caretChangeHandler=i.wrap(function(e,t,n,i){i||this._terminateTextUndo(),r(this.gui_root).find("._owns_caret").removeClass("_owns_caret");if(n){var s=r(n.node),o=s.closest("._gui");o.length>0&&o.trigger("wed-unclick");var u=s.closest("._placeholder._transient")[0];u&&this._gui_updater.removeNode(u)}if(!t)return;var a=r(t.node.nodeType===Node.ELEMENT_NODE?t.node:t.node.parentNode);if(a.closest(this.gui_root).length===0)return;a.closest("._gui").length===0&&a.addClass("_owns_caret");var l,c=a.closest("._gui");c.length>0?((!this._sel_anchor||r(this._sel_anchor.node).closest("._gui")[0]===c[0])&&a.trigger("wed-click"),l=c):this._fake_caret&&(l=this._$fake_caret);if(l){var h=this._positionFromGUIRoot(l);this.scrollIntoView(h.left,h.top,h.left+l.outerWidth(),h.top+l.outerHeight())}var p=[];while(!a.is(this.gui_root)){if(a[0].nodeType!==Node.ELEMENT_NODE)throw new Error("unexpected node type: "+a[0].nodeType);a.is("._phantom")||p.unshift("<span class='_gui _label'><span>&nbsp;"+f.getOriginalName(a[0])+"&nbsp;</span></span>"),a=a.parent()}this._$wed_location_bar.empty(),this._$wed_location_bar.append(p.join("/"))}),q.prototype.dismissContextMenu=function(){this._current_dropdown&&this._current_dropdown.dismiss()},q.prototype.displayContextMenu=function(e,t,n){this.dismissContextMenu();var r=this.$gui_root.offset(),i=this.$gui_root.height(),s=i-(t-r.top);this.pushSelection(),this._current_dropdown=new k.ContextMenu(this.my_window.document,e,t,s,n,function(){this._current_dropdown=undefined,this.popSelection()}.bind(this))},q.prototype.pushSelection=function(){this._selection_stack.push([this._sel_anchor,this._sel_focus])},q.prototype.popSelection=function(){var e=this._selection_stack.pop();this._sel_anchor=e[0],this._sel_focus=e[1];if(this._sel_anchor){var t=this._sel_anchor.makeRange(this._sel_focus);this.setSelectionRange(t.range,t.reversed),this._setFakeCaretTo(this._sel_focus),this._focusInputField(),this._caretChangeEmitter()}else this.clearSelection()},q.prototype.clearSelection=function(){this._setFakeCaretTo();var e=this.getDOMSelection();e.rangeCount>0&&r(e.focusNode).closest(this.$gui_root).length>0&&e.removeAllRanges(),this._sel_anchor=undefined,this._sel_focus=undefined,this._caretChangeEmitter()},q.prototype.getDOMSelection=function(){return o.getSelection(this.my_window)},q.prototype.clearDOMSelection=function(){this.getDOMSelection().removeAllRanges(),this._focusInputField()},q.prototype.getDOMSelectionRange=function(){var e=c.getSelectionRange(this.my_window);return e?r(e.startContainer).closest(this.$gui_root).length===0||r(e.endContainer).closest(this.$gui_root).length===0?undefined:e:undefined},q.prototype.getSelectionRange=function(){return this._sel_anchor?this._sel_anchor.makeRange(this._sel_focus).range:undefined},q.prototype.setSelectionRange=function(e,t){var n=H(this.gui_root,e.startContainer,e.startOffset),r=H(this.gui_root,e.endContainer,e.endOffset);t?(this._sel_anchor=r,this._sel_focus=n):(this._sel_anchor=n,this._sel_focus=r),this.setDOMSelectionRange(e,t),this._setFakeCaretTo(this._sel_focus),this._caretChangeEmitter()},q.prototype._normalizeSelectionRange=function(){var e=this.getDOMSelectionRange();if(!e)return undefined;var t=this._normalizeCaretToEditableRange(e.startContainer,e.startOffset),n=this._normalizeCaretToEditableRange(e.endContainer,e.endOffset);return t.makeRange(n).range},q.prototype._normalizeCaretToEditableRange=function(e,t){if(e instanceof B){if(e.root!=this.gui_root)throw new Error("DLoc object must be for the GUI tree");t=e.offset,e=e.node}if(e.nodeType===Node.ELEMENT_NODE){var n=this.mode.nodesAroundEditableContents(e),r=n[0]?j.call(e.childNodes,n[0]):-1;if(t<=r)t=r+1;else{var i=n[1]?j.call(e.childNodes,n[1]):e.childNodes.length;t>=i&&(t=i)}}return H(this.gui_root,e,t)},q.prototype.setDOMSelectionRange=function(e,t){if(e.collapsed){this.clearDOMSelection();return}var n=this.getDOMSelection();c.focusNode(e.endContainer),n.setSingleRange(e,t)},q.prototype.getDataSelectionRange=function(){var e=this.getDOMSelectionRange(),t=this.toDataLocation(e.startContainer,e.startOffset),n;return e.collapsed||(n=this.toDataLocation(e.endContainer,e.endOffset)),t.makeRange(n).range},q.prototype.setDataSelectionRange=function(e){var t=this.fromDataLocation(e.startContainer,e.startOffset),n;e.collapsed||(n=this.fromDataLocation(e.endContainer,e.endOffset)),this.setSelectionRange(t.makeRange(n).range)},q.prototype._onSaverSaved=function(){r.bootstrapGrowl("Saved",{ele:"body",type:"success",align:"center"}),this._emit("saved")},q.prototype._onSaverFailed=function(e){r.bootstrapGrowl("Failed to save!\n"+e.msg,{ele:"body",type:"danger",align:"center"})};var z={};z[u.INCOMPLETE]="stopped",z[u.WORKING]="working",z[u.INVALID]="invalid",z[u.VALID]="valid";var W={};W[u.INCOMPLETE]="info",W[u.WORKING]="info",W[u.INVALID]="danger",W[u.VALID]="success",q.prototype._onValidatorStateChange=function(){var e=this.validator.getWorkingState(),t=z[e.state],n=e.part_done*100>>0;if(e.state===u.WORKING){if(e.part_done-this._last_done_shown<.05)return}else if(e.state===u.VALID||e.state===u.INVALID)this._first_validation_complete||(this._first_validation_complete=!0,this._setCondition("first-validation-complete",{editor:this}));this._last_done_shown=e.part_done,this.$validation_progress.css("width",n+"%"),this.$validation_progress.removeClass("progress-bar-info progress-bar-success progress-bar-danger");var r=W[e.state];this.$validation_progress.addClass("progress-bar-"+r),this.$validation_message.text(t)},q.prototype._onValidatorError=function(e){this._validation_errors.push(e),this._processValidationError(e)},q.prototype._processValidationError=function(e){var t=e.error,n=e.node,s=e.index,o=this.fromDataLocation(n,s);o=this._normalizeCaretToEditableRange(o);var u=f.newGenericID(),a=r("<span class='_phantom wed-validation-error'></span>");a.click(i.wrap(function(e){this.$error_list.parents(".panel-collapse").collapse("show");var t=this.$error_list.find("#"+u),n=this.$error_list.parent(".panel-body");n.animate({scrollTop:t.offset().top-n.offset().top+n.scrollTop()}),this.$widget.find(".wed-validation-error.selected").removeClass("selected"),r(e.currentTarget).addClass("selected"),t.siblings().removeClass("selected"),t.addClass("selected")}.bind(this)));var l=a.get(0).id=f.newGenericID();this._gui_updater.insertAt(o,a.get(0));var c=t.getNames();for(var h=0;h<c.length;++h)c[h]=this.resolver.unresolveName(c[h].ns,c[h].name,t instanceof v.AttributeNameError||t instanceof v.AttributeValueError);var p=r("<li><a href='#"+l+"'>"+t.toStringWithNames(c)+"</li>");p.attr("id",u),p.children("a").click(i.wrap(function(e){this.$widget.find(".wed-validation-error.selected").removeClass("selected"),a.addClass("selected");var t=r(e.currentTarget).parent();t.siblings().removeClass("selected"),t.addClass("selected")}.bind(this))),this.$error_list.append(p)},q.prototype._onResetErrors=function(e){this.$error_list.children("li").slice(e.at).remove(),this.$widget.find(".wed-validation-error").remove()},q.prototype.nodeToPath=function(e){return c.nodeToPath(this.gui_root,e)},q.prototype.pathToNode=function(e){return c.pathToNode(this.gui_root,e)},q.prototype.makeModal=function(){var e=new C.Modal,t=e.getTopLevel();return t.on("show.bs.modal.modal",function(){this.pushSelection()}.bind(this)),t.on("hidden.bs.modal.modal",function(){this.popSelection()}.bind(this)),this.$widget.prepend(t),e},q.prototype.getModeData=function(e){return this._mode_data[e]},q.prototype.setModeData=function(e,t){this._mode_data[e]=t},q.prototype.increaseLabelVisibilityLevel=function(){this._current_label_level<this.max_label_level&&(this._current_label_level++,this.$gui_root.find("._label_level_"+this._current_label_level).show(),this._refreshFakeCaret())},q.prototype.decreaseLabelVisiblityLevel=function(){if(this._current_label_level){var e=this._current_label_level;this._current_label_level--,this.$gui_root.find("._label_level_"+e).hide(),this._refreshFakeCaret()}},q.prototype.destroy=function(){this._destroying=!0;if(this._destroyed)return;var e=A.editors.indexOf(this);e>=0&&A.editors.splice(e,1);try{this.validator&&this.validator.stop()}catch(t){i.unhandled(t)}try{this.gui_domlistener!==undefined&&this.gui_domlistener.stopListening()}catch(t){i.unhandled(t)}try{this.validation_domlistener!==undefined&&this.validation_domlistener.stopListening()}catch(t){i.unhandled(t)}this._current_dropdown&&this._current_dropdown.dismiss();try{var n=this.$gui_root;n.off(),n.removeData(),n.empty(),this.$frame.find("*").off(".wed"),r("body",this.my_window.document).off(".wed"),r(this.my_window).off(".wed")}catch(t){i.unhandled(t)}Object.keys(this).forEach(function(e){this[e]=undefined}.bind(this)),this._destroyed=!0,this.destroy=function(){}},t.Editor=q}),define("wed/mode",["require","exports","module","./domutil"],function(e,t,n){function i(e){this._editor=undefined,this._options=e||{},this._wed_options={label_levels:{max:1,initial:1}}}var r=e("./domutil");i.optionResolver=function(e,t){t(e)},i.prototype.init=function(e){this._editor=e},i.prototype.getWedOptions=function(){return this._wed_options},i.prototype.getAbsoluteResolver=function(){throw new Error("getAbsoluteResolver must be overriden.")},i.prototype.makeDecorator=function(){throw new Error("makeDecorator must be overriden.")},i.prototype.getContextualMenuItems=function(){return[]},i.prototype.getContextualActions=function(e,t,n,r){return this._tr.getTagTransformations(e,t)},i.prototype.getStylesheets=function(){return[]},i.prototype.nodesAroundEditableContents=function(e){throw new Error("nodesAroundEditableContents must be overriden.")},i.prototype.makePlaceholderFor=function(e){return r.makePlaceholder()},t.Mode=i}),define("wed/decorator",["require","exports","module","./util","jquery","./domutil","./jqutil","./transformation"],function(e,t,n){function a(e,t,n){this._domlistener=e,this._editor=t,this._gui_updater=n}var r=e("./util"),i=e("jquery"),s=e("./domutil"),o=e("./jqutil"),u=e("./transformation");t.Decorator=a,a.prototype.addHandlers=function(){this._domlistener.addHandler("added-element","._real, ._phantom, ._phantom_wrap",this.contentEditableHandler.bind(this))},a.prototype.startListening=function(e){var t=e.contents();t.detach(),this._domlistener.startListening(),this._gui_updater.insertAt(e.get(0),0,t.toArray())},a.prototype.listDecorator=function(e,t){var n={};i(e).children("._real").each(function(){n[r.getOriginalName(this)]=1});var s=Object.keys(n);if(s.length>1)throw new Error("calling listDecorator on a non-homogeneous list.");if(s.length===0)return;var o=this;i(e).children("[data-wed--separator-for]").each(function(){o._gui_updater.removeNode(this)});var u=s[0];typeof t=="string"&&(t=i('<div class="_text">'+t+"</div>")),i(t).addClass("_phantom"),i(t).attr("data-wed--separator-for",u);var a=!0;i(e).children("._real").each(function(){a?a=!1:o._gui_updater.insertBefore(this.parentNode,t.clone().get(0),this)})},a.prototype.addRemListElementHandler=function(e,t,n,r,i,s){this.listDecorator(n,e)},a.prototype.includeListHandler=function(e,t,n,r,i,s,o){this.listDecorator(o,e)},a.prototype.contentEditableHandler=function(e,t,n,r,i){i.findAndSelf("._phantom").attr("contenteditable","false"),i.findAndSelf("._phantom_wrap").attr("contenteditable","false"),i.findAndSelf("._real").attr("contenteditable","true"),i.findAndSelf("*").attr("tabindex","-1")},a.prototype.elementDecorator=function(e,t,n,s,o){if(n>this._editor.max_label_level)throw new Error("level higher than the maximum set by the mode: "+n);var u=i(t);t=u.get(0);var a=r.getOriginalName(t),f="_"+a+"_label",l=this;i(t).children("."+r.escapeCSSClass(f)).each(function(){l._gui_updater.deleteNode(this)}),f+=" _label_level_"+n;var c=i('<span class="_gui _phantom __start_label '+f+' _label"><span class="_phantom">&nbsp;'+a+" >&nbsp;</span></span>");this._gui_updater.insertNodeAt(t,0,c.get(0));var h=i('<span class="_gui _phantom __end_label '+f+' _label"><span class="_phantom">&nbsp;&lt; '+a+"&nbsp;</span></span>");this._gui_updater.insertBefore(t,h.get(0),null);var p={$root:e,$pre:c,$post:h};c.on("wed-click click",p,this._elementButtonClickHandler.bind(this)),h.on("wed-click click",p,this._elementButtonClickHandler.bind(this)),c.on("wed-unclick",p,this._elementButtonUnclickHandler.bind(this)),h.on("wed-unclick",p,this._elementButtonUnclickHandler.bind(this)),s!==undefined?c.on("wed-context-menu",s):c.on("wed-context-menu",!1),o!==undefined?h.on("wed-context-menu",o):h.on("wed-context-menu",!1)},a.prototype._elementButtonClickHandler=function(e){var t=e.data;t.$pre.addClass("_label_clicked"),t.$post.addClass("_label_clicked")},a.prototype._elementButtonUnclickHandler=function(e){var t=e.data;t.$pre.removeClass("_label_clicked"),t.$post.removeClass("_label_clicked")},a.prototype._contextMenuHandler=function(e,t,n){var s=i(t.currentTarget).parents("._real").first().get(0),o=[],u=this._editor,a=u.mode;if(s.parentNode!==u.gui_root){var f=r.getOriginalName(s),l=a.getContextualActions(["unwrap","delete-element"],f,s,0);l!==undefined&&l.forEach(function(e){var t={node:s,element_name:f},n=e.getIcon(),r=i("<a tabindex='-1' href='#'>"+(n?n+" ":"")+e.getDescriptionFor(t)+"</a>");r.click(t,e.bound_handler),o.push(i("<li>").append(r).get(0))}.bind(this));var c=s.parentNode,h=Array.prototype.indexOf.call(c.childNodes,s);e||h++;var p=u.toDataLocation(c,h);return u.validator.possibleAt(p).forEach(function(t){if(t.params[0]!=="enterStartTag")return;var n=u.resolver.unresolveName(t.params[1],t.params[2]),r=a.getContextualActions("insert",n,p.node,p.offset);if(r===undefined)return;for(var s=0,f;(f=r[s])!==undefined;++s){var l={element_name:n,move_caret_to:p},c=f.getIcon(),h=i("<a tabindex='-1' href='#'>"+(c?c+" ":"")+f.getDescriptionFor(l)+(e?" before this element":" after this element")+"</a>");h.click(l,f.bound_handler),o.push(i("<li></li>").append(h).get(0))}}.bind(this)),o===0?!0:(u.displayContextMenu(n.clientX,n.clientY,o),!1)}return!0}}),define("wed/modes/generic/generic_decorator",["require","exports","module","wed/decorator","wed/oop","jquery","wed/util","wed/jqutil","wed/log"],function(e,t,n){function f(e,t,n){r.apply(this,Array.prototype.slice.call(arguments,3)),this._mode=e,this._meta=t,this._options=n}var r=e("wed/decorator").Decorator,i=e("wed/oop"),s=e("jquery"),o=e("wed/util"),u=e("wed/jqutil"),a=e("wed/log");i.inherit(f,r),f.prototype.addHandlers=function(){this._domlistener.addHandler("included-element",o.classFromOriginalName("*"),function(e,t,n,r,i,s){this.elementDecorator(e,s)}.bind(this)),this._domlistener.addHandler("included-element",o.classFromOriginalName("*"),function(e,t,n,r,i,s){if(s.closest(e).length===0)return;var o=this._meta.getAdditionalClasses(s.get(0));o.length>0&&s.addClass(o)}.bind(this)),this._domlistener.addHandler("children-changed",o.classFromOriginalName("*"),function(e,t,n,r,i,s){(t.is("._real, ._phantom_wrap")||n.is("._real, ._phantom_wrap")||t.filter(u.textFilter).length+n.filter(u.textFilter).length>0)&&this.elementDecorator(e,s)}.bind(this)),this._domlistener.addHandler("text-changed",o.classFromOriginalName("*"),function(e,t){this.elementDecorator(e,t.parent())}.bind(this)),r.prototype.addHandlers.call(this)},f.prototype.elementDecorator=function(e,t){r.prototype.elementDecorator.call(this,e,t,1,a.wrap(this._contextMenuHandler.bind(this,!0)),a.wrap(this._contextMenuHandler.bind(this,!1)))},t.GenericDecorator=f}),define("wed/modes/generic/generic_tr",["require","exports","module","jquery","wed/domutil","wed/util","wed/wundo","wed/oop","wed/transformation"],function(e,t,n){function d(e){a.TransformationRegistry.call(this),this.addTagTransformations("insert","*",new c(e,"Create new <element_name>","","<i class='icon-plus icon-fixed-width'></i>",function(e,t){var n=e.getDataCaret(),r=f(e.data_updater,n.node,n.offset,t.element_name);e.setDataCaret(r.get(0),0)}.bind(this))),this.addTagTransformations("unwrap","*",new c(e,"Unwrap the content of this element",undefined,"<i class='icon-collapse-top'></i>",function(e,t){var n=t.node.parentNode,r=p.call(n.childNodes,t.node);h(e.data_updater,t.node),e.setDataCaret(n,r)})),this.addTagTransformations("wrap","*",new c(e,"Wrap in <element_name>",undefined,"<i class='icon-collapse'></i>",function(e,t){var n=e.getSelectionRange();if(!n)throw new Error("wrap transformation called with undefined range");if(n.collapsed)throw new Error("wrap transformation called with collapsed range");var r=e.toDataLocation(n.startContainer,n.startOffset),i=e.toDataLocation(n.endContainer,n.endOffset),s=a.wrapInElement(e.data_updater,r.node,r.offset,i.node,i.offset,t.element_name),o=s.parent()[0];e.clearSelection(),e.setDataCaret(o,p.call(o.childNodes,s[0])+1)})),this.addTagTransformations("delete-element","*",new c(e,"Delete this element",undefined,"<i class='icon-remove icon-fixed-width'></i>",function(e,t){var n=t.node.parentNode,r=p.call(n.childNodes,t.node);e.data_updater.removeNode(t.node),e.setDataCaret(n,r)})),this.addTagTransformations("delete-parent","*",new c(e,"Delete <element_name>",undefined,"<i class='icon-remove icon-fixed-width'></i>",function(e,t){var n=t.node.parentNode,r=p.call(n.childNodes,t.node);e.data_updater.removeNode(t.node),e.setDataCaret(n,r)}))}var r=e("jquery"),i=e("wed/domutil"),s=e("wed/util"),o=e("wed/wundo").Undo,u=e("wed/oop"),a=e("wed/transformation"),f=a.insertElement,l=a.makeElement,c=a.Transformation,h=a.unwrap,p=Array.prototype.indexOf;u.inherit(d,a.TransformationRegistry),t.Registry=d}),define("wed/modes/generic/generic",["require","exports","module","../../mode","salve/name_resolver","../../oop","./generic_decorator","./generic_tr","jquery"],function(e,t,n){function f(){r.apply(this,arguments),this._meta=new this._options.meta.Meta,this._resolver=new i.NameResolver;var e=this._meta.getNamespaceMappings();Object.keys(e).forEach(function(t){this._resolver.definePrefix(t,e[t])}.bind(this)),this.constructor===f&&(this._wed_options.metadata={name:"Generic",authors:["Louis-Dominique Dubeau"],description:"This is a basic mode bundled with wed and which can, and probably should be used as the base for other modes.",license:"MPL 2.0",copyright:"2013 Mangalam Research Center for Buddhist Languages"})}var r=e("../../mode").Mode,i=e("salve/name_resolver"),s=e("../../oop"),o=e("./generic_decorator").GenericDecorator,u=e("./generic_tr").Registry,a=e("jquery");s.inherit(f,r),f.optionResolver=function(t,n){var r=a.extend({},t);t&&t.meta?e([t.meta],function(e){r.meta=e,n(r)}):n(r)},f.prototype.init=function(e){r.prototype.init.call(this,e),this._tr=this._getTransformationRegistry()},f.prototype.getAbsoluteResolver=function(){return this._resolver},f.prototype.makeDecorator=function(){var e=Object.create(o.prototype),t=Array.prototype.slice.call(arguments);return t=[this,this._meta,this._options].concat(t),o.apply(e,t),e},f.prototype.getContextualMenuItems=function(){return[]},f.prototype.nodesAroundEditableContents=function(e){var t=[null,null],n=e.childNodes[0];a(n).is("._gui.__start_label")&&(t[0]=n);var r=e.childNodes[e.childNodes.length-1];return a(r).is("._gui.__end_label")&&(t[1]=r),t},f.prototype._getTransformationRegistry=function(){return new u(this._editor)},t.Mode=f}),define("wed/modes/generic/generic_meta",["require","exports","module"],function(e,t,n){function r(){}r.prototype.isInline=function(e){return!1},r.prototype.getAdditionalClasses=function(e){var t=[];return this.isInline(e)&&t.push("_inline"),t.join(" ")},r.prototype.getNamespaceMappings=function(){return{}},t.Meta=r});