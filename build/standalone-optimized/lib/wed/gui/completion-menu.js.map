{"version":3,"sources":["../../../wed/gui/completion-menu.ts"],"names":[],"mappings":"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","file":"completion-menu.js","sourcesContent":["/**\n * Menu for completions.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\nimport * as $ from \"jquery\";\n\nimport * as keyConstants from \"../key-constants\";\nimport { Editor, KeydownHandler } from \"../wed\";\nimport { ContextMenu, DismissCallback } from \"./context-menu\";\n\n/**\n * A menu for displaying completions.\n */\nexport class CompletionMenu extends ContextMenu {\n  private readonly completionPrefix: string;\n  private readonly completionItems: string[];\n  private readonly editor: Editor;\n  private readonly boundCompletionKeydownHandler: KeydownHandler;\n  private _focused: boolean = false;\n\n  /**\n   * @param editor The editor for which to create this menu.\n   *\n   * @param document The DOM document for which to make this context menu.\n   *\n   * @param x Position of the menu. The context menu may ignore this position if\n   * the menu would appear off-screen.\n   *\n   * @param y Position of the menu.\n   *\n   * @param prefix The prefix. This is the data which is currently present in\n   * the document and that has to be completed.\n   *\n   * @param items An array of possible completions.\n   *\n   * @param dismissCallback Function to call when the menu is dismissed.\n   */\n  constructor(editor: Editor, document: Document, x: number, y: number,\n              prefix: string, items: string[],\n              dismissCallback?: DismissCallback) {\n    super(document, x, y, [], dismissCallback, false);\n    this.completionPrefix = prefix;\n    this.completionItems = items;\n    this.editor = editor;\n\n    this.dropdown.classList.add(\"wed-completion-menu\");\n    // Remove the data toggle. This will prevent Bootstrap from closing this\n    // menu when the body gets the click event.\n    if (this.dropdown.firstElementChild!.getAttribute(\"data-toggle\") !== null) {\n      this.dropdown.removeChild(this.dropdown.firstChild!);\n    }\n    // Remove the backdrop. We do not need a backdrop for this kind of GUI item\n    // because completion menus are evanescent.\n    this.backdrop.parentNode!.removeChild(this.backdrop);\n\n    // We need to install our own handler so that we can handle the few keys\n    // that ought to be transferred to the menu itself.\n    this.boundCompletionKeydownHandler =\n      this.globalKeydownHandler.bind(this);\n    editor.pushGlobalKeydownHandler(this.boundCompletionKeydownHandler);\n\n    // We want the user to still be able to type into the document.\n    editor.caretManager.focusInputField();\n\n    this.display([]);\n  }\n\n  /** Whether the completion menu has been focused. */\n  get focused(): boolean {\n    return this._focused;\n  }\n\n  private globalKeydownHandler(wedEv: Event, ev: JQueryEventObject): boolean {\n    if (keyConstants.ENTER.matchesEvent(ev)) {\n      this.$menu.find(\"li:not(.divider):visible a\").first().click();\n      return false;\n    }\n    else if (keyConstants.DOWN_ARROW.matchesEvent(ev)) {\n      this._focused = true;\n      this.$menu.find(\"li:not(.divider):visible a\").first().focus();\n      this.$menu.trigger(ev);\n      return false;\n    }\n    else if (keyConstants.ESCAPE.matchesEvent(ev)) {\n      this.dismiss();\n      return false;\n    }\n    return true;\n  }\n\n  render(): void {\n    const editor = this.editor;\n    const items = [];\n    const prefix = this.completionPrefix;\n    const doc = editor.doc;\n    function typeData(ev: JQueryEventObject): void {\n      editor.type(ev.data);\n    }\n\n    for (const item of this.completionItems) {\n      if (prefix === \"\") {\n        const li = doc.createElement(\"li\");\n        // tslint:disable-next-line:no-inner-html\n        li.innerHTML = \"<a href='#'></a>\";\n        li.lastChild!.textContent = item;\n        items.push(li);\n        $(li).click(item, typeData);\n      }\n      else if (item.lastIndexOf(prefix, 0) === 0) {\n        const li = doc.createElement(\"li\");\n        // tslint:disable-next-line:no-inner-html\n        li.innerHTML = \"<a href='#'><b></b></a>\";\n        const a = li.lastChild!;\n        a.firstChild!.textContent = item.slice(0, prefix.length);\n        const tail = item.slice(prefix.length);\n        a.appendChild(doc.createTextNode(tail));\n        items.push(li);\n        $(li).click(tail, typeData);\n      }\n    }\n\n    if (items.length === 0) {\n      this.dismiss();\n    }\n\n    if (items.length === 1 && this.completionItems[0] === prefix) {\n      this.dismiss();\n    }\n\n    super.render(items);\n  }\n\n  dismiss(): void {\n    if (this.dismissed) {\n      return;\n    }\n    this.editor.popGlobalKeydownHandler(this.boundCompletionKeydownHandler);\n    super.dismiss();\n  }\n}\n\n//  LocalWords:  MPL li href\n"]}