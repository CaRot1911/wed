!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("salve")):"function"==typeof define&&define.amd?define(["salve"],t):"object"==typeof exports?exports["salve-dom"]=t(require("salve")):e["salve-dom"]=t(e.salve)}(window,function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fixPrototype=function(e,t){(void 0!==Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__)!==t&&(void 0!==Object.setPrototypeOf?Object.setPrototypeOf(e,t.prototype):e.__proto__=t.prototype)}},function(e,t,r){"use strict";
/**
 * A listener class.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright Mangalam Research Center for Buddhist Languages
 */var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}};Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){this._eventListeners=Object.create(null),this._generalListeners=[],this._trace=!1}return e.prototype.addEventListener=function(e,t){if("*"===e)this._generalListeners.push(t);else{var r=this._eventListeners[e];void 0===r&&(r=this._eventListeners[e]=[]),r.push(t)}},e.prototype.addOneTimeEventListener=function(e,t){var r=this,n=function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];return r.removeEventListener(e,n),t.apply(r,o)};return this.addEventListener(e,n),n},e.prototype.removeEventListener=function(e,t){var r="*"===e?this._generalListeners:this._eventListeners[e];if(void 0!==r){var n=r.lastIndexOf(t);-1!==n&&r.splice(n,1)}},e.prototype.removeAllListeners=function(e){"*"===e?this._generalListeners=[]:this._eventListeners[e]=[]},e.prototype._emit=function(e,t){var r,o,i,a,s;if(this._trace&&console.log("simple_event_emitter emitting:",e,"with:",t),(r=this._generalListeners).length>0){r=r.slice();try{for(var l=n(r),d=l.next();!d.done;d=l.next()){if(!1===d.value.call(void 0,e,t))return}}catch(e){o={error:e}}finally{try{d&&!d.done&&(i=l.return)&&i.call(l)}finally{if(o)throw o.error}}}if(void 0!==(r=this._eventListeners[e])&&r.length>0){r=r.slice();try{for(var u=n(r),c=u.next();!c.done;c=u.next()){if(!1===c.value.call(void 0,t))return}}catch(e){a={error:e}}finally{try{c&&!c.done&&(s=u.return)&&s.call(u)}finally{if(a)throw a.error}}}},e}();t.EventEmitter=o},function(t,r){t.exports=e},function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__values||function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}};Object.defineProperty(t,"__esModule",{value:!0});
/**
 * Main module of salve-dom.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright Mangalam Research Center for Buddhist Languages
 */
var a=r(2),s=r(1),l=r(0);function d(e,t){return Array.prototype.indexOf.call(e,t)}var u,c=Node.ATTRIBUTE_NODE;t.isAttr=void 0!==c?function(e){return e.nodeType===c}:function(e){return e instanceof Attr},function(e){e[e.INCOMPLETE=1]="INCOMPLETE",e[e.WORKING=2]="WORKING",e[e.INVALID=3]="INVALID",e[e.VALID=4]="VALID"}(u=t.WorkingState||(t.WorkingState={}));var h=function(){return function(e,t){this.partDone=e,this.portion=t}}(),v=function(e){function t(){var r=e.call(this,"undefined event_index; _validateUpTo should have taken care of that")||this;return l.fixPrototype(r,t),r}return o(t,e),t}(Error);var f=function(){function e(e,t,r){void 0===r&&(r={}),this.schema=e,this.root=t,this._cycleEntered=0,this._timeout=200,this._maxTimespan=100,this._resetting=!1,this._errors=[],this._errorsSeen=Object.create(null),this._boundWrapper=this._workWrapper.bind(this),this._validationEvents=[],this._workingState=u.INCOMPLETE,this._partDone=0,this._validationStage=2,this._previousChild=null,this._validationStack=[new h(0,1)],this._walkerCache=Object.create(null),this._walkerCacheMax=-1,this._prefix="salveDom",this._walkerCacheGap=100,this._events=new s.EventEmitter;var n,o;try{for(var a=i(["timeout","maxTimespan","walkerCacheGap"]),l=a.next();!l.done;l=a.next()){var d=l.value,c=r[d];if(void 0!==c){if(c<0)throw new Error("the value for "+d+" cannot be negative");this["_"+d]=r[d]}}}catch(e){n={error:e}}finally{try{l&&!l.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}void 0!==r.prefix&&(this._prefix=r.prefix),this._curEl=this.root,this._setNodeProperty(this._curEl,"EventIndexAfterStart",this._validationEvents.length),this._setWorkingState(u.INCOMPLETE,0),this._validationWalker=this.schema.newWalker(),this.events=this._events}return e.prototype.makeKey=function(e){return""+this._prefix+e},e.prototype.getNodeProperty=function(e,t){return e[this.makeKey(t)]},e.prototype._setNodeProperty=function(e,t,r){e[this.makeKey(t)]=r},e.prototype._clearNodeProperties=function(e){var t=e;delete t[this.makeKey("EventIndexAfter")],delete t[this.makeKey("EventIndexAfterStart")],delete t[this.makeKey("EventIndexBeforeAttributes")],delete t[this.makeKey("EventIndexAfterAttributes")],delete t[this.makeKey("PossibleDueToWildcard")],delete t[this.makeKey("ErrorId")]},e.prototype.start=function(){void 0!==this._timeoutId&&this._stop(u.WORKING),this._timeoutId=setTimeout(this._boundWrapper,0)},e.prototype.getSchemaNamespaces=function(){return this.schema.getNamespaces()},e.prototype.getDocumentNamespaces=function(){var e={};return function t(r){if(null!==r){for(var n=r.attributes.length,o=0;o<n;++o){var i=r.attributes[o];if(0===i.name.lastIndexOf("xmlns",0)){var a=i.name.slice(6),s=e[a];void 0===s&&(s=e[a]=[]),s.push(i.value)}}for(var l=r.firstChild;null!==l;)l.nodeType===Node.ELEMENT_NODE&&t(l),l=l.nextSibling}}(this.root.firstChild),e},e.prototype._workWrapper=function(){this._work()&&(this._timeoutId=setTimeout(this._boundWrapper,this._timeout))},e.prototype._work=function(){for(var e=Date.now();;){if(this._maxTimespan>0&&Date.now()-e>=this._maxTimespan)return!0;if(!this._cycle())return!1}},e.prototype._cycle=function(){var e=this;if(this._resetting=!1,this._cycleEntered>0)throw new Error("internal error: _cycle is being reentered");if(this._cycleEntered<0)throw new Error("internal error: _cycleEntered negative");this._cycleEntered++;var t=this._validationWalker,r=this._validationStack,n=this._validationEvents,o=r[0].portion,i=this._validationStage,s=function(){var s=l._curEl;switch(i){case 1:s=s,r.unshift(new h(l._partDone,o)),l._fireAndProcessEvent(t,"enterContext",[],s,0);for(var c=s.attributes.length,v=0;v<c;++v){var f=s.attributes[v],p=void 0;"xmlns"===f.name?p="":0===f.name.lastIndexOf("xmlns:",0)&&(p=f.name.slice(6)),void 0!==p&&l._fireAndProcessEvent(t,"definePrefix",[p,f.value],s,0)}var _=s.tagName,y=s.parentNode,E=d(y.childNodes,s);return void 0===(b=t.resolveName(_,!1))&&(l._processEventResult([new a.ValidationError("cannot resolve the name "+_)],y,E),b=new a.EName("",_)),l._setPossibleDueToWildcard(s,t,"enterStartTag",b.ns,b.name),l._fireAndProcessEvent(t,"enterStartTag",[b.ns,b.name],y,E),l._setNodeProperty(s,"EventIndexBeforeAttributes",n.length),l._fireAttributeEvents(t,s),l._setNodeProperty(s,"EventIndexAfterAttributes",n.length),l._fireAndProcessEvent(t,"leaveStartTag",[],s,0),i=l._validationStage=2,l._setNodeProperty(s,"EventIndexAfterStart",n.length),l._cycleEntered--,{value:!0};case 2:for(var m,N=null===l._previousChild?s.firstChild:l._previousChild.nextSibling,g="",x=function(){if(""!==g){var r=t.fireEvent("text",[g]);if(r instanceof Array){if(void 0===m)throw new Error("flushText running with undefined node");var n=m.parentNode;e._processEventResult(r,n,d(n.childNodes,m))}}g="",m=void 0};null!==N;){switch(N.nodeType){case Node.TEXT_NODE:g+=N.data,void 0===m&&(m=N);break;case Node.ELEMENT_NODE:return x(),o/=s.childElementCount,l._curEl=s=N,i=l._validationStage=1,l._previousChild=null,"continue-stage_change";case Node.COMMENT_NODE:break;default:throw new Error("unexpected node type: "+N.nodeType)}N=N.nextSibling}x(),i=l._validationStage=3;break;case 3:if(s===l.root){var w=t.end();return w instanceof Array&&l._processEventResult(w,s,s.childNodes.length),l._runDocumentValidation(),l._setNodeProperty(s,"EventIndexAfter",n.length),l._partDone=1,l._stop(l._errors.length>0?u.INVALID:u.VALID),l._cycleEntered--,{value:!1}}var b,T=s;_=s.tagName;void 0===(b=t.resolveName(_,!1))&&(b=new a.EName("",_)),l._fireAndProcessEvent(t,"endTag",[b.ns,b.name],s,s.childNodes.length),l._fireAndProcessEvent(t,"leaveContext",[],s,s.childNodes.length),l._previousChild=s,l._curEl=s=s.parentNode;var A=l._partDone;if(s!==l.root){r.shift();var k=r[0];A=k.partDone+=o,o=k.portion}return l._setWorkingState(u.WORKING,A),l._setNodeProperty(T,"EventIndexAfter",l._validationEvents.length),i=l._validationStage=2,l._cycleEntered--,{value:!0};default:throw new Error("unexpected state")}},l=this;e:for(;;){var c=s();if("object"==typeof c)return c.value;switch(c){case"continue-stage_change":continue e}}},e.prototype.stop=function(){this._stop()},e.prototype._stop=function(e){void 0!==this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0,void 0===e?this._workingState===u.WORKING&&this._setWorkingState(u.INCOMPLETE,this._partDone):this._setWorkingState(e,this._partDone)},e.prototype._runDocumentValidation=function(){},e.prototype.restartAt=function(e){this.resetTo(e),this.start()},e.prototype.resetTo=function(e){this._resetting||(this._resetting=!0,this._resetTo(e))},e.prototype._erase=function(e){this._clearNodeProperties(e);for(var t=e.firstElementChild;null!==t;)this._erase(t),t=t.nextElementSibling},e.prototype._resetTo=function(e){this._erase(this.root),this._validationStage=2,this._previousChild=null,this._validationWalker=this.schema.newWalker(),this._validationEvents=[],this._curEl=this.root,this._partDone=0,this._errors=[],this._errorsSeen=Object.create(null),this._walkerCache=Object.create(null),this._walkerCacheMax=-1,this._events._emit("reset-errors",{at:0})},e.prototype._setWorkingState=function(e,t){var r=!1;this._workingState!==e&&(this._workingState=e,r=!0),this._partDone!==t&&(this._partDone=t,r=!0),r&&this._events._emit("state-update",{state:e,partDone:t})},e.prototype.getWorkingState=function(){return{state:this._workingState,partDone:this._partDone}},Object.defineProperty(e.prototype,"errors",{get:function(){return this._errors.slice()},enumerable:!0,configurable:!0}),e.prototype._processEventResult=function(e,t,r){try{for(var n=i(e),o=n.next();!o.done;o=n.next()){var a=o.value;this._processError({error:a,node:t,index:r})}}catch(e){s={error:e}}finally{try{o&&!o.done&&(l=n.return)&&l.call(n)}finally{if(s)throw s.error}}var s,l},e.prototype._processError=function(e){var t,r,n=this,o=e.node,i=(null==o?"":String((t=o,void 0===(r=n.getNodeProperty(t,"ErrorId"))&&(r=n._errors.length,n._setNodeProperty(t,"ErrorId",r)),r)))+","+e.error.toString();!0!==this._errorsSeen[i]&&(this._errorsSeen[i]=!0,this._errors.push(e),this._events._emit("error",e))},e.prototype._fireAttributeEvents=function(e,t){for(var r=t.attributes,n=0;n<r.length;++n){var o=r[n];"xmlns"!==o.name&&0!==o.name.lastIndexOf("xmlns",0)&&(this._fireAttributeNameEvent(e,o)&&this._fireAndProcessEvent(e,"attributeValue",[o.value],o,0))}},e.prototype._fireAttributeNameEvent=function(e,t){var r=t.name,n=e.resolveName(r,!0);return void 0===n?(this._processError({error:new a.ValidationError("cannot resolve attribute name "+r),node:t,index:0}),!1):(this._setPossibleDueToWildcard(t,e,"attributeName",n.ns,n.name),this._fireAndProcessEvent(e,"attributeName",[n.ns,n.name],t,0),!0)},e.prototype._fireAndProcessEvent=function(e,t,r,n,o){switch(this._validationEvents.push({name:t,params:r}),t){case"enterContext":return void e.enterContext();case"leaveContext":return void e.leaveContext();case"definePrefix":return void e.definePrefix(r[0],r[1]);default:var i=e.fireEvent(t,r);i instanceof Array&&(null!=n&&void 0!==o&&"number"!=typeof o&&(o=d(n.childNodes,o)),this._processEventResult(i,n,o))}},e.prototype._validateUpTo=function(e,r,n){if(void 0===n&&(n=!1),(n=!!n)&&(void 0===e.childNodes||e.childNodes[r].nodeType!==Node.ELEMENT_NODE))throw new Error("trying to validate after attributes but before the end of the start tag on a node which is not an element node");var o=e,i="EventIndexAfter";if(e===this.root&&r<=0){if(n)i="EventIndexAfterAttributes",o=e.childNodes[r];else if(0===r)return}else if(t.isAttr(e))o=e.ownerElement,i="EventIndexBeforeAttributes";else switch(e.nodeType){case Node.TEXT_NODE:null===(o=e.previousElementSibling)&&(o=e.parentNode,i="EventIndexAfterStart");break;case Node.ELEMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:case Node.DOCUMENT_NODE:var a=e.childNodes[r],s=void 0===a?e.lastElementChild:a.previousElementSibling;n?(i="EventIndexAfterAttributes",o=a):null!==s?o=s:i="EventIndexAfterStart";break;default:throw new Error("unexpected node type: "+e.nodeType)}for(;void 0===this.getNodeProperty(o,i);)this._cycle()},e.prototype._getWalkerAt=function(e,r,n){if(void 0===n&&(n=!1),(n=!!n)&&(void 0===e.childNodes||e.childNodes[r].nodeType!==Node.ELEMENT_NODE))throw new Error("trying to get a walker for attribute events on a node which is not an element node");if(this._validateUpTo(e,r,n),e===this.root&&r<=0&&!n)return 0===r?this.schema.newWalker():this._validationWalker;var o;function i(e){if(void 0===o)throw new Error("calling fireTextEvent without a walker");o.fireEvent("text",[e.data])}if(t.isAttr(e)){var a=e.ownerElement;o=this.readyWalker(this.getNodeProperty(a,"EventIndexBeforeAttributes")),"xmlns"!==e.name&&"xmlns"!==e.prefix&&(o=o.clone(),this._fireAttributeNameEvent(o,e))}else switch(e.nodeType){case Node.TEXT_NODE:var s=void 0,l=void 0;null!==(u=e.previousElementSibling)?(s=u,l="EventIndexAfter"):(s=e.parentNode,l="EventIndexAfterStart"),o=this.readyWalker(this.getNodeProperty(s,l)),r>0&&(o=o.clone(),i(e));break;case Node.ELEMENT_NODE:case Node.DOCUMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:var d=e.childNodes[r],u=void 0;s=void 0,l=void 0;if(n?(s=d,l="EventIndexAfterAttributes"):null!==(u=void 0===d?e.lastElementChild:d.previousElementSibling)?(s=u,l="EventIndexAfter"):(s=e,l="EventIndexAfterStart"),o=this.readyWalker(this.getNodeProperty(s,l)),!n){var c=null!=d?d.previousSibling:null;null!==c&&c!==u&&c.nodeType===Node.TEXT_NODE&&(o=o.clone(),i(c))}break;default:throw new Error("unexpected node type: "+e.nodeType)}return o},e.prototype.readyWalker=function(e){if(void 0===e)throw new v;var t=this._walkerCache,r=this._walkerCacheMax,n=t[e];if(void 0!==n)return n;var o=e;if(o>=r)n=t[o=r];else for(;void 0===n&&--o>=0;)n=t[o];void 0!==n?n=n.clone():(n=this.schema.newWalker(),o=0);for(var i=o;i<e;++i){var a=this._validationEvents[i],s=a.name,l=a.params;switch(s){case"enterContext":n.enterContext();break;case"leaveContext":n.leaveContext();break;case"definePrefix":n.definePrefix(l[0],l[1]);break;default:n.fireEvent(s,l)}}return e-o>=this._walkerCacheGap&&(t[e]=n,this._walkerCacheMax=Math.max(e,r)),n},e.prototype.possibleAt=function(e,t,r){return void 0===r&&(r=!1),this._getWalkerAt(e,t,r).possible()},e.prototype.possibleWhere=function(e,t){var r=[],n=t.params;try{for(var o=i(n),a=o.next();!a.done;a=o.next()){if("string"!=typeof a.value)throw new Error("this method does not accept event with name patterns: convert the pattern to a uri, localPart pair")}}catch(e){l={error:e}}finally{try{a&&!a.done&&(d=o.return)&&d.call(o)}finally{if(l)throw l.error}}var s=n[0];if("startTagAndAttributes"===s||"attributeNameAndValue"===s)throw new Error("this method does not support "+s+": you must use granular events instead");for(var l,d,u,c,h,v,f=t.toString(),p="enterStartTag"===s||"attributeName"===s,_=0;_<=e.childNodes.length;++_){var y=this.possibleAt(e,_);if(p)try{for(var E=i(y),m=E.next();!m.done;m=E.next()){if((x=m.value).params[0]===s&&x.params[1].match(n[1],n[2])){r.push(_);break}}}catch(e){u={error:e}}finally{try{m&&!m.done&&(c=E.return)&&c.call(E)}finally{if(u)throw u.error}}else try{for(var N=i(y),g=N.next();!g.done;g=N.next()){var x;if((x=g.value).toString()===f){r.push(_);break}}}catch(e){h={error:e}}finally{try{g&&!g.done&&(v=N.return)&&v.call(N)}finally{if(h)throw h.error}}}return r},e.prototype.speculativelyValidate=function(e,t,r){var n;if(r instanceof Array){n=e.ownerDocument.createDocumentFragment();try{for(var o=i(r),a=o.next();!a.done;a=o.next()){var s=a.value;n.insertBefore(s.cloneNode(!0),null)}}catch(e){l={error:e}}finally{try{a&&!a.done&&(d=o.return)&&d.call(o)}finally{if(l)throw l.error}}}else n=r.cloneNode(!0);var l,d,u=e.ownerDocument.createElement("div");return u.insertBefore(n,null),this.speculativelyValidateFragment(e,t,u)},e.prototype.speculativelyValidateFragment=function(t,r,n){if(n.nodeType!==Node.ELEMENT_NODE)throw new Error("toParse is not an element");var o=new e(this.schema,n);return o._validationWalker=this._getWalkerAt(t,r).clone(),o._validateUpTo(n,n.childNodes.length),0!==o._errors.length&&o._errors},e.prototype.getErrorsFor=function(e){var t=e.parentNode;if(null===t)throw new Error("node without a parent!");this._validateUpTo(t,d(t.childNodes,e)+1);var r,n,o=[];try{for(var a=i(this._errors),s=a.next();!s.done;s=a.next()){var l=s.value;l.node===e&&o.push(l)}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return o},e.prototype._setPossibleDueToWildcard=function(e,t,r,n,o){var a=this.getNodeProperty(e,"PossibleDueToWildcard"),s=function(e,t,r,n){var o,a,s=e.possible(),l=!1;try{for(var d=i(s),u=d.next();!u.done;u=d.next()){var c=u.value;if(c.params[0]===t){var h=c.params[1];if(h.match(r,n)){if(!h.wildcardMatch(r,n))return!1;l=!0}}}}catch(e){o={error:e}}finally{try{u&&!u.done&&(a=d.return)&&a.call(d)}finally{if(o)throw o.error}}return l}(t,r,n,o);this._setNodeProperty(e,"PossibleDueToWildcard",s),void 0!==a&&a===s||this._events._emit("possible-due-to-wildcard-change",e)},e.prototype.resolveNameAt=function(e,t,r,n){return void 0===n&&(n=!1),this._getWalkerAt(e,t).resolveName(r,n)},e.prototype.unresolveNameAt=function(e,t,r,n){return this._getWalkerAt(e,t).unresolveName(r,n)},e}();t.Validator=f;var p=function(e){function t(r){var n=e.call(this)||this;n.xmlErrors=r;var o=new Error("cannot parse");return n.name="ParsingError",n.stack=o.stack,n.message=o.message,l.fixPrototype(n,t),n}return o(t,e),t}(Error);t.ParsingError=p;var _="http://www.w3.org/1999/xhtml",y="http://www.mozilla.org/newlayout/xml/parsererror.xml";t.safeParse=function(e,t){void 0===t&&(t=window);var r,n=new t.DOMParser;try{r=n.parseFromString(e,"text/xml")}catch(e){if("SyntaxError"!==e.name||12!==e.code)throw e;throw new p("no error information available")}if(void 0!==r.getElementsByTagNameNS(y,"parsererror")[0]||void 0!==r.getElementsByTagNameNS(_,"parsererror")[0])throw new p(r.documentElement.outerHTML);return r}}])});
//# sourceMappingURL=salve-dom.min.map.js