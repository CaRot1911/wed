{"version":3,"file":"wed-test-util.js","sourceRoot":"","sources":["../../../../lib/tests/wed-test-util.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Utilities that require a DOM to run.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\n\n// tslint:disable-next-line:import-name no-require-imports\nimport md5 = require(\"blueimp-md5\");\nimport { expect } from \"chai\";\n// tslint:disable-next-line: no-require-imports\nimport qs = require(\"qs\");\nimport * as sinon from \"sinon\";\n\nimport { domutil, makeEditor, Options } from \"wed\";\nimport { Editor } from \"wed/editor\";\nimport * as onerror from \"wed/onerror\";\n\nconst { childByClass, childrenByClass } = domutil;\n\nimport { DataProvider } from \"./util\";\n\nexport function activateContextMenu(editor: Editor, el: Element): void {\n  // tslint:disable-next-line:no-any\n  function computeValues(): any {\n    el.scrollIntoView();\n    const rect = el.getBoundingClientRect();\n    const left = rect.left + (rect.width / 2);\n    const top = rect.top + (rect.height / 2);\n    const scrollTop = editor.window.document.body.scrollTop;\n    const scrollLeft = editor.window.document.body.scrollLeft;\n    return {\n      which: 3,\n      pageX: left + scrollLeft,\n      pageY: top + scrollTop,\n      clientX: left,\n      clientY: top,\n      target: el,\n    };\n  }\n\n  editor.$guiRoot.trigger(new $.Event(\"mousedown\", computeValues()));\n  editor.$guiRoot.trigger(new $.Event(\"mouseup\", computeValues()));\n}\n\nexport function contextMenuHasOption(editor: Editor, pattern: RegExp,\n                                     expectedCount?: number): void {\n  const menu =\n    editor.window.document.getElementsByClassName(\"wed-context-menu\")[0];\n  expect(menu, \"the menu should exist\").to.not.be.undefined;\n  const items = menu.querySelectorAll(\"li>a\");\n  let found = 0;\n  for (let i = 0; i < items.length; ++i) {\n    const item = items[i];\n    if (pattern.test(item.textContent!.trim())) {\n      found++;\n    }\n\n    if (expectedCount === undefined && found > 0) {\n      break;\n    }\n  }\n\n  if (expectedCount === undefined) {\n    expect(found).to.be.greaterThan(0);\n  }\n  else {\n    expect(found).to.equal(expectedCount,\n                           \"should have seen the option a number of times \\\nequal to the expected count\");\n  }\n}\n\nexport function firstGUI(container: Element): Element | null {\n  return childByClass(container, \"_gui\");\n}\n\nexport function lastGUI(container: Element): Element | null {\n  const children = childrenByClass(container, \"_gui\");\n  const last = children[children.length - 1];\n  return last !== undefined ? last : null;\n}\n\nexport function getElementNameFor(container: Element,\n                                  last: boolean = false): Element | undefined {\n  const gui = last ? lastGUI(container) : firstGUI(container);\n\n  return gui!.getElementsByClassName(\"_element_name\")[0];\n}\n\nexport function getAttributeValuesFor(container: Element): NodeListOf<Element> {\n  return firstGUI(container)!.getElementsByClassName(\"_attribute_value\");\n}\n\nexport function getAttributeNamesFor(container: Element): NodeListOf<Element> {\n  return firstGUI(container)!.getElementsByClassName(\"_attribute_name\");\n}\n\nexport function caretCheck(editor: Editor, container: Node,\n                           offset: number | null, msg: string): void {\n  const caret = editor.caretManager.caret!;\n  expect(caret, \"there should be a caret\").to.not.be.undefined;\n  if (offset !== null) {\n    expect(caret.toArray(), msg).to.deep.equal([container, offset]);\n  }\n  else {\n    // A null offset means we are not interested in the specific offset.  We\n    // just want to know that the caret is *inside* container either directly or\n    // indirectly.\n    expect(container.contains(caret.node), msg).to.be.true;\n  }\n}\n\nexport function dataCaretCheck(editor: Editor, container: Node,\n                               offset: number, msg: string): void {\n  const dataCaret = editor.caretManager.getDataCaret()!;\n  expect(dataCaret.toArray(), msg).to.deep.equal([container, offset]);\n}\n\nexport interface Payload {\n  readonly command: string;\n  readonly data: string;\n  readonly version: string;\n}\n\n// tslint:disable-next-line:completed-docs\nexport class WedServer {\n  private _saveRequests: Payload[] = [];\n  private readonly oldUseFilters: boolean;\n    // tslint:disable-next-line:no-any\n  private readonly oldFilters: any[];\n  private readonly xhr: sinon.SinonFakeXMLHttpRequest;\n\n  emptyResponseOnSave: boolean = false;\n  failOnSave: boolean = false;\n  preconditionFailOnSave: boolean = false;\n  tooOldOnSave: boolean = false;\n\n  constructor(server: sinon.SinonFakeServer) {\n    // tslint:disable-next-line:no-any\n    const xhr = (server as any).xhr as sinon.SinonFakeXMLHttpRequest;\n    this.xhr = xhr;\n\n    // We must save and restore the filter state ourselves because Sinon does\n    // not do it. Fake servers don't restore it, nor do sandboxes.\n    this.oldUseFilters = xhr.useFilters;\n    // tslint:disable-next-line:no-any\n    this.oldFilters = (xhr as any).filters;\n\n    xhr.useFilters = true;\n    xhr.addFilter((_method: string, url: string): boolean =>\n                  !/^\\/build\\/ajax\\//.test(url));\n    server.respondImmediately = true;\n    server.respondWith(\"POST\", /^\\/build\\/ajax\\/save\\.txt$/,\n                       this.handleSave.bind(this));\n    server.respondWith(\"POST\", \"/build/ajax/log.txt\",\n                       [200, { \"Content-Type\": \"application/json\" }, \"{}\"]);\n  }\n\n  get saveRequests(): ReadonlyArray<Payload> {\n    return this._saveRequests;\n  }\n\n  get lastSaveRequest(): Payload {\n    const reqs = this.saveRequests;\n    return reqs[reqs.length - 1];\n  }\n\n  reset(): void {\n    this._saveRequests = [];\n    this.emptyResponseOnSave = false;\n    this.failOnSave = false;\n    this.preconditionFailOnSave = false;\n    this.tooOldOnSave = false;\n  }\n\n  restore(): void {\n    const xhr = this.xhr;\n    xhr.useFilters = this.oldUseFilters;\n    // tslint:disable-next-line:no-any\n    (xhr as any).filters = this.oldFilters;\n  }\n\n  private decode(request: sinon.SinonFakeXMLHttpRequest): Payload {\n    const contentType = request.requestHeaders[\"Content-Type\"];\n    const { requestBody } = request;\n    switch (contentType) {\n    case \"application/x-www-form-urlencoded;charset=utf-8\":\n      return qs.parse(requestBody);\n    case \"json\":\n      return JSON.parse(requestBody);\n    default:\n      throw new Error(`unknown content type: ${contentType}`);\n    }\n  }\n\n  private handleSave(request: sinon.SinonFakeXMLHttpRequest): void {\n    const decoded = this.decode(request);\n    this._saveRequests.push(decoded);\n    let status = 200;\n    const headers: Record<string, string> =\n      { \"Content-Type\": \"application/json\" };\n    // tslint:disable-next-line:no-reserved-keywords\n    const messages: { type: string }[] = [];\n\n    function populateSaveResponse(): void {\n      headers.ETag = btoa(md5(decoded.data, undefined, true));\n      messages.push({ type: \"save_successful\" });\n    }\n\n    switch (decoded.command) {\n    case \"check\":\n      break;\n    case \"save\":\n    case \"autosave\":\n      if (!this.emptyResponseOnSave) {\n        if (this.tooOldOnSave) {\n          messages.push({ type: \"version_too_old_error\" });\n        }\n\n        if (this.preconditionFailOnSave) {\n          status = 412;\n        }\n        else if (this.failOnSave) {\n          status = 400;\n        }\n        else {\n          populateSaveResponse();\n        }\n      }\n      break;\n    case \"recover\":\n      populateSaveResponse();\n      break;\n    default:\n      status = 400;\n    }\n\n    request.respond(status, headers, JSON.stringify({ messages }));\n  }\n}\n\nexport function makeWedRoot(doc: Document): HTMLElement {\n  const wedroot = doc.createElement(\"div\");\n  wedroot.className = \"wed-widget container\";\n  return wedroot;\n}\n\nexport function errorCheck(): void {\n  // We read the state, reset, and do the assertion later so that if the\n  // assertion fails, we still have our reset.\n  const wasTerminating = onerror.is_terminating();\n\n  // We don't reload our page so we need to do this.\n  onerror.__test.reset();\n  expect(wasTerminating)\n    .to.equal(false, \"test caused an unhandled exception to occur\");\n}\n\n// tslint:disable-next-line:completed-docs\nexport class EditorSetup {\n  private static provider: DataProvider = new DataProvider(\"\");\n\n  public readonly sandbox: sinon.SinonSandbox;\n  public readonly server: WedServer;\n  public readonly wedroot: HTMLElement;\n  public readonly editor: Editor;\n\n  constructor(public readonly source: string,\n              options: Options, doc: Document) {\n    this.sandbox = sinon.createSandbox({\n      useFakeServer: true,\n    });\n\n    this.server = new WedServer(this.sandbox.server);\n\n    this.wedroot = makeWedRoot(document);\n    doc.body.appendChild(this.wedroot);\n    this.editor = makeEditor(this.wedroot, options) as Editor;\n  }\n\n  async init(): Promise<Editor> {\n    const provider = (this.constructor as typeof EditorSetup).provider;\n    const data = await provider.getText(this.source);\n    return this.editor.init(data);\n  }\n\n  reset(): void {\n    const editor = this.editor;\n    editor.undoAll();\n    editor.resetLabelVisibilityLevel();\n    editor.editingMenuManager.dismiss();\n    // We set the caret to a position that will trigger some display changes\n    // (e.g. hide attributes).\n    editor.caretManager.setCaret(editor.caretManager.minCaret);\n    // Then we clear the selection to reset the caret to undefined. The mark\n    // will still be visible, but that's not an issue.\n    editor.caretManager.clearSelection();\n    this.server.reset();\n    errorCheck();\n  }\n\n  restore(): void {\n    if (this.editor !== undefined) {\n      this.editor.destroy();\n    }\n\n    this.server.restore();\n\n    errorCheck();\n\n    if (this.wedroot !== undefined) {\n      document.body.removeChild(this.wedroot);\n    }\n\n    if (this.sandbox !== undefined) {\n      this.sandbox.restore();\n    }\n\n    // Immediately destroy all notifications to prevent interfering with other\n    // tests. ($.notifyClose is not drastic enough.)\n    $(\"[data-notify=container]\").remove();\n  }\n}\n"]}