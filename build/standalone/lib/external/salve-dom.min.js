!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("salve")):"function"==typeof define&&define.amd?define(["salve"],t):"object"==typeof exports?exports["salve-dom"]=t(require("salve")):e["salve-dom"]=t(e.salve)}(this,function(e){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t,r){"use strict";/**
 * A listener class.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright Mangalam Research Center for Buddhist Languages
 */
Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._eventListeners=Object.create(null),this._generalListeners=[],this._trace=!1}return e.prototype.addEventListener=function(e,t){if("*"===e)this._generalListeners.push(t);else{var r=this._eventListeners[e];void 0===r&&(r=this._eventListeners[e]=[]),r.push(t)}},e.prototype.addOneTimeEventListener=function(e,t){var r=this,n=function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];return r.removeEventListener(e,n),t.apply(r,o)};return this.addEventListener(e,n),n},e.prototype.removeEventListener=function(e,t){var r="*"===e?this._generalListeners:this._eventListeners[e];if(void 0!==r){var n=r.lastIndexOf(t);n!==-1&&r.splice(n,1)}},e.prototype.removeAllListeners=function(e){"*"===e?this._generalListeners=[]:this._eventListeners[e]=[]},e.prototype._emit=function(e,t){this._trace&&console.log("simple_event_emitter emitting:",e,"with:",t);var r=this._generalListeners;if(r.length>0){r=r.slice();for(var n=0,o=r;n<o.length;n++){var i=o[n],s=i.call(void 0,e,t);if(s===!1)return}}var r=this._eventListeners[e];if(void 0!==r&&r.length>0){r=r.slice();for(var a=0,l=r;a<l.length;a++){var i=l[a],s=i.call(void 0,t);if(s===!1)return}}},e}();t.EventEmitter=n},function(e,t,r){"use strict";function n(e,t){(void 0!==Object.getPrototypeOf?Object.getPrototypeOf(e):e.__proto__)!==t&&(void 0!==Object.setPrototypeOf?Object.setPrototypeOf(e,t.prototype):e.__proto__=t.prototype)}Object.defineProperty(t,"__esModule",{value:!0}),t.fixPrototype=n},function(t,r){t.exports=e},function(e,t,r){"use strict";function n(e,t){return Array.prototype.indexOf.call(e,t)}function o(e){var t=Node.ATTRIBUTE_NODE;return e instanceof Attr||void 0!==t&&e.nodeType===t}function i(e,t,r,n){for(var o=e.possible().toArray(),i=!1,s=0,a=o;s<a.length;s++){var l=a[s];if(l.params[0]===t){var d=l.params[1],u=d.match(r,n);if(i=i||u,u&&!d.wildcardMatch(r,n))return!1}}return i}var s=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0});/**
 * Main module of salve-dom.
 * @author Louis-Dominique Dubeau
 * @license MPL 2.0
 * @copyright Mangalam Research Center for Buddhist Languages
 */
var a=r(2),l=r(0),d=r(1);t.isAttr=o;var u;!function(e){e[e.START_TAG=1]="START_TAG",e[e.CONTENTS=2]="CONTENTS",e[e.END_TAG=3]="END_TAG"}(u||(u={}));var h;!function(e){e[e.INCOMPLETE=1]="INCOMPLETE",e[e.WORKING=2]="WORKING",e[e.INVALID=3]="INVALID",e[e.VALID=4]="VALID"}(h=t.WorkingState||(t.WorkingState={}));var c=function(){function e(e,t){this.partDone=e,this.portion=t}return e}(),v=new a.Event("enterContext"),p=new a.Event("leaveStartTag"),f=new a.Event("leaveContext"),_=function(e){function t(){var r=e.call(this,"undefined event_index; _validateUpTo should have taken care of that")||this;return d.fixPrototype(r,t),r}return s(t,e),t}(Error),E=function(){function e(e,t,r){void 0===r&&(r={}),this.schema=e,this.root=t,this._cycleEntered=0,this._timeout=200,this._maxTimespan=100,this._resetting=!1,this._errors=[],this._boundWrapper=this._workWrapper.bind(this),this._validationEvents=[],this._workingState=h.INCOMPLETE,this._partDone=0,this._validationStage=u.CONTENTS,this._previousChild=null,this._validationStack=[new c(0,1)],this._walkerCache=Object.create(null),this._walkerCacheMax=-1,this._prefix="salveDom",this._walkerCacheGap=100,this._events=new l.EventEmitter;for(var n=["timeout","maxTimespan","walkerCacheGap"],o=0,i=n;o<i.length;o++){var s=i[o],a=r[s];if(void 0!==a){if(a<0)throw new Error("the value for "+s+" cannot be negative");this["_"+s]=r[s]}}void 0!==r.prefix&&(this._prefix=r.prefix),this._curEl=this.root,this._setNodeProperty(this._curEl,"EventIndexAfterStart",this._validationEvents.length),this._setWorkingState(h.INCOMPLETE,0),this._validationWalker=this.schema.newWalker(),this.events=this._events}return e.prototype.makeKey=function(e){return""+this._prefix+e},e.prototype.getNodeProperty=function(e,t){return e[this.makeKey(t)]},e.prototype._setNodeProperty=function(e,t,r){e[this.makeKey(t)]=r},e.prototype._clearNodeProperties=function(e){for(var t=["EventIndexAfter","EventIndexAfterStart","EventIndexBeforeAttributes","EventIndexAfterAttributes","PossibleDueToWildcard"],r=0,n=t;r<n.length;r++){var o=n[r];delete e[this.makeKey(o)]}},e.prototype.start=function(){void 0!==this._timeoutId&&this._stop(h.WORKING),this._timeoutId=setTimeout(this._boundWrapper,0)},e.prototype.getSchemaNamespaces=function(){return this.schema.getNamespaces()},e.prototype.getDocumentNamespaces=function(){function e(r){if(null!==r){for(var n=r.attributes.length,o=0;o<n;++o){var i=r.attributes[o];if(0===i.name.lastIndexOf("xmlns",0)){var s=i.name.slice(6),a=t[s];void 0===a&&(a=t[s]=[]),a.push(i.value)}}for(var l=r.firstChild;null!==l;)l.nodeType===Node.ELEMENT_NODE&&e(l),l=l.nextSibling}}var t={};return e(this.root.firstChild),t},e.prototype._workWrapper=function(){this._work()&&(this._timeoutId=setTimeout(this._boundWrapper,this._timeout))},e.prototype._work=function(){for(var e=Date.now();;){if(this._maxTimespan>0&&Date.now()-e>=this._maxTimespan)return!0;if(!this._cycle())return!1}},e.prototype._cycle=function(){var e=this;if(this._resetting=!1,this._cycleEntered>0)throw new Error("internal error: _cycle is being reentered");if(this._cycleEntered<0)throw new Error("internal error: _cycleEntered negative");this._cycleEntered++;var t=this._validationWalker,r=this._validationStack,o=this._validationEvents,i=r[0].portion,s=this._validationStage,l=function(){var l=d._curEl;switch(s){case u.START_TAG:l=l,r.unshift(new c(d._partDone,i)),d._fireAndProcessEvent(t,v,l,0);for(var _=l.attributes.length,E=0;E<_;++E){var N=l.attributes[E];"xmlns"===N.name?d._fireAndProcessEvent(t,new a.Event("definePrefix","",N.value),l,0):0===N.name.lastIndexOf("xmlns:",0)&&d._fireAndProcessEvent(t,new a.Event("definePrefix",N.name.slice(6),N.value),l,0)}var m=l.tagName,y=l.parentNode,g=n(y.childNodes,l),T=t.resolveName(m,!1);return void 0===T&&(d._processEventResult([new a.ValidationError("cannot resolve the name "+m)],y,g),T=new a.EName("",m)),d._setPossibleDueToWildcard(l,t,"enterStartTag",T.ns,T.name),d._fireAndProcessEvent(t,new a.Event("enterStartTag",T.ns,T.name),y,g),d._setNodeProperty(l,"EventIndexBeforeAttributes",o.length),d._fireAttributeEvents(t,l),d._setNodeProperty(l,"EventIndexAfterAttributes",o.length),d._fireAndProcessEvent(t,p,l,0),s=d._validationStage=u.CONTENTS,d._setNodeProperty(l,"EventIndexAfterStart",o.length),d._cycleEntered--,{value:!0};case u.CONTENTS:for(var w,b=null===d._previousChild?l.firstChild:d._previousChild.nextSibling,A=[],x=function(){if(0!==A.length){var r=new a.Event("text",A.join("")),o=t.fireEvent(r);if(o instanceof Array){if(void 0===w)throw new Error("flushText running with undefined node");var i=w.parentNode;e._processEventResult(o,i,n(i.childNodes,w))}}A=[],w=void 0};null!==b;){switch(b.nodeType){case Node.TEXT_NODE:A.push(b.data),void 0===w&&(w=b);break;case Node.ELEMENT_NODE:return x(),i/=l.childElementCount,d._curEl=l=b,s=d._validationStage=u.START_TAG,d._previousChild=null,"continue-stage_change";case Node.COMMENT_NODE:break;default:throw new Error("unexpected node type: "+b.nodeType)}b=b.nextSibling}x(),s=d._validationStage=u.END_TAG;break;case u.END_TAG:if(l===d.root){var O=t.end();return O instanceof Array&&d._processEventResult(O,l,l.childNodes.length),d._runDocumentValidation(),d._setNodeProperty(l,"EventIndexAfter",o.length),d._partDone=1,d._stop(d._errors.length>0?h.INVALID:h.VALID),d._cycleEntered--,{value:!1}}var k=l,m=l.tagName,T=t.resolveName(m,!1);void 0===T&&(T=new a.EName("",m)),d._fireAndProcessEvent(t,new a.Event("endTag",T.ns,T.name),l,l.childNodes.length),d._fireAndProcessEvent(t,f,l,l.childNodes.length),d._previousChild=l,d._curEl=l=l.parentNode;var D=d._partDone;if(l!==d.root){r.shift();var P=r[0];D=P.partDone+=i,i=P.portion}return d._setWorkingState(h.WORKING,D),d._setNodeProperty(k,"EventIndexAfter",d._validationEvents.length),s=d._validationStage=u.CONTENTS,d._cycleEntered--,{value:!0};default:throw new Error("unexpected state")}},d=this;e:for(;;){var _=l();if("object"==typeof _)return _.value;switch(_){case"continue-stage_change":continue e}}},e.prototype.stop=function(){this._stop()},e.prototype._stop=function(e){void 0!==this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0,void 0===e?this._workingState===h.WORKING&&this._setWorkingState(h.INCOMPLETE,this._partDone):this._setWorkingState(e,this._partDone)},e.prototype._runDocumentValidation=function(){},e.prototype.restartAt=function(e){this.resetTo(e),this.start()},e.prototype.resetTo=function(e){this._resetting||(this._resetting=!0,this._resetTo(e))},e.prototype._erase=function(e){this._clearNodeProperties(e);for(var t=e.firstElementChild;null!==t;)this._erase(t),t=t.nextElementSibling},e.prototype._resetTo=function(e){this._erase(this.root),this._validationStage=u.CONTENTS,this._previousChild=null,this._validationWalker=this.schema.newWalker(),this._validationEvents=[],this._curEl=this.root,this._partDone=0,this._errors=[],this._walkerCache=Object.create(null),this._walkerCacheMax=-1,this._events._emit("reset-errors",{at:0})},e.prototype._setWorkingState=function(e,t){var r=!1;this._workingState!==e&&(this._workingState=e,r=!0),this._partDone!==t&&(this._partDone=t,r=!0),r&&this._events._emit("state-update",{state:e,partDone:t})},e.prototype.getWorkingState=function(){return{state:this._workingState,partDone:this._partDone}},Object.defineProperty(e.prototype,"errors",{get:function(){return this._errors.slice()},enumerable:!0,configurable:!0}),e.prototype._processEventResult=function(e,t,r){for(var n=0,o=e;n<o.length;n++){var i=o[n];this._processError({error:i,node:t,index:r})}},e.prototype._processError=function(e){this._errors.push(e),this._events._emit("error",e)},e.prototype._fireAttributeEvents=function(e,t){for(var r=t.attributes,n=0;n<r.length;++n){var o=r[n];"xmlns"!==o.name&&0!==o.name.lastIndexOf("xmlns",0)&&this._fireAttributeNameEvent(e,t,o)&&this._fireAndProcessEvent(e,new a.Event("attributeValue",o.value),o,0)}},e.prototype._fireAttributeNameEvent=function(e,t,r){var n=r.name,o=e.resolveName(n,!0);return void 0===o?(this._processError({error:new a.ValidationError("cannot resolve attribute name "+n),node:r,index:0}),!1):(this._setPossibleDueToWildcard(r,e,"attributeName",o.ns,o.name),this._fireAndProcessEvent(e,new a.Event("attributeName",o.ns,o.name),r,0),!0)},e.prototype._fireAndProcessEvent=function(e,t,r,o){this._validationEvents.push(t);var i=e.fireEvent(t);i instanceof Array&&(null!=r&&void 0!==o&&"number"!=typeof o&&(o=n(r.childNodes,o)),this._processEventResult(i,r,o))},e.prototype._validateUpTo=function(e,t,r){if(void 0===r&&(r=!1),(r=!!r)&&(void 0===e.childNodes||e.childNodes[t].nodeType!==Node.ELEMENT_NODE))throw new Error("trying to validate after attributes but before the end of the start tag on a node which is not an element node");var n=e,i="EventIndexAfter";if(e===this.root&&t<=0){if(r)i="EventIndexAfterAttributes",n=e.childNodes[t];else if(0===t)return}else if(o(e))n=e.ownerElement,i="EventIndexBeforeAttributes";else switch(e.nodeType){case Node.TEXT_NODE:n=e.previousElementSibling,null===n&&(n=e.parentNode,i="EventIndexAfterStart");break;case Node.ELEMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:case Node.DOCUMENT_NODE:var s=e.childNodes[t],a=void 0===s?e.lastElementChild:s.previousElementSibling;r?(i="EventIndexAfterAttributes",n=s):null!==a?n=a:i="EventIndexAfterStart";break;default:throw new Error("unexpected node type: "+e.nodeType)}for(;void 0===this.getNodeProperty(n,i);)this._cycle()},e.prototype._getWalkerAt=function(e,t,r){function n(e){if(void 0===i)throw new Error("calling fireTextEvent without a walker");i.fireEvent(new a.Event("text",e.data))}if(void 0===r&&(r=!1),(r=!!r)&&(void 0===e.childNodes||e.childNodes[t].nodeType!==Node.ELEMENT_NODE))throw new Error("trying to get a walker for attribute events on a node which is not an element node");if(this._validateUpTo(e,t,r),e===this.root&&t<=0&&!r)return 0===t?this.schema.newWalker():this._validationWalker;var i;if(o(e)){var s=e.ownerElement;i=this.readyWalker(this.getNodeProperty(s,"EventIndexBeforeAttributes")),"xmlns"!==e.name&&"xmlns"!==e.prefix&&(i=i.clone(),this._fireAttributeNameEvent(i,s,e))}else switch(e.nodeType){case Node.TEXT_NODE:var l=e.previousElementSibling,d=void 0,u=void 0;null!==l?(d=l,u="EventIndexAfter"):(d=e.parentNode,u="EventIndexAfterStart"),i=this.readyWalker(this.getNodeProperty(d,u)),t>0&&(i=i.clone(),n(e));break;case Node.ELEMENT_NODE:case Node.DOCUMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:var h=e.childNodes[t],l=void 0,d=void 0,u=void 0;if(r?(d=h,u="EventIndexAfterAttributes"):(l=void 0===h?e.lastElementChild:h.previousElementSibling,null!==l?(d=l,u="EventIndexAfter"):(d=e,u="EventIndexAfterStart")),i=this.readyWalker(this.getNodeProperty(d,u)),!r){var c=null!=h?h.previousSibling:null;null!==c&&c!==l&&c.nodeType===Node.TEXT_NODE&&(i=i.clone(),n(c))}break;default:throw new Error("unexpected node type: "+e.nodeType)}return i},e.prototype.readyWalker=function(e){if(void 0===e)throw new _;var t=this._walkerCache,r=this._walkerCacheMax,n=t[e];if(n)return n;var o=e;if(o>=r)o=r,n=t[o];else for(;!n&&--o>=0;)n=t[o];n?n=n.clone():(n=this.schema.newWalker(),o=0);for(var i=o;i<e;++i)n.fireEvent(this._validationEvents[i]);return e-o>=this._walkerCacheGap&&(t[e]=n,this._walkerCacheMax=Math.max(e,r)),n},e.prototype.possibleAt=function(e,t,r){return void 0===r&&(r=!1),this._getWalkerAt(e,t,r).possible()},e.prototype.possibleWhere=function(e,t){for(var r=[],n=0;n<=e.childNodes.length;++n){var o=this.possibleAt(e,n);if(o.has(t))r.push(n);else if("enterStartTag"===t.params[0]||"attributeName"===t.params[0])for(var i=0,s=o.toArray();i<s.length;i++){var a=s[i];if(a.params[0]===t.params[0]&&a.params[1].match(t.params[1],t.params[2])){r.push(n);break}}}return r},e.prototype.speculativelyValidate=function(e,t,r){var n;if(r instanceof Array){n=e.ownerDocument.createDocumentFragment();for(var o=0,i=r;o<i.length;o++){var s=i[o];n.insertBefore(s.cloneNode(!0),null)}}else n=r.cloneNode(!0);var a=e.ownerDocument.createElement("div");return a.insertBefore(n,null),this.speculativelyValidateFragment(e,t,a)},e.prototype.speculativelyValidateFragment=function(t,r,n){if(n.nodeType!==Node.ELEMENT_NODE)throw new Error("toParse is not an element");var o=new e(this.schema,n);return o._validationWalker=this._getWalkerAt(t,r).clone(),o._validateUpTo(n,n.childNodes.length),0!==o._errors.length&&o._errors},e.prototype.getErrorsFor=function(e){var t=e.parentNode;if(null===t)throw new Error("node without a parent!");this._validateUpTo(t,n(t.childNodes,e)+1);for(var r=[],o=0,i=this._errors;o<i.length;o++){var s=i[o];s.node===e&&r.push(s)}return r},e.prototype._setPossibleDueToWildcard=function(e,t,r,n,o){var s=this.getNodeProperty(e,"PossibleDueToWildcard"),a=i(t,r,n,o);this._setNodeProperty(e,"PossibleDueToWildcard",a),void 0!==s&&s===a||this._events._emit("possible-due-to-wildcard-change",e)},e.prototype.resolveNameAt=function(e,t,r,n){return void 0===n&&(n=!1),this._getWalkerAt(e,t).resolveName(r,n)},e.prototype.unresolveNameAt=function(e,t,r,n){return this._getWalkerAt(e,t).unresolveName(r,n)},e}();t.Validator=E}])});
//# sourceMappingURL=salve-dom.min.map.js