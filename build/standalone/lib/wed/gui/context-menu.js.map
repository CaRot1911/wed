{"version":3,"sources":["../../../wed/gui/context-menu.ts"],"names":[],"mappings":"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","file":"context-menu.js","sourcesContent":["/**\n * Context menus.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\n\nimport \"bootstrap\";\nimport * as $ from \"jquery\";\nimport * as domutil from \"../domutil\";\n\nexport type DismissCallback = () => void;\n\n/**\n * A context menu GUI element.\n */\nexport class ContextMenu {\n  private readonly dismissCallback: DismissCallback | undefined;\n  /**\n   * The ``Element`` that contains the list of menu items. This ``Element`` is\n   * an HTML list. It is created at construction of the object and deleted only\n   * when the object is destroyed. This is what the [[ContextMenu.render]]\n   * method should populate.\n   */\n  protected readonly menu: HTMLElement;\n\n  /**\n   * The jQuery equivalent of [[ContextMenu.menu]].\n   */\n  protected readonly $menu: JQuery;\n\n  protected dismissed: boolean;\n  protected dropdown: HTMLElement;\n  protected backdrop: Element;\n\n  private x: number;\n  private y: number;\n\n  /**\n   * @param document The DOM document for which to make this\n   * context menu.\n   *\n   * @param x Position of the menu. The context menu may ignore this position if\n   * the menu would appear off-screen.\n   *\n   * @param y Position of the menu.\n   *\n   * @param items The items to show in the menu. These should be list items\n   * containing links appropriately formatted for a menu.\n   *\n   * @param dismissCallback Function to call when the menu is dismissed.\n   *\n   * @param immediateDisplay If true, will call ``render`` from the constructor.\n   */\n  constructor(document: Document, x: number, y: number,\n              items: Element[], dismissCallback?: DismissCallback,\n              immediateDisplay: boolean = true) {\n    this.dismissCallback = dismissCallback;\n    this.dismissed = false;\n\n    const dropdown = document.createElement(\"div\");\n    dropdown.className = \"dropdown wed-context-menu\";\n    // tslint:disable-next-line:no-inner-html\n    dropdown.innerHTML =\n      // This fake toggle is required for bootstrap to do its work.\n      \"<a href='#' data-toggle='dropdown'></a>\" +\n      \"<ul class='dropdown-menu' role='menu'></ul>\";\n    const menu = dropdown.lastElementChild! as HTMLElement;\n    // We move the top and left so that we appear under the mouse cursor.\n    // Hackish, but it works. If we don't do this, then the mousedown that\n    // brought the menu up also registers as a click on the body element and the\n    // menu disappears right away.  (It would be nice to have a more general\n    // solution some day.)\n    x -= 5;\n    y -= 5;\n    dropdown.style.top = `${y}px`;\n    dropdown.style.left = `${x}px`;\n    this.x = x;\n    this.y = y;\n\n    const $menu = $(menu);\n\n    this.menu = menu;\n    this.$menu = $menu;\n\n    this.dropdown = dropdown;\n    this.backdrop = document.createElement(\"div\");\n    this.backdrop.className = \"wed-context-menu-backdrop\";\n\n    $(this.backdrop).click(this.backdropClickHandler.bind(this));\n\n    $menu.on(\"click\", this.contentsClickHandler.bind(this));\n\n    $menu.on(\"mousedown\", (ev) => {\n      ev.stopPropagation();\n    });\n\n    $(dropdown).on(\"contextmenu mouseup\", false);\n\n    const body = document.body;\n    body.insertBefore(dropdown, body.firstChild);\n    body.insertBefore(this.backdrop, body.firstChild);\n\n    if (immediateDisplay) {\n      this.display(items);\n    }\n  }\n\n  protected display(items: Element[]): void {\n    const dropdown = this.dropdown;\n    const $toggle = $(dropdown.firstElementChild!);\n\n    this.render(items);\n\n    const $menu = this.$menu;\n    const menu = this.menu;\n    const document = dropdown.ownerDocument;\n    const x = this.x;\n    let y = this.y;\n\n    // Verify if we're going to run off screen. If so, then modify our position\n    // to be inside the screen.\n    const width = $menu.outerWidth();\n    const winWidth = $(document.defaultView).width();\n    // The x value that would put the menu just against the side of the window\n    // is width - winWidth. If x is less than it, then x is the value we want,\n    // but we don't want less than 0.\n    dropdown.style.left = `${Math.max(0, Math.min(x, winWidth - width))}px`;\n    menu.style.maxWidth = `${winWidth}px`;\n\n    // Adjust height so that we can see about 5 lines.\n    const fiveLines = Number($menu.css(\"line-height\").replace(\"px\", \"\")) * 5;\n\n    const winHeight = $(document.defaultView).height();\n    let maxHeight = winHeight - y;\n    if (maxHeight < fiveLines) {\n      y -= fiveLines - maxHeight;\n      maxHeight = fiveLines;\n    }\n    dropdown.style.top = `${y}px`;\n    menu.style.maxHeight = `${maxHeight}px`;\n\n    $toggle.focus(this.handleToggleFocus.bind(this));\n    $toggle.dropdown(\"toggle\");\n\n    //\n    // What is going on here? When Bootstrap detects that touch events are\n    // supported, it assumes it is on a mobile device (which is a false\n    // assumption) and adds a backdrop to its dropdowns so as to be able to\n    // close it if the user \"clicks\" outside the dropdown. This messes up our\n    // own handling of the same scenario. To prevent this issue, we remove any\n    // backdrop added by Bootstrap. (It may be possible to keep both backdrops\n    // around but it would just complicate the code needlessly.)\n    //\n    // Note that we cannot rely on Bootstrap's backdrop, generally, because, as\n    // mentioned already, it won't be added for non-mobile platforms. However,\n    // we *always* need to detect clicks outside our menu, on all platforms.\n    //\n    const bootstrapBackdrop =\n      domutil.childByClass(dropdown, \"dropdown-backdrop\");\n    if (bootstrapBackdrop !== null) {\n      dropdown.removeChild(bootstrapBackdrop);\n    }\n  }\n\n  /**\n   * Event handler for focus events on the toggle. Bootstrap focuses the toggle\n   * when the dropdown is shown. This can cause problems on some platforms if\n   * the dropdown is meant to have a descendant focused. (IE in particular\n   * grants focus asynchronously.) This method can be used to focus the proper\n   * element.\n   */\n  handleToggleFocus(): void {\n    // Default does nothing.\n  }\n\n  /**\n   * Event handler for clicks on the contents. Dismissed the menu.\n   */\n  private contentsClickHandler(ev: Event): false {\n    this.dismiss();\n    ev.stopPropagation();\n    ev.preventDefault();\n    return false;\n  }\n\n  /**\n   * Event handler for clicks on the backdrop. Dismisses the menu.\n   * @private\n   */\n  private backdropClickHandler(): false {\n      this.dismiss();\n      return false;\n  }\n\n  /**\n   * Subclasses can override this to customize what is shown to the user. For\n   * instance, subclasses could accept a list of items which is more complex\n   * than DOM ``Element`` objects. Or could include in the list shown to the\n   * user some additional GUI elements.\n   *\n   * @param items The list of items that should make up the menu.\n   */\n  protected render(items: Element[]): void {\n    this.$menu.append(items);\n  }\n\n  /**\n   * Dismisses the menu.\n   */\n  dismiss(): void {\n    if (this.dismissed) {\n      return;\n    }\n\n    this.$menu.dropdown(\"toggle\");\n    if (this.dropdown.parentNode !== null) {\n      this.dropdown.parentNode.removeChild(this.dropdown);\n    }\n    if (this.backdrop.parentNode !== null) {\n      this.backdrop.parentNode.removeChild(this.backdrop);\n    }\n    if (this.dismissCallback !== undefined) {\n      this.dismissCallback();\n    }\n    this.dismissed = true;\n  }\n}\n\n//  LocalWords:  contextmenu mousedown dropdown tabindex href gui MPL px\n//  LocalWords:  Mangalam Dubeau ul jQuery Prepend util jquery mouseup winWidth\n//  LocalWords:  dropdowns\n"]}