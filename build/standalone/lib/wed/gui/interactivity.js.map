{"version":3,"file":"interactivity.js","sourceRoot":"","sources":["../../../../../lib/wed/gui/interactivity.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Add interactivity to existing GUI elements.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\nimport interact from \"interactjs\";\n\nimport * as browsers from \"../browsers\";\n\n/**\n * This records changes in such a way that if any of the changes cannot take\n * effect, then all the changes are \"rolled back\". It is called pseudo-atomic\n * because it is not really meant to track any changes that do not happen\n * through instances of this class. This is needed because we are changing the\n * size of multiple elements, and beyond a certain \"smallness\", some elements\n * won't register any change in dimensions (perhaps due to \"min-...\" styles.\n */\nclass PseudoAtomicRectChange {\n  private readonly changes: { el: HTMLElement; rect: ClientRect }[] = [];\n  private rolledback: boolean = false;\n\n  updateElementRect(el: HTMLElement, dx: number, dy: number): void {\n    // If we've already rolled back, we don't do anything.\n    if (this.rolledback) {\n      return;\n    }\n\n    let rect = el.getBoundingClientRect();\n\n    // This works around a fractional pixel issue in IE. We set the element to\n    // the dimensions returned by getBoundingClientRect and then reacquire the\n    // dimensions to account for any funny adjustments IE may decide to do.\n    if (browsers.MSIE) {\n      el.style.width = `${rect.width}px`;\n      el.style.height = `${rect.height}px`;\n\n      rect = el.getBoundingClientRect();\n    }\n\n    const width = rect.width + dx;\n    const height = rect.height + dy;\n    el.style.width = `${width}px`;\n    el.style.height = `${height}px`;\n    this.changes.push({ el: el, rect: rect });\n    const newRect = el.getBoundingClientRect();\n\n    // Check whether the change \"took\". If not, roll back.\n    if (newRect.width !== width || newRect.height !== height) {\n      this.rollback();\n    }\n  }\n\n  rollback(): void {\n    const changes = this.changes;\n    for (const change of changes) {\n      const el = change.el;\n      const rect = change.rect;\n      el.style.width = `${rect.width}px`;\n      el.style.height = `${rect.height}px`;\n    }\n\n    this.rolledback = true;\n  }\n}\n\n/**\n * Make a bootstrap dialog resizable by clicking on its edge.\n *\n * @param $top The top level element of the dialog.\n */\nexport function makeResizable($top: JQuery): void {\n  // We listen to resizestart and resizeend to deal with the following scenario:\n  // the user starts resizing the modal, it goes beyond the limits of how big it\n  // can be resized, the mouse pointer moves outside the modal window and the\n  // user releases the button when the pointer is outside. Without the use of\n  // ignoreBackdropClick, this causes the modal to close.\n  const content = $top.find(\".modal-content\")[0];\n  const body = $top.find(\".modal-body\")[0];\n  interact(content)\n    .resizable({})\n    .on(\"resizestart\", () => {\n      const modal = $top.data(\"bs.modal\");\n      if (modal == null) {\n        return; // Deal with edge cases.\n      }\n      // Prevent modal closure.\n      modal.ignoreBackdropClick = true;\n    })\n    .on(\"resizeend\", () => {\n      // We use a setTimeout otherwise we turn ignoreBackdropClick too soon.\n      setTimeout(() => {\n        const modal = $top.data(\"bs.modal\");\n        if (modal == null) {\n          return; // Deal with edge cases.\n        }\n        modal.ignoreBackdropClick = false;\n      }, 0);\n    })\n    .on(\"resizemove\", (event: interact.InteractEvent) => {\n      const target = event.target;\n\n      const change = new PseudoAtomicRectChange();\n      change.updateElementRect(target, event.dx, event.dy);\n      change.updateElementRect(body, event.dx, event.dy);\n    });\n}\n\n/**\n * Make a bootstrap dialog draggable by clicking and dragging the header.\n *\n * @param $top The top level element of the dialog.\n */\nexport function makeDraggable($top: JQuery): void {\n  const win = $top[0].ownerDocument.defaultView;\n  const header = $top.find(\".modal-header\")[0];\n  const content = $top.find(\".modal-content\")[0];\n\n  let startLeft: number;\n  let startTop: number;\n  interact(header)\n    .draggable({\n      restrict: {\n        restriction: {\n          left: 0,\n          top: 0,\n          right: win.innerWidth - 10,\n          bottom: win.innerHeight - 10,\n        },\n      },\n    })\n    .on(\"dragstart\", () => {\n      startLeft = content.offsetLeft;\n      startTop = content.offsetTop;\n    })\n    .on(\"dragmove\", (event: interact.InteractEvent) => {\n      content.style.left = `${startLeft + event.clientX - event.clientX0}px`;\n      content.style.top = `${startTop + event.clientY - event.clientY0}px`;\n    });\n}\n"]}