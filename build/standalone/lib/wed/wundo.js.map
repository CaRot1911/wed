{"version":3,"file":"wundo.js","sourceRoot":"","sources":["../../../../lib/wed/wundo.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Wed-specific undo functionality.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\n\nimport { Editor } from \"./editor\";\nimport * as undo from \"./undo\";\n\nexport type Caret = [string | undefined, number | undefined];\n\n/**\n * This class extends the vanilla UndoGroup class by recording the\n * location of the caret when the group is created and when group\n * recording ends. This allows restoring the caret to sensible\n * positions before and after undoing or redoing.\n */\nexport class UndoGroup extends undo.UndoGroup {\n  private readonly editor: Editor;\n  private readonly caretAsPathBefore: Caret;\n  private caretAsPathAfter: Caret | undefined;\n\n  /**\n   * @param desc The description of this group.\n   *\n   * @param editor The editor for which this undo group is created.\n   */\n  constructor(desc: string, editor: Editor) {\n    super(desc);\n    this.editor = editor;\n    this.caretAsPathBefore = this.getDataCaretAsPath();\n  }\n\n  performUndo(): void {\n    super.performUndo();\n    this.setDataCaretAsPath(this.caretAsPathBefore);\n  }\n\n  performRedo(): void {\n    super.performRedo();\n    if (this.caretAsPathAfter === undefined) {\n      throw new Error(`caretAsPathAfter is undefined, this indicates a \\\ncorrupted state and thus an internal error`);\n    }\n    this.setDataCaretAsPath(this.caretAsPathAfter);\n  }\n\n  /**\n   * Get the current data caret position as a path.\n   *\n   * @returns A caret.\n   */\n  getDataCaretAsPath(): Caret {\n    const caret = this.editor.caretManager.getDataCaret(true);\n    if (caret === undefined) {\n      // Returning undefined for \"the caret was undefined\" would not\n      // trap stupid mistakes in managing the data.\n      return [undefined, undefined];\n    }\n    return [this.editor.dataUpdater.nodeToPath(caret.node), caret.offset];\n  }\n\n  /**\n   * Set the data caret.\n   *\n   * @param caret A caret.\n   */\n  setDataCaretAsPath(caret: Caret): void {\n    // [undefined, undefined] === the caret was undefined. We can't do anything.\n    if (caret[0] === undefined && caret[1] === undefined) {\n      return;\n    }\n    this.editor.caretManager.setCaret(\n      this.editor.dataUpdater.pathToNode(caret[0]!), caret[1]);\n  }\n\n  /**\n   * This method can be used to record the caret position after the acts\n   * recorded by this undo are performed. If the caret is recorded by means of\n   * this method, then [[end]] will not record the caret position again. This\n   * can be useful in cases for which it is not clear when an UndoGroup might\n   * end. [[TextUndoGroup]] is a case in point. This method can be called any\n   * number of times to update the caret position at the end of the group.\n   */\n  recordCaretAfter(): void {\n    this.caretAsPathAfter = this.getDataCaretAsPath();\n  }\n\n  end(): void {\n    if (this.caretAsPathAfter === undefined) {\n      this.recordCaretAfter();\n    }\n  }\n}\n\n/**\n * Grouping of text operations should be limited in size. For instance, if the\n * user hits backspace to delete a whole sentence and then wants to undo this\n * operation. It is better to undo it in chunks instead of reinserting the whole\n * sentence. This class allows for limiting the length of such chunks.\n */\nexport class TextUndoGroup extends UndoGroup {\n    /**\n     * @param desc The description of this group.\n     *\n     * @param editor The editor for which this undo group is created.\n     *\n     * @param undoList The list which will hold this group.\n     *\n     * @param limit The maximum number of undo operations that this group should\n     * record.\n     */\n  constructor(desc: string, editor: Editor,\n              private readonly undoList: undo.UndoList,\n              private readonly limit: number) {\n    super(desc, editor);\n  }\n\n  record(undoToRecord: undo.Undo): void {\n    if (this.list.length >= this.limit) {\n      throw new Error(\"TextUndoGroup.record called beyond the limit\");\n    }\n    super.record(undoToRecord);\n    if (this.list.length === this.limit) {\n      this.undoList.endGroup();\n    }\n  }\n}\n\n//  LocalWords:  pathToNode nodeToPath Dubeau MPL Mangalam param UndoGroup\n//  LocalWords:  TextUndoGroup caretAsPathAfter\n"]}