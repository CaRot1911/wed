{"version":3,"file":"editor.js","sourceRoot":"","sources":["../../../../lib/wed/editor.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * The editor.\n * @author Louis-Dominique Dubeau\n * @license MPL 2.0\n * @copyright Mangalam Research Center for Buddhist Languages\n */\nimport Ajv from \"ajv\";\nimport \"bootstrap\";\nimport $ from \"jquery\";\nimport { Observable } from \"rxjs\";\nimport { filter } from \"rxjs/operators\";\nimport * as salve from \"salve\";\nimport { WorkingState, WorkingStateData } from \"salve-dom\";\n\nimport { Action } from \"./action\";\nimport { CaretChange, CaretManager } from \"./caret-manager\";\nimport * as caretMovement from \"./caret-movement\";\nimport { DLoc, DLocRoot } from \"./dloc\";\nimport * as domlistener from \"./domlistener\";\nimport { isAttr, isElement, isText } from \"./domtypeguards\";\nimport * as domutil from \"./domutil\";\n// tslint:disable-next-line:no-duplicate-imports\nimport { closest, closestByClass, htmlToElements, indexOf } from \"./domutil\";\nimport * as editorActions from \"./editor-actions\";\nimport { AbortTransformationException } from \"./exceptions\";\nimport { GUIUpdater } from \"./gui-updater\";\nimport { GUIValidationError } from \"./gui-validation-error\";\nimport { DialogSearchReplace } from \"./gui/dialog-search-replace\";\nimport { EditingMenuManager } from \"./gui/editing-menu-manager\";\nimport { ErrorLayer } from \"./gui/error-layer\";\nimport * as icon from \"./gui/icon\";\nimport { Layer } from \"./gui/layer\";\nimport { Minibuffer } from \"./gui/minibuffer\";\nimport { Modal, Options as ModalOptions } from \"./gui/modal\";\nimport { notify } from \"./gui/notify\";\nimport { Direction, QuickSearch } from \"./gui/quick-search\";\nimport { Scroller } from \"./gui/scroller\";\nimport { AddOptions, Toolbar } from \"./gui/toolbar\";\nimport { tooltip } from \"./gui/tooltip\";\nimport { AttributeNotFound, GUIRoot } from \"./guiroot\";\nimport { Key, makeKey } from \"./key\";\nimport * as keyConstants from \"./key-constants\";\nimport * as log from \"./log\";\nimport { Mode } from \"./mode\";\nimport { EditorAPI , PasteTransformationData,\n         ReplaceRangeTransformationData } from \"./mode-api\";\nimport { ModeTree } from \"./mode-tree\";\nimport * as onbeforeunload from \"./onbeforeunload\";\nimport * as onerror from \"./onerror\";\nimport { Options } from \"./options\";\nimport * as optionsSchema from \"./options-schema.json\";\nimport * as preferences from \"./preferences\";\nimport { Runtime } from \"./runtime\";\nimport { FailedEvent, SaveKind, Saver, SaverConstructor } from \"./saver\";\nimport { StockModals } from \"./stock-modals\";\nimport { Task, TaskRunner } from \"./task-runner\";\nimport { insertElement, mergeWithNextHomogeneousSibling,\n         mergeWithPreviousHomogeneousSibling, removeMarkup, splitNode,\n         Transformation, TransformationData, TransformationEvent,\n         TransformationEventSubject } from \"./transformation\";\nimport { BeforeInsertNodeAtEvent, InsertNodeAtEvent,\n         TreeUpdater } from \"./tree-updater\";\nimport { Undo, UndoEvents, UndoList } from \"./undo\";\nimport { UndoRecorder } from \"./undo-recorder\";\nimport * as util from \"./util\";\nimport { ErrorItemHandler,\n         ValidationController } from \"./validation-controller\";\nimport { Validator } from \"./validator\";\nimport { boundaryXY, getGUINodeIfExists } from \"./wed-util\";\nimport * as wundo from \"./wundo\";\n\nexport const version = \"2.0.0\";\n\nexport type KeydownHandler = (wedEv: JQueryEventObject,\n                              ev: JQueryKeyEventObject) => boolean;\n\n// We don't put this in keyConstants because ESCAPE_KEYPRESS should never be\n// seen elsewhere.\nconst ESCAPE_KEYPRESS = makeKey(27);\n\nfunction filterSaveEvents(name: string, ev: { name: string }): boolean {\n  return ev.name === name;\n}\n\n/**\n * An action for bringing up the complex pattern modal.\n */\nclass ComplexPatternAction extends Action<{}> {\n  private _modal: Modal | undefined;\n\n  get modal(): Modal {\n    if (this._modal === undefined) {\n      const modal = this._modal = this.editor.makeModal();\n      modal.setTitle(\"Complex Name Pattern Encountered\");\n      modal.setBody(\n        \"<p>The schema contains here a complex name pattern modal. While wed \\\nhas no problem validating such cases. It does not currently have facilities to \\\nadd elements or attributes that match such patterns. You can continue editing \\\nyour document but you will not be able to take advantage of the possibilities \\\nprovided by the complex pattern here.</p>\");\n      modal.addButton(\"Ok\", true);\n    }\n    return this._modal;\n  }\n\n  execute(): void {\n    this.modal.modal();\n  }\n}\n\n/**\n * The possible targets for some wed operations that generate events. It is\n * currently used to determine where to type keys when calling [[Editor.type]].\n */\nexport enum WedEventTarget {\n  /** The default target is the main editing panel. */\n  DEFAULT,\n  /** Target the minibuffer. */\n  MINIBUFFER,\n}\n\nconst FRAMEWORK_TEMPLATE = \"\\\n<div class='row'>\\\n <div class='toolbar'></div>\\\n <div class='wed-frame col-sm-push-2 col-lg-10 col-md-10 col-sm-10'>\\\n  <div class='row'>\\\n   <div class='progress'>\\\n    <span></span>\\\n    <div class='wed-validation-progress progress-bar' style='width: 0%'></div>\\\n   </div>\\\n  </div>\\\n  <div class='row'>\\\n   <div class='wed-cut-buffer' contenteditable='true'></div>\\\n   <div class='wed-document-constrainer'>\\\n    <input class='wed-comp-field' type='text'></input>\\\n    <div class='wed-scroller'>\\\n     <div class='wed-caret-layer'></div>\\\n     <div class='wed-error-layer'></div>\\\n     <div class='wed-document'><span class='root-here'></span></div>\\\n    </div>\\\n   </div>\\\n   <div class='wed-minibuffer'></div>\\\n   <div class='wed-location-bar'>@&nbsp;<span>&nbsp;</span></div>\\\n  </div>\\\n </div>\\\n <div class='wed-sidebar col-sm-pull-10 col-lg-2 col-md-2 col-sm-2'>\\\n  <div class='wed-save-and-modification-status'>\\\n   <span class='wed-modification-status label label-success' \\\n         title='Modification status'>\\\n    <i class='fa fa-asterisk'></i>\\\n   </span>\\\n   <span class='wed-save-status label label-default'>\\\n    <i class='fa fa-cloud-upload'></i> <span></span>\\\n   </span>\\\n  </div>\\\n  <div id='sidebar-panel' class='panel-group wed-sidebar-panel'>\\\n   <div class='panel panel-info wed-navigation-panel'>\\\n    <div class='panel-heading'>\\\n     <div class='panel-title'>\\\n      <a class='accordion-toggle' data-toggle='collapse' \\\n         data-parent='#sidebar-panel' href='#sb-nav-collapse'>Navigation</a>\\\n     </div>\\\n    </div>\\\n   <div id='sb-nav-collapse' data-parent='#sidebar-panel' \\\n        class='panel-collapse collapse in'>\\\n     <div id='sb-nav' class='panel-body'>\\\n      <ul id='navlist' class='nav nav-list'>\\\n       <li class='inactive'>A list of navigation links will appear here</li>\\\n      </ul>\\\n     </div>\\\n    </div>\\\n   </div>\\\n   <div class='panel panel-danger'>\\\n    <div class='panel-heading'>\\\n     <div class='panel-title'>\\\n      <a class='accordion-toggle' data-toggle='collapse'\\\n         data-parent='#sidebar-panel' href='#sb-errors-collapse'>Errors</a>\\\n     </div>\\\n    </div>\\\n    <div id='sb-errors-collapse' data-parent='#sidebar-panel'\\\n         class='panel-collapse collapse'>\\\n     <div id='sb-errors' class='panel-body'>\\\n      <ul id='sb-errorlist' class='nav nav-list wed-errorlist'>\\\n       <li class='inactive'></li>\\\n      </ul>\\\n     </div>\\\n    </div>\\\n   </div>\\\n  </div>\\\n </div>\\\n</div>\";\n\n/**\n * This is the class to instantiate for editing.\n */\nexport class Editor implements EditorAPI {\n  private _firstValidationComplete: boolean = false;\n  private firstValidationCompleteResolve!: (value: Editor) => void;\n  private initializedResolve!: (value: Editor) => void;\n  // tslint:disable-next-line:no-any\n  private modeData: any = {};\n  private developmentMode: boolean = false;\n  private textUndoMaxLength: number = 10;\n  private readonly taskRunners: TaskRunner[] = [];\n  private taskSuspension: number = 0;\n  // We may want to make this configurable in the future.\n  private readonly normalizeEnteredSpaces: boolean = true;\n  private readonly strippedSpaces: RegExp = /\\u200B/g;\n  private readonly replacedSpaces: RegExp = /\\s+/g;\n  private destroyed: boolean = false;\n  private initialLabelLevel: number = 0;\n  private currentLabelLevel: number = 0;\n  /** A temporary initialization value. */\n  private _dataChild: Element | undefined;\n  private readonly scroller: Scroller;\n  private readonly constrainer: HTMLElement;\n  private readonly inputField: HTMLInputElement;\n  private readonly $inputField: JQuery;\n  private readonly cutBuffer: HTMLElement;\n  private readonly caretLayer: Layer;\n  private readonly errorLayer: ErrorLayer;\n  private readonly wedLocationBar: HTMLElement;\n  private readonly sidebar: HTMLElement;\n  private readonly validationProgress: HTMLElement;\n  private readonly validationMessage: HTMLElement;\n  private readonly caretOwners: NodeListOf<Element>;\n  private readonly clickedLabels: NodeListOf<Element>;\n  private readonly withCaret: NodeListOf<Element>;\n  private readonly $modificationStatus: JQuery;\n  private readonly $saveStatus: JQuery;\n  private readonly $navigationPanel: JQuery;\n  private readonly $navigationList: JQuery;\n  private readonly $excludedFromBlur: JQuery;\n  private readonly errorItemHandlerBound: ErrorItemHandler;\n  private readonly appender: log4javascript.AjaxAppender | undefined;\n  private readonly _undo: UndoList;\n  private undoRecorder!: UndoRecorder;\n  private saveStatusInterval: number | undefined;\n  private readonly globalKeydownHandlers: KeydownHandler[] = [];\n  private updatingPlaceholder: number = 0;\n  private readonly preferences: preferences.Preferences;\n  private composing: boolean = false;\n  private compositionData: {\n    // tslint:disable-next-line:no-any\n    data: any;\n    startCaret: DLoc | undefined;\n  } | undefined;\n  private validationController!: ValidationController;\n  private readonly _transformations: TransformationEventSubject =\n    new TransformationEventSubject();\n\n  readonly name: string = \"\";\n  readonly firstValidationComplete: Promise<Editor>;\n  readonly initialized: Promise<Editor>;\n  readonly widget: HTMLElement;\n  readonly $widget: JQuery;\n  readonly $frame: JQuery;\n  readonly window: Window;\n  readonly doc: Document;\n  readonly runtime: Runtime;\n  readonly options: Options;\n  readonly guiRoot: HTMLElement;\n  readonly $guiRoot: JQuery;\n  readonly $errorList: JQuery;\n  readonly complexPatternAction: Action<{}>;\n  readonly pasteTr: Transformation<PasteTransformationData>;\n  readonly cutTr: Transformation<TransformationData>;\n  readonly splitNodeTr: Transformation<TransformationData>;\n  readonly replaceRangeTr: Transformation<ReplaceRangeTransformationData>;\n  readonly removeMarkupTr: Transformation<TransformationData>;\n  readonly saveAction: Action<{}> =\n    new editorActions.Save(this);\n  readonly decreaseLabelVisibilityLevelAction: Action<{}> =\n    new editorActions.DecreaseLabelVisibilityLevel(this);\n  readonly increaseLabelVisibilityLevelAction: Action<{}> =\n    new editorActions.IncreaseLabelVisibilityLevel(this);\n  readonly undoAction: Action<{}> =\n    new editorActions.Undo(this);\n  readonly redoAction: Action<{}> =\n    new editorActions.Redo(this);\n  readonly toggleAttributeHidingAction: Action<{}> =\n    new editorActions.ToggleAttributeHiding(this);\n  readonly minibuffer: Minibuffer;\n  readonly docURL: string;\n  readonly transformations: Observable<TransformationEvent> =\n    this._transformations.asObservable();\n  readonly toolbar: Toolbar;\n  dataRoot!: Document;\n  $dataRoot!: JQuery;\n  maxLabelLevel: number = 0;\n  guiDLocRoot!: DLocRoot;\n  dataDLocRoot!: DLocRoot;\n  dataUpdater!: TreeUpdater;\n  guiUpdater!: GUIUpdater;\n  domlistener!: domlistener.DOMListener;\n  modals: StockModals;\n\n  mergeWithPreviousHomogeneousSiblingTr: Transformation<TransformationData>;\n\n  mergeWithNextHomogeneousSiblingTr: Transformation<TransformationData>;\n\n  modeTree!: ModeTree;\n\n  caretManager!: CaretManager;\n\n  validator!: Validator;\n\n  editingMenuManager!: EditingMenuManager;\n\n  saver!: Saver;\n\n  // tslint:disable-next-line:max-func-body-length\n  constructor(widget: HTMLElement, options: Options | Runtime) {\n    // tslint:disable-next-line:promise-must-complete\n    this.firstValidationComplete = new Promise((resolve) => {\n      this.firstValidationCompleteResolve = resolve;\n    });\n\n    // tslint:disable-next-line:promise-must-complete\n    this.initialized = new Promise((resolve) => {\n      this.initializedResolve = resolve;\n    });\n\n    onerror.editors.push(this);\n\n    this.widget = widget;\n    this.$widget = $(this.widget);\n\n    // We could be loaded in a frame in which case we should not alter anything\n    // outside our frame.\n    this.$frame = $(closest(this.widget, \"html\"));\n    const doc = this.doc = this.$frame[0].ownerDocument;\n    this.window = doc.defaultView;\n\n    // It is possible to pass a runtime as \"options\" but if the user passed\n    // actual options, then make a runtime from them.\n    this.runtime = (options instanceof Runtime) ? options :\n      new Runtime(options);\n    options = this.runtime.options;\n\n    this.modals = new StockModals(this);\n\n    // ignore_module_config allows us to completely ignore the module config. In\n    // some case, it may be difficult to just override individual values.\n    // tslint:disable-next-line:no-any strict-boolean-expressions\n    if ((options as any).ignore_module_config) {\n      console.warn(\"the option ignore_module_config is no longer useful\");\n    }\n\n    const ajv = new Ajv();\n    const optionsValidator = ajv.compile(optionsSchema);\n\n    if (!optionsValidator(options)) {\n      // tslint:disable-next-line:prefer-template\n      throw new Error(\"the options passed to wed are not valid: \" +\n                      ajv.errorsText(optionsValidator.errors!, {\n                        dataVar: \"options\",\n                      }));\n    }\n\n    if (options.ajaxlog !== undefined) {\n      this.appender = log.addURL(options.ajaxlog.url, options.ajaxlog.headers);\n    }\n\n    this.name = options.name !== undefined ? options.name : \"\";\n    this.options = options;\n\n    const docURL = this.options.docURL;\n    this.docURL = docURL == null ? \"./doc/index.html\" : docURL;\n\n    this.preferences = new preferences.Preferences({\n      tooltips: true,\n    });\n\n    // This structure will wrap around the document to be edited.\n    //\n    // We duplicate data-parent on the toggles and on the collapsible\n    // elements due to a bug in Bootstrap 3.0.0. See\n    // https://github.com/twbs/bootstrap/issues/9933.\n    //\n    const framework = htmlToElements(FRAMEWORK_TEMPLATE, doc)[0] as HTMLElement;\n\n    //\n    // Grab all the references we need while framework does not yet contain the\n    // document to be edited. (Faster!)\n    //\n\n    const guiRoot = this.guiRoot =\n      framework.getElementsByClassName(\"wed-document\")[0] as HTMLElement;\n    this.$guiRoot = $(guiRoot);\n    this.scroller =\n      new Scroller(\n        framework.getElementsByClassName(\"wed-scroller\")[0] as HTMLElement);\n\n    this.constrainer =\n      framework\n      .getElementsByClassName(\"wed-document-constrainer\")[0] as HTMLElement;\n\n    const toolbar = this.toolbar = new Toolbar();\n    const toolbarPlaceholder = framework.getElementsByClassName(\"toolbar\")[0];\n    toolbarPlaceholder.parentNode!.insertBefore(toolbar.top,\n                                                toolbarPlaceholder);\n    toolbarPlaceholder.parentNode!.removeChild(toolbarPlaceholder);\n\n    this.inputField =\n      framework.getElementsByClassName(\"wed-comp-field\")[0] as HTMLInputElement;\n    this.$inputField = $(this.inputField);\n    this.cutBuffer =\n      framework.getElementsByClassName(\"wed-cut-buffer\")[0] as HTMLElement;\n\n    this.caretLayer = new Layer(\n      framework.getElementsByClassName(\"wed-caret-layer\")[0] as HTMLElement);\n    this.errorLayer = new ErrorLayer(\n      framework.getElementsByClassName(\"wed-error-layer\")[0] as HTMLElement);\n\n    this.wedLocationBar =\n      framework.getElementsByClassName(\"wed-location-bar\")[0] as HTMLElement;\n\n    this.minibuffer = new Minibuffer(\n      framework.getElementsByClassName(\"wed-minibuffer\")[0] as HTMLElement);\n\n    const sidebar = this.sidebar =\n      framework.getElementsByClassName(\"wed-sidebar\")[0] as HTMLElement;\n\n    this.validationProgress =\n      framework\n      .getElementsByClassName(\"wed-validation-progress\")[0] as HTMLElement;\n    this.validationMessage =\n      this.validationProgress.previousElementSibling as HTMLElement;\n\n    // Insert the framework and put the document in its proper place.\n    const rootPlaceholder = framework.getElementsByClassName(\"root-here\")[0];\n\n    if (this.widget.firstChild !== null) {\n      // tslint:disable-next-line:no-any\n      if (!(this.widget.firstChild instanceof (this.window as any).Element)) {\n        throw new Error(\"the data is populated with DOM elements constructed \" +\n                        \"from another window\");\n      }\n\n      rootPlaceholder.parentNode!.insertBefore(this.widget.firstChild,\n                                               rootPlaceholder);\n    }\n    rootPlaceholder.parentNode!.removeChild(rootPlaceholder);\n    this.widget.appendChild(framework);\n\n    this.caretOwners = guiRoot.getElementsByClassName(\"_owns_caret\");\n    this.clickedLabels = guiRoot.getElementsByClassName(\"_label_clicked\");\n    this.withCaret = guiRoot.getElementsByClassName(\"_with_caret\");\n\n    this.$modificationStatus =\n      $(sidebar.getElementsByClassName(\"wed-modification-status\")[0]);\n    this.$saveStatus =\n      $(sidebar.getElementsByClassName(\"wed-save-status\")[0]);\n\n    this.$navigationPanel =\n      $(sidebar.getElementsByClassName(\"wed-navigation-panel\")[0]);\n    this.$navigationPanel.css(\"display\", \"none\");\n\n    this.$navigationList = $(doc.getElementById(\"navlist\"));\n    this.$errorList = $(doc.getElementById(\"sb-errorlist\"));\n    this.$excludedFromBlur = $();\n    this.errorItemHandlerBound = this.errorItemHandler.bind(this);\n    this._undo = new UndoList();\n\n    this.complexPatternAction = new ComplexPatternAction(\n      this, \"Complex name pattern\", undefined, icon.makeHTML(\"exclamation\"),\n      true);\n\n    this.pasteTr = new Transformation(this, \"add\", \"Paste\",\n                                      this.paste.bind(this));\n    this.cutTr = new Transformation(this, \"delete\", \"Cut\", this.cut.bind(this));\n\n    this.replaceRangeTr =\n      new Transformation(\n        this, \"transform\", \"Replace Range\", this.replaceRange.bind(this));\n\n    this.splitNodeTr =\n      new Transformation(this, \"split\", \"Split <name>\",\n                         (editor, data) => {\n                           splitNode(editor, data.node!);\n                         });\n\n    this.mergeWithPreviousHomogeneousSiblingTr =\n      new Transformation(\n        this, \"merge-with-previous\", \"Merge <name> with previous\",\n        (editor, data) => {\n          mergeWithPreviousHomogeneousSibling(editor, data.node as Element);\n        });\n\n    this.mergeWithNextHomogeneousSiblingTr =\n      new Transformation(\n        this, \"merge-with-next\", \"Merge <name> with next\",\n        (editor, data) => {\n          mergeWithNextHomogeneousSibling(editor, data.node as Element);\n        });\n\n    this.removeMarkupTr =\n      new Transformation(this, \"delete\", \"Remove mixed-content markup\",\n          \"Remove mixed-content markup\", \"<i class='fa fa-eraser'></i>\", true,\n          removeMarkup);\n\n    toolbar.addButton([this.saveAction.makeButton(),\n                       this.undoAction.makeButton(),\n                       this.redoAction.makeButton(),\n                       this.decreaseLabelVisibilityLevelAction.makeButton(),\n                       this.increaseLabelVisibilityLevelAction.makeButton(),\n                       this.removeMarkupTr.makeButton(),\n                       this.toggleAttributeHidingAction.makeButton()]);\n\n    // Setup the cleanup code.\n    $(this.window).on(\"unload.wed\", { editor: this }, (e) => {\n      e.data.editor.destroy();\n    });\n\n    $(this.window).on(\"popstate.wed\", () => {\n      if (document.location.hash === \"\") {\n        this.guiRoot.scrollTop = 0;\n      }\n    });\n  }\n\n  get undoEvents(): Observable<UndoEvents> {\n    return this._undo.events;\n  }\n\n  fireTransformation<T extends TransformationData>(tr: Transformation<T>,\n                                                   data: T): void {\n    // This is necessary because our context menu saves/restores the selection\n    // using rangy. If we move on without this call, then the transformation\n    // could destroy the markers that rangy put in and rangy will complain.\n    this.editingMenuManager.dismiss();\n    let currentGroup = this._undo.getGroup();\n    if (currentGroup instanceof wundo.TextUndoGroup) {\n      this._undo.endGroup();\n    }\n\n    const newGroup = new wundo.UndoGroup(`Undo ${tr.getDescriptionFor(data)}`,\n                                         this);\n    this._undo.startGroup(newGroup);\n    this.caretManager.mark.suspend();\n    this.enterTaskSuspension();\n    try {\n      try {\n        // We've separated the core of the work into a another method so that it\n        // can be optimized.\n        this._fireTransformation(tr, data);\n      }\n      catch (ex) {\n        // We want to log it before we attempt to do anything else.\n        if (!(ex instanceof AbortTransformationException)) {\n          log.handle(ex);\n        }\n        throw ex;\n      }\n      finally {\n        // It is possible for a transformation to create new subgroups without\n        // going through fireTransformation. So we terminate all groups until\n        // the last one we terminated is the one we created.\n        do {\n          currentGroup = this._undo.getGroup();\n          this._undo.endGroup();\n        } while (currentGroup !== newGroup);\n      }\n    }\n    catch (ex) {\n      this.undo();\n      if (!(ex instanceof AbortTransformationException)) {\n        throw ex;\n      }\n    }\n    finally {\n      this.caretManager.mark.resume();\n      this.exitTaskSuspension();\n      this.validationController.refreshErrors();\n    }\n  }\n\n  private _fireTransformation<T extends TransformationData>(\n    tr: Transformation<T>,\n    data: T): void {\n    const node = data.node;\n    if (node !== undefined) {\n      // Convert the gui node to a data node\n      if (this.guiRoot.contains(node)) {\n        const dataNode = this.toDataNode(node);\n        data.node = dataNode === null ? undefined : dataNode;\n      }\n      else {\n        if (!domutil.contains(this.dataRoot, node)) {\n          throw new Error(\"node is neither in the gui tree nor the data tree\");\n        }\n      }\n    }\n\n    const caret = data.moveCaretTo;\n    if (caret !== undefined) {\n      this.caretManager.setCaret(caret);\n    }\n\n    if (this.caretManager.caret === undefined) {\n      throw new Error(\"transformation applied with undefined caret.\");\n    }\n\n    const start =\n      new TransformationEvent(\"StartTransformation\",\n                              tr as Transformation<TransformationData>);\n    this._transformations.next(start);\n    start.throwIfAborted();\n\n    tr.handler(this, data);\n    const end =\n      new TransformationEvent(\"EndTransformation\",\n                              tr as Transformation<TransformationData>);\n    this._transformations.next(end);\n    end.throwIfAborted();\n  }\n\n  /**\n   * Enter a state in which all tasks are suspended. It is possible to call this\n   * method while the state is already in effect. Its sister method\n   * ``exitTaskSuspension`` should be called the same number of times to resume\n   * the tasks.\n   */\n  private enterTaskSuspension(): void {\n    if (this.taskSuspension === 0) {\n      this.stopAllTasks();\n    }\n    this.taskSuspension++;\n  }\n\n  /**\n   * Exit a state in which all tasks are suspended. For the state to be\n   * effectively exited, this method needs to be called the same number of times\n   * ``enterTaskSuspension`` was called.\n   */\n  private exitTaskSuspension(): void {\n    this.taskSuspension--;\n    if (this.taskSuspension < 0) {\n      throw new Error(\"exitTaskSuspension underflow\");\n    }\n    if (this.taskSuspension === 0) {\n      this.resumeAllTasks();\n    }\n  }\n\n  /**\n   * Unconditionally stop all tasks.\n   */\n  private stopAllTasks(): void {\n    for (const runner of this.taskRunners) {\n      runner.stop();\n    }\n\n    this.validationController.stop();\n  }\n\n  /**\n   * Unconditionally resume all tasks.\n   */\n  private resumeAllTasks(): void {\n    for (const runner of this.taskRunners) {\n      runner.resume();\n    }\n\n    // The validator is a special case. And yes, ``start`` is the correct method\n    // to call on it.\n    this.validationController.resume();\n  }\n\n  /**\n   * If we are not in the task suspended state that is entered upon calling\n   * ``enterTaskSuspension``, resume the task right away. Otherwise, this is a\n   * no-op.\n   */\n  resumeTaskWhenPossible(task: TaskRunner): void {\n    if (this.taskSuspension === 0) {\n      task.resume();\n    }\n  }\n\n  /**\n   * Record an undo object in the list of undoable operations.\n   *\n   * Note that this method also provides the implementation for the restricted\n   * method of the same name that allows only [[\"wed/undo\".UndoMarker]] objects.\n   *\n   * @param undo The object to record.\n   */\n  recordUndo(undo: Undo): void {\n    this._undo.record(undo);\n  }\n\n  undoAll(): void {\n    while (this._undo.canUndo()) {\n      this.undo();\n    }\n  }\n\n  undo(): void {\n    // We need to replicate to some extent how fireTransformation inhibits\n    // functions and reinstates them.\n    this.caretManager.mark.suspend();\n    this.enterTaskSuspension();\n\n    this.undoRecorder.suppressRecording(true);\n    this._undo.undo();\n    this.undoRecorder.suppressRecording(false);\n\n    this.caretManager.mark.resume();\n    this.exitTaskSuspension();\n  }\n\n  redo(): void {\n    // We need to replicate to some extent how fireTransformation inhibits\n    // functions and reinstates them.\n    this.caretManager.mark.suspend();\n    this.enterTaskSuspension();\n\n    this.undoRecorder.suppressRecording(true);\n    this._undo.redo();\n    this.undoRecorder.suppressRecording(false);\n\n    this.caretManager.mark.resume();\n    this.exitTaskSuspension();\n  }\n\n  dumpUndo(): void {\n    // tslint:disable-next-line:no-console\n    console.log(this._undo.toString());\n  }\n\n  undoingOrRedoing(): boolean {\n    return this._undo.undoingOrRedoing();\n  }\n\n  isAttrProtected(attr: string, parent: Element): boolean;\n  isAttrProtected(attr: Attr | Element): boolean;\n  isAttrProtected(attr: Attr | Element | string, parent?: Element): boolean {\n    let name;\n    if (typeof attr === \"string\") {\n      name = attr;\n      if (parent === undefined) {\n        throw new Error(\"must specify a parent\");\n      }\n    }\n    else if (isAttr(attr)) {\n      name = attr.name;\n    }\n    else if (isElement(attr)) {\n      name = domutil.siblingByClass(attr, \"_attribute_name\")!.textContent!;\n    }\n    else {\n      throw new Error(\"unexpected value for attr\");\n    }\n\n    return (name === \"xmlns\" || name.lastIndexOf(\"xmlns:\", 0) === 0);\n  }\n\n  save(): Promise<void> {\n    return this.saver.save();\n  }\n\n  private initiateTextUndo(): wundo.UndoGroup {\n    // Handle undo information\n    let currentGroup = this._undo.getGroup();\n    if (currentGroup === undefined ||\n        !(currentGroup instanceof wundo.TextUndoGroup)) {\n      currentGroup = new wundo.TextUndoGroup(\"text\", this, this._undo,\n                                             this.textUndoMaxLength);\n      this._undo.startGroup(currentGroup);\n    }\n\n    return currentGroup as wundo.UndoGroup;\n  }\n\n  private terminateTextUndo(): void {\n    const currentGroup = this._undo.getGroup();\n    if (currentGroup instanceof wundo.TextUndoGroup) {\n      this._undo.endGroup();\n    }\n  }\n\n  private normalizeEnteredText(text: string): string {\n    if (!this.normalizeEnteredSpaces) {\n      return text;\n    }\n\n    return text.replace(this.strippedSpaces, \"\")\n      .replace(this.replacedSpaces, \" \");\n  }\n\n  private compensateForAdjacentSpaces(text: string, caret: DLoc): string {\n    if (!this.normalizeEnteredSpaces) {\n      return text;\n    }\n\n    const arCaret = caret.toArray();\n    // If there is previous text and the previous text\n    // is a space, then we need to prevent a double\n    // space.\n    if (text[0] === \" \" &&\n        domutil.getCharacterImmediatelyBefore(arCaret) === \" \") {\n      text = text.slice(1);\n    }\n\n    // Same with the text that comes after.\n    if (text.length > 0 && text[text.length - 1] === \" \" &&\n        domutil.getCharacterImmediatelyAt(arCaret) === \" \") {\n      text = text.slice(-1);\n    }\n\n    return text;\n  }\n\n  insertText(text: string): void {\n    // We remove zero-width spaces.\n    this.closeAllTooltips();\n\n    text = this.normalizeEnteredText(text);\n\n    if (text === \"\") {\n      return;\n    }\n\n    const caretManager = this.caretManager;\n    let caret = caretManager.caret;\n\n    if (caret === undefined) {\n      return;\n    }\n\n    const el = closestByClass(caret.node, \"_real\", this.guiRoot);\n    // We do not operate on elements that are readonly.\n    if (el === null || el.classList.contains(\"_readonly\")) {\n      return;\n    }\n\n    this.enterTaskSuspension();\n    try {\n      const attrVal = closestByClass(caret.node, \"_attribute_value\",\n                                     this.guiRoot);\n      if (attrVal === null) {\n        caret = caretManager.getDataCaret()!;\n        text = this.compensateForAdjacentSpaces(text, caret);\n        if (text === \"\") {\n          return;\n        }\n\n        const textUndo = this.initiateTextUndo();\n        const { caret: newCaret } = this.dataUpdater.insertText(caret, text);\n        caretManager.setCaret(newCaret, { textEdit: true });\n        textUndo.recordCaretAfter();\n      }\n      else {\n        // Modifying an attribute...\n        this.spliceAttribute(attrVal as HTMLElement, caret.offset, 0, text);\n      }\n    }\n    finally {\n      this.exitTaskSuspension();\n      this.validationController.refreshErrors();\n    }\n  }\n\n  private spliceAttribute(attrVal: HTMLElement, offset: number, count: number,\n                          add: string): void {\n    if (offset < 0) {\n      return;\n    }\n\n    // We ignore changes to protected attributes.\n    if (this.isAttrProtected(attrVal)) {\n      return;\n    }\n\n    let val = (this.toDataNode(attrVal) as Attr).value;\n    if (offset > val.length) {\n      return;\n    }\n\n    if (offset === val.length && count > 0) {\n      return;\n    }\n\n    if (this.normalizeEnteredSpaces) {\n      if (add[0] === \" \" && val[offset - 1] === \" \") {\n        add = add.slice(1);\n      }\n\n      if (add[add.length - 1] === \" \" && val[offset + count] === \" \") {\n        add = add.slice(-1);\n      }\n    }\n\n    const textUndo = this.initiateTextUndo();\n    val = val.slice(0, offset) + add + val.slice(offset + count);\n    offset += add.length;\n    const dataReal =\n      $.data(closestByClass(attrVal, \"_real\")!, \"wed_mirror_node\");\n    const guiPath = this.nodeToPath(attrVal);\n    const name =\n      domutil.siblingByClass(attrVal, \"_attribute_name\")!.textContent!;\n    const mode = this.modeTree.getMode(attrVal);\n    const resolved = mode.getAbsoluteResolver().resolveName(name, true);\n    if (resolved === undefined) {\n      throw new Error(`cannot resolve ${name}`);\n    }\n    this.dataUpdater.setAttributeNS(dataReal, resolved.ns, resolved.name, val);\n    // Redecoration of the attribute's element may have destroyed our old\n    // attrVal node. Refetch. And after redecoration, the attribute value\n    // element may not have a child. Not only that, but the attribute may no\n    // longer be shown at all.\n    let moveTo;\n    try {\n      moveTo = this.pathToNode(guiPath)!;\n      if (moveTo.firstChild !== null) {\n        moveTo = moveTo.firstChild;\n      }\n    }\n    catch (ex) {\n      if (!(ex instanceof AttributeNotFound)) {\n        throw ex;\n      }\n    }\n\n    // We don't have an attribute to go back to. Go back to the element that\n    // held the attribute.\n    if (moveTo == null) {\n      moveTo = dataReal;\n      offset = 0;\n    }\n\n    this.caretManager.setCaret(moveTo, offset, { textEdit: true });\n    textUndo.recordCaretAfter();\n  }\n\n  insertTransientPlaceholderAt(loc: DLoc): Element {\n    const ph =\n      // tslint:disable-next-line:no-jquery-raw-elements\n      $(\"<span class='_placeholder _transient' contenteditable='false'> \\\n</span>\", loc.node.ownerDocument)[0];\n    this.guiUpdater.insertNodeAt(loc, ph);\n    return ph;\n  }\n\n  toDataNode(node: Node): Node | Attr | null {\n    if (isElement(node)) {\n      const ret = $.data(node, \"wed_mirror_node\");\n      // We can bypass the whole pathToNode, nodeToPath thing.\n      if (ret != null) {\n        return ret;\n      }\n    }\n\n    return this.dataUpdater.pathToNode(this.nodeToPath(node));\n  }\n\n  fromDataNode(node: Node): Node | null {\n    if (isElement(node)) {\n      const ret = $.data(node, \"wed_mirror_node\");\n      // We can bypass the whole pathToNode, nodeToPath thing.\n      if (ret != null) {\n        return ret;\n      }\n    }\n\n    return this.pathToNode(this.dataUpdater.nodeToPath(node));\n  }\n\n  private onSaverSaved(): void {\n    notify(\"Saved\", { type: \"success\" });\n    this.refreshSaveStatus();\n  }\n\n  private onSaverAutosaved(): void {\n    notify(\"Autosaved\", { type: \"success\" });\n    this.refreshSaveStatus();\n  }\n\n  private onSaverChanged(): void {\n    this.refreshSaveStatus();\n  }\n\n  private onSaverFailed(event: FailedEvent): void {\n    this.refreshSaveStatus();\n    const error = event.error;\n    if (error.type === \"too_old\") {\n      // Reload when the modal is dismissed.\n      this.modals.getModal(\"tooOld\").modal(\n        this.window.location.reload.bind(this.window.location));\n    }\n    else if (error.type === \"save_disconnected\") {\n      this.modals.getModal(\"disconnect\").modal(() => {\n        // tslint:disable-next-line:no-floating-promises\n        this.save();\n      });\n    }\n    else if (error.type === \"save_edited\") {\n      this.modals.getModal(\"editedByOther\").modal(() => {\n        this.window.location.reload();\n      });\n    }\n    else {\n      notify(`Failed to save!\\n${error.msg}`, { type: \"danger\" });\n    }\n  }\n\n  nodeToPath(node: Node | Attr): string {\n    return this.guiDLocRoot.nodeToPath(node);\n  }\n\n  pathToNode(path: string): Node | Attr | null {\n    return this.guiDLocRoot.pathToNode(path);\n  }\n\n  // tslint:disable-next-line:no-any\n  getModeData(key: string): any {\n    return this.modeData[key];\n  }\n\n  // tslint:disable-next-line:no-any\n  setModeData(key: string, value: any): void {\n    this.modeData[key] = value;\n  }\n\n  destroy(): void {\n    if (this.destroyed) {\n      return;\n    }\n\n    const myIndex = onerror.editors.indexOf(this);\n    if (myIndex >= 0) {\n      onerror.editors.splice(myIndex, 1);\n    }\n\n    //\n    // This is imperfect, but the goal here is to do as much work as possible,\n    // even if things have not been initialized fully.\n    //\n    // The last recorded exception will be rethrown at the end.\n    //\n\n    // Turn off autosaving.\n    if (this.saver !== undefined) {\n      this.saver.setAutosaveInterval(0);\n    }\n\n    if (this.saveStatusInterval !== undefined) {\n      clearInterval(this.saveStatusInterval);\n    }\n\n    try {\n      if (this.validationController !== undefined) {\n        this.validationController.terminate();\n      }\n    }\n    catch (ex) {\n      log.unhandled(ex);\n    }\n\n    if (this.taskRunners !== undefined) {\n      for (const runner of this.taskRunners) {\n        try {\n          runner.stop();\n        }\n        catch (ex) {\n          log.unhandled(ex);\n        }\n      }\n    }\n\n    try {\n      if (this.domlistener !== undefined) {\n        this.domlistener.stopListening();\n        this.domlistener.clearPending();\n      }\n    }\n    catch (ex) {\n      log.unhandled(ex);\n    }\n\n    if (this.editingMenuManager !== undefined) {\n      this.editingMenuManager.dismiss();\n    }\n\n    // These ought to prevent jQuery leaks.\n    try {\n      this.$widget.empty();\n      this.$frame.find(\"*\").off(\".wed\");\n      // This will also remove handlers on the window.\n      $(this.window).off(\".wed\");\n    }\n    catch (ex) {\n      log.unhandled(ex);\n    }\n\n    // Trash our variables: this will likely cause immediate failure if the\n    // object is used again.\n    for (const key of Object.keys(this)) {\n      // tslint:disable-next-line:no-any\n      delete (this as any)[key];\n    }\n\n    if (this.appender !== undefined) {\n      log.removeAppender(this.appender);\n    }\n\n    // ... but keep these two. Calling destroy over and over is okay.\n    this.destroyed = true;\n    // tslint:disable-next-line:no-empty\n    this.destroy = function fakeDestroy(): void {};\n  }\n\n  async init(xmlData?: string): Promise<Editor> {\n    const parser = new this.window.DOMParser();\n    if (xmlData !== undefined && xmlData !== \"\") {\n      this.dataRoot = parser.parseFromString(xmlData, \"text/xml\");\n      this._dataChild = this.dataRoot.firstChild as Element;\n    }\n    else {\n      this.dataRoot = parser.parseFromString(\"<div></div>\", \"text/xml\");\n      this._dataChild = undefined;\n    }\n    this.dataRoot.removeChild(this.dataRoot.firstChild!);\n\n    // $dataRoot is the document we are editing, $guiRoot will become decorated\n    // with all kinds of HTML elements so we keep the two separate.\n    this.$dataRoot = $(this.dataRoot);\n\n    this.guiDLocRoot = new GUIRoot(this.guiRoot);\n    this.dataDLocRoot = new DLocRoot(this.dataRoot);\n\n    this.dataUpdater = new TreeUpdater(this.dataRoot);\n    this.guiUpdater = new GUIUpdater(this.guiRoot, this.dataUpdater);\n    this.undoRecorder = new UndoRecorder(this, this.dataUpdater);\n\n    this.guiUpdater.events.subscribe((ev) => {\n      switch (ev.name) {\n      case \"BeforeInsertNodeAt\":\n        if (isElement(ev.node)) {\n          this.initialContentEditableHandler(ev);\n        }\n        break;\n      case \"InsertNodeAt\":\n        if (isElement(ev.node)) {\n          this.finalContentEditableHandler(ev);\n        }\n        break;\n      default:\n      }\n    });\n\n    // This is a workaround for a problem in Bootstrap >= 3.0.0 <= 3.2.0. When\n    // removing a Node that has an tooltip associated with it and the trigger is\n    // delayed, a timeout is started which may timeout *after* the Node and its\n    // tooltip are removed from the DOM. This causes a crash.\n    //\n    // All versions >= 3.0.0 also suffer from leaving the tooltip up if the Node\n    // associated with it is deleted from the DOM. This does not cause a crash\n    // but must be dealt with to avoid leaving orphan tooltips around.\n    //\n    const hasTooltips = document.getElementsByClassName(\"wed-has-tooltip\");\n    this.guiUpdater.events.subscribe((ev) => {\n      if (ev.name !== \"BeforeDeleteNode\") {\n        return;\n      }\n\n      const node = ev.node;\n      if (node.nodeType !== Node.TEXT_NODE) {\n        for (const hasTooltip of Array.from(hasTooltips)) {\n          if (!node.contains(hasTooltip)) {\n            continue;\n          }\n\n          const tt = $.data(hasTooltip, \"bs.tooltip\");\n          if (tt != null) {\n            tt.destroy();\n          }\n\n          // We don't remove the wed-has-tooltip class. Generally, the elements\n          // that have tooltips and are removed from the GUI tree won't be added\n          // to the tree again. If they are added again, they'll most likely get\n          // a new tooltip so removing the class does not gain us much because\n          // it will be added again.\n          //\n          // If we *were* to remove the class, then the collection would change\n          // as we go through it.\n        }\n      }\n    });\n\n    this.domlistener = new domlistener.DOMListener(this.guiRoot,\n                                                   this.guiUpdater);\n\n    this.modeTree = new ModeTree(this, this.options.mode);\n\n    await this.modeTree.init();\n    return this.onModeChange(this.modeTree.getMode(this.guiRoot));\n  }\n\n  private async onModeChange(mode: Mode): Promise<Editor> {\n    // We purposely do not raise an error here so that calls to destroy can be\n    // done as early as possible. It aborts the initialization sequence without\n    // causing an error.\n    if (this.destroyed) {\n      return this;\n    }\n\n    this.maxLabelLevel = this.modeTree.getMaxLabelLevel();\n    this.initialLabelLevel = this.modeTree.getInitialLabelLevel();\n    this.currentLabelLevel = this.initialLabelLevel;\n\n    const styles = this.modeTree.getStylesheets();\n    const $head = this.$frame.children(\"head\");\n    for (const style of styles) {\n      $head.append(`<link rel=\"stylesheet\" href=\"${style}\" type=\"text/css\" />`);\n    }\n\n    this.guiRoot.setAttribute(\"tabindex\", \"-1\");\n    this.$guiRoot.focus();\n\n    this.caretManager = new CaretManager(\n      this.guiDLocRoot,\n      this.dataDLocRoot,\n      this.inputField,\n      this.guiUpdater,\n      this.caretLayer,\n      this.scroller,\n      this.modeTree);\n    this.editingMenuManager = new EditingMenuManager(this);\n    this.caretManager.events.subscribe(this.caretChange.bind(this));\n    this.resizeHandler();\n\n    let schema: salve.Grammar;\n    const schemaOption = this.options.schema;\n    if (schemaOption instanceof salve.Grammar) {\n      schema = schemaOption;\n    }\n    else if (typeof schemaOption === \"string\") {\n      const schemaText = await this.runtime.resolveToString(schemaOption);\n      schema = salve.constructTree(schemaText);\n    }\n    else {\n      throw new Error(\"unexpected value for schema\");\n    }\n\n    this.validator = new Validator(schema, this.dataRoot,\n                                   this.modeTree.getValidators());\n    this.validator.events.addEventListener(\n      \"state-update\", this.onValidatorStateChange.bind(this));\n    this.validator.events.addEventListener(\n      \"possible-due-to-wildcard-change\",\n      this.onPossibleDueToWildcardChange.bind(this));\n    this.validationController =\n      new ValidationController(this,\n                               this.validator,\n                               mode.getAbsoluteResolver(),\n                               this.scroller,\n                               this.guiRoot,\n                               this.validationProgress,\n                               this.validationMessage,\n                               this.errorLayer,\n                               this.$errorList[0],\n                               this.errorItemHandlerBound);\n    return this.postInitialize();\n  }\n\n  // tslint:disable-next-line:max-func-body-length\n  private async postInitialize(): Promise<Editor> {\n    if (this.destroyed) {\n      return this;\n    }\n\n    // Make the validator revalidate the structure from the point where a change\n    // occurred.\n    this.domlistener.addHandler(\n      \"children-changed\",\n      \"._real, ._phantom_wrap, .wed-document\",\n      (_root: Node, added: Node[], removed: Node[], _prev: Node | null,\n       _next: Node | null, target: Element) => {\n        for (const child of added.concat(removed)) {\n          if (isText(child) ||\n              (isElement(child) &&\n               (child.classList.contains(\"_real\") ||\n                child.classList.contains(\"_phantom_wrap\")))) {\n            this.validator.resetTo(target);\n            break;\n          }\n        }\n      });\n\n    // Revalidate on attribute change.\n    this.domlistener.addHandler(\n      \"attribute-changed\",\n      \"._real\",\n      (_root: Node, el: Element, namespace: string, name: string) => {\n        if (namespace === \"\" && name.indexOf(\"data-wed\", 0) === 0) {\n          // Doing the restart immediately messes up the editing. So schedule it\n          // for ASAP.\n          setTimeout(() => {\n            if (this.destroyed) {\n              return;\n            }\n            this.validator.resetTo(el);\n          }, 0);\n        }\n      });\n\n    this.modeTree.addDecoratorHandlers();\n\n    this.domlistener.addHandler(\n      \"included-element\",\n      \"._label\",\n      (_root: Node, _tree: Node, _parent: Node, _prev: Node | null,\n       _next: Node | null, target: Element) => {\n         const cl = target.classList;\n         let found: number | undefined;\n         for (let i = 0; i < cl.length && found === undefined; ++i) {\n           if (cl[i].lastIndexOf(\"_label_level_\", 0) === 0) {\n             found = Number(cl[i].slice(13));\n           }\n         }\n         if (found === undefined) {\n           throw new Error(\"unable to get level\");\n         }\n         if (found > this.currentLabelLevel) {\n           cl.add(\"_invisible\");\n         }\n       });\n\n    // If an element is edited and contains a placeholder, delete the\n    // placeholder\n    this.domlistener.addHandler(\n      \"children-changed\",\n      \"._real, ._phantom_wrap, .wed-document\",\n      // tslint:disable-next-line:cyclomatic-complexity\n      (_root: Node, _added: Node[], removed: Node[], _prev: Node | null,\n       _next: Node | null, target: Element) => {\n         if (this.updatingPlaceholder !== 0) {\n           return;\n         }\n\n         this.updatingPlaceholder++;\n\n         // We perform this check on the GUI tree because there's no way to know\n         // about ._phantom._text elements in the data tree.\n         const toConsider: Node[] = [];\n         let ph: Element | undefined;\n         let child = target.firstChild;\n         while (child !== null) {\n           if (isText(child) ||\n               (isElement(child) &&\n                (child.classList.contains(\"_real\") ||\n                 child.classList.contains(\"_phantom_wrap\") ||\n                 // For ._phantom._text but ._text is used only with ._real and\n                 // ._phantom so we don't check for ._phantom.\n                 child.classList.contains(\"_text\")))) {\n             toConsider.push(child);\n           }\n           if (isElement(child) && child.classList.contains(\"_placeholder\")) {\n             ph = child;\n           }\n           child = child.nextSibling;\n         }\n\n         const caretManager = this.caretManager;\n         if (toConsider.length === 0 ||\n             (toConsider.length === 1 &&\n              removed.indexOf(toConsider[0]) !== -1)) {\n           if (ph === undefined) {\n             const mode = this.modeTree.getMode(target);\n             const nodes = mode.nodesAroundEditableContents(target);\n             if (target === this.guiRoot) {\n               const loc = caretManager.makeCaret(this.guiRoot, 0)!;\n               ph = this.insertTransientPlaceholderAt(loc);\n               caretManager.setCaret(loc, { textEdit: true });\n             }\n             else {\n               ph = mode.makePlaceholderFor(target);\n               this.guiUpdater.insertBefore(target, ph, nodes[1]);\n             }\n           }\n         }\n         else if (ph !== undefined && !ph.classList.contains(\"_transient\")) {\n           const caret = caretManager.caret !==  undefined ?\n             caretManager.caret.node : undefined;\n           // Move the caret out of the placeholder if needed...\n           const move = caret !== undefined && ph.contains(caret);\n           let parent;\n           let offset;\n           if (move) {\n             parent = ph.parentNode!;\n             offset = indexOf(parent.childNodes, ph);\n           }\n           this.guiUpdater.removeNode(ph);\n           if (move) {\n             caretManager.setCaret(parent, offset, { textEdit: true });\n           }\n         }\n\n         this.updatingPlaceholder--;\n       });\n\n    const attributePlaceholderHandler = (target: Element) => {\n      if (this.updatingPlaceholder !== 0) {\n        return;\n      }\n\n      this.updatingPlaceholder++;\n      const dataNode = this.toDataNode(target) as Attr;\n      const ph = domutil.childByClass(target, \"_placeholder\");\n      if (dataNode.value !== \"\") {\n        if (ph !== null) {\n          target.removeChild(ph);\n        }\n      }\n      else if (ph === null) {\n        this.guiUpdater.insertBefore(target, domutil.makePlaceholder(), null);\n      }\n      this.updatingPlaceholder--;\n    };\n\n    this.domlistener.addHandler(\n      \"children-changed\",\n      \"._attribute_value\",\n      (_root: Node, _added: Node[], _removed: Node[], _prev: Node | null,\n       _next: Node | null, target: Element) => {\n        attributePlaceholderHandler(target);\n      });\n\n    this.domlistener.addHandler(\n      \"included-element\",\n      \"._attribute_value\",\n      (_root: Node, _tree: Node, _parent: Node, _prev: Node | null,\n       _next: Node | null, target: Element) => {\n        attributePlaceholderHandler(target);\n      });\n\n    this.modeTree.startListening();\n    if (this._dataChild !== undefined) {\n      this.dataUpdater.insertAt(this.dataRoot, 0, this._dataChild);\n    }\n\n    // Drag and drop not supported by us. And we have to use \"as any\" to please\n    // TS.\n    const $guiRoot = this.$guiRoot;\n    // tslint:disable-next-line:no-any\n    $guiRoot.on(\"dragenter\" as any, \"*\", false);\n    // tslint:disable-next-line:no-any\n    $guiRoot.on(\"dragstart\" as any, \"*\", false);\n    // tslint:disable-next-line:no-any\n    $guiRoot.on(\"dragover\" as any, \"*\", false);\n    // tslint:disable-next-line:no-any\n    $guiRoot.on(\"drop\" as any, \"*\", false);\n\n    $guiRoot.on(\"wed-global-keydown\", this.globalKeydownHandler.bind(this));\n\n    $guiRoot.on(\"wed-global-keypress\", this.globalKeypressHandler.bind(this));\n\n    $guiRoot.on(\"keydown\", this.keydownHandler.bind(this));\n    $guiRoot.on(\"keypress\", this.keypressHandler.bind(this));\n\n    this.$inputField.on(\"keydown\", this.keydownHandler.bind(this));\n    this.$inputField.on(\"keypress\", this.keypressHandler.bind(this));\n\n    this.$inputField.on(\"compositionstart compositionupdate compositionend\",\n                        this.compositionHandler.bind(this));\n    this.$inputField.on(\"input\", this.inputHandler.bind(this));\n\n    // No click in the next binding because click does not distinguish left,\n    // middle, right mouse buttons.\n    $guiRoot.on(\"mousedown\", this.mousedownHandler.bind(this));\n    $guiRoot.on(\"mouseover\", this.mouseoverHandler.bind(this));\n    $guiRoot.on(\"mouseout\", this.mouseoutHandler.bind(this));\n    $guiRoot.on(\"contextmenu\", this.mouseupHandler.bind(this));\n\n    $guiRoot.on(\"paste\", log.wrap(this.pasteHandler.bind(this)));\n    this.$inputField.on(\"paste\", log.wrap(this.pasteHandler.bind(this)));\n\n    $guiRoot.on(\"cut\", log.wrap(this.cutHandler.bind(this)));\n    $(this.window).on(\"resize.wed\", this.resizeHandler.bind(this));\n\n    $guiRoot.on(\"click\", \"a\", (ev) => {\n      if (ev.ctrlKey) {\n        window.location.href = (ev.currentTarget as HTMLAnchorElement).href;\n      }\n      return false;\n    });\n\n    // This is a guard to make sure that mousemove handlers are removed once the\n    // button is up again.\n    const $body = $(this.doc.body);\n    $body.on(\"mouseup.wed\", () => {\n      this.$guiRoot.off(\"mousemove.wed mouseup\");\n    });\n\n    $body.on(\"contextmenu.wed\", (ev) => {\n      // It may happen that contextmenu can escape to the body even if the\n      // target is an element in guiRoot. This notably happens on IE for some\n      // reason. So trap such cases here and dispose of them.\n      return !this.guiRoot.contains(ev.target);\n    });\n\n    $body.on(\"click.wed\", (ev) => {\n      // If the click is triggered programmatically ``pageX`` and ``pageY``\n      // won't be defined. If the click is triggered due to an ENTER key\n      // converted by the browser, one or both will be negative. Or screenX,\n      // screenY will both be zero.\n      if (ev.pageX === undefined || ev.pageX < 0 ||\n          ev.pageY === undefined || ev.pageY < 0 ||\n          ((ev.screenX === ev.screenY) && (ev.screenX === 0))) {\n        return;\n      }\n\n      // We don't want to blur for clicks that are on elements part of our GUI.\n      if (this.widget.contains(ev.target)) {\n        return;\n      }\n\n      const el = this.doc.elementFromPoint(ev.clientX, ev.clientY);\n\n      if ($(el).closest(this.$excludedFromBlur).length !== 0) {\n        return;\n      }\n\n      const offset = this.$guiRoot.offset()!;\n      const x = ev.pageX - offset.left;\n      const y = ev.pageY - offset.top;\n\n      if (!((x >= 0) && (y >= 0) &&\n            (x < this.$guiRoot.outerWidth()) &&\n            (y < this.$guiRoot.outerHeight()))) {\n        this.caretManager.onBlur();\n      }\n      // We don't need to do anything special to focus the editor.\n    });\n\n    // Make ourselves visible.\n    this.$widget.removeClass(\"loading\");\n    this.$widget.css(\"display\", \"block\");\n\n    const namespaceError = this.initializeNamespaces();\n    if (namespaceError !== undefined) {\n      const limitationModal = this.modals.getModal(\"limitation\");\n      limitationModal.setBody(namespaceError);\n      limitationModal.modal();\n      this.destroy();\n      return this;\n    }\n    this.domlistener.processImmediately();\n    // Flush whatever has happened earlier.\n    this._undo.reset();\n\n    $guiRoot.focus();\n\n    this.validator.start();\n\n    let demo = this.options.demo;\n    if (demo !== undefined) {\n      // Provide a generic message.\n      if (typeof demo !== \"string\") {\n        demo = \"Some functions may not be available.\";\n      }\n      const demoModal = this.makeModal();\n      demoModal.setTitle(\"Demo\");\n      demoModal.setBody(`<p>This is a demo of wed. ${demo}</p> \\\n<p>Click <a href='${this.docURL}' target='_blank'>this link</a> to see \\\nwed's generic help. The link by default will open in a new tab.</p>`);\n      demoModal.addButton(\"Ok\", true);\n      demoModal.modal();\n    }\n\n    const save = this.options.save;\n    let savePromise;\n    if (save !== undefined) {\n      // The editor is not initialized until the saver is also initialized,\n      // which may take a bit.\n      savePromise = this.runtime.resolveModules(save.path)\n        .then((modules) => {\n          // tslint:disable-next-line:no-any variable-name\n          const SaverClass = (modules[0] as any).Saver as SaverConstructor;\n          const saveOptions = save.options !== undefined ? save.options : {};\n          const saver = new SaverClass(this.runtime, version, this.dataUpdater,\n                                       this.dataRoot, saveOptions);\n          this.saver = saver;\n\n          saver.events\n            .pipe(filter(filterSaveEvents.bind(undefined, \"Saved\")))\n            .subscribe(this.onSaverSaved.bind(this));\n\n          saver.events\n            .pipe(filter(filterSaveEvents.bind(undefined, \"Autosaved\")))\n            .subscribe(this.onSaverAutosaved.bind(this));\n\n          saver.events\n            .pipe(filter(filterSaveEvents.bind(undefined, \"Failed\")))\n            .subscribe(this.onSaverFailed.bind(this));\n\n          saver.events\n            .pipe(filter(filterSaveEvents.bind(undefined, \"Changed\")))\n            .subscribe(this.onSaverChanged.bind(this));\n\n          this.refreshSaveStatus();\n          this.saveStatusInterval =\n            setInterval(this.refreshSaveStatus.bind(this), 30 * 1000);\n          onbeforeunload.install(\n            this.window,\n            () => !this.destroyed && this.saver.getModifiedWhen() !== false,\n            true);\n\n          return saver.init();\n        });\n    }\n    else {\n      savePromise = Promise.resolve()\n        .then(() => {\n          log.error(\"wed cannot save data due to the absence of a save option\");\n        });\n    }\n\n    await savePromise;\n    this.initializedResolve(this);\n    return this;\n  }\n\n  /**\n   * Handler for setting ``contenteditable`` on nodes included into the\n   * tree. This handler preforms an initial generic setup that does not need\n   * mode-specific information. It sets ``contenteditable`` to true on any real\n   * element or any attribute value.\n   */\n  private initialContentEditableHandler(ev: BeforeInsertNodeAtEvent): void {\n    const mod = (el: Element) => {\n      // All elements that may get a selection must be focusable to\n      // work around issue:\n      // https://bugzilla.mozilla.org/show_bug.cgi?id=921444\n      el.setAttribute(\"tabindex\", \"-1\");\n      el.setAttribute(\"contenteditable\",\n                      String(el.classList.contains(\"_real\") ||\n                             el.classList.contains(\"_attribute_value\")));\n      let child = el.firstElementChild;\n      while (child !== null) {\n        mod(child);\n        child = child.nextElementSibling;\n      }\n    };\n\n    // We never call this function with something else than an Element for\n    // ev.node.\n    mod(ev.node as Element);\n  }\n\n  /**\n   * Handler for setting ``contenteditable`` on nodes included into the\n   * tree. This handler adjusts whether attribute values are editable by using\n   * mode-specific data.\n   */\n  private finalContentEditableHandler(ev: InsertNodeAtEvent): void {\n    // We never call this function with something else than an Element for\n    // ev.node.\n    const el = ev.node as Element;\n\n    const attrs = el.getElementsByClassName(\"_attribute_value\");\n    for (const attr of Array.from(attrs)) {\n      if (this.modeTree.getAttributeHandling(attr) !== \"edit\") {\n        attr.setAttribute(\"contenteditable\", \"false\");\n      }\n    }\n  }\n\n  private initializeNamespaces(): string | undefined {\n    const mode = this.modeTree.getMode(this.guiRoot);\n    const resolver = mode.getAbsoluteResolver();\n    let failure: string | undefined;\n    if (this.dataRoot.firstChild === null) {\n      // The document is empty: create a child node with the absolute namespace\n      // mappings.\n      const attrs = Object.create(null);\n      this.validator.getSchemaNamespaces().forEach((ns) => {\n        if (ns === \"*\" || ns === \"::except\") {\n          return;\n        }\n\n        const k = resolver.prefixFromURI(ns);\n        // Don't create a mapping for the `xml`, seeing as it is defined by\n        // default.\n        if (k === \"xml\") {\n          return;\n        }\n\n        if (k === \"\") {\n          attrs.xmlns = ns;\n        }\n        else {\n          if (k === undefined) {\n            failure = `The mode does not allow determining the namespace \\\nprefix for ${ns}. The most likely issue is that the mode is buggy or wed was \\\nstarted with incorrect options.`;\n          }\n          attrs[`xmlns:${k}`] = ns;\n        }\n      });\n\n      if (failure !== undefined) {\n        return failure;\n      }\n\n      const evs = Array.from(this.validator.possibleAt(this.dataRoot, 0));\n      if (evs.length === 1 && evs[0].params[0] === \"enterStartTag\") {\n        const name = evs[0].params[1] as salve.BaseName;\n        // If the name pattern is not simple or it allows for a number of\n        // choices, then we skip this creation.\n        const asArray = name.toArray();\n        if (asArray !== null && asArray.length === 1) {\n          const simple = asArray[0];\n          insertElement(\n            this.dataUpdater, this.dataRoot, 0, simple.ns,\n            resolver.unresolveName(simple.ns, simple.name)!, attrs);\n          this.caretManager.setCaret(this.dataRoot.firstElementChild, 0);\n        }\n      }\n\n      // Ok, we did not insert anything, let's put a placeholder there.\n      if (this.dataRoot.firstChild === null) {\n        const ph = this.insertTransientPlaceholderAt(\n          this.caretManager.makeCaret(this.guiRoot, 0)!);\n        this.caretManager.setCaret(ph, 0);\n      }\n    }\n    else {\n      const namespaces = this.validator.getDocumentNamespaces();\n      // Yeah, we won't stop as early as possible if there's a failure.  So\n      // what?\n      Object.keys(namespaces).forEach((prefix) => {\n        const uri = namespaces[prefix];\n        if (uri.length > 1) {\n          failure = \"The document you are trying to edit uses namespaces \\\nin a way not supported by this version of wed.\";\n        }\n\n        resolver.definePrefix(prefix, uri[0]);\n      });\n    }\n    return failure;\n  }\n\n  addToolbarAction(actionClass: editorActions.ActionCtor,\n                   options: AddOptions): void {\n    this.toolbar.addButton(new actionClass(this).makeButton(), options);\n  }\n\n  /**\n   * Creates a new task runner and registers it with the editor so that it is\n   * started and stopped by the methods that stop/start all tasks.\n   *\n   * @param task The task that the runner must run.\n   *\n   * @returns The new runner.\n   */\n  newTaskRunner(task: Task): TaskRunner {\n    const runner = new TaskRunner(task);\n    this.taskRunners.push(runner);\n    return runner;\n  }\n\n  /**\n   * Triggers the resizing algorithm.\n   */\n  resize(): void {\n    this.resizeHandler();\n  }\n\n  private resizeHandler(): void {\n    let heightAfter = 0;\n\n    function addHeight(x: Element): void {\n      heightAfter += x.getBoundingClientRect().height;\n    }\n\n    let constrainerSibling = this.constrainer.nextElementSibling;\n    while (constrainerSibling !== null) {\n      addHeight(constrainerSibling);\n      constrainerSibling = constrainerSibling.nextElementSibling;\n    }\n\n    let examine: Element | null = this.widget;\n    // We want to use isElement here because eventually we'll run into the\n    // document element that holds everything. We still declare examine as an\n    // Element or null because we never use it as a document.\n    while (isElement(examine)) {\n      let sibling = examine.nextElementSibling;\n      while (sibling !== null) {\n        if (sibling.tagName !== \"script\") {\n          addHeight(sibling);\n        }\n        sibling = sibling.nextElementSibling;\n      }\n      examine = examine.parentNode as (Element | null);\n    }\n\n    // The height is the inner height of the window:\n    // a. minus what appears before it.\n    // b. minus what appears after it.\n    let height = this.window.innerHeight -\n      // This is the space before\n      (this.scroller.getBoundingClientRect().top + this.window.pageYOffset) -\n      // This is the space after\n      heightAfter;\n\n    height = Math.floor(height);\n\n    this.scroller.coerceHeight(height);\n\n    const sidebar = this.sidebar;\n    let pheight = this.window.innerHeight -\n      (sidebar.getBoundingClientRect().top + this.window.pageYOffset) -\n      heightAfter;\n    sidebar.style.maxHeight = `${pheight}px`;\n    sidebar.style.minHeight = `${pheight}px`;\n\n    const sp =\n      sidebar.getElementsByClassName(\"wed-sidebar-panel\")[0] as HTMLElement;\n    pheight = this.window.innerHeight -\n      (sp.getBoundingClientRect().top + this.window.pageYOffset) -\n      heightAfter;\n    sp.style.maxHeight = `${pheight}px`;\n    sp.style.minHeight = `${pheight}px`;\n\n    const panels = sp.getElementsByClassName(\"panel\");\n    const headings = sp.getElementsByClassName(\"panel-heading\");\n    let hheight = 0;\n    for (let i = 0; i < headings.length; ++i) {\n      const heading = headings[i];\n      const $parent = $(heading.parentNode as Node);\n      hheight += $parent.outerHeight(true) - $parent.innerHeight();\n      hheight += $(heading).outerHeight(true);\n    }\n    const maxPanelHeight = pheight - hheight;\n    let panel;\n    for (let i = 0; i < panels.length; ++i) {\n      panel = panels[i] as HTMLElement;\n      panel.style.maxHeight = `${maxPanelHeight +\n        $(domutil.childByClass(panel, \"panel-heading\")).outerHeight(true)}px`;\n      const body = panel.getElementsByClassName(\"panel-body\")[0] as HTMLElement;\n      body.style.height = `${maxPanelHeight}px`;\n    }\n\n    if (this.validationController !== undefined) {\n      // We must refresh these because resizing the editor pane may cause text\n      // to move up or down due to line wrap.\n      this.validationController.refreshErrors();\n    }\n    this.caretManager.mark.refresh();\n  }\n\n  /**\n   * Opens a documentation link.\n   *\n   * @param url The URL to open.\n   */\n  openDocumentationLink(url: string): void {\n    window.open(url);\n  }\n\n  /**\n   * Returns the list of element transformations for the location pointed to by\n   * the caret.\n   *\n   * @param treeCaret The location in the document. This must be a data\n   * location, not a GUI location.\n   *\n   * @param types The types of transformations to get.\n   *\n   * @return An array of objects having the fields ``tr`` which contain the\n   * actual transformation and ``name`` which is the unresolved element name for\n   * this transformation. It is exceptionally possible to have an item of the\n   * list contain ``undefined`` for ``name``.\n   */\n  getElementTransformationsAt(treeCaret: DLoc, types: string |  string[]):\n  { tr: Action<{}>; name?: string }[]\n  {\n    const mode = this.modeTree.getMode(treeCaret.node);\n    const resolver = mode.getAbsoluteResolver();\n    const ret: { tr: Action<{}>; name?: string }[] = [];\n    this.validator.possibleAt(treeCaret).forEach((ev: salve.Event) => {\n      if (ev.params[0] !== \"enterStartTag\") {\n        return;\n      }\n\n      const pattern = ev.params[1] as salve.BaseName;\n      const asArray = pattern.toArray();\n      if (asArray !== null) {\n        for (const name of asArray) {\n          const unresolved = resolver.unresolveName(name.ns, name.name);\n\n          const trs = mode.getContextualActions(\n            types, unresolved!, treeCaret.node, treeCaret.offset);\n          if (trs === undefined) {\n            return;\n          }\n\n          for (const tr of trs) {\n            ret.push({ tr, name: unresolved });\n          }\n        }\n      }\n      else {\n        // We push an action rather than a transformation.\n        ret.push({ tr: this.complexPatternAction, name: undefined });\n      }\n    });\n\n    return ret;\n  }\n\n  private cutHandler(e: JQueryEventObject): boolean {\n    if (this.caretManager.getDataCaret() === undefined) {\n      // XXX alert the user?\n      return false;\n    }\n\n    const sel = this.caretManager.sel!;\n    if (sel.wellFormed) {\n      const el = closestByClass(sel.anchor.node, \"_real\", this.guiRoot);\n      // We do not operate on elements that are readonly.\n      if (el === null || el.classList.contains(\"_readonly\")) {\n        return false;\n      }\n\n      // The only thing we need to pass is the event that triggered the\n      // cut.\n      this.fireTransformation(this.cutTr, { e: e });\n      return true;\n    }\n\n    this.modals.getModal(\"straddling\").modal();\n    return false;\n  }\n\n  private pasteHandler(e: JQueryEventObject): boolean {\n    const caret = this.caretManager.getDataCaret();\n    if (caret === undefined) {\n      // XXX alert the user?\n      return false;\n    }\n\n    const el = closestByClass(this.caretManager.anchor!.node, \"_real\",\n                            this.guiRoot);\n    // We do not operate on elements that are readonly.\n    if (el === null || el.classList.contains(\"_readonly\")) {\n      return false;\n    }\n\n    // IE puts the clipboardData as a object on the window.\n    // tslint:disable\n    const cd = (e.originalEvent as any).clipboardData ||\n      (this.window as any).clipboardData;\n    // tslint:enable\n\n    let text = cd.getData(\"text\");\n    if (text == null || text === \"\") {\n      return false;\n    }\n\n    // This could result in an empty string.\n    text = this.normalizeEnteredText(text);\n    if (text === \"\") {\n      return false;\n    }\n\n    const parser = new this.window.DOMParser();\n    const doc = parser.parseFromString(`<div>${text}</div>`, \"text/xml\");\n    let asXML = true;\n    if (isElement(doc.firstChild) &&\n        doc.firstChild.tagName === \"parsererror\" &&\n        doc.firstChild.namespaceURI ===\n        // tslint:disable-next-line:no-http-string\n        \"http://www.mozilla.org/newlayout/xml/parsererror.xml\") {\n      asXML = false;\n    }\n\n    let data: Element;\n    if (asXML) {\n      data = doc.firstChild as Element;\n      // Otherwise, check whether it is valid.\n      const errors = this.validator.speculativelyValidate(\n        caret, Array.prototype.slice.call(data.childNodes));\n\n      if (errors) {\n        // We need to save this before we bring up the modal because clicking to\n        // dismiss the modal will mangle ``cd``.\n        const modal = this.modals.getModal(\"paste\");\n        modal.modal(() => {\n          if (modal.getClickedAsText() === \"Yes\") {\n            data = this.doc.createElement(\"div\");\n            data.textContent = text;\n            // At this point data is a single top level fake <div> element which\n            // contains the contents we actually want to paste.\n            this.fireTransformation(\n              this.pasteTr,\n              { node: caret.node, to_paste: data, e: e });\n          }\n        });\n        return false;\n      }\n    }\n    else {\n      data = this.doc.createElement(\"div\");\n      data.textContent = text;\n    }\n\n    // At this point data is a single top level fake <div> element\n    // which contains the contents we actually want to paste.\n    this.fireTransformation(this.pasteTr,\n                            { node: caret.node, to_paste: data, e: e });\n    return false;\n  }\n\n  private keydownHandler(e: JQueryKeyEventObject): void {\n    const caret = this.caretManager.getNormalizedCaret();\n    // Don't call it on undefined caret.\n    if (caret !== undefined) {\n      this.$guiRoot.trigger(\"wed-input-trigger-keydown\", [e]);\n    }\n    if (e.isImmediatePropagationStopped() || e.isPropagationStopped()) {\n      return;\n    }\n\n    this.$guiRoot.trigger(\"wed-global-keydown\", [e]);\n  }\n\n  pushGlobalKeydownHandler(handler: KeydownHandler): void {\n    this.globalKeydownHandlers.push(handler);\n  }\n\n  popGlobalKeydownHandler(handler: KeydownHandler): void {\n    const popped = this.globalKeydownHandlers.pop();\n    if (popped !== handler) {\n      throw new Error(\"did not pop the expected handler\");\n    }\n  }\n\n  // tslint:disable-next-line:cyclomatic-complexity max-func-body-length\n  private globalKeydownHandler(wedEvent: JQueryEventObject,\n                               e: JQueryEventObject): boolean {\n    let caret; // damn hoisting\n\n    // These are things like the user hitting Ctrl, Alt, Shift, or\n    // CapsLock, etc. Return immediately.\n    if (e.which === 17 || e.which === 16 || e.which === 18 || e.which === 0) {\n      return true;\n    }\n\n    // We don't process any input if the minibuffer is enabled.\n    if (this.minibuffer.enabled) {\n      return true;\n    }\n\n    function terminate(): false {\n      e.stopPropagation();\n      e.preventDefault();\n      return false;\n    }\n\n    for (const handler of this.globalKeydownHandlers) {\n      const ret = handler(wedEvent, e);\n      if (ret === false) {\n        return terminate();\n      }\n    }\n\n    // F1\n    if (e.which === 112) {\n      this.modals.getModal(\"help\").modal();\n      return terminate();\n    }\n\n    // Diagnosis stuff\n    if (this.developmentMode) {\n      // F2\n      if (e.which === 113) {\n        this.caretManager.dumpCaretInfo();\n        return terminate();\n      }\n      // F3\n      if (e.which === 114) {\n        this.dumpUndo();\n        return terminate();\n      }\n      // F4\n      if (e.which === 115) {\n        // tslint:disable:no-console\n        console.log(\"manual focus\");\n        console.log(\"document.activeElement before\",\n                    document.activeElement);\n        console.log(\"document.querySelector(\\\":focus\\\") before\",\n                    document.querySelector(\":focus\"));\n        this.caretManager.focusInputField();\n        console.log(\"document.activeElement after\",\n                    document.activeElement);\n        console.log(\"document.querySelector(\\\":focus\\\") after\",\n                    document.querySelector(\":focus\"));\n        // tslint:enable:no-console\n        return terminate();\n      }\n    }\n\n    const selFocus = this.caretManager.caret;\n    // Cursor movement keys: handle them.\n    if (e.which >= 33 /* page up */ && e.which <= 40 /* down arrow */) {\n      let direction: caretMovement.Direction | undefined;\n      if (keyConstants.RIGHT_ARROW.matchesEvent(e)) {\n        direction = \"right\";\n      }\n      else if (keyConstants.LEFT_ARROW.matchesEvent(e)) {\n        direction = \"left\";\n      }\n      else if (keyConstants.DOWN_ARROW.matchesEvent(e)) {\n        direction = \"down\";\n      }\n      else if (keyConstants.UP_ARROW.matchesEvent(e)) {\n        direction = \"up\";\n      }\n\n      if (direction !== undefined) {\n        this.caretManager.move(direction, e.shiftKey);\n        return terminate();\n      }\n      return true;\n    }\n    else if (keyConstants.ESCAPE.matchesEvent(e)) {\n      if (this.closeAllTooltips()) {\n        return terminate();\n      }\n      return true;\n    }\n    else if (keyConstants.SAVE.matchesEvent(e)) {\n      // tslint:disable-next-line:no-floating-promises\n      this.save();\n      return terminate();\n    }\n    else if (keyConstants.UNDO.matchesEvent(e)) {\n      this.undo();\n      return terminate();\n    }\n    else if (keyConstants.REDO.matchesEvent(e)) {\n      this.redo();\n      return terminate();\n    }\n    else if (keyConstants.COPY.matchesEvent(e) ||\n             keyConstants.CUT.matchesEvent(e) ||\n             keyConstants.PASTE.matchesEvent(e)) {\n      return true;\n    }\n    else if (keyConstants.DEVELOPMENT.matchesEvent(e)) {\n      this.developmentMode = !this.developmentMode;\n      notify(this.developmentMode ? \"Development mode on.\" :\n             \"Development mode off.\");\n      if (this.developmentMode) {\n        log.showPopup();\n      }\n      return terminate();\n    }\n    else if (keyConstants.LOWER_LABEL_VISIBILITY.matchesEvent(e)) {\n      return this.decreaseLabelVisibilityLevelAction.terminalEventHandler(e);\n    }\n    else if (keyConstants.INCREASE_LABEL_VISIBILITY.matchesEvent(e)) {\n      return this.increaseLabelVisibilityLevelAction.terminalEventHandler(e);\n    }\n    else if (keyConstants.CONTEXTUAL_MENU.matchesEvent(e)) {\n      if (selFocus !== undefined) {\n        let selFocusNode = selFocus.node;\n        const gui = closestByClass(selFocusNode, \"_gui\", selFocus.root);\n        if (gui !== null && gui.classList.contains(\"_label_clicked\")) {\n          if (isText(selFocusNode)) {\n            selFocusNode = selFocusNode.parentNode!;\n          }\n          $(selFocusNode).trigger(\"wed-context-menu\", [e]);\n          return terminate();\n        }\n      }\n\n      if (this.editingMenuManager.contextMenuHandler(e) === false) {\n        return terminate();\n      }\n    }\n    else if (keyConstants.REPLACEMENT_MENU.matchesEvent(e)) {\n      this.editingMenuManager.setupReplacementMenu();\n      return terminate();\n    }\n    else if (keyConstants.QUICKSEARCH_FORWARD.matchesEvent(e)) {\n      if (this.caretManager.caret !== undefined) {\n        // tslint:disable-next-line:no-unused-expression\n        new QuickSearch(this, this.scroller, Direction.FORWARD);\n      }\n      return terminate();\n    }\n    else if (keyConstants.QUICKSEARCH_BACKWARDS.matchesEvent(e)) {\n      if (this.caretManager.caret !== undefined) {\n        // tslint:disable-next-line:no-unused-expression\n        new QuickSearch(this, this.scroller, Direction.BACKWARDS);\n      }\n      return terminate();\n    }\n    else if (keyConstants.SEARCH_FORWARD.matchesEvent(e)) {\n      if (this.caretManager.caret !== undefined) {\n        // tslint:disable-next-line:no-unused-expression\n        new DialogSearchReplace(this, this.scroller, Direction.FORWARD);\n      }\n      return terminate();\n    }\n    else if (keyConstants.SEARCH_BACKWARDS.matchesEvent(e)) {\n      if (this.caretManager.caret !== undefined) {\n        // tslint:disable-next-line:no-unused-expression\n        new DialogSearchReplace(this, this.scroller, Direction.BACKWARDS);\n      }\n      return terminate();\n    }\n\n    if (selFocus === undefined) {\n      return true;\n    }\n\n    const placeholder = closestByClass(selFocus.node, \"_placeholder\",\n                                       selFocus.root);\n    if (placeholder !== null) {\n      // We're in a placeholder, so...\n\n      // Reminder: if the caret is currently inside a placeholder getCaret will\n      // return a caret value just in front of the placeholder.\n      caret = this.caretManager.getDataCaret();\n\n      // A place holder could be in a place that does not allow text. If so,\n      // then do not allow entering regular text in this location.\n      if (!util.anySpecialKeyHeld(e)) {\n        let textPossible = false;\n\n        if ((placeholder.parentNode as HTMLElement)\n            .classList.contains(\"_attribute_value\")) {\n          textPossible = true;\n        }\n        else {\n          // Maybe throwing an exception could stop this loop early but that\n          // would have to be tested.\n          this.validator.possibleAt(caret!).forEach((ev) => {\n            if (ev.params[0] === \"text\") {\n              textPossible = true;\n            }\n          });\n        }\n\n        if (!textPossible) {\n          return terminate();\n        }\n      }\n\n      // Swallow these events when they happen in a placeholder.\n      if (keyConstants.BACKSPACE.matchesEvent(e) ||\n          keyConstants.DELETE.matchesEvent(e)) {\n        return terminate();\n      }\n    }\n\n    const attrVal = closestByClass(selFocus.node, \"_attribute_value\",\n                                   selFocus.root);\n    const label = this.guiRoot.querySelector(\n      \".__start_label._label_clicked, .__end_label._label_clicked\");\n    if (attrVal === null && label !== null &&\n        keyConstants.DELETE.matchesEvent(e)) {\n      // The caret is currently in an element label, and not in an attribute\n      // value. Delete the element!\n      const el = closestByClass(label, \"_real\", this.guiRoot);\n      const dataNode =\n        this.dataUpdater.pathToNode(this.nodeToPath(el!)) as HTMLElement;\n      const mode = this.modeTree.getMode(el!);\n      // Yes, delete-parent is correct because we take position 0 *inside*\n      // dataNode.\n      const trs = mode.getContextualActions(\"delete-parent\", dataNode.tagName,\n                                            dataNode, 0);\n\n      trs[0].execute({ node: dataNode, name: dataNode.tagName });\n      return terminate();\n    }\n    else if (isElement(selFocus.node) &&\n             (selFocus.node.classList.contains(\"_phantom\") ||\n              selFocus.node.classList.contains(\"_phantom_wrap\"))) {\n      return terminate();\n    }\n\n    let textUndo;\n    let parent;\n    let offset;\n\n    if (keyConstants.SPACE.matchesEvent(e)) {\n      caret = this.caretManager.getNormalizedCaret();\n      if (caret === undefined) {\n        return terminate();\n      }\n\n      if (attrVal !== null ||\n          closestByClass(caret.node, \"_phantom\", caret.root) === null) {\n        this.handleKeyInsertingText(e);\n      }\n\n      return terminate();\n    }\n    else if (keyConstants.DELETE.matchesEvent(e)) {\n      if (attrVal !== null) { // In attribute.\n        if (attrVal.textContent === \"\") { // empty === noop\n          return terminate();\n        }\n\n        this.spliceAttribute(attrVal as HTMLElement,\n                             this.caretManager.getNormalizedCaret()!.offset, 1,\n                             \"\");\n      }\n      else {\n        // Prevent deleting phantom stuff\n        const next =\n          domutil.nextCaretPosition(selFocus.toArray(), this.guiRoot, true)![0];\n        if (!isElement(next) ||\n            !(next.classList.contains(\"_phantom\") ||\n              next.classList.contains(\"_phantom_wrap\"))) {\n          // When a range is selected, we delete the whole range.\n          if (this.cutSelection()) {\n            this.validationController.refreshErrors();\n            return terminate();\n          }\n\n          // We need to handle the delete\n          caret = this.caretManager.getDataCaret()!;\n          // If the container is not a text node, we may still be just AT a text\n          // node from which we can delete. Handle this.\n          if (!isText(caret.node)) {\n            caret = caret.make(caret.node.childNodes[caret.offset], 0);\n          }\n\n          if (isText(caret.node)) {\n            parent = caret.node.parentNode!;\n            offset = indexOf(parent.childNodes, caret.node);\n\n            textUndo = this.initiateTextUndo();\n            this.dataUpdater.deleteText(caret, 1);\n            // Don't set the caret inside a node that has been deleted.\n            if (caret.node.parentNode !== null) {\n              this.caretManager.setCaret(caret, { textEdit: true });\n            }\n            else {\n              this.caretManager.setCaret(parent, offset, { textEdit: true });\n            }\n            textUndo.recordCaretAfter();\n          }\n        }\n      }\n      this.validationController.refreshErrors();\n      return terminate();\n    }\n    else if (keyConstants.BACKSPACE.matchesEvent(e)) {\n      if (attrVal !== null) { // In attribute.\n        if (attrVal.textContent === \"\") { // empty === noop\n          return terminate();\n        }\n\n        this.spliceAttribute(attrVal as HTMLElement,\n                             this.caretManager.getNormalizedCaret()!.offset - 1,\n                             1, \"\");\n      }\n      else {\n        // Prevent backspacing over phantom stuff\n        const prev =\n          domutil.prevCaretPosition(selFocus.toArray(), this.guiRoot, true)![0];\n        if (!isElement(prev) ||\n            !(prev.classList.contains(\"_phantom\") ||\n              prev.classList.contains(\"_phantom_wrap\"))) {\n          // When a range is selected, we delete the whole range.\n          if (this.cutSelection()) {\n            this.validationController.refreshErrors();\n            return terminate();\n          }\n\n          // We need to handle the backspace\n          caret = this.caretManager.getDataCaret()!;\n\n          // If the container is not a text node, we may still be just behind a\n          // text node from which we can delete. Handle this.\n          if (!isText(caret.node)) {\n            const last = caret.node.childNodes[caret.offset - 1];\n            // tslint:disable-next-line:no-any\n            const length: number | undefined = (last as any).length;\n            caret = caret.make(last, length);\n          }\n\n          if (isText(caret.node)) {\n            parent = caret.node.parentNode!;\n            offset = indexOf(parent.childNodes, caret.node);\n\n            // At start of text, nothing to delete.\n            if (caret.offset === 0) {\n              return terminate();\n            }\n\n            textUndo = this.initiateTextUndo();\n            this.dataUpdater.deleteText(caret.node, caret.offset - 1,\n                                         1);\n            // Don't set the caret inside a node that has been deleted.\n            if (caret.node.parentNode !== null) {\n              this.caretManager.setCaret(caret.node, caret.offset - 1,\n                                         { textEdit: true });\n            }\n            else {\n              this.caretManager.setCaret(parent, offset, { textEdit: true });\n            }\n            textUndo.recordCaretAfter();\n          }\n        }\n      }\n      this.validationController.refreshErrors();\n      return terminate();\n    }\n\n    return true;\n  }\n\n  private keypressHandler(e: JQueryEventObject): boolean | undefined {\n    // IE is the odd browser that allows ESCAPE to show up as a keypress so\n    // we have to prevent it from going any further.\n    if (ESCAPE_KEYPRESS.matchesEvent(e)) {\n      return true;\n    }\n\n    this.$guiRoot.trigger(\"wed-input-trigger-keypress\", [e]);\n    if (e.isImmediatePropagationStopped() || e.isPropagationStopped()) {\n      return true;\n    }\n\n    this.$guiRoot.trigger(\"wed-global-keypress\", [e]);\n    return undefined;\n  }\n\n  /**\n   * Simulates typing text in the editor.\n   *\n   * **NOTE**: this function is limited in what it can simulate. The main\n   * editing pane is where you get the most support. Other locations offer less\n   * support. One good example is the minibuffer. Typing a string into it works\n   * fine. Trying to use directional arrows and backspace/delete currently does\n   * not work. We'd have to write custom code to handle these cases because it\n   * is not possible, as we speak, to write JavaScript code that **entirely**\n   * simulates pressing keyboard keys. (JavaScript easily supports sending the\n   * events *generated* by hitting the keyboard, but this is not enough.)\n   *\n   * @param text The text to type in. An array of keys, a string or a single\n   * key.\n   */\n  // tslint:disable-next-line:no-reserved-keywords\n  type(text: string | Key | Key[],\n       where: WedEventTarget = WedEventTarget.DEFAULT): void {\n    if (text instanceof Key) {\n      text = [text];\n    }\n\n    for (let k of text) {\n      if (typeof k === \"string\") {\n        k = (k === \" \") ? keyConstants.SPACE : makeKey(k);\n      }\n\n      const event = new $.Event(\"keydown\");\n      k.setEventToMatch(event);\n\n      switch (where) {\n      case WedEventTarget.MINIBUFFER:\n        this.minibuffer.forwardEvent(event);\n        break;\n      case WedEventTarget.DEFAULT:\n        this.$inputField.trigger(event);\n        break;\n      default:\n        const t: never = where;\n        throw new Error(`unhandled target: ${t}`);\n      }\n    }\n  }\n\n  private globalKeypressHandler(_wedEvent: JQueryEventObject,\n                                e: JQueryKeyEventObject): boolean {\n    if (this.caretManager.caret === undefined) {\n      return true;\n    }\n\n    function terminate(): false {\n      e.preventDefault();\n      e.stopPropagation();\n      return false;\n    }\n\n    // On Firefox keypress events are generated for things like hitting the left\n    // or right arrow. The which value is 0 in these cases. On Chrome, hitting\n    // the left or right arrow will generate keyup, keydown events but not\n    // keypress. Yay for inconsistencies!\n    if (e.which === 0) {\n      return true;\n    }\n\n    // Backspace, which for some reason gets here on Firefox...\n    if (e.which === 8) {\n      return terminate();\n    }\n\n    // On Firefox the modifier keys will generate a keypress event, etc. Not so\n    // on Chrome. Yay for inconsistencies!\n    if (e.ctrlKey || e.altKey || e.metaKey) {\n      return true;\n    }\n\n    this.cutSelection();\n    this.handleKeyInsertingText(e);\n    return terminate();\n  }\n\n  private cutSelection(): boolean {\n    const sel = this.caretManager.sel;\n    if (sel !== undefined && !sel.collapsed) {\n      if (!sel.wellFormed) {\n        return true;\n      }\n\n      const textUndo = this.initiateTextUndo();\n      const [start, end] = sel.mustAsDataCarets();\n      const cutRet = this.dataUpdater.cut(start, end)[0];\n      this.caretManager.setCaret(cutRet, { textEdit: true });\n      textUndo.recordCaretAfter();\n      return true;\n    }\n\n    return false;\n  }\n\n  private handleKeyInsertingText(e: JQueryKeyEventObject): boolean | undefined {\n    const text = String.fromCharCode(e.which);\n\n    if (text === \"\") {\n      // Nothing needed\n      return false;\n    }\n\n    this.insertText(text);\n    e.preventDefault();\n    e.stopPropagation();\n    return undefined;\n  }\n\n  private compositionHandler(ev: JQueryEventObject): void {\n    if (ev.type === \"compositionstart\") {\n      this.composing = true;\n      this.compositionData = {\n        // tslint:disable-next-line:no-any\n        data: (ev.originalEvent as any).data,\n        startCaret: this.caretManager.caret,\n      };\n      this.inputField.style.zIndex = \"10\";\n      this.caretManager.mark.refresh();\n    }\n    else if (ev.type === \"compositionupdate\") {\n      // tslint:disable-next-line:no-any\n      this.compositionData!.data = (ev.originalEvent as any).data;\n    }\n    else if (ev.type === \"compositionend\") {\n      this.composing = false;\n      this.inputField.style.zIndex = \"\";\n      this.inputField.style.top = \"\";\n      this.inputField.style.left = \"\";\n    }\n    else {\n      throw new Error(`unexpected event type: ${ev.type}`);\n    }\n  }\n\n  private inputHandler(): void {\n    if (this.composing) {\n      return;\n    }\n    if (this.$inputField.val() === \"\") {\n      return;\n    }\n    this.insertText(this.$inputField.val());\n    this.$inputField.val(\"\");\n    this.caretManager.focusInputField();\n  }\n\n  private mousemoveHandler(e: JQueryMouseEventObject): void {\n    let elementAtMouse = this.doc.elementFromPoint(e.clientX, e.clientY);\n    if (!this.guiRoot.contains(elementAtMouse)) {\n      // Not in GUI tree.\n      return;\n    }\n\n    const editable = (el: Element): boolean => {\n      const cl = el.classList;\n      return cl.contains(\"_real\") ||\n        (cl.contains(\"_attribute_value\") &&\n         this.modeTree.getAttributeHandling(el) === \"edit\");\n    };\n\n    let boundary;\n    if (editable(elementAtMouse)) {\n      boundary = this.pointToCharBoundary(e.clientX, e.clientY);\n      if (boundary === undefined) {\n        return;\n      }\n    }\n    else {\n      let child = elementAtMouse;\n      while (!editable(elementAtMouse)) {\n        child = elementAtMouse;\n        elementAtMouse = child.parentNode as Element;\n        if (!this.guiRoot.contains(elementAtMouse)) {\n          // The mouse was in a bunch of non-editable elements.\n          return;\n        }\n      }\n      let offset = indexOf(elementAtMouse.childNodes, child);\n      const range = this.doc.createRange();\n      range.setStart(elementAtMouse, offset);\n      range.setEnd(elementAtMouse, offset + 1);\n      const rect = range.getBoundingClientRect();\n      if (Math.abs(rect.left - e.clientX) >= Math.abs(rect.right - e.clientX)) {\n        offset++;\n      }\n      boundary = this.caretManager.makeCaret(elementAtMouse, offset);\n    }\n\n    this.caretManager.setRange(this.caretManager.anchor!, boundary!);\n  }\n\n  private mousedownHandler(ev: JQueryMouseEventObject): boolean {\n    // Make sure the mouse is not on a scroll bar.\n    if (!this.scroller.isPointInside(ev.pageX, ev.pageY)) {\n      return false;\n    }\n\n    const boundary = this.pointToCharBoundary(ev.clientX, ev.clientY);\n    if (boundary === undefined) {\n      return true;\n    }\n\n    this.$guiRoot.one(\"mouseup\", this.mouseupHandler.bind(this));\n\n    this.errorLayer.unselectAll();\n    this.$errorList.find(\".selected\").removeClass(\"selected\");\n\n    const root = this.guiRoot;\n    const target = ev.target;\n    const placeholder = closestByClass(target, \"_placeholder\", root);\n    const label = closestByClass(target, \"_label\", root);\n    const caretManager = this.caretManager;\n    switch (ev.which) {\n    case 1:\n      // Don't track selections in gui elements, except if they are inside an\n      // attribute value.\n      if (closest(target, \"._gui, ._phantom\", root) === null ||\n          closestByClass(target, \"_attribute_value\", root) !== null) {\n        this.$guiRoot.on(\"mousemove.wed\", this.mousemoveHandler.bind(this));\n      }\n\n      // If the caret is changing due to a click on a placeholder, then put it\n      // inside the placeholder.\n      if (placeholder !== null) {\n        caretManager.setCaret(placeholder, 0);\n      }\n      else if (label !== null) {\n        // If the caret is changing due to a click on a label, then normalize it\n        // to a valid position.\n        caretManager.setCaretToLabelPosition(target, label, boundary);\n      }\n      else {\n        caretManager.setCaret(boundary);\n      }\n\n      if (ev.target.classList.contains(\"wed-validation-error\")) {\n        return true;\n      }\n\n      break;\n    case 3:\n      const range = this.caretManager.range;\n      if (!(range !== undefined && !range.collapsed)) {\n        // If the caret is changing due to a click on a placeholder, then put it\n        // inside the placeholder.\n        if (placeholder !== null) {\n          caretManager.setCaret(placeholder, 0);\n        }\n        else if (label !== null) {\n          // If the caret is changing due to a click on a label, then normalize\n          // it to a valid position.\n          caretManager.setCaretToLabelPosition(target, label, boundary);\n        }\n        else {\n          caretManager.setCaret(boundary);\n        }\n      }\n      break;\n    default:\n    }\n    return false;\n  }\n\n  // In previous versions of wed all mouse button processing was done in\n  // _mousedownHandler. However, this caused problems when processing context\n  // menus events. On IE in particular the mouseup that would occur when a\n  // context menu is brought up would happen on the newly brought up menu and\n  // would cause focus problems.\n  private mouseupHandler(ev: JQueryEventObject): boolean {\n    // Make sure the mouse is not on a scroll bar.\n    if (!this.scroller.isPointInside(ev.pageX, ev.pageY)) {\n      return false;\n    }\n\n    const boundary = this.pointToCharBoundary(ev.clientX, ev.clientY);\n    if (boundary === undefined) {\n      return true;\n    }\n\n    // Normalize.\n    if (ev.type === \"contextmenu\") {\n      ev.which = 3;\n    }\n\n    const root = this.guiRoot;\n    const target = ev.target;\n    const placeholder = closestByClass(target, \"_placeholder\", root);\n    const label = closestByClass(target, \"_label\", root);\n    const caretManager = this.caretManager;\n    switch (ev.which) {\n    case 3:\n      // If the caret is changing due to a click on a placeholder, then put it\n      // inside the placeholder.\n      if (placeholder !== null) {\n        caretManager.setCaret(target, 0);\n      }\n\n      if (label !== null) {\n        caretManager.setCaretToLabelPosition(target, label, boundary);\n        $(target).trigger(\"wed-context-menu\", [ev]);\n      }\n      else {\n        // If the editor is just gaining focus with *this* click, then\n        // this.caretManager.caret will not be set. It also means the range is\n        // collapsed.\n        if (caretManager.caret === undefined) {\n          caretManager.setCaret(boundary);\n        }\n\n        if (closest(target, \"*[data-wed--custom-context-menu]\",\n                    root) !== null) {\n          $(target).trigger(\"wed-context-menu\", [ev]);\n        }\n        else {\n          this.editingMenuManager.contextMenuHandler(ev);\n        }\n      }\n      break;\n    default:\n    }\n    this.$guiRoot.off(\"mousemove\");\n    ev.preventDefault();\n    return false;\n  }\n\n  private mouseoverHandler(ev: JQueryMouseEventObject): void {\n    const root = this.guiRoot;\n    const label = closestByClass(ev.target, \"_label\", root);\n    if (label !== null) {\n      // Get tooltips from the current mode\n      const real = closestByClass(label, \"_real\", root);\n      const origName = util.getOriginalName(real!);\n      const options = {\n        title: () => {\n          const mode = this.modeTree.getMode(label);\n          return mode.shortDescriptionFor(origName);\n        },\n        container: \"body\",\n        delay: { show: 1000 },\n        placement: \"auto top\",\n        trigger: \"hover\",\n      };\n      this.makeGUITreeTooltip($(label), options);\n      const tt = $.data(label, \"bs.tooltip\");\n      tt.enter(tt);\n    }\n  }\n\n  private mouseoutHandler(ev: JQueryMouseEventObject): boolean | undefined {\n    const root = this.guiRoot;\n    const label = closestByClass(ev.target, \"_label\", root);\n    if (label !== null) {\n      $(label).tooltip(\"destroy\");\n      // See _mouseoutHandler. We return false here for symmetry.\n      return false;\n    }\n\n    return undefined;\n  }\n\n  private refreshSaveStatus(): void {\n    if (this.saver !== undefined) {\n      const saveStatus = this.saver.getSavedWhen();\n      this.$saveStatus.children(\"span\").first()\n        .text(saveStatus !== undefined ? saveStatus : \"\");\n      if (saveStatus === undefined) {\n        this.$saveStatus.removeClass(\"label-success label-info\")\n          .addClass(\"label-default\");\n      }\n      else {\n        const kind = this.saver.getLastSaveKind();\n        let toAdd;\n        let tip;\n        switch (kind) {\n        case SaveKind.AUTO:\n          toAdd = \"label-info\";\n          tip = \"The last save was an autosave.\";\n          break;\n        case SaveKind.MANUAL:\n          toAdd = \"label-success\";\n          tip = \"The last save was a manual save.\";\n          break;\n        default:\n          throw new Error(`unexpected kind of save: ${kind}`);\n        }\n        this.$saveStatus.removeClass(\"label-default label-info label-success\")\n          .addClass(toAdd);\n        this.$saveStatus.tooltip(\"destroy\");\n        this.$saveStatus.tooltip({\n          title: tip,\n          container: \"body\",\n          placement: \"auto top\",\n          trigger: \"hover\",\n        });\n      }\n\n      const modified = this.saver.getModifiedWhen();\n      if (modified !== false) {\n        this.$modificationStatus.removeClass(\"label-success\");\n        this.$modificationStatus.addClass(\"label-warning\");\n        this.$modificationStatus.children(\"i\").css(\"visibility\", \"\");\n      }\n      else {\n        this.$modificationStatus.removeClass(\"label-warning\");\n        this.$modificationStatus.addClass(\"label-success\");\n        this.$modificationStatus.children(\"i\").css(\"visibility\", \"hidden\");\n      }\n    }\n  }\n\n  private onValidatorStateChange(workingState: WorkingStateData): void {\n    const state = workingState.state;\n    if (state === WorkingState.VALID || state === WorkingState.INVALID) {\n      if (!this._firstValidationComplete) {\n        this._firstValidationComplete = true;\n        this.firstValidationCompleteResolve(this);\n      }\n    }\n  }\n\n  private onPossibleDueToWildcardChange(node: Node): void {\n    //\n    // This function is designed to execute fairly quickly. **IT IS IMPORTANT\n    // NOT TO BURDEN THIS FUNCTION.** It will be called for every element and\n    // attribute in the data tree and thus making this function slower will have\n    // a significant impact on validation speed and the speed of wed generally.\n    //\n    let guiNode: Node | Element | undefined | null =\n      getGUINodeIfExists(this, node);\n\n    // This may happen if we are dealing with an attribute node.\n    if (isText(guiNode)) {\n      guiNode = closestByClass(guiNode, \"_attribute\", this.guiRoot);\n    }\n\n    if (guiNode != null) {\n      const decorator = this.modeTree.getDecorator(node);\n      // guiNode is necessarily an Element if we get here.\n      // And the property is necessarily set.\n      decorator.setReadOnly(guiNode as Element,\n                            this.validator.getNodeProperty(\n                              node, \"PossibleDueToWildcard\")!);\n    }\n\n    // If the GUI node does not exist yet, then the decorator will take care of\n    // adding or removing _readonly when decorating the node.\n  }\n\n  /**\n   * Expand the error panel if there is no navigation.\n   */\n  expandErrorPanelWhenNoNavigation(): void {\n    if (this.$navigationPanel[0].style.display === \"none\") {\n      this.$errorList.parents(\".panel-collapse\").collapse(\"show\");\n    }\n  }\n\n  private errorItemHandler(ev: JQueryEventObject): boolean {\n    const err = ev.data as GUIValidationError;\n    const marker =\n      document.querySelector(ev.target.getAttribute(\"href\")!) as HTMLElement;\n    this.errorLayer.select(marker);\n    const $parent = $(ev.target.parentNode!);\n    $parent.siblings().removeClass(\"selected\");\n    $parent.addClass(\"selected\");\n\n    // We move the caret to the location of the error.\n    this.caretManager.setCaret(err.ev.node, err.ev.index);\n\n    // We don't want href to cause further movement.\n    return false;\n  }\n\n  setNavigationList(items: Node | JQuery | Node[]): void {\n    this.$navigationList.empty();\n    // tslint:disable-next-line:no-any\n    this.$navigationList.append(items as any);\n\n    // Show the navigation panel.\n    this.$navigationPanel.css(\"display\", \"\");\n  }\n\n  makeModal(options?: ModalOptions): Modal {\n    const ret = new Modal(options);\n    const $top = ret.getTopLevel();\n    // Ensure that we don't lose the caret when a modal is displayed.\n    $top.on(\"show.bs.modal.modal\", () => {\n      this.caretManager.pushSelection();\n    });\n    $top.on(\"hidden.bs.modal.modal\", () => {\n      this.caretManager.popSelection();\n    });\n    this.$widget.prepend($top);\n    return ret;\n  }\n\n  makeGUITreeTooltip($for: JQuery, options: TooltipOptions): void {\n    const title = options.title;\n    if (title !== undefined) {\n      options = {...options};\n      options.title = () => {\n        // The check is here so that we can turn tooltips on and off\n        // dynamically.\n        if (this.destroyed || !(this.preferences.get(\"tooltips\") as boolean)) {\n          return undefined;\n        }\n\n        return (typeof title === \"function\") ? title() : title;\n      };\n    }\n\n    tooltip($for, options);\n  }\n\n  /**\n   * Reset the label visibility level to what it was when the editor was first\n   * initialized.\n   */\n  resetLabelVisibilityLevel(): void {\n    this.setLabelVisibilityLevel(this.initialLabelLevel);\n  }\n\n  /**\n   * Set the visibility level to a specific value. It is a no-op if it is called\n   * with a value that is less than 0 or greater than the maximum level\n   * supported, or if the new level is the same as the current level.\n   *\n   * @param level The new level.\n   */\n  setLabelVisibilityLevel(level: number): void {\n    if (level < 0 || level > this.maxLabelLevel) {\n      return;\n    }\n\n    while (this.currentLabelLevel > level) {\n      this.decreaseLabelVisiblityLevel();\n    }\n\n    while (this.currentLabelLevel < level) {\n      this.increaseLabelVisibilityLevel();\n    }\n  }\n\n  increaseLabelVisibilityLevel(): void {\n    if (this.currentLabelLevel >= this.maxLabelLevel) {\n      return;\n    }\n\n    this.currentLabelLevel++;\n    const labels = this.guiRoot.getElementsByClassName(\n      `_label_level_${this.currentLabelLevel}`);\n    // tslint:disable-next-line:one-variable-per-declaration\n    for (let i = 0, limit = labels.length; i < limit; i++) {\n      labels[i].classList.remove(\"_invisible\");\n    }\n\n    // We cannot just refresh the errors because some errors may appear or\n    // disappear due to the visibility change.\n    this.validationController.recreateErrors();\n    this.caretManager.mark.refresh();\n  }\n\n  decreaseLabelVisiblityLevel(): void {\n    if (this.currentLabelLevel === 0) {\n      return;\n    }\n\n    const prev = this.currentLabelLevel;\n    this.currentLabelLevel--;\n    const labels = this.guiRoot.getElementsByClassName(`_label_level_${prev}`);\n    // tslint:disable-next-line:one-variable-per-declaration\n    for (let i = 0, limit = labels.length; i < limit; i++) {\n      labels[i].classList.add(\"_invisible\");\n    }\n\n    // We cannot just refresh the errors because some errors may appear or\n    // disappear due to the visibility change.\n    this.validationController.recreateErrors();\n    this.caretManager.mark.refresh();\n  }\n\n  toggleAttributeHiding(): void {\n    this.guiRoot.classList.toggle(\"inhibit_attribute_hiding\");\n  }\n\n  private closeAllTooltips(): boolean {\n    const tts = this.doc.querySelectorAll(\"div.tooltip\");\n    let closed = false;\n    for (let i = 0; i < tts.length; ++i) {\n      const forEl = $.data(tts[i], \"wed-tooltip-for\");\n      const data = $(forEl).data(\"bs.tooltip\");\n      if (data != null) {\n        data.leave(data);\n        closed = true;\n      }\n    }\n    return closed;\n  }\n\n  excludeFromBlur(elements: JQuery | Element): void {\n    // tslint:disable-next-line:no-any\n    this.$excludedFromBlur.add(elements as any);\n  }\n\n  /**\n   * Finds the location of the character closest to the ``x, y``\n   * coordinates. Very often this will be the character whose bounding client\n   * rect encloses the coordinates. However, if no such character exists the\n   * algorithm will return the closest character. If multiple characters are at\n   * the same distance, then the first one found will be returned.\n   *\n   * @param x The x coordinate in client coordinates.\n   *\n   * @param y The y coordinate in client coordinates.\n   *\n   * @returns The location of the boundary character. The value return is\n   * ``undefined`` if the coordinates are outside the client or if the element\n   * in which the click occurred is not inside the editor pane (a descendant of\n   * ``this.guiRoot``).\n   */\n  private findLocationAt(x: number, y: number): DLoc | undefined {\n    const elementAtMouse = this.doc.elementFromPoint(x, y);\n    // This could happen if x, y is outside our screen.\n    if (elementAtMouse === null) {\n      return undefined;\n    }\n\n    // The elementAtMouse is not in the editing pane.\n    if (!this.guiRoot.contains(elementAtMouse)) {\n      return undefined;\n    }\n\n    return this.findLocationInElementAt(elementAtMouse, x, y);\n  }\n\n  private findLocationInElementAt(node: Node, x: number, y: number,\n                                  textOk: boolean = true): DLoc | undefined {\n    const range = this.doc.createRange();\n\n    let min: {\n      dist: { x: number; y: number };\n      node: Node;\n      start: number;\n    } | undefined;\n\n    //\n    // This function works only in cases where a space that is effectively\n    // rendered as a line break on the screen has a height and width of\n    // zero. (Logically this makes sense, there is no part of the screen which\n    // really belongs to the space.)\n    //\n    function checkRange(checkNode: Node, start: number): boolean {\n      let rects;\n      if (isText(checkNode)) {\n        range.setStart(checkNode, start);\n        range.setEnd(checkNode, start + 1);\n        rects = range.getClientRects();\n      }\n      else {\n        rects = (checkNode.childNodes[start] as Element).getClientRects();\n      }\n\n      for (let rectIx = 0; rectIx < rects.length; ++rectIx) {\n        const rect = rects[rectIx];\n        // Not a contender...\n        if (rect.height === 0 || rect.width === 0) {\n          continue;\n        }\n\n        const dist = util.distsFromRect(x, y, rect.left, rect.top,\n                                        rect.right, rect.bottom);\n        if (min === undefined || min.dist.y > dist.y ||\n            (min.dist.y === dist.y && min.dist.x > dist.x)) {\n          min = {\n            dist: dist,\n            node: checkNode,\n            start: start,\n          };\n\n          // Returning true means the search can end.\n          return (dist.y === 0 && dist.x === 0);\n        }\n      }\n\n      return false;\n    }\n\n    let child = node.firstChild;\n    let childIx = 0;\n    main_loop:\n    while (child !== null) {\n      if (textOk && isText(child)) {\n        for (let i = 0; i < child.length; ++i) {\n          if (checkRange(child, i)) {\n            // Can't get any better than this.\n            break main_loop;\n          }\n        }\n      }\n      else if (checkRange(node, childIx)) {\n          // Can't get any better than this.\n        break;\n      }\n      child = child.nextSibling;\n      childIx++;\n    }\n\n    if (min === undefined) {\n      return this.caretManager.makeCaret(node, 0);\n    }\n\n    return this.caretManager.makeCaret(min.node, min.start);\n  }\n\n  // tslint:disable-next-line:cyclomatic-complexity\n  private pointToCharBoundary(x: number, y: number): DLoc | undefined {\n    // This obviously won't work for top to bottom scripts.  Probably does not\n    // work with RTL scripts either.\n    let boundary = this.findLocationAt(x, y);\n    if (boundary !== undefined) {\n      const { node, offset } = boundary;\n      const nodeType = node.nodeType;\n\n      if ((isElement(node) && (offset < node.childNodes.length)) ||\n          (isText(node) && (offset < node.length))) {\n        // Adjust the value we return so that the location returned is the one\n        // closest to the x, y coordinates.\n\n        const range = this.doc.createRange();\n        range.setStart(node, offset);\n        range.setEnd(node, offset + 1);\n        const rect = range.getBoundingClientRect();\n        switch (nodeType) {\n        case Node.TEXT_NODE:\n          // We use newPosition to adjust the position so that the caret ends up\n          // in a location that makes sense from an editing standpoint.\n          const right = this.caretManager.newPosition(boundary, \"right\");\n          const left = this.caretManager.newPosition(boundary.make(node,\n                                                                   offset + 1),\n                                                     \"left\");\n          if (right !== undefined && left === undefined) {\n            boundary = right;\n          }\n          else if (left !== undefined && right === undefined) {\n            boundary = left;\n          }\n          else if (right !== undefined && left !== undefined) {\n            boundary = (Math.abs(boundaryXY(right).left - x) >=\n                        Math.abs(boundaryXY(left).left - x) ?\n                        left : right);\n          }\n          break;\n        case Node.ELEMENT_NODE:\n          // We don't use newPosition here because we want to skip over the\n          // *whole* element.\n          let before;\n          const pointedNode = node.childNodes[offset];\n          if (isElement(pointedNode)) {\n            const closestPos = this.findLocationInElementAt(pointedNode, x, y)!;\n            const limit = isElement(closestPos.node) ?\n                  closestPos.node.childNodes.length - 1 : -1;\n            switch (closestPos.offset) {\n            case 0:\n              before = true;\n              break;\n            case limit:\n              before = false;\n              break;\n            default:\n            }\n          }\n\n          if (before === undefined) {\n            before = Math.abs(rect.left - x) < Math.abs(rect.right - x);\n          }\n\n          if (!before) {\n            boundary = boundary.make(node, offset + 1);\n          }\n\n          break;\n        default:\n          throw new Error(`unexpected node type: ${nodeType}`);\n        }\n      }\n    }\n    return boundary;\n  }\n\n  // tslint:disable-next-line:max-func-body-length cyclomatic-complexity\n  private caretChange(ev: CaretChange): void {\n    const { options, caret, prevCaret, mode, prevMode, manager } = ev;\n    if (caret === undefined) {\n      return;\n    }\n\n    const textEdit = options.textEdit === true;\n    const gainingFocus = options.gainingFocus === true;\n    // We don't want to do this on regaining focus.\n    if (!gainingFocus) {\n      this.editingMenuManager.setupCompletionMenu();\n    }\n\n    // Caret movement terminates a text undo, unless the caret is moved by a\n    // text edit.\n    if (!textEdit) {\n      this.terminateTextUndo();\n    }\n\n    // The class owns_caret can be on more than one element. The classic case is\n    // if the caret is at an element label.\n    while (this.caretOwners[0] !== undefined) {\n      this.caretOwners[0].classList.remove(\"_owns_caret\");\n    }\n\n    // _label_clicked can also be on more than one element.\n    while (this.clickedLabels[0] !== undefined) {\n      this.clickedLabels[0].classList.remove(\"_label_clicked\");\n    }\n\n    // _with_caret should not be on more than one element, but if a momentary\n    // issue happens, we fix it here.\n    let hadCaret: Element | undefined;\n    while (this.withCaret[0] !== undefined) {\n      // We record the element with the caret. If there is more than one, which\n      // should not happen except in transient cases, it does not matter as it\n      // only means that we'll have an unnecessary error recreation.\n      hadCaret = this.withCaret[0];\n      hadCaret.classList.remove(\"_with_caret\");\n    }\n\n    if (prevCaret !== undefined) {\n      const oldTp = closest(prevCaret.node, \"._placeholder._transient\",\n                            prevCaret.root);\n      if (oldTp !== null && caret.root.contains(oldTp)) {\n        this.guiUpdater.removeNode(oldTp);\n      }\n    }\n\n    const node = isElement(caret.node) ?\n      caret.node : caret.node.parentNode as HTMLElement;\n    const root = caret.root;\n\n    // This caret is no longer in the gui tree. It is probably an intermediary\n    // state so don't do anything with it.\n    if (!this.guiRoot.contains(node)) {\n      return;\n    }\n\n    if (mode !== prevMode) {\n      this.toolbar.setModeButtons(\n        mode !== undefined ? mode.getToolbarButtons() : []);\n    }\n\n    const real = closestByClass(node, \"_real\", root);\n    if (real !== null) {\n      real.classList.add(\"_owns_caret\");\n    }\n\n    let hasCaret: Element | undefined;\n    const gui = closestByClass(node, \"_gui\", root);\n    // Make sure that the caret is in view.\n    if (gui !== null) {\n      if (manager.anchor === undefined ||\n          closestByClass(manager.anchor.node, \"_gui\", root) === gui) {\n        for (const child of domutil.childrenByClass(gui.parentNode!, \"_gui\")) {\n          child.classList.add(\"_label_clicked\");\n        }\n\n        gui.classList.add(\"_with_caret\");\n        hasCaret = gui;\n      }\n    }\n    else {\n      node.classList.add(\"_owns_caret\");\n    }\n\n    // When the caret moves, it may move outside of, or into, a start label\n    // that has autohidden attributes. In such case, we must recreate the\n    // errors, so that any error associated with an attribute that may be\n    // shown or hidden is recreated to fix hyperlinking.\n    if ((hadCaret !== hasCaret) &&\n        ((hasCaret !== undefined &&\n          hasCaret.getElementsByClassName(\"_shown_when_caret_in_label\")\n          .length !== 0) ||\n         (hadCaret !== undefined &&\n          hadCaret.getElementsByClassName(\"_shown_when_caret_in_label\")\n          .length !== 0))) {\n      this.validationController.recreateErrors();\n    }\n\n    if (!gainingFocus) {\n      manager.mark.scrollIntoView();\n    }\n\n    // We need to refresh the mark here because the modifications we made above\n    // to the CSS may have caused GUI items to appear or disappear and may have\n    // mucked up the caret mark.\n    this.caretManager.mark.refresh();\n    this.setLocationTo(node);\n  }\n\n  /**\n   * Set the location bar to a new location.\n   *\n   * @param el The element at which the location should point.\n   */\n  private setLocationTo(el: Element): void {\n    const steps = [];\n    while (el !== this.guiRoot) {\n      if (el.nodeType !== Node.ELEMENT_NODE) {\n        throw new Error(`unexpected node type: ${el.nodeType}`);\n      }\n\n      if (!el.classList.contains(\"_placeholder\") &&\n          closestByClass(el, \"_phantom\", this.guiRoot) === null) {\n        steps.unshift(`<span class='_gui _label'><span>&nbsp;\\\n${util.getOriginalName(el)}&nbsp;</span></span>`);\n      }\n      el = el.parentNode as HTMLElement;\n    }\n    const span = this.wedLocationBar.getElementsByTagName(\"span\")[0];\n    // tslint:disable-next-line:no-inner-html\n    span.innerHTML =\n      steps.length !== 0 ? steps.join(\"/\") : \"<span>&nbsp;</span>\";\n  }\n\n  private cut(): void {\n    const caretManager = this.caretManager;\n    const sel = caretManager.sel;\n    if (sel === undefined) {\n      throw new Error(\"no selection\");\n    }\n\n    if (!sel.wellFormed) {\n      throw new Error(\"malformed range\");\n    }\n\n    const [startCaret, endCaret] = sel.mustAsDataCarets();\n    const cutBuffer = this.cutBuffer;\n    while (cutBuffer.firstChild !== null) {\n      cutBuffer.removeChild(cutBuffer.firstChild);\n    }\n    if (isAttr(startCaret.node)) {\n      const attr = startCaret.node;\n      if (attr !== endCaret.node) {\n        throw new Error(\"attribute selection that does not start \" +\n                        \"and end in the same attribute\");\n      }\n      const removedText = attr.value.slice(startCaret.offset, endCaret.offset);\n      this.spliceAttribute(\n        closestByClass(caretManager.mustFromDataLocation(startCaret).node,\n                       \"_attribute_value\") as HTMLElement,\n        startCaret.offset,\n        endCaret.offset - startCaret.offset, \"\");\n      cutBuffer.textContent = removedText;\n    }\n    else {\n      const cutRet = this.dataUpdater.cut(startCaret, endCaret);\n      const nodes = cutRet[1];\n      const parser = new this.window.DOMParser();\n      const doc = parser.parseFromString(\"<div></div>\", \"text/xml\");\n      for (const node of nodes) {\n        doc.firstChild!.appendChild(doc.adoptNode(node));\n      }\n      cutBuffer.textContent = (doc.firstChild as Element).innerHTML;\n      caretManager.setCaret(cutRet[0]);\n    }\n\n    const range = this.doc.createRange();\n    const container = cutBuffer;\n    range.setStart(container, 0);\n    range.setEnd(container, container.childNodes.length);\n    const domSel = this.window.getSelection();\n    domSel.removeAllRanges();\n    domSel.addRange(range);\n\n    // We've set the range to the cut buffer, which is what we want for the cut\n    // operation to work. However, the focus is also set to the cut buffer but\n    // once the cut is done we want the focus to be back to our caret, so...\n    setTimeout(() => {\n      caretManager.focusInputField();\n    }, 0);\n  }\n\n  private paste(_editor: EditorAPI, data: PasteTransformationData): void {\n    const toPaste = data.to_paste;\n    const dataClone = toPaste.cloneNode(true);\n    let caret = this.caretManager.getDataCaret();\n    if (caret === undefined) {\n      throw new Error(\"trying to paste without a caret\");\n    }\n\n    let newCaret;\n\n    // Handle the case where we are pasting only text.\n    if (toPaste.childNodes.length === 1 && isText(toPaste.firstChild)) {\n      if (isAttr(caret.node)) {\n        const guiCaret = this.caretManager.mustGetNormalizedCaret();\n        this.spliceAttribute(closestByClass(\n          guiCaret.node, \"_attribute_value\",\n          guiCaret.node as HTMLElement) as HTMLElement,\n                             guiCaret.offset, 0, toPaste.firstChild.data);\n      }\n      else {\n        ({ caret: newCaret } =\n         this.dataUpdater.insertText(caret, toPaste.firstChild.data));\n      }\n    }\n    else {\n      const frag = document.createDocumentFragment();\n      while (toPaste.firstChild !== null) {\n        frag.appendChild(toPaste.firstChild);\n      }\n      switch (caret.node.nodeType) {\n      case Node.TEXT_NODE:\n        newCaret = this.dataUpdater.insertIntoText(caret, frag)[1];\n        break;\n      case Node.ELEMENT_NODE:\n        const child = caret.node.childNodes[caret.offset];\n        const after = child != null ? child.nextSibling : null;\n        // tslint:disable-next-line:no-any\n        this.dataUpdater.insertBefore(caret.node as Element, frag as any,\n                                      child);\n        newCaret = caret.makeWithOffset(after !== null ?\n                                        indexOf(caret.node.childNodes, after) :\n                                        caret.node.childNodes.length);\n        break;\n      default:\n        throw new Error(`unexpected node type: ${caret.node.nodeType}`);\n      }\n    }\n    if (newCaret != null) {\n      this.caretManager.setCaret(newCaret);\n      caret = newCaret;\n    }\n    this.$guiRoot.trigger(\"wed-post-paste\", [data.e, caret, dataClone]);\n  }\n\n  public replaceRange(editor: EditorAPI,\n                      data: ReplaceRangeTransformationData): void {\n    const caretManager = editor.caretManager;\n    const { range, newText, caretAtEnd } = data;\n    const { start, end } = range;\n    const dataStart = caretManager.toDataLocation(start)!;\n    const dataEnd = caretManager.toDataLocation(end)!;\n\n    let caret: DLoc;\n    if (isAttr(dataStart.node)) {\n      const attr = dataStart.node;\n      let value = attr.value;\n      value = value.slice(0, dataStart.offset) + newText +\n        value.slice(dataEnd.offset);\n      editor.dataUpdater.setAttributeNS(\n        attr.ownerElement!,\n        attr.namespaceURI === null ? \"\" : attr.namespaceURI,\n        attr.name, value);\n      if (caretAtEnd) {\n        caret = dataStart.makeWithOffset(dataStart.offset + newText.length);\n      }\n      else {\n        caret = dataStart;\n      }\n    }\n    else {\n      const cutRet = editor.dataUpdater.cut(dataStart, dataEnd)[0];\n      ({ caret } = editor.dataUpdater.insertText(cutRet, newText, caretAtEnd));\n    }\n    caretManager.setCaret(caret, { textEdit: true });\n  }\n}\n\nexport {\n  PasteTransformationData,\n  ReplaceRangeTransformationData,\n};\n\n//  LocalWords:  MPL keyConstants KEYPRESS sm md contenteditable constrainer sb\n//  LocalWords:  scroller nbsp href nav ul li errorlist HTMLElement jQuery lt\n//  LocalWords:  html runtime DLocRoot config navlist popstate attr xmlns xml\n//  LocalWords:  getDescriptionFor fireTransformation exitTaskSuspension tooOld\n//  LocalWords:  readonly attrVal Refetch pathToNode nodeToPath Autosaved bs ev\n//  LocalWords:  editedByOther autosaving guiRoot BeforeInsertNodeAt tooltip ns\n//  LocalWords:  InsertNodeAt tooltips BeforeDeleteNode stylesheet css tabindex\n//  LocalWords:  revalidate dragenter dragstart dragover keydown keypress pageX\n//  LocalWords:  compositionstart compositionupdate compositionend mousedown px\n//  LocalWords:  mouseover mouseout contextmenu mousemove mouseup pageY screenX\n//  LocalWords:  screenY docUrl wed's enterStartTag pheight maxPanelHeight cd\n//  LocalWords:  domutil childByClass outerHeight clipboardData parsererror Yay\n//  LocalWords:  Ctrl CapsLock activeElement querySelector getCaret dataNode nd\n//  LocalWords:  noop keyup mousedownHandler caretManager mouseoutHandler rect\n//  LocalWords:  typeahead autosave guiNode PossibleDueToWildcard RTL nodeType\n//  LocalWords:  currentLabelLevel elementAtMouse newPosition\n"]}